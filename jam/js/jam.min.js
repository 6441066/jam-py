(function(a){"use strict";var b,c,d={"RESPONSE":1,"NOT_LOGGED":2,"UNDER_MAINTAINANCE":3,"NO_PROJECT":4,"TEXT":1,"INTEGER":2,"FLOAT":3,"CURRENCY":4,"DATE":5,"DATETIME":6,"BOOLEAN":7,"BLOB":8,"ITEM_FIELD":1,"FILTER_FIELD":2,"PARAM_FIELD":3,"FILTER_EQ":1,"FILTER_NE":2,"FILTER_LT":3,"FILTER_LE":4,"FILTER_GT":5,"FILTER_GE":6,"FILTER_IN":7,"FILTER_NOT_IN":8,"FILTER_RANGE":9,"FILTER_ISNULL":10,"FILTER_EXACT":11,"FILTER_CONTAINS":12,"FILTER_STARTWITH":13,"FILTER_ENDWITH":14,"FILTER_CONTAINS_ALL":15,"ALIGN_LEFT":1,"ALIGN_CENTER":2,"ALIGN_RIGHT":3,"STATE_INACTIVE":0,"STATE_BROWSE":1,"STATE_INSERT":2,"STATE_EDIT":3,"STATE_DELETE":4,"RECORD_UNCHANGED":null,"RECORD_INSERTED":1,"RECORD_MODIFIED":2,"RECORD_DETAILS_MODIFIED":3,"RECORD_DELETED":4,"REC_STATUS":0,"REC_CONTROLS_INFO":1,"REC_CHANGE_ID":2,"UPDATE_OPEN":0,"UPDATE_DELETE":1,"UPDATE_CANCEL":2,"UPDATE_APPEND":3,"UPDATE_INSERT":4,"UPDATE_SCROLLED":5,"UPDATE_CONTROLS":6,"UPDATE_REFRESH":7,"UPDATE_CLOSE":8},e=['','left','center','right'],f=['eq','ne','lt','le','gt','ge','in','not_in','range','isnull','exact','contains','startwith','endwith','contains_all'];function g(a,b,c,d,e,f,g){if(e===undefined)e=true;this.owner=a;this.item_name=c||'';this.item_caption=d||'';this.visible=e;this.ID=b||undefined;this.item_type_id=f;this.item_type='';if(f)this.item_type=this.types[f-1];if(g)this.js_filename='js/'+g;this.modal_options={width:560,transition:false,title:'',fields:[],close_button:true,close_caption:true,close_on_escape:true,print:false};this.items=[];if(a){if(!a.find(c))a.items.push(this);if(!(c in a))a[c]=this;this.task=a.task;}}g.prototype={constructor:g,types:["root","users","roles","tasks",'task',"catalogs","journals","tables","reports","catalog","journal","table","report","detail"],get_master_field:function(a,b){var c=0,d=a.length;for(;c<d;c++)if(a[c].ID==b)return a[c];},each_item:function(a){var b=0,c=this.items.length,d;for(;b<c;b++){d=a.call(this.items[b],this.items[b],b);if(d===false)break;}},all:function(a){var b=0,c=this.items.length;a.call(this,this);for(;b<c;b++)this.items[b].all(a);},find:function(a){var b=0,c=this.items.length;for(;b<c;b++)if(this.items[b].item_name===a)return this.items[b];},item_by_ID:function(a){var b;if(this.ID===a)return this;var c=0,d=this.items.length;for(;c<d;c++){b=this.items[c].item_by_ID(a);if(b)return b;}},addChild:function(a,b,c,d,e,f){var g;if(this.getChildClass){g=this.getChildClass();if(g)return new g(this,a,b,c,d,e,f);}},send_request:function(a,b,c){return this.task.process_request(a,this,b,c);},init:function(a){var b=0,c=a.items,d,e=c.length,f;for(;b<e;b++){f=c[b][1];d=this.addChild(f.id,f.name,f.caption,f.visible,f.type,f.js_filename);d._default_order=f.default_order;if(d.initAttr)d.initAttr(f);d.init(f);}},bind_items:function(){var a=0,b=this.items.length;if(this.bind_item)this.bind_item();for(;a<b;a++)this.items[a].bind_items();},script_loaded:function(){if(this.js_filename)return this.task._script_cache[this.js_filename];else return true;},load_script:function(a,b,c){var d=this,e,f=document.createElement('script');if(a&&!this.task._script_cache[a]){e=location.protocol+'//'+location.hostname+(location.port?':'+location.port:'')+'/'+a;f.src=e;f.type="text/javascript";document.getElementsByTagName('head')[0].appendChild(f);f.onload=function(){d.task._script_cache[a]=true;if(c)c.call(d,d);if(b)b.call(d,d);};}else if(b)b.call(d,d);},load_module:function(a){this.load_modules([this],a);},load_modules:function(a,b){var c=this,d=0,e=a.length,f,g=[],h=0,i=false,j=function(a){a.load_script(a.js_filename,function(){if(--h===0)if(b&&!i){i=true;b.call(c,c);}},function(){a.bind_handlers();});};for(;d<e;d++){f=a[d];if(!f.script_loaded())g.push(f);if(f.details&&f.each_detail)f.each_detail(function(a){if(!a.script_loaded())g.push(a);});}e=g.length;h=e;if(e)for(d=0;d<e;d++)j.call(g[d],g[d]);else if(b)b.call(this,this);},bind_handlers:function(){var a=task.events['events'+this.ID];this._events=[];for(var b in a)if(a.hasOwnProperty(b)){this[b]=a[b];this._events.push([b,a[b]]);}},bind_events:function(){var a=0,b=this.items.length;this.bind_handlers();for(;a<b;a++)this.items[a].bind_events();},can_view:function(){return this.task.has_privilege(this,'can_view');},findTemplate:function(a,b){var c,d,e,f=this;if(b.template_class)d=this.task.templates.find("."+b.template_class);else while(true){e=f.item_name;if(f.item_type==="detail")e=f.owner.item_name+"-"+f.item_name;d=this.task.templates.find("."+e+"-"+a);if(d.length)break;f=f.owner;if(f===f.task)break;}if(d)c=d.clone();return c;},server:function(b,c,d){var e,f,g;if(arguments.length==2&&typeof arguments[1]==="function"){d=arguments[1];c=[];}if(!c)c=[];else if(!a.isArray(c))c=[c];if(d)this.send_request('server_function',[b,c],function(a){e=a[0];f=a[1];if(f)throw f;else d.call(this,e);});else{g=this.send_request('server_function',[b,c]);e=g[0];f=g[1];if(f)throw f;else return e;}},makeFormModal:function(b,c){var d,e,f,g,h,i={title:this.item_caption,close_caption:true,close_button:true,print:false};function j(a){if(g){a.preventDefault();f.css('cursor','auto');e.css('margin-left',parseInt(e.css('margin-left'),10)+a.screenX-g);e.css('margin-top',parseInt(e.css('margin-top'),10)+a.screenY-h);g=a.screenX;h=a.screenY;}}function k(a){g=undefined;h=undefined;d.off("mousemove.modalform");d.off("mouseup.modalform");}c=a.extend({},i,c);if(!c.title)c.title='&nbsp';e=a('<div class="modal hide normal-modal-border" tabindex="-1" data-backdrop="static" data-item="'+this.item_name+'">'+'<div class="modal-header">'+'</div>'+'</div>');d=a(document);this.set_form_options(e,c);f=e.find('.modal-title');f.on("mousedown",function(a){g=a.screenX;h=a.screenY;d.on("mousemove.modalform",j);d.on("mouseup.modalform",k);});f.on("mousemove",function(b){a(this).css('cursor','move');});e.append(b);return e;},set_form_options:function(a,b,d){var e=this,f=a.find('.modal-header'),g=f.find('.modal-title'),h='',i='',j='',k='';if(b.close_button){if(c&&b.close_caption)h='&nbsp;'+c.close+' - [Esc]</small>';i='<button type="button" id="close-btn" class="close" tabindex="-1" aria-hidden="true" style="padding: 0px 10px;">'+h+' Ã—</button>';}if(c&&b.print)j='&nbsp;'+c.print+' - [Ctrl-P]</small>',k='<button type="button" id="print-btn" class="close" tabindex="-1" aria-hidden="true" style="padding: 0px 10px;">'+j+'</button>';if(!g.length)g=('<h4 class="modal-title">'+b.title+'</h4>');else{g.detach();g.html(b.title);}f.empty();f.append(i+k);f.append(g);f.find("#close-btn").css('cursor','default').click(function(a){if(d)e.close_form(d);});f.find('#print-btn').css('cursor','default').click(function(b){e.print_message(a.find(".modal-body").clone());});},_close_modeless_form:function(a){var b=this;if(this[a])this.close_form(a);if(this[a]){this[a].bind('destroyed',function(){b._close_modeless_form(a);});throw this.item_name+" - can't close form";}},create_form:function(b,c){var d=this,e=b+'_form',f=e+'.'+this.item_name;if(this[e]&&c.container)this._close_modeless_form(e);c.item_options=this[b+'_options'];this[e]=a("<div></div>").append(this.findTemplate(b,c.item_options));if(!c.container)this[e]=this.makeFormModal(this[e],c.item_options);if(this[e]){this[e]._options=c;this[e].tabindex=1;if(c.container){c.container.empty();a(window).on("keyup."+f,function(a){a.stopPropagation();if(c.onKeyUp)c.onKeyUp.call(d,a);});a(window).on("keydown."+f,function(a){a.stopPropagation();if(c.onKeyDown)c.onKeyDown.call(d,a);});c.container.append(this[e]);this[e].bind('destroyed',function(){d._close_modeless_form(e);});if(c.beforeShow)c.beforeShow.call(this);if(c.onShown)c.onShown.call(this);}else if(this[e].hasClass("modal")){this[e].on("show",function(a){a.stopPropagation();if(c.beforeShow)c.beforeShow.call(d,a);if(d[e].title)c.item_options.title=d[e].title;if(d[e].modal_width)c.item_options.width=d[e].modal_width;d.set_form_options(d[e],c.item_options,e);});this[e].on("shown",function(a){a.stopPropagation();if(c.onShown)c.onShown.call(d,a);});this[e].on("hide",function(a){var b=true;a.stopPropagation();if(c.onHide)b=c.onHide.call(d,a);if(b===false){a.preventDefault();d[e].data('_closing',false);}});this[e].on("hidden",function(a){a.stopPropagation();if(c.onHidden)c.onHidden.call(d,a);d[e]=undefined;});this[e].on("keydown."+f,function(a){a.stopPropagation();if(c.onKeyDown)c.onKeyDown.call(d,a);});this[e].on("keyup."+f,function(a){a.stopPropagation();if(c.onKeyUp)c.onKeyUp.call(d,a);});this[e].modal({item_options:c.item_options});}}},close_form:function(b){var c=this,d=this[b],e,f=b+'.'+this.item_name;if(d){d.data('_closing',true);if(d.hasClass('modal'))setTimeout(function(){d.modal('hide');},100);else{if(d._options&&d._options.onHide)e=d._options.onHide.call(c);if(e!==false){this[b]=undefined;a(window).off("keydown."+f);a(window).off("keyup."+f);d.remove();}}}},print_message:function(b){var c=window.frames.dummy,d=a("link[rel='stylesheet']"),e='<head>';d.each(function(a,b){e+='<link href="'+b.href+'" rel="stylesheet">';});e+='</head>';c.document.write(e+'<body onload="window.print()">'+b.html()+'</body>');a("link[rel='stylesheet']").clone().appendTo(a("dummy").contents().find("head"));c.document.close();},message:function(b,c){var d=1,e=this,f={buttons:undefined,title:'',width:400,height:undefined,margin:undefined,print:false,text_center:false,button_min_width:100,center_buttons:false,close_button:true,close_on_escape:true},g,h,i='',j,k,l=a('<button type="button" class="btn">OK</button>'),m;c=a.extend({},f,c);g=c.buttons;i='<div class="modal-body"></div>';if(!this.is_empty_obj(g))i+='<div class="modal-footer"></div>';j=this.makeFormModal(a(i),c);k=j.find('.modal-body');if(c.margin)k.css('margin',c.margin);k.html(b);if(!c.title)j.find('.modal-header').remove();if(c.text_center)k.html(b).addClass("text-center");if(c.center_buttons)j.find(".modal-footer").css("text-align","center");j.find("#close-btn").click(function(a){j.modal('hide');});for(h in g)if(g.hasOwnProperty(h)){j.find(".modal-footer").append(l.clone().attr("id",h).attr("tabindex",d).css("min-width",c.button_min_width).html(h));d++;}j.on("shown",function(a){a.stopPropagation();});j.on("hide",function(a){a.stopPropagation();});j.on("hidden",function(a){a.stopPropagation();});j.on("keyup keydown",function(a){var b=(a.keyCode?a.keyCode:a.which);a.stopPropagation();if(b===80&&a.ctrlKey){a.preventDefault();e.print_message(j.find(".modal-body").clone());}});j.on("click",".btn",function(b){var c;b.preventDefault();b.stopImmediatePropagation();for(var d in g)if(g.hasOwnProperty(d))if(a(b.target).attr("id")===d){if(g[d])c=g[d];clearTimeout(m);m=setTimeout(function(){if(c)c.call(e);j.modal('hide');},100);}});j.modal({width:c.width,height:c.height,keyboard:c.close_on_escape});return j;},question:function(a,b,d){var e={};e[c.yes]=b;e[c.no]=d;return this.message(a,{buttons:e,margin:"20px 20px",text_center:true,center_buttons:true});},warning:function(a,b){var c={"OK":b};return this.message(a,{buttons:c,margin:"20px 20px",text_center:true,center_buttons:true});},show_message:function(a,b){return this.message(a,b);},hide_message:function(a){a.modal('hide');},yes_no_cancel:function(a,b,d,e){var f={};f[c.yes]=b;f[c.no]=d;f[c.cancel]=e;return this.message(a,{buttons:f,margin:"20px 20px",text_center:true,width:500,center_buttons:true});},is_empty_obj:function(a){for(var b in a)if(a.hasOwnProperty(b))return false;return true;},emptyFunc:function(){},abort:function(a){a=a?' - '+a:'';throw 'execution aborted: '+this.item_name+a;},log_message:function(a){if(this.task.settings.DEBUGGING){a=a?' message: '+a:'';console.log(this.item_name+a);}}};h.prototype=new g();function h(b,c){var d=this;g.call(this,undefined,0,b,c,true);this.task=this;this.user_info={};this._script_cache={};this.gridId=0;a('body').on('mousedown.context_menu',function(a){if(d.$context_menu){d.$context_menu.hide();d.$context_menu.detach();d.$context_menu_parent.append(d.$context_menu);d.$context_menu=undefined;}});}a.extend(h.prototype,{constructor:h,consts:d,getChildClass:function(){return i;},process_request:function(b,e,f,g){var h=this,i=new Date().getTime(),j=false,k={},l="application/json;charset=utf-8",m;if(g)j=true;if(this.ajaxStatusCode)k=this.ajaxStatusCode;a.ajax({url:"/api",type:"POST",contentType:l,async:j,cache:false,data:JSON.stringify([b,this.user_id,this.ID,e.ID,f,i]),statusCode:k,success:function(a){var b;if(a.error)e.warning(c.error+': '+e.item_caption+' - '+a.error);else{if(a.result.status===d.NO_PROJECT){e.warning('You need to create a project.');return;}else if(a.result.status===d.UNDER_MAINTAINANCE){if(!h.task._under_maintainance){h.task._under_maintainance=true;if(c)b=c.website_maintenance;else b='Web site currently under maintenance.';e.warning(b,function(){h.task._under_maintainance=undefined;});}return;}else if(a.result.status===d.NOT_LOGGED)if(!h.logged_in){h.login();return;}else location.reload();else if(h.ID>0&&a.result.version&&h.version&&a.result.version!==h.version)if(!h.task._version_changed){h.task._version_changed=true;h.message('<h4>'+c.apply_changes+'</h4>',{margin:'50px 0px',width:500,text_center:true});}if(g)g.call(e,a.result.data);else m=a.result.data;}},error:function(a,b,d){if(a.responseText){document.open();document.write(a.responseText);document.close();}else if(c)if(!h.task._server_request_error){h.task._server_request_error=true;h.warning(c.server_request_error,function(){h.task._server_request_error=undefined;});}},fail:function(a,b,c){console.log('ajax fail: ',a,b,c);}});if(m!==undefined)return m;},_byteLength:function(a){var b=a.length;for(var c=a.length-1;c>=0;c--){var d=a.charCodeAt(c);if(d>0x7f&&d<=0x7ff)b++;else if(d>0x7ff&&d<=0xffff)b+=2;if(d>=0xDC00&&d<=0xDFFF)c--;}return b;},do_upload:function(a,b,c){var d=this,e,f,g=[],h,i='',j=[],k=';',l=new XMLHttpRequest(),m=this.ID+';'+this.user_id;i+=m.length+';'+m+k;i+=b.length+k;i+=this._byteLength(a)+k;for(e=0;e<b.length;e++){f=b[e][0];h=b[e][1];i+=this._byteLength(f.name)+k;i+=h.byteLength+k;g.push(f.name);}j.push(i);j.push(a);for(e=0;e<b.length;e++){f=b[e][0];h=b[e][1];j.push(f.name);j.push(h);}l.open('POST','/upload',true);if(c.callback)l.onload=function(a){if(c.multiple)c.callback.call(d,d,g);else c.callback.call(d,d,g[0]);};if(c.on_progress)l.upload.onprogress=function(a){c.on_progress.call(d,d,a);};var n=new Blob(j,{type:'application/octet-stream'});l.send(n);},upload:function(b,c){var d=this,e={callback:undefined,on_progress:undefined,extension:undefined,multiple:false},f=a('<input type="file" style="position: absolute; top: -100px"/>');c=a.extend({},e,c);if(c.multiple)f.attr('multiple','multiple');a('body').append(f);f.on('change',function(a){var e=a.target.files,g,h,i,j,k,l=[],m,n=[];for(g=0,j;j=e[g];g++){i='';if(c.extension){h=j.name.split('.');if(h.length)i=h[h.length-1];if(i!==c.extension)continue;}n.push(j);}for(g=0;g<n.length;g++){k=n[g];m=new FileReader();m.onload=(function(a){return function(e){l.push([a,e.target.result]);if(l.length===n.length)d.do_upload(b,l,c);};})(k);m.readAsArrayBuffer(k);}f.remove();});f.click();},load:function(){var e=this,f;if(!this.user_id)this.user_id=this.read_cookie('user_id');this.send_request('init_client',null,function(f){var g=f[0],h;e.logged_in=true;b=g.settings;c=g.language;e.settings=g.settings;e.language=g.language;e.user_info=g.user_info;e.user_privileges=g.privileges;e.consts=d;e.safe_mode=e.settings.SAFE_MODE;e.version=e.settings.VERSION;e.ID=g.task.id;e.item_name=g.task.name;e.item_caption=g.task.caption;e.visible=g.task.visible;e.item_type="";if(g.task.type)e.item_type=e.types[g.task.type-1];if(g.task.js_filename)e.js_filename='js/'+g.task.js_filename;e.task=e;e.templates=a("<div></div>");h=a(".templates");e.templates=h.clone();h.remove();e.init(g.task);e.bind_items();e.events={};if(e.ID===0){e.js_filename='jam/js/admin.js';e.settings.DYNAMIC_JS=false;}e.init_modules();});},init_modules:function(){var a=this,b=0,c=false,d=function(a){if(a.js_filename)b++;},e=function(d){if(d.js_filename)d.load_script(d.js_filename,function(){if(--b===0){a.bind_events();if(a.on_page_loaded&&!c){c=true;a.on_page_loaded.call(a,a);}}});};if(this.settings.DYNAMIC_JS){b=1;e(this);}else{this.all(d);this.all(e);}},login:function(){var b=this,c,d;if(this.templates)d=this.templates.find("#login-form").clone();else d=a("#login-form").clone();d=this.makeFormModal(d,{title:d.data('caption'),transition:false});d.find("#login-btn").click(function(a){var c=d.find("#inputLoging").val(),e=d.find("#inputPassword").val(),f=hex_md5(e);b.user_id=b.send_request('login',[c,f])[0];b.create_cookie('user_id',b.user_id,0.5);if(b.user_id){if(d)d.modal('hide');location.reload();}});d.find("#close-btn").click(function(a){d.modal('hide');});d.on("shown",function(a){d.find("#inputLoging").focus();a.stopPropagation();});d.find('input').keydown(function(b){var c=a(this),e=(b.keyCode?b.keyCode:b.which);if(e===40)if(c.attr('id')==='inputLoging')d.find('#inputPassword').focus();else d.find('#login-btn').focus();});d.modal({width:500});},logout:function(){if(this.user_id){this.send_request('logout',this.user_id);this.user_id=null;this.erase_cookie('user_id');location.reload();}},has_privilege:function(a,b){var c;if(a.task.ID===0)return true;if(!this.user_privileges||a.master)return true;else{if(!this.user_privileges)return false;try{c=this.user_privileges[a.ID];}catch(d){c=null;}if(c)return c[b];else return false;}},create_cookie:function(a,b,c){var d;if(c){var e=new Date();e.setTime(e.getTime()+(c*24*60*60*1000));d="; expires="+e.toGMTString();}else d="";document.cookie=escape(a)+"="+escape(b)+d+"; path=/";},read_cookie:function(a){var b=escape(a)+"=";var c=document.cookie.split(';');for(var d=0;d<c.length;d++){var e=c[d];while(e.charAt(0)===' ')e=e.substring(1,e.length);if(e.indexOf(b)===0)return unescape(e.substring(b.length,e.length));}return null;},erase_cookie:function(a){this.create_cookie(a,"",-1);},show_context_menu:function(b,c){if(b.length){c.preventDefault();this.$context_menu=b;this.$context_menu_parent=b.parent();b.detach();a('body').prepend(b);b.show();b.find('ul').css({top:c.pageY+"px",left:c.pageX+"px"}).show();}}});i.prototype=new g();i.prototype.constructor=i;function i(a,b,c,d,e,f,h){g.call(this,a,b,c,d,e,f,h);}i.prototype.getChildClass=function(){if(this.item_type==="reports")return l;else return k;};function j(a){this.item=a;this._change_id=0;this.records=[];this.logs={};this.fields=[];this.expanded=true;}j.prototype={constructor:j,get_change_id:function(){this._change_id+=1;return this._change_id+'';},is_empty_obj:function(a){for(var b in a)if(a.hasOwnProperty(b))return false;return true;},log_changes:function(){if(this.item.master)return this.item.master.change_log.log_changes();else return this.item.log_changes;},find_record_log:function(){var a,b,c,d,e,f,g=[],h;if(this.log_changes()){if(this.item.master){b=this.item.master.change_log.find_record_log();if(b){c=b.details;d=c[this.item.ID];if(this.is_empty_obj(d)){f=this.item.fields.length;for(e=0;e<f;e++)g.push(this.item.fields[e].field_name);d={'logs':{},'records':this.item._records,'fields':g,'expanded':this.item.expanded};c[this.item.ID]=d;}this.logs=d.logs;this.records=d.records;this.fields=d.fields;this.expanded=d.expanded;}}if(this.item.record_count()){h=this.item.get_rec_change_id();if(!h){h=this.get_change_id();this.item.set_rec_change_id(h);}a=this.logs[h];if(this.is_empty_obj(a)){a={'unmodified_record':null,'record':this.cur_record(),'details':{}};this.logs[h]=a;}}return a;}},get_detail_log:function(a){var b,c,d;if(this.log_changes()){c=this.find_record_log();d=c.details;if(!this.is_empty_obj(d))b=d[a];if(b===undefined&&this._is_delta)b={'records':[],'fields':[],'expanded':false,'logs':{}};return b;}},remove_record_log:function(){var a=this.item.get_rec_change_id();if(a){this.find_record_log();delete this.logs[a];this.item.set_rec_change_id(null);this.item.set_record_status(d.RECORD_UNCHANGED);}},cur_record:function(){return this.item._records[this.item.get_rec_no()];},record_modified:function(a){var b=false,c=a.unmodified_record,d=a.record;for(var e=0;e<this.item._record_lookup_index;e++)if(c[e]!==d[e]){b=true;break;}return b;},copy_record:function(a,b){var c=null,d;if(a){if(b===undefined)b=true;if(b)c=a.slice(0,this.item._record_info_index);else c=a.slice(0,this.item._record_lookup_index);d=this.item.get_rec_info(undefined,a);c.push([d[0],{},d[2]]);}return c;},can_log_changes:function(){var a=this.log_changes();if(this.item.item_state===d.STATE_EDIT){}},log_change:function(){var a;if(this.log_changes()){a=this.find_record_log();if(this.item.item_state===d.STATE_BROWSE){if((this.item.get_record_status()===d.RECORD_UNCHANGED)||(this.item.get_record_status()===d.RECORD_DETAILS_MODIFIED&&a.unmodified_record===null)){a.unmodified_record=this.copy_record(this.cur_record(),false);return;}}else if(this.item.item_state===d.STATE_INSERT)this.item.set_record_status(d.RECORD_INSERTED);else if(this.item.item_state===d.STATE_EDIT){if(this.item.get_record_status()===d.RECORD_UNCHANGED)this.item.record_status=d.RECORD_MODIFIED;else if(this.item.get_record_status()===d.RECORD_DETAILS_MODIFIED)if(this.record_modified(a))this.item.set_record_status(d.RECORD_MODIFIED);}else if(this.item.item_state===d.STATE_DELETE)if(this.item.get_record_status()===d.RECORD_INSERTED)this.remove_record_log();else this.item.set_record_status(d.RECORD_DELETED);else throw this.item.item_name+': change log invalid records state';if(this.item.master)if(this.item.master.get_record_status()===d.RECORD_UNCHANGED)this.item.master.set_record_status(d.RECORD_DETAILS_MODIFIED);}},get_changes:function(a){var b={},c,e,f,g,h,i,j,k,l,m;a.fields=this.fields;a.expanded=false;a.data=b;for(var n in this.logs)if(this.logs.hasOwnProperty(n)){c=this.logs[n];e=c.record;f=this.item.get_rec_info(undefined,e);if(f[d.REC_STATUS]!==d.RECORD_UNCHANGED){k=c.details;g=this.copy_record(e,false);h={};for(var i in k)if(k.hasOwnProperty(i)){j=k[i];l={};m=this.item.item_by_ID(parseInt(i,10));m.change_log.logs=j.logs;m.change_log.get_changes(l);h[i]=l;}b[n]={'record':g,'details':h};}}},set_changes:function(a){var b=a.data,c,d,e,f,g,h;this.records=[];this.logs={};this.fields=a.fields;this.expanded=a.expanded;this._change_id=0;for(var i in b)if(b.hasOwnProperty(i)){c=b[i];if(this._change_id<parseInt(i,10))this._change_id=parseInt(i,10);d=c.record;this.records.push(d);f={};this.logs[i]={'unmodified_record':null,'record':d,'details':f};e=c.details;for(var j in e)if(e.hasOwnProperty(j)){g=e[j];h=this.item.item_by_ID(parseInt(j,10));h.change_log.set_changes(g);f[j]={'logs':h.change_log.logs,'records':h.change_log.records,'fields':h.change_log.fields,'expanded':h.change_log.expanded};}}},copy_records:function(a){var b=0,c=a.length,d=[];for(b=0;b<c;b++)d.push(a[b].slice(0));return d;},store_details:function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p;for(var q=0;q<this.item.details.length;q++){c=this.item.details[q];o=c.ID;n=a[o];f={};h=[];k=[];l=true;if(n){d=n.logs;g=n.records;k=n.fields;l=n.expanded;h=this.copy_records(g);for(var r in d)if(d.hasOwnProperty(r)){e=d[r];i=e.record;j=c.change_log.copy_record(i);m=g.indexOf(i);if(m!==-1)h[m]=j;p={};c.change_log.store_details(e.details,p);f[r]={'unmodified_record':e.unmodified_record,'record':j,'details':p};}}else if(c._records)h=this.copy_records(c._records);b[o]={'logs':f,'records':h,'fields':k,'expanded':l};}},store_record_log:function(){var a,b,c,d;if(this.log_changes()){a=this.find_record_log();b={};this.store_details(a.details,b);d={};d.unmodified_record=a.unmodified_record;d.record=this.copy_record(a.record);d.details=b;}else{d={};d.record=this.copy_record(this.cur_record());b={};for(var e=0;e<this.item.details.length;e++){c=this.item.details[e];if(!c.disabled&&c._records)b[c.ID]=c._records.slice(0);}d.details=b;}return d;},restore_record_log:function(a){var b,c,e,f,g,h;if(this.log_changes()){b=this.find_record_log();c=a.record;g=this.cur_record();h=this.item._record_info_index;for(var i=0;i<h;i++)g[i]=c[i];b.unmodified_record=a.unmodified_record;b.record=g;b.details=a.details;for(var i=0;i<this.item.details.length;i++){e=this.item.details[i];f=a.details[e.ID];if(!this.is_empty_obj(f))e._records=f.records;}if(this.item.get_record_status()===d.RECORD_UNCHANGED)this.remove_record_log();}else{c=a.record;g=this.cur_record();h=this.item._record_info_index;for(var i=0;i<h;i++)g[i]=c[i];for(var i=0;i<this.item.details.length;i++){e=this.item.details[i];e._records=a.details[e.ID];}}},update:function(a){var b,c,e,f,g,h,i,j,k,l,m,n,o,p;if(a){c=a.changes;for(var q in c)if(c.hasOwnProperty(q)){b=c[q];e=b.log_id;f=b.rec_id;h=b.details;i=this.logs[e];j=i.record;k=i.details;l=h.length;for(var r=0;r<l;r++){g=h[r];m=g.ID;n=this.item.detail_by_ID(parseInt(m,10));o=k[m];if(!this.is_empty_obj(o)){n.change_log.logs=o.logs;n.change_log.update(g);}}if(f&&!j[this.item.id.bind_index])j[this.item.id.bind_index]=f;p=this.item.get_rec_info(undefined,j);p[d.REC_STATUS]=d.RECORD_UNCHANGED;p[d.REC_CHANGE_ID]=d.RECORD_UNCHANGED;delete this.logs[e];}}},prepare:function(){var a=this,b,c=this.item.fields.length;if(this.item.master)a=this.item.master.change_log.get_detail_log(this.item.ID);if(a){a.records=[];a.logs={};a.fields=[];for(b=0;b<c;b++)if(!this.item.fields[b].master_field)a.fields.push(this.item.fields[b].field_name);a.expanded=this.item.expanded;}}};k.prototype=new g();function k(b,c,d,e,f,h,i){var k;g.call(this,b,c,d,e,f,h,i);if(this.task&&h!==0&&!(d in this.task))this.task[d]=this;this.field_defs=[];this._fields=[];this.fields=[];this.filter_defs=[];this.filters=[];this.details=[];this.controls=[];this.change_log=new j(this);this.paginate=false;this.disabled=false;this.expanded=true;this._log_changes=true;this._records=null;this._eof=false;this._bof=false;this._cur_row=null;this._old_row=0;this._old_status=null;this._buffer=null;this._modified=null;this._state=0;this._read_only=false;this._parent_read_only=true;this._active=false;this._disabled_count=0;this._open_params={};this._where_list=[];this._order_by_list=[];this._select_field_list=[];this._record_lookup_index=-1;this._record_info_index=-1;this._is_delta=false;this._pg_limit=20;this._pg_offset=0;this.is_loaded=false;this.view_options=a.extend({},this.modal_options);this.view_options.width=960;this.edit_options=a.extend({},this.modal_options);this.filter_options=a.extend({},this.modal_options);Object.defineProperty(this,"rec_no",{get:function(){return this.get_rec_no();},set:function(a){this.set_rec_no(a);}});Object.defineProperty(this,"rec_count",{get:function(){return this.record_count();}});Object.defineProperty(this,"records",{get:function(){return this.get_records();},set:function(a){this.set_records(a);}});Object.defineProperty(this,"active",{get:function(){return this.get_active();}});Object.defineProperty(this,"read_only",{get:function(){return this.get_read_only();},set:function(a){this.set_read_only(a);}});Object.defineProperty(this,"modified",{get:function(){return this.is_modified();}});Object.defineProperty(this,"filtered",{get:function(){return this.get_filtered();},set:function(a){this.set_filtered(a);}});Object.defineProperty(this,"item_state",{get:function(){return this.get_state();},set:function(a){this.set_state(a);}});Object.defineProperty(this,"record_status",{get:function(){return this.get_record_status();},set:function(a){this.set_record_status(a);}});Object.defineProperty(this,"default_field",{get:function(){return this.find_default_field();}});Object.defineProperty(this,"log_changes",{get:function(){return this.get_log_changes();},set:function(a){this.set_log_changes(a);}});}a.extend(k.prototype,{constructor:k,getChildClass:function(){return m;},initAttr:function(a){var b,c=a.fields,d=a.filters,e;if(c){e=c.length;for(b=0;b<e;b++){this.field_defs.push(c[b]);new n(this,c[b]);}}if(d){e=d.length;for(b=0;b<e;b++){this.filter_defs.push(d[b]);new o(this,d[b]);}}this.reports=a.reports;},bind_item:function(){var a=0,b,c;this.prepare_fields();this.init_options();this.prepare_filters();b=this.reports.length;c=this.reports;this.reports=[];for(a=0;a<b;a++)this.reports.push(this.task.item_by_ID(c[a]));},can_create:function(){return this.task.has_privilege(this,'can_create');},can_edit:function(){return this.task.has_privilege(this,'can_edit');},can_delete:function(){return this.task.has_privilege(this,'can_delete');},prepare_fields:function(){var a=0,b=this._fields.length,c;for(;a<b;a++){c=this._fields[a];if(c.lookup_item&&(typeof c.lookup_item==="number")){c.lookup_item=this.task.item_by_ID(c.lookup_item);if(c.lookup_field&&(typeof c.lookup_field==="number"))c.lookup_field=c.lookup_item._field_by_ID(c.lookup_field).field_name;}if(c.master_field&&(typeof c.master_field==="number"))c.master_field=this.get_master_field(this._fields,c.master_field);}this.fields=this._fields.slice(0);for(a=0;a<b;a++){c=this.fields[a];if(this[c.field_name]===undefined)this[c.field_name]=c;}},prepare_filters:function(){var a=0,b,c;b=this.filters.length;for(a=0;a<b;a++){c=this.filters[a].field;if(c.lookup_item&&(typeof c.lookup_item==="number"))c.lookup_item=this.task.item_by_ID(c.lookup_item);if(c.lookup_field&&(typeof c.lookup_field==="number"))c.lookup_field=c.lookup_item._field_by_ID(c.lookup_field).field_name;}},init_options:function(){var b,c=[],d=[],e=this._fields.length;for(b=0;b<e;b++){if(this._fields[b].view_visible&&this._fields[b].view_index!==-1)c.push(this._fields[b]);if(this._fields[b].edit_visible&&this._fields[b].edit_index!==-1)d.push(this._fields[b]);}c.sort(function(a,b){if(a.view_index>b.view_index===0)return 0;if(a.view_index>b.view_index)return 1;else return -1;});d.sort(function(a,b){if(a.edit_index>b.edit_index===0)return 0;if(a.edit_index>b.edit_index)return 1;else return -1;});this.view_options.fields=[];for(b=0;b<c.length;b++)this.view_options.fields.push(c[b].field_name);this.edit_options.fields=[];for(b=0;b<d.length;b++)this.edit_options.fields.push(d[b].field_name);this.edit_options.title=this.item_caption;this.view_options.title=this.item_caption;this._edit_options=a.extend({},this.edit_options);this._view_options=a.extend({},this.view_options);},each:function(a){var b;if(this._active){this.first();while(!this.eof()){b=a.call(this,this);if(b===false)break;else this.next();}}},each_field:function(a){var b=0,c=this.fields.length,d;for(;b<c;b++){d=a.call(this.fields[b],this.fields[b],b);if(d===false)break;}},each_filter:function(a){var b=0,c=this.filters.length,d;for(;b<c;b++){d=a.call(this.filters[b],this.filters[b],b);if(d===false)break;}},each_detail:function(a){var b=0,c=this.details.length,d;for(;b<c;b++){d=a.call(this.details[b],this.details[b],b);if(d===false)break;}},_field_by_name:function(a){return this.field_by_name(a,this._fields);},field_by_name:function(a,b){var c=0,d,e;if(b===undefined)b=this.fields;d=b.length;for(;c<d;c++)if(b[c].field_name===a)return b[c];return e;},_field_by_ID:function(a){return this.field_by_ID(a,this._fields);},field_by_ID:function(a,b){var c=0,d;if(b===undefined)b=this.fields;d=b.length;for(;c<d;c++)if(b[c].ID===a)return b[c];},filter_by_name:function(a){var b=0,c=this.filters.length;try{return this.filters[a];}catch(d){for(;b<c;b++)if(this.filters[b].filter_name===a)return this.filters[b];}},detail_by_name:function(a){var b=0,c=this.details.length;try{return this.details[a];}catch(d){for(;b<c;b++)if(this.details[b].item_name===a)return this.details[b];}},get_records:function(){var a,b,c=[];if(this.active){b=this._records.length;for(a=0;a<b;a++)c.push(this._records[a].slice(0,this._record_info_index));return c;}},set_records:function(a){this._records=a;},copy:function(b){var c,d,e,f,g,h,i={filters:true,details:true,handlers:true};h=new k(this.owner,this.ID,this.item_name,this.item_caption,this.visible,this.item_type_id);h.master=this.master;h.item_type=this.item_type;b=a.extend({},i,b);h.ID=this.ID;h.item_name=this.item_name;h.expanded=this.expanded;h.field_defs=this.field_defs;h.filter_defs=this.filter_defs;h._default_order=this._default_order;h._edit_options=this._edit_options;h._view_options=this._view_options;h.edit_options=a.extend({},this._edit_options);h.view_options=a.extend({},this._view_options);e=h.field_defs.length;for(d=0;d<e;d++)new n(h,h.field_defs[d]);h.prepare_fields();if(b.filters){e=h.filter_defs.length;for(d=0;d<e;d++)new o(h,h.filter_defs[d]);h.prepare_filters();}h._events=this._events;if(b.handlers){e=this._events.length;for(d=0;d<e;d++)h[this._events[d][0]]=this._events[d][1];}if(b.handlers)for(var j in this)if(this.hasOwnProperty(j))if((j.substring(0,3)==="on_")&&(typeof this[j]==="function"))h[j]=this[j];if(b.details)this.each_detail(function(a,d){c=a.copy(b);c.owner=h;c.expanded=a.expanded;c.master=h;c.item_type=a.item_type;h.details.push(c);h.items.push(c);if(!(c.item_name in h))h[c.item_name]=c;if(!(c.item_name in h.details))h.details[c.item_name]=c;});return h;},clone:function(a){var b,c,e,f,g;if(a===undefined)a=true;b=new k(this.owner,this.ID,this.item_name,this.item_caption,this.visible,this.item_type_id);b.master=this.master;b.item_type=this.item_type;b.ID=this.ID;b.item_name=this.item_name;b.field_defs=this.field_defs;b.filter_defs=this.filter_defs;e=b.field_defs.length;for(c=0;c<e;c++)f=new n(b,b.field_defs[c]);b.prepare_fields();e=b.fields.length;for(c=0;c<e;c++){f=b.fields[c];if(b[f.field_name]!==undefined)delete b[f.field_name];}b.fields=[];e=this.fields.length;for(c=0;c<e;c++){f=this.fields[c];g=b._field_by_name(f.field_name);b.fields.push(g);if(b[g.field_name]===undefined)b[g.field_name]=g;}b.bind_fields();b._records=this._records;if(a){b.on_filter_record=this.on_filter_record;b.filtered=this.filtered;}b._active=true;b.set_state(d.STATE_BROWSE);b.first();return b;},store_handlers:function(){var a={};for(var b in this)if(this.hasOwnProperty(b))if((b.substring(0,3)==="on_")&&(typeof this[b]==="function"))a[b]=this[b];return a;},clear_handlers:function(){for(var a in this)if(this.hasOwnProperty(a))if((a.substring(0,3)==="on_")&&(typeof this[a]==="function"))this[a]=undefined;},load_handlers:function(a){for(var b in a)if(a.hasOwnProperty(b))this[b]=a[b];},get_log_changes:function(){return this._log_changes;},set_log_changes:function(a){this._log_changes=a;},is_modified:function(){return this._modified;},set_modified:function(a){this._modified=a;if(this.master&&a)this.master.set_modified(a);}});a.extend(k.prototype,{bind_fields:function(a){var b=0;if(a===undefined)a=true;this.each_field(function(a,b){a.bind_index=null;a.lookup_index=null;});this.each_field(function(a,c){if(!a.master_field){a.bind_index=b;b+=1;}});this.each_field(function(a,b){if(a.master_field)a.bind_index=a.master_field.bind_index;});this._record_lookup_index=b;if(a)this.each_field(function(a,c){if(a.lookup_item){a.lookup_index=b;b+=1;}});this._record_info_index=b;},set_fields:function(a){this._select_field_list=a;},set_order_by:function(a){this._order_by_list=this.get_order_by_list(a);},get_order_by_list:function(a){var b,c,d,e,f,g,h=[];g=a.length;for(f=0;f<g;f++){b=a[f];c=b;d=false;if(b[0]==='-'){d=true;c=b.substring(1);}try{e=this.field_by_name(c);}catch(i){throw this.item_name+': set_order_by method arument error - '+b+' '+i;}h.push([e.ID,d]);}return h;},set_where:function(a){this._where_list=this.get_where_list(a);},get_where_list:function(a){var b,c,e,g,h,i,j,k=[];for(c in a)if(a.hasOwnProperty(c)){e=c;i=a[c];j=c.indexOf('__');if(j>-1){h=c.substring(j+2);c=c.substring(0,j);}else h='eq';g=f.indexOf(h);if(g!==-1)g+=1;else throw this.item_name+': set_where method arument error - '+e;b=this._field_by_name(c);if(!b)throw this.item_name+': set_where method arument error - '+e;if(i!==null){if(b.data_type===d.DATETIME)i=b.format_date_to_string(i,'%Y-%m-%d %H:%M:%S');k.push([c,g,i]);}}return k;},do_before_open:function(a,b,c,e,f,g,h,i,j,k){var l,m,n,o,p,q=[];g.__expanded=a;g.__fields=[];n=this.fields.length;for(m=0;m<n;m++){o=this.fields[m];if(this[o.field_name]!==undefined)delete this[o.field_name];}this.fields=[];if(b===undefined&&this._select_field_list.length)b=this._select_field_list;if(b){n=b.length;for(m=0;m<n;m++)this.fields.push(this._field_by_name(b[m]));g.__fields=b;}else this.fields=this._fields.slice(0);n=this.fields.length;for(m=0;m<n;m++){o=this.fields[m];if(this[o.field_name]===undefined)this[o.field_name]=o;}g.__open_empty=f;g.__order=[];if(!f){g.__limit=0;g.__offset=0;if(i){g.__limit=i;if(h)g.__offset=h;}if(c)q=this.get_where_list(c);else if(this._where_list.length)q=this._where_list.slice(0);else this.each_filter(function(a,b){if(a.get_value()!==null)q.push([a.field.field_name,a.filter_type,a.get_value()]);});if(g.__search!==undefined){var p=g.__search[0],r=g.__search[1];q.push([p,d.FILTER_CONTAINS_ALL,r]);}g.__filters=q;if(e)g.__order=this.get_order_by_list(e);else if(this._order_by_list.length)g.__order=this._order_by_list.slice(0);else if(this._default_order)g.__order=this._default_order.slice();this._where_list=[];this._order_by_list=[];if(j)g.__funcs=j;if(k)g.__group_by=k;}this._open_params=g;if(this.on_before_open)this.on_before_open.call(this,this,g);},do_after_open:function(){if(this.on_after_open)this.on_after_open.call(this,this);},open_details:function(a){var b=this,c=0;function d(){c-=1;if(c===0)a.call(b);}if(a){this.each_detail(function(a,b){if(!a.disabled)c+=1;});this.each_detail(function(a,b){if(!a.disabled)a.open(d);});}else this.each_detail(function(a,b){if(!a.disabled)a.open();});},find_change_log:function(){if(this.master)if(this.master.get_record_status()!==d.RECORD_UNCHANGED)return this.master.change_log.get_detail_log(this.ID);},open:function(a,b){var c=0,e=arguments.length,a,f,g,h,i,j,k,l,m,b,n,o,p,q,r,s,t,u=this;if(e>2)throw item.item_name+' open method error: invalid number of arguments';for(;c<e;c++)switch(typeof arguments[c]){case "function":b=arguments[c];break;case "object":a=arguments[c];break;}if(a){f=a.expanded;g=a.fields;h=a.where;i=a.order_by;j=a.open_empty;m=a.params;q=a.offset;p=a.limit;k=a.funcs;l=a.group_by;}if(!m)m={};if(f===undefined)f=this.expanded;else this.expanded=f;n=b?true:false;if(this.master)if(!this.disabled&&this.master.record_count()>0){m.__owner_id=this.master.ID;if(this.master.id)m.__owner_rec_id=this.master.id.get_value();if(this.master.is_new())t=[];else{o=this.find_change_log();if(o){t=o.records;g=o.fields;f=o.expanded;}}if(t!==undefined){this.do_before_open(f,g,h,i,j,m,q,p,k,l);this.bind_fields(f);if(this.master.is_new())this.change_log.prepare();this._records=t;this._active=true;this.set_state(d.STATE_BROWSE);this.first();this.do_after_open();this.update_controls(d.UPDATE_OPEN);if(b)b.call(this,this);return;}}else{this.close();return;}if(this.paginate&&q!==undefined){m=this._open_params;m.__offset=q;if(this.on_before_open)this.on_before_open.call(this,this,m);}else{q=0;this.do_before_open(f,g,h,i,j,m,q,p,k,l);this.bind_fields(f);}if(this.paginate)m.__limit=this._pg_limit;this.change_log.prepare();this._records=[];this.do_open(q,n,m,j,function(){u._active=true;u.set_state(d.STATE_BROWSE);u._cur_row=null;u.first();u.do_after_open();if((!u.paginate||u.paginate&&q===0)&&u.on_filters_applied)u.on_filters_applied.call(u,u);u.update_controls(d.UPDATE_OPEN);if(b)b.call(u,u);});},do_open:function(a,b,c,d,e){var f=this,g;if(b&&!d)this.send_request('open',c,function(b){f.do_after_upload(b,a,e);});else{if(d)g=[[],''];else g=this.send_request('open',c);this.do_after_upload(g,a,e);}},do_after_upload:function(a,b,c){var d,e,f,g;if(a){e=a[1];if(e)this.warning(e);else if(a[0]){d=a[0];g=d.length;this._records=[];for(f=0;f<g;f++)this._records.push(d[f]);if(this._pg_limit&&this.paginate&&d){this._pg_offset=b;this.is_loaded=false;}if(g<this._pg_limit)this.is_loaded=true;c.call(this,this);}}else{this._records=[];console.log(this.item_name+" error while opening table");}},do_close:function(){this._active=false;this._records=null;this._cur_row=null;},close:function(){var a=this.details.length;this.do_close();for(var b=0;b<a;b++)this.details[b].close();this.update_controls(d.UPDATE_CLOSE);},sort:function(a){var b=this,c,e,f=[],g=[],h;function i(a,b){if(a===null)if(b===d.TEXT)a='';else if(b===d.INTEGER||b===d.FLOAT||b===d.CURRENCY)a=0;else if(b===d.DATE||b===d.DATETIME)a=new Date(0);else if(b===d.BOOLEAN)a=false;if(b===d.FLOAT)a=Number(a.toFixed(10));if(b===d.CURRENCY)a=Number(a.toFixed(2));return a;}function j(a,c){var d,e,h,j,k,l,m;for(var d=0;d<f.length;d++){e=b.field_by_name(f[d]);j=e.bind_index;if(e.lookup_item)j=e.lookup_index;h=e.get_lookup_data_type();l=i(a[j],h);m=i(c[j],h);if(l<m)k=-1;if(l>m)k=1;if(k){if(g[d])k=-k;return k;}}return 0;}for(c=0;c<a.length;c++){f.push(this.field_by_ID(a[c][0]).field_name);g.push(a[c][1]);}this._records.sort(j);this.update_controls();},search:function(a,b){var c=b.trim(),d={};if(c.length){d.__search=[a,c];this.open({params:d});}else this.open();},total_records:function(a){var b=this;if(this._open_params.__open_empty&&a)return 0;else this.send_request('get_record_count',this._open_params,function(c){if(c&&a)a.call(b,c[0]);});},new_record:function(){var a=[];this.each_field(function(b,c){if(!b.master_field)a.push(null);});if(this.expanded)this.each_field(function(b,c){if(b.lookup_item)a.push(null);});return a;},do_before_append:function(){if(this.on_before_append)this.on_before_append.call(this,this);},do_after_append:function(){if(this.on_after_append)this.on_after_append.call(this,this);},append:function(){if(!this._active)throw this.item_name+": can't append record - item is not active";if(this.master&&!this.master.is_changing())throw this.item_name+": can't append record - master item is not in edit or insert mode";if(this.get_state()!==d.STATE_BROWSE)throw this.item_name+": can't append record - item is not in browse mode";this.do_before_append();this.do_before_scroll();this._old_row=this.get_rec_no();this.set_state(d.STATE_INSERT);this._records.push(this.new_record());this._cur_row=this._records.length-1;this._modified=false;this.set_record_status(d.RECORD_INSERTED);this.update_controls(d.UPDATE_APPEND);this.do_after_scroll();this.do_after_append();},insert:function(){if(!this._active)throw this.item_name+": can't insert record - item is not active";if(this.master&&!this.master.is_changing())throw this.item_name+": can't insert record - master item is not in edit or insert mode";if(this.get_state()!==d.STATE_BROWSE)throw this.item_name+": can't insert record - item is not in browse mode";this.do_before_append();this.do_before_scroll();this._old_row=this.get_rec_no();this.set_state(d.STATE_INSERT);this._records.splice(0,0,this.new_record());this._cur_row=0;this._modified=false;this.set_record_status(d.RECORD_INSERTED);this.update_controls(d.UPDATE_INSERT);this.do_after_scroll();this.do_after_append();},do_before_edit:function(){if(this.on_before_edit)this.on_before_edit.call(this,this);},do_after_edit:function(){if(this.on_after_edit)this.on_after_edit.call(this,this);},edit:function(){if(!this._active)throw this.item_name+": can't edit record - item is not active";if(this.record_count()===0)throw this.item_name+": can't edit record - item record list is empty";if(this.master&&!this.master.is_changing())throw this.item_name+": can't edit record - master item is not in edit or insert mode";if(this.get_state()!==d.STATE_BROWSE)throw this.item_name+": can't edit record - item is not in browse mode";this.do_before_edit();this.change_log.log_change();this._buffer=this.change_log.store_record_log();this.set_state(d.STATE_EDIT);this._old_row=this.get_rec_no();this._old_status=this.get_record_status();this._modified=false;this.do_after_edit();},do_before_cancel:function(){if(this.on_before_cancel)this.on_before_cancel.call(this,this);},do_after_cancel:function(){if(this.on_after_cancel)this.on_after_cancel.call(this,this);},cancel:function(){var a,b,c,e;c=this.get_rec_no();this.do_before_cancel();if(this.get_state()===d.STATE_EDIT){this.change_log.restore_record_log(this._buffer);this.update_controls(d.UPDATE_CANCEL);for(var a=0;a<this.details.length;a++)this.details[a].update_controls(d.UPDATE_OPEN);}else if(this.get_state()===d.STATE_INSERT){this.change_log.remove_record_log();this.update_controls(d.UPDATE_DELETE);this._records.splice(c,1);}else throw this.item_name+' cancel error: invalid item state';e=this.get_state();this.set_state(d.STATE_BROWSE);if(e===d.STATE_INSERT)this.do_before_scroll();this._cur_row=this._old_row;if(e===d.STATE_EDIT)this.set_record_status(this._old_status);this._modified=false;if(e===d.STATE_INSERT)this.do_after_scroll();this.do_after_cancel();},is_browsing:function(){return this.get_state()===d.STATE_BROWSE;},is_changing:function(){return(this.get_state()===d.STATE_INSERT)||(this.get_state()===d.STATE_EDIT);},is_new:function(){return this.get_state()===d.STATE_INSERT;},is_edited:function(){return this.get_state()===d.STATE_EDIT;},is_deleting:function(){return this.get_state()===d.STATE_DELETE;},do_before_delete:function(a){if(this.on_before_delete)this.on_before_delete.call(this,this);},do_after_delete:function(){if(this.on_after_delete)this.on_after_delete.call(this,this);},"delete":function(){var a=this.get_rec_no();if(!this._active)throw this.item_name+": can't delete record - item is not active";if(this.record_count()===0)throw this.item_name+": can't delete record - item record list is empty";if(this.master&&!this.master.is_changing())throw this.item_name+": can't delete record - master item is not in edit or insert mode";this.set_state(d.STATE_DELETE);try{this.do_before_delete();this.do_before_scroll();this.update_controls(d.UPDATE_DELETE);this.change_log.log_change();if(this.master)this.master.set_modified(true);this._records.splice(a,1);this.set_rec_no(a);this.do_after_scroll();this.set_state(d.STATE_BROWSE);this.do_after_delete();}finally{this.set_state(d.STATE_BROWSE);}},detail_by_ID:function(a){var b;if(typeof a==="string")a=parseInt(a,10);this.each_detail(function(c,d){if(c.ID===a){b=c;return false;}});return b;},post:function(a){var b,c,e,f=this.get_state();if(!this.is_changing())throw this.item_name+' post method: dataset is not in edit or insert mode';if(this.on_before_post)this.on_before_post.call(this,this);this.check_record_valid();e=this.details.length;for(c=0;c<e;c++)if(this.details[c].is_changing())this.details[c].post();if(this.is_modified()||this.is_new())this.change_log.log_change();else if(this.get_record_status()===d.RECORD_UNCHANGED)this.change_log.remove_record_log();this._modified=false;this.set_state(d.STATE_BROWSE);if(this.on_after_post)this.on_after_post.call(this,this);if(!this._valid_record()){this.update_controls(d.UPDATE_DELETE);this._search_record(this.get_rec_no(),0);}},get_change_id:function(){this._change_id=this._change_id+1;return this._change_id;},apply:function(){var a=0,b=arguments.length,c=this,d={},e,f,g,h=true;for(;a<b;a++)switch(typeof arguments[a]){case "function":e=arguments[a];break;case "object":f=arguments[a];break;}if(this.master)return;if(this.is_changing())this.post();this.change_log.get_changes(d);if(!this.change_log.is_empty_obj(d.data)){if(this.on_before_apply)this.on_before_apply.call(this,this);if(e)this.send_request('apply_changes',[d,f],function(a){c.process_apply(a);});else{g=this.send_request('apply_changes',[d,f]);h=this.process_apply(g);}}},process_apply:function(a){var b,c;if(a){b=a[0];c=a[1];if(c)throw c;else{this.change_log.update(b);if(this.on_after_apply)this.on_after_apply.call(this,this);}}},delta:function(a){var b,c,e,f;if(a===undefined){a={};this.change_log.get_changes(a);}f=this.copy({filters:false,details:true,handlers:false});f.on_after_scroll=function(a){a.open_details();};f.expanded=false;f._is_delta=true;c=f.details.length;for(b=0;b<c;b++){f.details[b].expanded=false;f.details[b]._is_delta=true;}f.change_log.set_changes(a);f._records=f.change_log.records;f.bind_fields(f.change_log.expanded);f.set_state(d.STATE_BROWSE);f._cur_row=null;f._active=true;f.first();return f;},field_by_id:function(a,b,c){var d,e,f;if(typeof b==='string')b=[b];d=this.copy();d.set_where({id:a});if(c){d.open({expanded:false,fields:b},function(){e=d._records[0];if(b.length===1)e=e[0];return e;});}else{d.open({expanded:false,fields:b});if(d.record_count()===1){e=d._records[0];if(b.length===1)e=e[0];return e;}}},locate:function(a,b){var c=this.clone();function d(){var d,e;if(a instanceof Array){e=a.length;for(d=0;d<e;d++)if(c.field_by_name(a[d]).value!==b[d])return false;return true;}else if(c.field_by_name(a).value===b)return true;}c.first();while(!c.eof()){if(d()){this.rec_no=c.rec_no;return true;}c.next();}}});a.extend(k.prototype,{get_active:function(){return this._active;},set_read_only:function(a){var b,c;this._read_only=a;c=this.fields.length;for(b=0;b<c;b++)this.fields[b].update_controls();this.each_detail(function(b,c){b.set_read_only(a);});},get_read_only:function(){if(this.master&&this._parent_read_only)return this.master.get_read_only();else return this._read_only;},get_filtered:function(){return this._filtered;},set_filtered:function(a){if(a)if(!this.on_filter_record)a=false;if(this._filtered!==a){this._filtered=a;this.first();this.update_controls(d.UPDATE_OPEN);}},clear_filters:function(){this.each_filter(function(a){a.value=null;});},assign_filters:function(a){var b=this;a.each_filter(function(a){if(a.value===null)b.filter_by_name(a.filter_name).field.value=null;else b.filter_by_name(a.filter_name).field.value=a.field.value;});},set_state:function(a){if(this._state!==a){this._state=a;if(this.on_state_changed)this.on_state_changed.call(this,this);}},get_state:function(){return this._state;},do_after_scroll:function(){var a=this.details.length;for(var b=0;b<a;b++)this.details[b].do_close();this.update_controls(d.UPDATE_SCROLLED);if(this.on_after_scroll)this.on_after_scroll.call(this,this);},do_before_scroll:function(){if(this._cur_row!==null){if(this.is_changing())this.post();if(this.on_before_scroll)this.on_before_scroll.call(this,this);}},skip:function(a){var b,c,d,e;if(this.record_count()===0){this.do_before_scroll();this._eof=true;this._bof=true;this.do_after_scroll();}else{d=this._cur_row;b=false;c=false;e=a;if(e<0){e=0;c=true;}if(e>=this._records.length){e=this._records.length-1;b=true;}this._eof=b;this._bof=c;if(d!==e){this.do_before_scroll();this._cur_row=e;this.do_after_scroll();}else if(b||c&&this.is_new()&&this.record_count()===1){this.do_before_scroll();this.do_after_scroll();}}},set_rec_no:function(a){if(this._active)if(this.filter_active())this._search_record(a,0);else this.skip(a);},get_rec_no:function(){if(this._active)return this._cur_row;},filter_active:function(){if(this.on_filter_record&&this.filtered)return true;},first:function(){if(this.filter_active())this.find_first();else this.set_rec_no(0);},last:function(){if(this.filter_active())this.find_last();else this.set_rec_no(this._records.length);},next:function(){if(this.filter_active())this.find_next();else this.set_rec_no(this.get_rec_no()+1);},prior:function(){if(this.filter_active())this.find_prior();else this.set_rec_no(this.get_rec_no()-1);},eof:function(){return this._eof;},bof:function(){return this._bof;},_valid_record:function(){if(this.on_filter_record&&this.filtered)return this.on_filter_record.call(this,this);else return true;},_search_record:function(a,b){var c,d,e=this;if(b===undefined)b=1;function f(){if(e.record_count()===0){e._eof=true;e._bof=true;}else{e._eof=false;e._bof=false;if(e._cur_row<0){e._cur_row=0;e._bof=true;}if(e._cur_row>=e._records.length){e._cur_row=e._records.length-1;e._eof=true;}}}function g(){if(b===1)return e.eof();else return e.bof();}if(this.active){if(this.record_count()===0){this.skip(a);return;}d=this._cur_row;this._cur_row=a+b;f();if(b===0){if(this._valid_record()){this._cur_row=d;this.skip(a);return;}b=1;}while(!g())if(this._valid_record()){if(a!==this._cur_row){c=this._cur_row;this._cur_row=a;this.skip(c);return;}}else{this._cur_row=this._cur_row+b;f();}}},find_first:function(){this._search_record(-1,1);},find_last:function(){this._search_record(this._records.length,-1);},find_next:function(){this._search_record(this.get_rec_no(),1);},find_prior:function(){this._search_record(this.get_rec_no(),-1);},record_count:function(){if(this._records)return this._records.length;else return 0;},find_rec_info:function(a,b){if(b===undefined)if(a===undefined){a=this.get_rec_no();if(this.record_count()>0)b=this._records[a];}if(b&&(this._record_info_index>0)){if(b.length<this._record_info_index+1)b.push([null,{},null]);return b[this._record_info_index];}},get_rec_info:function(a,b){return this.find_rec_info(a,b);},get_record_status:function(){var a=this.get_rec_info();if(a)return a[d.REC_STATUS];},set_record_status:function(a){var b=this.get_rec_info();if(b&&this.log_changes)b[d.REC_STATUS]=a;},rec_controls_info:function(){var a=this.get_rec_info();if(a)return a[d.REC_CONTROLS_INFO];},get_rec_change_id:function(){var a=this.get_rec_info();if(a)return a[d.REC_CHANGE_ID];},set_rec_change_id:function(a){var b=this.get_rec_info();if(b)b[d.REC_CHANGE_ID]=a;},rec_unchanged:function(){return this.get_record_status()===d.RECORD_UNCHANGED;},rec_inserted:function(){return this.get_record_status()===d.RECORD_INSERTED;},rec_deleted:function(){return this.get_record_status()===d.RECORD_DELETED;},rec_modified:function(){return this.get_record_status()===d.RECORD_MODIFIED||this.get_record_status()===d.RECORD_DETAILS_MODIFIED;}});a.extend(k.prototype,{insert_record:function(a){if(this.can_create()){if(!this.is_changing())this.insert();this.create_edit_form(a);}},append_record:function(a){if(this.can_create()){if(!this.is_changing())this.append();this.create_edit_form(a);}},edit_record:function(a){if(this.can_edit()){if(!this.is_changing())this.edit();this.create_edit_form(a);}},copy_record:function(a){function b(a){var b={};a.each_field(function(a){if(!a.system_field())b[a.field_name]=[a.value,a.lookup_value];});return b;}function c(a,b){for(var c in b)if(b.hasOwnProperty(c)){a.field_by_name(c).value=b[c][0];a.field_by_name(c).lookup_value=b[c][1];}}var d={},e=[],f,g,h;if(this.can_create()){d=b(this);this.each_detail(function(a){var c=[];if(a.record_count()){a.each(function(a){c.push(b(a));});e[a.ID]=c;}});this.append();c(this,d);for(var i in e)if(e.hasOwnProperty(i)){g=this.item_by_ID(parseInt(i,10));h=e[i];g.open();for(f=0;f<h.length;f++){g.append();c(g,h[f]);g.post();}}if(a)a.call(this,this);this.create_edit_form();}},cancel_edit:function(){this.close_edit_form();this.cancel();},delete_record:function(a){var b=this,d=b.get_rec_no(),e=b._records[d],f;if(this.can_delete())if(this.record_count()>0){this.question(c.delete_record,function(){b["delete"]();try{b.apply();}catch(g){f=(g+'').toUpperCase();if(f&&f.indexOf('FOREIGN KEY')!==-1&&(f.indexOf('VIOLATION')!==-1||f.indexOf('FAILED')!==-1))b.warning(c.cant_delete_used_record);else b.warning(g);b._records.splice(d,0,e);b._cur_row=d;b.change_log.remove_record_log();b.update_controls();b.do_after_scroll();if(a)a.call(this);}});}else this.warning('Record is not selected.');},check_record_valid:function(){var a;this.each_field(function(b,c){try{b.check_valid();}catch(d){b.update_control_state(d);if(!a)a=d;}});if(a)throw a;},check_filters_valid:function(){var a;this.each_filter(function(b,c){try{b.check_valid();}catch(d){b.field.update_control_state(d);if(b.field1)b.field1.update_control_state(d);if(!a)a=d;}});if(a)throw a;},post_record:function(){this.post();this.close_edit_form();},apply_record:function(a){this.post();this.apply(a);this.close_edit_form();},do_on_view_keyup:function(a){if(this.task.on_view_form_keyup)this.task.on_view_form_keyup.call(this,this,a);if(this.owner.on_view_form_keyup)this.owner.on_view_form_keyup.call(this,this,a);if(this.on_view_form_keyup)this.on_view_form_keyup.call(this,this,a);},do_on_view_keydown:function(a){if(this.task.on_view_form_keydown)this.task.on_view_form_keydown.call(this,this,a);if(this.owner.on_view_form_keydown)this.owner.on_view_form_keydown.call(this,this,a);if(this.on_view_form_keydown)this.on_view_form_keydown.call(this,this,a);},view_modal:function(a){this.is_lookup_item=true;this.view(a);},view:function(a){var b=this;this.load_modules([this,this.owner],function(){b._view(a);});},_view:function(a){var b=this;this.create_form('view',{container:a,beforeShow:function(){if(this.task.on_view_form_created)this.task.on_view_form_created.call(this,this);if(this.owner.on_view_form_created)this.owner.on_view_form_created.call(this,this);if(this.on_view_form_created)this.on_view_form_created.call(this,this);},onShown:function(){if(b.task.on_view_form_shown)b.task.on_view_form_shown.call(b,b);if(b.owner.on_view_form_shown)b.owner.on_view_form_shown.call(b,b);if(b.on_view_form_shown)b.on_view_form_shown.call(b,b);},onHide:function(a){var c,d;if(b.on_view_form_close_query)d=b.on_view_form_close_query.call(b,b);if(d===undefined&&b.owner.on_view_form_close_query&&!b.master)d=b.owner.on_view_form_close_query.call(b,b);if(d===undefined&&b.task.on_view_form_close_query)d=b.task.on_view_form_close_query.call(b,b);return d;},onHidden:function(){},onKeyUp:this.do_on_view_keyup,onKeyDown:this.do_on_view_keydown});},close_view_form:function(){this.close_form('view_form');},do_on_edit_keyup:function(a){if(this.task.on_edit_form_keyup)this.task.on_edit_form_keyup.call(this,this,a);if(this.owner.on_edit_form_keyup)this.owner.on_edit_form_keyup.call(this,this,a);if(this.on_edit_form_keyup)this.on_edit_form_keyup.call(this,this,a);},do_on_edit_keydown:function(a){if(this.task.on_edit_form_keydown)this.task.on_edit_form_keydown.call(this,this,a);if(this.owner.on_edit_form_keydown)this.owner.on_edit_form_keydown.call(this,this,a);if(this.on_edit_form_keydown)this.on_edit_form_keydown.call(this,this,a);},create_edit_form:function(){var a=this,b,c,d=arguments.length;if(d)for(var e=0;e<d;e++)if(!b&&arguments[e] instanceof jQuery)b=arguments[e];else if(!c&&typeof arguments[e]==="function")c=arguments[e];this.create_form('edit',{container:b,beforeShow:function(){if(a.task.on_edit_form_created)a.task.on_edit_form_created.call(a,a);if(a.owner.on_edit_form_created&&!a.master)a.owner.on_edit_form_created.call(a,a);if(a.on_edit_form_created)a.on_edit_form_created.call(a,a);},onShown:function(){if(a.task.on_edit_form_shown)a.task.on_edit_form_shown.call(a,a);if(a.owner.on_edit_form_shown&&!a.master)a.owner.on_edit_form_shown.call(a,a);if(a.on_edit_form_shown)a.on_edit_form_shown.call(a,a);if(c)c.call(a);},onHide:function(b){var c,d;if(a.on_edit_form_close_query)d=a.on_edit_form_close_query.call(a,a);if(d===undefined&&a.owner.on_edit_form_close_query&&!a.master)d=a.owner.on_edit_form_close_query.call(a,a);if(d===undefined&&a.task.on_edit_form_close_query)d=a.task.on_edit_form_close_query.call(a,a);return d;},onKeyUp:this.do_on_edit_keyup,onKeyDown:this.do_on_edit_keydown});},close_edit_form:function(){this.close_form('edit_form');},create_filter_form:function(){var a=this,b,c,d=arguments.length;if(d)for(var e=0;e<d;e++)if(!b&&arguments[e] instanceof jQuery)b=arguments[e];else if(!c&&typeof arguments[e]==="function")c=arguments[e];this.create_form('filter',{container:b,beforeShow:function(){if(a.task.on_filter_form_created)a.task.on_filter_form_created.call(a,a);if(a.owner.on_filter_form_created)a.owner.on_filter_form_created.call(a,a);if(a.on_filter_form_created)a.on_filter_form_created.call(a,a);},onShown:function(){if(a.task.on_filter_form_shown)a.task.on_filter_form_shown.call(a,a);if(a.owner.on_filter_form_shown&&!a.master)a.owner.on_filter_form_shown.call(a,a);if(a.on_filter_form_shown)a.on_filter_form_shown.call(a,a);},onHide:function(b){var c,d;if(a.on_filter_form_close_query)d=a.on_filter_form_close_query.call(a,a);if(d===undefined&&a.owner.on_filter_form_close_query)d=a.owner.on_filter_form_close_query.call(a,a);if(d===undefined&&a.task.on_filter_form_close_query)d=a.task.on_filter_form_close_query.call(a,a);return d;}});},close_filter_form:function(){this.close_form('filter_form');},apply_filters:function(){try{this.check_filters_valid();this.open();this.close_filter_form();}catch(a){}},get_filter_text:function(){var a='';this.each_filter(function(b){if(b.text)a+=' '+b.text;});if(a)a=c.filter+' -'+a;return a;},close_filter:function(){this.close_filter_form();},disable_controls:function(){this._disabled_count-=1;},enable_controls:function(){this._disabled_count+=1;if(this.controls_enabled())this.update_controls(d.UPDATE_CONTROLS);},controls_enabled:function(){return this._disabled_count===0;},controls_disabled:function(){return !this.controls_enabled();},update_controls:function(a){var b=0,c=this.fields.length;if(a===undefined)a=d.UPDATE_REFRESH;if(this.controls_enabled()){for(b=0;b<c;b++)this.fields[b].update_controls(true);c=this.controls.length;if(this.on_update_controls)this.on_update_controls.call(this,this);for(b=0;b<c;b++)this.controls[b].update(a);}},create_table:function(a,b){return new r(this,a,b);},create_tree:function(a,b,c,d,e){return new q(this,a,b,c,d,e);},create_inputs:function(b,c){var d,e,f,g,h,i=[],j=[],k=[],l,m;d={fields:[],col_count:1,label_on_top:false,row_count:undefined,autocomplete:false,tabindex:undefined};if(!b)return;c=a.extend({},d,c);if(c.fields.length)j=c.fields;else j=this.edit_options.fields;f=j.length;for(e=0;e<f;e++){h=this.field_by_name(j[e]);if(h)i.push(h);else throw this.item_name+' create_entries: there is not a field with field_name - "'+j.fields[e]+'"';}b.empty();m=a('<form autocomplete="off"></form>').appendTo(a("<div></div>").addClass("row-fluid").appendTo(b));if(c.autocomplete)m.attr("autocomplete","on");if(!c.label_on_top)m.addClass("form-horizontal");f=i.length;for(g=0;g<c.col_count;g++)k.push(a("<div></div>").addClass("span"+12/c.col_count).appendTo(m));l=c.tabindex;if(!l&&this.edit_form){l=this.edit_form.tabindex;this.edit_form.tabindex+=f;}if(!c.row_count)c.row_count=Math.ceil(f/c.col_count);for(e=0;e<f;e++)new u(i[e],e+l,k[Math.floor(e/c.row_count)],c.label_on_top);},create_filter_inputs:function(b,e){var f,g,h,i,j,k=[],l=[],m,n;f={filters:[],col_count:1,label_on_top:false,autocomplete:false,tabindex:undefined},e=a.extend({},f,e);if(e.filters.length){h=e.filters.length;for(g=0;g<h;g++)k.push(this.filter_by_name(e.filters[g]));}else this.each_filter(function(a,b){if(a.visible)k.push(a);});b.empty();n=a('<form autocomplete="off"></form>').appendTo(a("<div></div>").addClass("row-fluid").appendTo(b));if(e.autocomplete)n.attr("autocomplete","on");if(!e.label_on_top)n.addClass("form-horizontal");h=k.length;for(i=0;i<e.col_count;i++)l.push(a("<div></div>").addClass("span"+12/e.col_count).appendTo(n));m=e.tabindex;if(!m&&this.filter_form){m=this.filter_form.tabindex;this.filter_form.tabindex+=h;}for(g=0;g<h;g++){j=k[g];if(j.filter_type===d.FILTER_RANGE){new u(j.field,g+1,l[Math.floor(g%e.col_count)],e.label_on_top,j.filter_caption+' '+c.range_from);new u(j.field1,g+1,l[Math.floor(g%e.col_count)],e.label_on_top,j.filter_caption+' '+c.range_to);}else new u(j.field,g+1,l[Math.floor(g%e.col_count)],e.label_on_top,j.filter_caption);}},set_lookup_field_value:function(){if(this.record_count()){var a=this.lookup_field,b=this.field_by_name(a.lookup_field),c=null,e=this.lookup_field.owner,f={},g=[],h=this;if(b)c=b.get_value();if(a.owner&&a.owner.is_changing&&!a.owner.is_changing())a.owner.edit();if(a.filter&&a.filter.filter_type===d.FILTER_IN)a.set_value([this.id.value],c);else{if(e)e.each_field(function(c){if(c.master_field===a){b=h.field_by_name(c.lookup_field);if(b)f[c.field_name]=b.get_value();}});a.set_value(this.id.get_value(),c,f,this);}}if(this.lookup_field)this.close_view_form();},find_default_field:function(){var a=0,b=this.fields.length;for(;a<b;a++)if(this.fields[a].is_default)return this.fields[a];},set_edit_fields:function(a){this.edit_options.fields=a;},set_view_fields:function(a){this.view_options.fields=a;},round:function(a,b){return Number(a.toFixed(b));},refresh_record:function(a){var b=this,c,e,f=[],g=this.copy({filters:false,details:false,handlers:false});if(this.id.value!==null){b.each_field(function(a){f.push(a.field_name);});g.open({expanded:this.expanded,fields:f,where:{id:this.id.value}});if(g.record_count()===1){e=g._records[0].length;for(c=0;c<e;c++)b._records[b.rec_no][c]=g._records[0][c];b.update_controls(d.UPDATE_CANCEL);if(a)a.call(this);}}}});l.prototype=new g();function l(b,c,e,f,h,i,j){g.call(this,b,c,e,f,h,i,j);if(this.task&&!(e in this.task))this.task[e]=this;this._fields=[];this.params=this._fields;this._state=d.STATE_EDIT;this.param_options=a.extend({},this.modal_options);}a.extend(l.prototype,{constructor:l,set_state:function(a){if(this._state!==a)this._state=a;},get_state:function(){return this._state;},initAttr:function(a){var b,c=a.fields,d;if(c){d=c.length;for(b=0;b<d;b++)new p(this,c[b]);}},bind_item:function(){var a=0,b,c=this.params.length;for(a=0;a<c;a++){b=this.params[a];if(b.lookup_item&&(typeof b.lookup_item==="number"))b.lookup_item=this.task.item_by_ID(b.lookup_item);if(b.lookup_field&&(typeof b.lookup_field==="number"))b.lookup_field=b.lookup_item._field_by_ID(b.lookup_field).field_name;}this.param_options.title=this.item_caption;},eachParam:function(a){var b=0,c=this.params.length,d;for(;b<c;b++){d=a.call(this.params[b],this.params[b],b);if(d===false)break;}},each_field:function(a){this.eachParam(a);},param_by_name:function(a){var b=0,c=this.params.length;for(;b<c;b++)if(this.params[b].param_name===a)return this.params[b];},create_param_form:function(){var a=this,b,c,d=arguments.length;if(d)for(var e=0;e<d;e++)if(!b&&arguments[e] instanceof jQuery)b=arguments[e];else if(!c&&typeof arguments[e]==="function")c=arguments[e];this.create_form('param',{container:b,beforeShow:function(){if(a.task.on_param_form_created)a.task.on_param_form_created.call(a,a);if(a.owner.on_param_form_created)a.owner.on_param_form_created.call(a,a);if(a.on_param_form_created)a.on_param_form_created.call(a,a);},onShown:function(){if(a.task.on_param_form_shown)a.task.on_param_form_shown.call(a,a);if(a.owner.on_param_form_shown)a.owner.on_param_form_shown.call(a,a);if(a.on_param_form_shown)a.on_param_form_shown.call(a,a);},onHide:function(b){var c,d;if(a.on_param_form_close_query)d=a.on_param_form_close_query.call(a,a);if(d===undefined&&a.owner.on_param_form_close_query)d=a.owner.on_param_form_close_query.call(a,a);if(d===undefined&&a.task.on_param_form_close_query)d=a.task.on_param_form_close_query.call(a,a);return d;}});},close_param_form:function(){this.close_form('param_form');},print:function(a,b){var c=this;this.load_modules([this,this.owner],function(){c._print(a,b);});},_print:function(){var a=0,b=arguments.length,c=true,d;for(;a<b;a++)switch(typeof arguments[a]){case "function":d=arguments[a];break;case "boolean":c=arguments[a];break;}if(!c)this.eachParam(function(a){if(a.edit_visible){c=true;return false;}});if(c)this.create_param_form();else this.process_report(d);},checkParams:function(){var a,b=this.params.length;for(a=0;a<b;a++)try{this.params[a].check_valid();}catch(c){this.warning(c);return false;}return true;},process_report:function(a){var b=this,c=location.protocol+'//'+location.hostname+(location.port?':'+location.port:''),d,e,f=[];if(this.checkParams()){if(this.owner.on_before_print_report)this.owner.on_before_print_report.call(this,this);if(this.on_before_print_report)this.on_before_print_report.call(this,this);e=this.params.length;for(d=0;d<e;d++)f.push(this.params[d].get_raw_value());this.send_request('print_report',[f,c,this.extension],function(c){var d,e,f,g,h;if(c)d=c[0],e=c[1];if(e)b.warning(e);if(d)if(b.on_open_report)b.on_open_report.call(b,b,d);else if(b.owner.on_open_report)b.owner.on_open_report.call(b.owner,b,d);else{f=d.split('.').pop();if(f==='ods')window.open(d,"_self");else{h=window.open(d,"_blank");if(b.send_to_printer)h.onload=function(){h.print();g=setTimeout(function(){h.onfocus=function(){h.close();};},1000);};}}if(a)a.call(b,b,d);});return true;}},create_param_inputs:function(b,c){var d,e,f,g,h=[],i=[],j,k;d={params:[],col_count:1,label_on_top:false,autocomplete:false,tabindex:undefined},c=a.extend({},d,c);if(c.params.length){f=c.params.length;for(e=0;e<f;e++)h.push(this.param_by_name(c.params[e]));}else{this.eachParam(function(a){if(a.edit_visible&&a.edit_index!==-1)h.push(a);});h.sort(function(a,b){if(a.edit_index>b.edit_index===0)return 0;if(a.edit_index>b.edit_index)return 1;else return -1;});}b.empty();j=a('<form autocomplete="off"></form>').appendTo(a("<div></div>").addClass("row-fluid").appendTo(b));if(c.autocomplete)j.attr("autocomplete","on");if(!c.label_on_top)j.addClass("form-horizontal");f=h.length;for(g=0;g<c.col_count;g++)i.push(a("<div></div>").addClass("span"+12/c.col_count).appendTo(j));k=c.tabindex;if(!k&&this.param_form){k=this.param_form.tabindex;this.param_form.tabindex+=f;}for(e=0;e<f;e++)new u(h[e],e+k,i[Math.floor(e%c.col_count)],c.label_on_top);}});m.prototype=new k();m.prototype.constructor=m;function m(a,b,c,d,e,f,g){k.call(this,a,b,c,d,e,f,g);this.master=a;a.details.push(this);a.details[c]=this;this.item_type="detail";}m.prototype.getChildClass=function(){return undefined;};function n(a,b){this.owner=a;this.set_info(b);this.controls=[];this.bind_index=null;this.lookup_index=null;this.field_type=this.type_names[this.data_type];this.field_kind=d.ITEM_FIELD;if(a)a._fields.push(this);Object.defineProperty(this,"value",{get:function(){return this.get_value();},set:function(a){this.set_value(a);}});Object.defineProperty(this,"raw_value",{get:function(){return this.get_raw_value();}});Object.defineProperty(this,"text",{get:function(){return this.get_text();},set:function(a){this.set_text(a);}});Object.defineProperty(this,"display_text",{get:function(){return this.get_display_text();}});Object.defineProperty(this,"lookup_text",{get:function(){return this.get_lookup_text();}});Object.defineProperty(this,"lookup_value",{get:function(){return this.get_lookup_value();}});Object.defineProperty(this,"alignment",{get:function(){return this.get_alignment();},set:function(a){this.set_alignment(a);}});Object.defineProperty(this,"read_only",{get:function(){return this.get_read_only();},set:function(a){this.set_read_only(a);}});}n.prototype={constructor:n,attr:["ID","field_name","field_caption","data_type","required","lookup_item","master_field","lookup_field","view_visible","view_index","edit_visible","edit_index","_read_only","_expand","_word_wrap","field_size","is_default","calculated","editable","_alignment","lookup_values","enable_typeahead"],type_names:["","text","integer","float",'currency',"date","datetime","boolean","blob"],copy:function(a){var b=new n(a,this.get_info());b.lookup_item=this.lookup_item;b.lookup_field=this.lookup_field;return b;},get_info:function(){var a,b=this.attr.length,c=[];for(a=0;a<b;a++)c.push(this[this.attr[a]]);return c;},set_info:function(a){if(a){var b,c=this.attr.length;for(b=0;b<c;b++)this[this.attr[b]]=a[b];}},get_row:function(){if(this.owner._records)return this.owner._records[this.owner.get_rec_no()];else throw 'An attempt to get a field value in the empty dataset - item: '+this.owner.item_name;},get_data:function(){var a;if(this.field_kind===d.ITEM_FIELD){a=this.get_row();if(a&&this.bind_index>=0)return a[this.bind_index];}else return this._value;},set_data:function(a){var b;if(this.field_kind===d.ITEM_FIELD){b=this.get_row();if(b&&this.bind_index>=0)b[this.bind_index]=a;}else this._value=a;},get_lookup_data:function(){var a;if(this.field_kind===d.ITEM_FIELD){a=this.get_row();if(a&&this.lookup_index>=0)return a[this.lookup_index];}else return this._lookup_value;},set_lookup_data:function(a){var b;if(this.field_kind===d.ITEM_FIELD){b=this.get_row();if(b&&this.lookup_index>=0)b[this.lookup_index]=a;}else this._lookup_value=a;},get_text:function(){var a="",b="";try{a=this.get_value();if(a!==null)switch(this.data_type){case d.TEXT:break;case d.INTEGER:a=this.int_to_str(a);break;case d.FLOAT:a=this.float_to_str(a);break;case d.CURRENCY:a=this.float_to_str(a);break;case d.DATE:a=this.date_to_str(a);break;case d.DATETIME:a=this.datetime_to_str(a);break;case d.BOOLEAN:if(this.get_value())a=c.yes;else a=c.no;break;}else a="";}catch(e){a='';b=this.field_caption+": "+this.type_error();this.do_on_error(b);}if(typeof a!=='string')a='';return a;},set_text:function(a){var b="";if(a!==this.get_text())try{switch(this.data_type){case d.TEXT:this.set_value(a);break;case d.INTEGER:this.set_value(this.str_to_int(a));break;case d.FLOAT:this.set_value(this.str_to_float(a));break;case d.CURRENCY:this.set_value(this.str_to_float(a));break;case d.DATE:this.set_value(this.str_to_date(a));break;case d.DATETIME:this.set_value(this.str_to_datetime(a));break;case d.BOOLEAN:if(c)if(a.length&&a.toUpperCase().trim()===c.yes.toUpperCase().trim())this.set_value(true);else this.set_value(false);else if(a.length&&(a[0]==='T'||a[0]==='t'))this.set_value(true);else this.set_value(false);break;default:this.set_value(a);}}catch(e){b=this.field_caption+": "+this.type_error();this.do_on_error(b);}},convert_date_time:function(a){if(a.search('.')!==-1)a=a.split('.')[0];return this.format_string_to_date(a,'%Y-%m-%d %H:%M:%S');},convert_date:function(a){if(a.search(' ')!==-1)a=a.split(' ')[0];return this.format_string_to_date(a,'%Y-%m-%d');},get_raw_value:function(){var a=this.get_data();if(this.data_type===d.DATETIME&&a)a=a.replace('T',' ');return a;},get_value:function(){var a=this.get_raw_value();if(a===null){if(this.field_kind===d.ITEM_FIELD)switch(this.data_type){case d.INTEGER:a=0;break;case d.FLOAT:a=0;break;case d.CURRENCY:a=0;break;case d.TEXT:a='';break;case d.BOOLEAN:a=false;break;}}else switch(this.data_type){case d.DATE:a=this.convert_date(a);break;case d.DATETIME:a=this.convert_date_time(a);break;case d.BOOLEAN:return a?true:false;break;}return a;},do_on_change_lookup_field:function(a,b){var c=this;if(a===undefined)a=null;if(this.lookup_item)if(this.master_field)this.master_field.do_on_change_lookup_field(null);else{this.set_lookup_data(a);if(this.owner)this.owner.each_field(function(a,d){if(c===a.master_field&&b!==undefined){a.set_lookup_data(b[a.field_name]);a.update_controls();}});}},do_before_changed:function(){if(this.field_kind===d.ITEM_FIELD){if(this.owner.get_state()!==d.STATE_INSERT&&this.owner.get_state()!==d.STATE_EDIT)throw this.owner.item_name+' is not in edit or insert mode';if(this.owner.on_before_field_changed)this.owner.on_before_field_changed.call(this.owner,this);}},do_after_changed:function(a){if(this.owner&&this.owner.on_field_changed)this.owner.on_field_changed.call(this.owner,this,a);if(this.filter){this.filter.update(this);if(this.filter.owner.on_filter_changed)this.filter.owner.on_filter_changed.call(this.filter.owner,this.filter);}},set_value:function(b,c,e,f){var g;if(((this.field_name==='id'&&this.value)||this.field_name==='deleted')&&(this.field_kind===d.ITEM_FIELD)&&(self.value!==b))throw this.owner.item_name+': can not change value of the system field - '+this.field_name;this.new_value=null;if(b!==null){this.new_value=b;if(this.field_kind===d.FILTER_FIELD&&a.inArray(this.filter.filter_type,[d.FILTER_IN,d.FILTER_NOT_IN])!==-1){if(!a.isArray(b)){g='Filter "'+this.filter.filter_name+'" value must be an array';this.do_on_error(g);}}else switch(this.data_type){case d.INTEGER:this.new_value=b;if(typeof b==="string")this.new_value=parseInt(b,10);break;case d.FLOAT:this.new_value=b;if(typeof b==="string")this.new_value=parseFloat(b);break;case d.CURRENCY:this.new_value=b;if(typeof b==="string")this.new_value=parseFloat(b);break;case d.BOOLEAN:this.new_value=b?1:0;break;case d.DATE:this.new_value=this.format_date_to_string(b,'%Y-%m-%d');break;case d.DATETIME:this.new_value=this.format_date_to_string(b,'%Y-%m-%d %H:%M:%S');break;case d.TEXT:this.new_value=b+'';break;}}if(this.get_raw_value()!==this.new_value){this.do_before_changed();try{this.set_data(this.new_value);}catch(h){g=this.field_name+": "+this.type_error();this.do_on_error(g);}this.new_value=null;this.do_on_change_lookup_field(c,e);this.set_modified(true);this.do_after_changed(f);}else if(c&&c!==this.get_lookup_value()){this.do_on_change_lookup_field(c,e);this.do_after_changed(f);}this.update_controls();},set_modified:function(a){if(this.field_kind===d.ITEM_FIELD)if(this.owner.set_modified&&!this.calculated)this.owner.set_modified(a);},get_lookup_data_type:function(){if(this.lookup_values)return d.TEXT;else if(this.lookup_item)return this.lookup_item._field_by_name(this.lookup_field).data_type;else return this.data_type;},get_lookup_value:function(){var a=null;if(this.lookup_item&&this.get_value()){a=this.get_lookup_data();switch(this.get_lookup_data_type()){case d.DATE:if(typeof a==="string")a=this.convert_date(a);break;case d.DATETIME:if(typeof a==="string")a=this.convert_date_time(a);break;case d.BOOLEAN:if(a)return true;else return false;break;}}else a=this.get_value();return a;},get_lookup_text:function(){var a=this,b,c='';try{if(this.lookup_item){if(this.get_value())c=this.get_lookup_value();if(c===null)c='';else{b=this.get_lookup_data_type();if(b)switch(b){case d.DATE:c=this.date_to_str(c);break;case d.DATETIME:c=this.datetime_to_str(c);break;case d.FLOAT:c=this.float_to_str(c);break;case d.CURRENCY:c=this.cur_to_str(c);break;}}}}catch(e){}return c;},_get_value_in_list:function(){var a=0,b=this.lookup_values.length,c='';for(;a<b;a++)if(this.lookup_values[a][0]===this.value)c=this.lookup_values[a][1];return c;},get_display_text:function(){var a,b='';if(this.lookup_values)try{b=this._get_value_in_list();}catch(c){}else if(this.lookup_item)b=this.get_lookup_text();else if(this.data_type===d.CURRENCY){if(this.raw_value!==null)b=this.cur_to_str(this.get_value());}else b=this.get_text();if(this.owner&&this.owner.on_get_field_text)if(!this.on_get_field_text_called){this.on_get_field_text_called=true;try{a=this.owner.on_get_field_text.call(this.owner,this);if(a!==undefined)b=a;}finally{this.on_get_field_text_called=false;}}if(b===undefined)b='';return b;},set_read_only:function(a){this._read_only=a;this.update_controls();},get_read_only:function(){var a=this._read_only;if(this.owner&&this.owner._parent_read_only&&this.owner.get_read_only())a=this.owner.get_read_only();return a;},set_visible:function(a){this._visible=a;this.update_controls();},get_visible:function(){return this._visible;},set_alignment:function(a){this._alignment=a;this.update_controls();},get_alignment:function(){return this._alignment;},set_expand:function(a){this._expand=a;this.update_controls();},get_expand:function(){return this._expand;},set_word_wrap:function(a){this._word_wrap=a;this.update_controls();},get_word_wrap:function(){return this._word_wrap;},check_type:function(){this.get_value();if((this.data_type===d.TEXT)&&(this.field_size!==0)&&(this.get_text().length>this.field_size))this.do_on_error(this.field_caption+': '+c.invalid_length.replace('%d',this.field_size));return true;},check_reqired:function(){if(!this.required)return true;else if(this.get_raw_value()!==null)return true;else this.do_on_error(this.field_caption+': '+c.value_required);},check_valid:function(){var a;if(this.check_reqired())if(this.check_type()){if(this.owner&&this.owner.on_field_validate){a=this.owner.on_field_validate.call(this.owner,this);if(a){this.do_on_error(a);return;}}if(this.filter){a=this.filter.check_value(this);if(a){this.do_on_error(a);return;}}return true;}},get_typeahead_defs:function(a){var b=this,c,d=10,e;c=b.lookup_item.copy(),c.lookup_field=this,e={items:d,lookup_item:c,field:this,source:function(a,e){var f={};if(b.owner&&b.owner.on_param_select_value)b.owner.on_param_select_value.call(b.owner,b,c);if(b.owner&&b.owner.on_field_select_value)b.owner.on_field_select_value.call(b.owner,b,c);if(b.filter&&b.filter.owner.on_filter_select_value)b.filter.owner.on_filter_select_value.call(b.filter.owner,b.filter,c);f.__search=[b.lookup_field,a];c.open({limit:d,params:f},function(a){var b=[];a.each(function(a){b.push(a.rec_no);});return e(b);});}};return e;},do_on_error:function(a){throw a;},system_field:function(){if(this.field_name==='id'||this.field_name==='deleted'||this.field_name==='owner_id'||this.field_name==='owner_rec_id')return true;},update_controls:function(a){var b,c;c=this.controls.length;for(b=0;b<c;b++)this.controls[b].update();if(!a&&this.owner&&this.owner.controls){c=this.owner.controls.length;for(b=0;b<c;b++)this.owner.controls[b].update_field(this);}},update_control_state:function(a){for(var b=0;b<this.controls.length;b++){this.controls[b].error=a;this.controls[b].updateState(false);}},type_error:function(){switch(this.data_type){case d.INTEGER:return c.invalid_int.replace('%s','');case d.FLOAT:return c.invalid_float.replace('%s','');case d.CURRENCY:return c.invalid_cur.replace('%s','');case d.DATE:return c.invalid_date.replace('%s','');case d.DATE_TIME:return c.invalid_date.replace('%s','');case d.BOOLEAN:return c.invalid_bool.replace('%s','');default:return c.invalid_value.replace('%s','');}},valid_char_code:function(a){var c=String.fromCharCode(a),e=a>=48&&a<=57,f=c==='.'||c===b.DECIMAL_POINT||c===b.MON_DECIMAL_POINT,g=c==='+'||c==='-',h=this.get_lookup_data_type();if(h===d.INTEGER)if(!e&&!g)return false;if(h===d.FLOAT||h===d.CURRENCY)if(!e&&!g&&!f)return false;return true;},str_to_int:function(a){var b=parseInt(a,10);if(isNaN(b))throw "invalid integer value";return b;},str_to_date:function(a){return this.format_string_to_date(a,b.D_FMT);},str_to_datetime:function(a){return this.format_string_to_date(a,b.D_T_FMT);},str_to_float:function(a){var c;a=a.replace(b.DECIMAL_POINT,".");a=a.replace(b.MON_DECIMAL_POINT,".");c=parseFloat(a);if(isNaN(c))throw "invalid float value";return c;},str_to_cur:function(c){var d=a.trim(c);if(b.MON_THOUSANDS_SEP)d=d.replace(b.MON_THOUSANDS_SEP,'');if(b.CURRENCY_SYMBOL)d=a.trim(d.replace(b.CURRENCY_SYMBOL,''));if(b.POSITIVE_SIGN)d=d.replace(b.POSITIVE_SIGN,'');if(b.NEGATIVE_SIGN&&d.indexOf(b.NEGATIVE_SIGN)!==-1){d=d.replace(b.NEGATIVE_SIGN,'');d='-'+d;}d=a.trim(d.replace(b.MON_DECIMAL_POINT,'.'));d=parseFloat(d);return d;},int_to_str:function(a){return a.toString();},float_to_str:function(a){var c=(''+a.toFixed(6)).replace(".",b.DECIMAL_POINT),d=c.length-1,e='';for(;d>=0;d--)if((c[d]==='0')&&(e.length===0))continue;else e=c[d]+e;if(e.slice(e.length-1)===b.DECIMAL_POINT)e=e+'0';return e;},date_to_str:function(a){return this.format_date_to_string(a,b.D_FMT);},datetime_to_str:function(a){return this.format_date_to_string(a,b.D_T_FMT);},cur_to_str:function(a){var c,d,e,f,g,h=0,i,j=a.toFixed(b.FRAC_DIGITS);if(isNaN(j[0]))j=j.slice(1,j.length);c=j.indexOf('.');d='';e=j;if(c>=0){e=j.slice(0,c);d=j.slice(c+1,j.length);}j='';i=e.length;for(f=0;f<i;f++){g=e[i-f-1];j=g+j;h+=1;if((h%3===0)&&(f!==i-1))j=b.MON_THOUSANDS_SEP+j;}if(d)j=j+b.MON_DECIMAL_POINT+d;if(a<0){if(b.N_SIGN_POSN===3)j=b.NEGATIVE_SIGN+j;else if(b.N_SIGN_POSN===4)j=b.result+b.NEGATIVE_SIGN;}else if(b.P_SIGN_POSN===3)j=b.POSITIVE_SIGN+j;else if(b.P_SIGN_POSN===4)j=j+b.POSITIVE_SIGN;if(b.CURRENCY_SYMBOL)if(a<0)if(b.N_CS_PRECEDES)if(b.N_SEP_BY_SPACE)j=b.CURRENCY_SYMBOL+' '+j;else j=b.CURRENCY_SYMBOL+j;else if(b.N_SEP_BY_SPACE)j=j+' '+b.CURRENCY_SYMBOL;else j=j+b.CURRENCY_SYMBOL;else if(b.P_CS_PRECEDES)if(b.P_SEP_BY_SPACE)j=b.CURRENCY_SYMBOL+' '+j;else j=b.CURRENCY_SYMBOL+j;else if(b.P_SEP_BY_SPACE)j=j+' '+b.CURRENCY_SYMBOL;else j=j+b.CURRENCY_SYMBOL;if(a<0){if(b.N_SIGN_POSN===0&&b.NEGATIVE_SIGN)j=b.NEGATIVE_SIGN+'('+j+')';else if(b.N_SIGN_POSN===1)j=b.NEGATIVE_SIGN+j;else if(b.N_SIGN_POSN===2)j=j+b.NEGATIVE_SIGN;}else if(b.P_SIGN_POSN===0&&b.POSITIVE_SIGN)j=b.POSITIVE_SIGN+'('+j+')';else if(b.P_SIGN_POSN===1)j=b.POSITIVE_SIGN+j;else if(b.P_SIGN_POSN===2)j=j+b.POSITIVE_SIGN;return j;},parseDateInt:function(a,b){var c=parseInt(a.substring(0,b),10);if(isNaN(c))throw 'invalid date';return c;},format_string_to_date:function(a,b){var c='',d=a,e,f,g,h=0,i=0,j=0;for(var k=0;k<b.length;++k){c=b.charAt(k);switch(c){case "%":break;case "d":e=this.parseDateInt(d,2);d=d.slice(2);break;case "m":f=this.parseDateInt(d,2);d=d.slice(2);break;case "Y":g=this.parseDateInt(d,4);d=d.slice(4);break;case "H":h=this.parseDateInt(d,2);d=d.slice(2);break;case "M":i=this.parseDateInt(d,2);d=d.slice(2);break;case "S":j=this.parseDateInt(d,2);d=d.slice(2);break;default:d=d.slice(c.length);}}return new Date(g,f-1,e,h,i,j);},leftPad:function(a,b,c){var d=a.toString();while(d.length<b)d=c+d;return d;},format_date_to_string:function(a,b){var c='',d='';for(var e=0;e<b.length;++e){c=b.charAt(e);switch(c){case "%":break;case "d":d+=this.leftPad(a.getDate(),2,'0');break;case "m":d+=this.leftPad(a.getMonth()+1,2,'0');break;case "Y":d+=a.getFullYear();break;case "H":d+=this.leftPad(a.getHours(),2,'0');break;case "M":d+=this.leftPad(a.getMinutes(),2,'0');break;case "S":d+=this.leftPad(a.getSeconds(),2,'0');break;default:d+=c;}}return d;},select_value:function(){var a=this.lookup_item.copy();a.is_lookup_item=true;a.lookup_field=this;if(this.owner&&this.owner.on_param_select_value)this.owner.on_param_select_value.call(this.owner,this,a);if(this.owner&&this.owner.on_field_select_value)this.owner.on_field_select_value.call(this.owner,this,a);if(this.filter&&this.filter.owner.on_filter_select_value)this.filter.owner.on_filter_select_value.call(this.filter.owner,this.filter,a);a.view();}};function o(a,b){var c=this,e;this.owner=a;this.set_info(b);if(a){a.filters.push(this);if(!(this.filter_name in a.filters))a.filters[this.filter_name]=this;if(this.field_name){e=this.owner._field_by_ID(this.field_name);this.field=this.create_field(e);if(this.filter_type===d.FILTER_RANGE)this.field1=this.create_field(e);}}Object.defineProperty(this,"value",{get:function(){return this.get_value();},set:function(a){this.set_value(a);}});Object.defineProperty(this,"text",{get:function(){return this.get_text();}});}o.prototype={constructor:o,attr:["filter_name","filter_caption","field_name","filter_type","data_type","visible"],create_field:function(a){var b=new n();b.set_info(a.get_info());b._read_only=false;b.filter=this;b._value=null;b._lookup_value=null;b.field_kind=d.FILTER_FIELD;return b;},copy:function(a){var b=new o(a,this.get_info());return b;},get_info:function(){var a,b=this.attr.length,c=[];for(a=0;a<b;a++)c.push(this[this.attr[a]]);return c;},set_info:function(a){if(a){var b,c=this.attr.length;for(b=0;b<c;b++)this[this.attr[b]]=a[b];}},get_value:function(){if(this.filter_type===d.FILTER_RANGE)if(this.field.raw_value!==null&&this.field1.raw_value!==null)return [this.field.raw_value,this.field1.raw_value];else return null;else return this.field.raw_value;},set_value:function(a,b){if(this.filter_type===d.FILTER_RANGE)if(a===null){this.field.value=null;this.field1.value=null;}else{this.field.value=a[0];this.field1.value=a[1];}else this.field.set_value(a,b);},update:function(a){var b=this.field;if(this.filter_type===d.FILTER_RANGE)if(a.value!==null){if(a===this.field)b=this.field1;if(b.raw_value===null)b.value=a.value;}},check_valid:function(){var a=this.check_value(this.field);if(a)throw a;},check_value:function(a){if(this.filter_type===d.FILTER_RANGE)if(this.field.raw_value===null&&this.field1.raw_value!==null||this.field.raw_value!==null&&this.field1.raw_value===null||this.field.value>this.field1.value)return c.invalid_range;},get_text:function(){var a='';if(this.visible&&this.value!=null){a=this.filter_caption+': ';if(this.filter_type===d.FILTER_RANGE)a+=this.field.get_display_text()+' - '+this.field1.get_display_text();else if(this.field.data_type===d.BOOLEAN)if(this.field.value)a+='x';else a+='-';else a+=this.field.get_display_text();}return a;}};p.prototype=new n();p.prototype.constructor=n;function p(a,b){n.call(this,a,b);this.param_name=this.field_name;this.param_caption=this.field_caption;this.field_size=0;this.report=a;this._value=null;this._lookup_value=null;this.field_kind=d.PARAM_FIELD;if(this.owner[this.param_name]===undefined)this.owner[this.param_name]=this;}function q(a,b,c,d,e,f){this.init(a,b,c,d,e,f);}q.prototype={constructor:q,init:function(b,c,d){var e=this,f={id_field:undefined,parent_field:undefined,text_field:undefined,parent_of_root_value:undefined,text_tree:undefined,on_click:undefined,on_dbl_click:undefined};this.id=b.task.controlId++;this.item=b;this.$container=c;this.options=a.extend({},f,d);this.$element=a('<div class="dbtree '+this.item.item_name+'" tabindex="0" style="overflow-x:auto; overflow-y:auto;"></div>');this.$element.css('position','relative');this.$element.data('tree',this);this.$element.tabindex=0;this.item.controls.push(this);this.$element.bind('destroyed',function(){e.item.controls.splice(e.item.controls.indexOf(e),1);});this.$element.appendTo(this.$container);this.height(c.height());this.$element.on('focus blur',function(a){e.select_node(e.selected_node,false);});this.$element.on('keyup',function(a){e.keyup(a);});this.$element.on('keydown',function(a){e.keydown(a);});if(b.get_active()&&this.$container.width())this.build();},form_closing:function(){var a=this.$element.closest('.modal');if(a)return a.data('_closing');return false;},height:function(a){if(a)this.$element.height(a);else return this.$element.height();},is_focused:function(){return this.$element.get(0)===document.activeElement;},scroll_into_view:function(){this.select_node(this.selected_node);},update:function(a){var b,c=this,e;if(this.form_closing())return;switch(a){case d.UPDATE_OPEN:this.build();break;case d.UPDATE_CANCEL:this.changed();break;case d.UPDATE_APPEND:this.changed();break;case d.UPDATE_INSERT:this.changed();break;case d.UPDATE_DELETE:this.changed();break;case d.UPDATE_SCROLLED:this.syncronize();break;case d.UPDATE_CONTROLS:this.syncronize();break;case d.UPDATE_CLOSE:this.$element.empty();break;case d.UPDATE_REFRESH:this.build();break;}},keydown:function(a){var b=this,c,d=(a.keyCode?a.keyCode:a.which);if(this.selected_node&&!a.ctrlKey&&!a.shiftKey)switch(d){case 13:a.preventDefault();this.toggle_expanded(this.selected_node);break;case 38:a.preventDefault();c=this.selected_node.prev();if(c.length)this.select_node(c);else{c=this.selected_node.parent().parent();if(c.length&&c.prop("tagName")==="LI")this.select_node(c);}break;case 40:a.preventDefault();if(this.selected_node.hasClass('parent')&&!this.selected_node.hasClass('collapsed')){c=this.selected_node.find('ul:first li:first');if(c.length)this.select_node(c);}else{c=this.selected_node.next();if(c.length)this.select_node(c);else{c=this.selected_node.find('ul:first li:first');if(c.length)this.select_node(c);}}break;}},keyup:function(a){var b=this,c=(a.keyCode?a.keyCode:a.which);if(!a.ctrlKey&&!a.shiftKey)switch(c){case 13:break;case 38:break;case 40:break;}},build_child_nodes:function(a,b){var c=0,d=b.length,e,f,g,h,i,j,k,l,m,n,o,p;for(c=0;c<d;c++){e=b[c];f=e.id;g=e.text;h=e.rec;i='<span class="empty-bullet"></span>',j="",k="",o=this.child_nodes[f+''];if(o&&o.length){i='<i class="icon-chevron-right bullet"></i>';j=' parent';k='collapsed';}l='<li class="'+k+j+'" style="list-style: none" data-rec="'+h+'">'+'<div><span class="tree-bullet">'+i+'</span>'+'<span class="tree-text">'+g+'<span></div>';a+=l;if(o&&o.length){a+='<ul style="display: none">';a=this.build_child_nodes(a,o);a+='</ul>';}a+='</li>';a+='</li>';}return a;},collect_nodes:function(a){var b=a[this.options.id_field],c=a[this.options.parent_field],d=a[this.options.text_field],e;this.child_nodes={};a.first();while(!a.eof()){e=this.child_nodes[c.value+''];if(e===undefined){e=[];this.child_nodes[c.value+'']=e;}e.push({'id':b.value,'text':d.display_text,'rec':a.rec_no});a.next();}},build:function(){var b=this,c=this.item.clone(),d='<ul>',e,f,g,h,i,j,k;this.collect_nodes(c);this.$element.empty();k=this.child_nodes[this.options.parent_of_root_value+''];if(k&&k.length)d=this.build_child_nodes(d,k);d+='</ul>';this.$element.append(a(d));j=this.$element.find('li');f=j.length;for(e=0;e<f;e++){i=j.eq(e);g=i.data('rec');c.set_rec_no(g);this.item._cur_row=g;i.data("record",c._records[g]);h=c.rec_controls_info();h[this.id]=i.get();if(this.options.node_callback)this.options.node_callback(i,this.item);}this.select_node(j.eq(0));this.$element.off('click','li.parent > div span.tree-bullet');this.$element.on('click','li.parent > div span.tree-bullet',function(c){var d=a(this),e=d.parent().parent(),f;b.toggle_expanded(e);c.preventDefault();c.stopPropagation();});this.$element.off('click','li > div span.tree-text');this.$element.on('click','li > div span.tree-text',function(c){var d=a(this).parent().parent();b.select_node(d);});},toggle_expanded:function(a){var b=a.find('div:first span.tree-bullet'),c;if(a.hasClass('parent')){c=a.find('ul:first'),a.toggleClass('collapsed');if(a.hasClass('collapsed'))b.html('<i class="icon-chevron-right bullet"></i>');else b.html('<i class="icon-chevron-down bullet"></i>');c.slideToggle(0);}},expand:function(a){if(a.hasClass('parent')&&a.hasClass('collapsed'))this.toggle_expanded(a);a=a.parent().parent();if(a.prop("tagName")==="LI")this.expand(a);},collapse:function(a){if(a.hasClass('parent')&&!a.hasClass('collapsed'))this.toggle_expanded(a);},select_node:function(a,b){var c=this,d,e;if(b===undefined)b=true;if(this.selected_node)this.selected_node.removeClass('selected selected-focused');if(a&&(!this.selected_node||a.get(0)!==this.selected_node.get(0))){this.selected_node=a;e=this.item._records.indexOf(a.data("record"));if(e!==this.item.rec_no)this.item.set_rec_no(e);d=this.selected_node.parent().parent();if(d.prop("tagName")==="LI")this.expand(d);}if(this.is_focused())this.selected_node.addClass('selected-focused');else this.selected_node.addClass('selected');if(b)this.update_selected_node(this.selected_node);},update_selected_node:function(a){var b,c,d,e,f;if(a.length){b=this.$element.scrollTop();c=b+this.$element.height();d=a.get(0).offsetTop;e=d+a.height();if(d<b)this.$element.scrollTop(d);else if(e>c)this.$element.scrollTop(e-this.$element.height());}},syncronize:function(){var b,c;if(this.item.record_count())try{b=this.item.rec_controls_info(),c=a(b[this.id]);this.select_node(c);}catch(d){console.log(d);}},changed:function(){}};function r(a,b,c){this.init(a,b,c);}r.prototype={constructor:r,init:function(b,e,f){var g=this,h={height:480,fields:[],column_width:{},title_word_wrap:false,row_line_count:1,expand_selected_row:0,auto_fit_width:true,multi_select:false,multi_select_title:'',multi_select_colum_width:undefined,multi_select_get_selected:undefined,multi_select_set_selected:undefined,multi_select_select_all:undefined,tabindex:0,striped:true,dblclick_edit:true,on_click:undefined,on_dblclick:undefined,on_pagecount_update:undefined,editable:false,keypress_edit:true,editable_fields:undefined,selected_field:undefined,append_on_lastrow_keydown:false,sortable:false,sort_fields:undefined,row_callback:undefined,title_callback:undefined,show_footer:undefined,pagination_container:undefined};this.item=b;if(!this.item.paginate)h.striped=false;this.id=b.task.gridId++;this.$container=e;this.options=a.extend({},h,f);this.editMode=false;this._sorted_fields=[];this._multiple_sort=false;this.on_dblclick=this.options.on_dblclick;if(!this.options.multi_select&&this.item.lookup_field&&this.item.lookup_field.field_kind===d.FILTER_FIELD&&(this.item.lookup_field.filter.filter_type===d.FILTER_IN||this.item.lookup_field.filter.filter_type===d.FILTER_NOT_IN)){this.options.multi_select=true;this._filter_dict={};if(this.item.lookup_field.value&&this.item.lookup_field.value.length)for(var i=0;i<this.item.lookup_field.value.length;i++)this._filter_dict[this.item.lookup_field.value[i]]=true;this.options.multi_select_get_selected=function(a){return g._filter_dict[a.id.value];},this.options.multi_select_set_selected=function(a,b){var d=[];if(b)g._filter_dict[a.id.value]=true;else delete g._filter_dict[a.id.value];for(var e in g._filter_dict)if(g._filter_dict.hasOwnProperty(e))d.push(parseInt(e,10));if(d.length)g.item.lookup_field.set_value(d,c.items_selected.replace('%d',d.length));else g.item.lookup_field.set_value(null,'');};}this.page=0;this.recordCount=0;this.cellWidths={};this.autoFieldWidth=true;this.fieldWidthUpdated=false;this.initFields();this.$element=a('<div class="dbtable '+b.item_name+'" style="overflow-x:auto;"></div>');this.$element.data('dbtable',this);this.item.controls.push(this);this.$element.bind('destroyed',function(){g.item.controls.splice(g.item.controls.indexOf(g),1);});this.$container.empty();this.$element.appendTo(this.$container);this.createTable();if(b.get_active())setTimeout(function(){g.init_table();},0);},initFields:function(){var a=0,b,c,d;this.fields=[];if(this.options.fields.length)d=this.options.fields;else d=this.item.view_options.fields;if(d.length){b=d.length;for(;a<b;a++){c=this.item.field_by_name(d[a]);if(c)this.fields.push(c);}}this.options.editable=this.options.editable&&!this.item.read_only;if(this.options.editable)this.options.striped=false;this.editableFields=[];if(this.options.editable_fields){b=this.options.editable_fields.length;for(a=0;a<b;a++){c=this.item.field_by_name(this.options.editable_fields[a]);if(c&&!c.read_only)this.editableFields.push(c);}}else{b=this.fields.length;for(a=0;a<b;a++)if(!this.fields[a].read_only)this.editableFields.push(this.fields[a]);}this.initSelectedField();this.colspan=this.fields.length;if(this.options.multi_select)this.colspan+=1;},initKeyboardEvents:function(){var a=this,b;clearTimeout(b);b=setTimeout(function(){a.$table.on('keydown',function(b){a.keydown(b);});a.$table.on('keyup',function(b){a.keyup(b);});a.$table.on('keypress',function(b){a.keypress(b);});},400);},createTable:function(){var b=this,c=a(document),d,e,f,g,h=0,i,j,k,l,m,n,o,p,q;this.colspan=this.fields.length;if(this.options.multi_select)this.colspan+=1;this.$element.append(a('<table class="outer-table" style="width: 100%;">'+'   <thead>'+'       <tr><th>&nbsp</th></tr>'+'   </thead>'+'   <tfoot>'+'       <tr><th>&nbsp</th></tr>'+'   </tfoot>'+'   <tr>'+'       <td id="top-td" style="padding: 0; border: 0" colspan='+this.colspan+'>'+'           <div class="overlay-div" style="height: 100px; width: 100%; overflow-y: auto; overflow-x: hidden;">'+'               <table class="inner-table" style="width: 100%"></table>'+'           </div>'+'       </td>'+'   </tr>'+'</table>'));this.$outer_table=this.$element.find("table.outer-table");this.$scroll_div=this.$element.find('div.overlay-div');this.$table=this.$element.find("table.inner-table");this.$head=this.$element.find("table.outer-table thead tr:first");this.$foot=this.$element.find("table.outer-table tfoot tr:first");this.$scroll_div.keydown(function(a){var b=(a.keyCode?a.keyCode:a.which);if(b==32)a.preventDefault();});this.$element.find('table.outer-table').addClass("table table-condensed table-bordered").css("margin",0);this.$table.addClass("table table-condensed").css("margin",0).attr("disabled",false);if(this.options.striped)this.$table.addClass("table-striped");this.$table.on('mousedown dblclick','td',function(c){var d=this;if(this.nodeName!=='TD')d=a(this).closest('td');c.preventDefault();c.stopPropagation();b.clicked(c,d);});this.$table.on('click','td',function(a){if(b.options.on_click)b.options.on_click.call(b.item,b.item);});if(!this.options.word_wrap)this.$table.on('mouseenter','div',function(){var b=a(this);if(this.offsetHeight<(this.scrollHeight-2)||this.offsetWidth<(this.scrollWidth-2))b.tooltip({'placement':'right','title':b.text()}).on('hide',function(a){a.stopPropagation();}).on('hidden',function(a){a.stopPropagation();}).on('show',function(a){a.stopPropagation();}).on('shown',function(a){a.stopPropagation();}).eq(0).tooltip('show');});if(this.options.multi_select){var b=this;this.$table.on('mousedown','td input.multi_select',function(c){var d=a(this),e=d.is(':checked');c.preventDefault();c.stopPropagation();b.clicked(c,d.closest('td'));if(b.options.multi_select_set_selected){b.options.multi_select_set_selected.call(b.item,b.item,!e);b.update_select_all_checkbox();}});}if(this.options.multi_select_select_all){var b=this;this.$outer_table.on('click','th input.multi_select',function(c){b.options.multi_select_select_all.call(b.item,b.item,a(this).is(':checked'));});}this.$table.attr("tabindex",this.options.tabindex);this.initKeyboardEvents();this.$element.on('mousemove.grid-title','table.outer-table thead tr:first th',function(c){var d=a(this),e=d.data('field_name'),f=b.$element.find("thead tr:first th:last").get(0);if(d.outerWidth()-c.offsetX<8&&!i&&this!==f)d.css('cursor','col-resize');else if(b.options.sortable&&(!b.options.sort_fields||b.options.sort_fields.indexOf(e)!==-1))d.css('cursor','pointer');else d.css('cursor','default');});function r(a){var c=h+a.screenX-i,f=parseInt(d.css("left"),10);if(i){a.preventDefault();if(c>-(e.innerWidth()-30)&&(!b.options.auto_fit_width||c<(g.innerWidth()-30))){h=c;d.css('left',f+a.screenX-i);}i=a.screenX;}}function s(a,c){var d,e,f,g,h;d=a.data('field_name');e=b.$table.find('td.'+d);f=b.$element.find("tfoot tr:first th."+d);g=b.getCellWidth(d);h=g+c;e.width(h);e.find('div').width(h);a.width(h);a.find('div').width(h);f.width(h);f.find('div').width(h);b.syncColWidth();h=a.width();b.setCellWidth(d,h);return h-g;}function t(a){var f,j,k,l;c.off("mousemove.grid-title");c.off("mouseup.grid-title");if(h<0){h=s(e,h);if(b.options.auto_fit_width)s(g,-h);}else if(b.options.auto_fit_width){h=-s(g,-h);s(e,h);}else s(e,h);i=undefined;d.remove();}this.$element.on('mousedown.grid-title','table.outer-table thead tr:first th',function(f){var j=a(this),k,l,m=j.data('field_name'),n,o,p=[],k,q=false,s,u,v;l=b.$element.find("thead tr:first th:last").get(0);if(j.outerWidth()-f.offsetX<8&&this!==l){j.css('cursor','default');i=f.screenX;e=j;k=b.fields.indexOf(b.item.field_by_name(m));s=b.fields[k+1].field_name;g=b.$element.find("thead tr:first th."+s);h=0;c.on("mousemove.grid-title",r);c.on("mouseup.grid-title",t);d=a('<div>').addClass('selection-box').css({'width':0,'height':b.$outer_table.find('thead').innerHeight()+b.$scroll_div.innerHeight(),'left':j.position().left+j.outerWidth(),'top':b.$element.position().top});d.appendTo(b.$element);}else if(m&&b.options.sortable&&(!b.options.sort_fields||b.options.sort_fields.indexOf(m)!==-1)){if(f.ctrlKey){if(!b._multiple_sort)b._multiple_sort=true;}else if(b._multiple_sort){b._sorted_fields=[];b._multiple_sort=false;}o=b.item.field_by_name(m).ID;v=b._sorted_fields.slice();if(b._multiple_sort){k=-1;for(var w=0;w<v.length;w++)if(v[w][0]===o){k=w;break;}if(k===-1)v.push([o,false]);else v[k][1]=!v[k][1];}else if(v.length&&v[0][0]===o)v[0][1]=!v[0][1];else v=[[o,false]];b._sorted_fields=v.slice();if(b.item.master||!b.item.paginate)b.item.sort(b._sorted_fields);else{b.item._open_params.__order=b._sorted_fields;b.item.open({params:b.item._open_params,offset:0});}}});this.$table.focus(function(a){if(!this.syncronizing){this.syncronizing=true;try{b.syncronize();}finally{this.syncronizing=false;}}});this.$table.blur(function(a){b.syncronize();});this.createPager();this.createFooter();l=this.$element.clone().css("float","left").css("position","absolute").css("top",-1000);l.width(this.$container.width());this.fillTitle(l);this.createFooter(l);k=l.find("table.inner-table");if(this.options.multi_select)m=a('<tr><td><div><input type="checkbox"></div></td><td><div>W</div></td></tr>');else m=a("<tr><td><div>W</div></td></tr>");for(j=0;j<10;j++)k.append(m.clone());a('body').append(l);this.rowHeight=k.height()/10;f=k.find('td');this.td_height_margin=parseInt(f.css('padding-top'),10)+parseInt(f.css('padding-bottom'),10)+parseInt(f.css('margin-top'),10)+parseInt(f.css('margin-bottom'),10)+parseInt(f.css('border-top-width'),10);this.textHeight=k.find('div').outerHeight();q=l.outerHeight();p=l.find('div.overlay-div').height();l.remove();this.$scroll_div.height(this.options.height-(q-p));if(this.item.paginate){if(this.options.row_line_count>1)this.row_count=Math.floor((this.$scroll_div.height()-1)/(this.textHeight*this.options.row_line_count+this.td_height_margin+1));else if(this.options.expand_selected_row&&this.options.row_line_count===1){p=this.$scroll_div.height()-this.rowHeight-(this.options.expand_selected_row-1)*this.textHeight-1;this.row_count=Math.floor(p/this.rowHeight)+1;}else this.row_count=Math.floor((this.$scroll_div.height()-1)/this.rowHeight);if(this.row_count<=0)this.row_count=1;this.item._pg_limit=this.row_count;}},createPager:function(b){var d=this,e,f,g,h;if(this.item.paginate){g=-1;e=a('<td class="pager" style="line-height: 0" colspan='+this.colspan+'>'+'   <div id="pager" style="margin: 0 auto">'+'       <form class="form-inline" style="margin: 0">'+'           <a class="btn btn-small" tabindex="-1" href="first"><i class="icon-backward"></i></a>'+'           <a class="btn btn-small" tabindex="-1" href="prior"><i class="icon-chevron-left"></i></a>'+'           <label  class="control-label" for="input-page" style="margin: 0px 4px">'+c.page+'</label>'+'           <input class="pager-input input-mini" id="input-page" tabindex="'+g+'" type="text">'+'           <label id="page-count" class="control-label" for="input-page" style="margin: 0px 4px">'+c.of+'1000000 </label>'+'           <a class="btn btn-small" tabindex="-1" href="next"><i class="icon-chevron-right"></i></a>'+'           <a class="btn btn-small" tabindex="-1" href="last"><i class="icon-forward"></i></a>'+'       </form>'+'   </div>'+'</td>');this.$fistPageBtn=e.find('[href="first"]');this.$fistPageBtn.on("click",function(a){d.firstPage();a.preventDefault();});this.$fistPageBtn.addClass("disabled");this.$priorPageBtn=e.find('[href="prior"]');this.$priorPageBtn.on("click",function(a){d.priorPage();a.preventDefault();});this.$priorPageBtn.addClass("disabled");this.$nextPageBtn=e.find('[href="next"]');this.$nextPageBtn.on("click",function(a){d.nextPage();a.preventDefault();});this.$lastPageBtn=e.find('[href="last"]');this.$lastPageBtn.on("click",function(a){d.lastPage();a.preventDefault();});this.$pageInput=e.find('input');this.$pageInput.val(1);this.$pageInput.on("keydown",function(a){var b,c=(a.keyCode?a.keyCode:a.which);if(c===13){b=parseInt(d.$pageInput.val(),10);a.preventDefault();if(!isNaN(b)&&(b>0)){d.$pageInput.val(b);d.setPageNumber(b-1);}}});this.$pageCount=e.find('#page-count');this.$pageCount.text(c.of+'1000000');f=e.find('#pager').clone().css("float","left").css("position","absolute").css("top",-1000);a("body").append(f);h=f.width();f.remove();if(this.options.pagination_container){this.options.pagination_container.empty();this.options.pagination_container.append(e);}else if(b)b.find('tfoot').append(e);else this.$element.find('tfoot').append(e);this.$pageCount.text(c.of+' ');e.find('#pager').width(h);}},initSelectedField:function(){var a;if(!this.selectedField&&this.editableFields.length){this.selectedField=this.editableFields[0];if(this.options.selected_field){a=this.item.field_by_name(this.options.selected_field);if(this.editableFields.indexOf(a)!==-1)this.selectedField=a;}}},setSelectedField:function(a){var b=this,c=this.selectedField!==a;if(this.editableFields.indexOf(a)!==-1){if(c&&this.options.editable){this.flushEditor();this.hideEditor();}this.hide_selection();this.selectedField=a;if(c&&this.options.editable&&this.editMode){clearTimeout(this.editorsTimeOut);this.editorsTimeOut=setTimeout(function(){b.showEditor();},75);}this.show_selection();}},nextField:function(){var a;if(this.selectedField){a=this.editableFields.indexOf(this.selectedField);if(a<this.editableFields.length-1)this.setSelectedField(this.editableFields[a+1]);}},priorField:function(){var a;if(this.selectedField){a=this.editableFields.indexOf(this.selectedField);if(a>0)this.setSelectedField(this.editableFields[a-1]);}},hideEditor:function(){var a,b,c,d;d;if(this.editing){try{this.editMode=false;d=this.editor.$controlGroup.parent();b=this.editor.field;c=d.find('div.'+b.field_name);a=d.outerWidth();d.css("padding-left",this.editor.paddingLeft);d.css("padding-top",this.editor.paddingTop);d.css("padding-right",this.editor.paddingRight);d.css("padding-bottom",this.editor.paddingBottom);this.editor.$controlGroup.remove();this.editor.removed=true;this.editor=undefined;d.outerWidth(a);c.show();}finally{this.editing=false;}this.focus();}},flushEditor:function(){if(this.editor&&this.editing)this.editor.change_field_text();},showEditor:function(){var b,c,d,e,f=this.itemRow();if(f&&!this.editing&&this.selectedField&&this.item.record_count()){if(!this.item.is_changing())this.item.edit();this.editMode=true;this.editor=new t(this,this.selectedField);this.editor.$controlGroup.find('.controls, .input-prepend, .input-append, input').css('margin-bottom',0);this.editor.$controlGroup.css('margin-bottom',0);d=f.find('div.'+this.editor.field.field_name);d.hide();e=f.find('td.'+this.editor.field.field_name);this.editor.$input.css('font-size',e.css('font-size'));b=e.outerWidth();this.editor.paddingLeft=e.css("padding-left");this.editor.paddingTop=e.css("padding-top");this.editor.paddingRight=e.css("padding-right");this.editor.paddingBottom=e.css("padding-bottom");this.editor.padding=e.css("padding");e.css("padding",0);e.outerWidth(b);e.append(this.editor.$controlGroup);b=0;this.editor.$input.parent().children('*').each(function(){b+=a(this).outerWidth(true);});this.editor.$input.width(this.editor.$input.width()+this.editor.$controlGroup.width()-b);this.editor.update();if(this.is_focused())if(this.editor.$input.modalCanFocus())this.editor.$input.focus();this.editing=true;}},height:function(a){if(a===undefined)return this.$element.height();else this.$scroll_div.height(a-(this.$element.height()-this.$scroll_div.height()));},fillTitle:function(b){var c,d,e,f,g,h,i,j,k,l={},m='',n;if(b===undefined)b=this.$element;d=this._sorted_fields.length;for(c=0;c<d;c++)try{k=this._sorted_fields[c][1];e=this.item.field_by_ID(this._sorted_fields[c][0]);if(k)l[e.field_name]='icon-arrow-down';else l[e.field_name]='icon-arrow-up';}catch(o){}f=b.find("table.outer-table thead tr:first");f.empty();if(this.options.multi_select){if(this.options.multi_select_select_all)i=a('<input class="multi_select" type="checkbox">');else if(this.options.multi_select_title)m=this.options.multi_select_title;g=a('<div class="text-center multi_select" style="overflow: hidden">'+m+'</div>');if(i)g.append(i);h=a('<th class="bottom-border multi_select"></th>').append(g);n=this.getCellWidth('multi_select');if(n&&this.fields.length){h.width(n);g.width(n);}f.append(h);}d=this.fields.length;for(c=0;c<d;c++){e=this.fields[c];g=a('<div class="text-center '+e.field_name+'" style="overflow: hidden"><p style="vertical-align: middle; margin: 0;">'+e.field_caption+'</p></div>');h=a('<th class="'+e.field_name+'" data-field_name="'+e.field_name+'" bottom-border"></th>').append(g);if(!this.options.title_word_wrap){g.css('height',this.textHeight);h.css('height',this.textHeight);}n=this.getCellWidth(e.field_name);if(n&&(c<this.fields.length-1)){h.width(n);g.width(n);}if(l[e.field_name]){h.find('p').append('<i class="'+l[e.field_name]+'"></i>');h.find('i').css('margin-left',2);}f.append(h);}if(this.options.title_callback)this.options.title_callback(f,this.item);},createFooter:function(b){var c,d,e,f,g,h,i;if(b===undefined)b=this.$element;f=b.find("table.outer-table tfoot tr:first");f.empty();if(this.options.multi_select){g=a('<div class="text-center multi_select" style="overflow: hidden"></div>');h=a('<th class="multi_select"></th>').append(g);f.append(h);}d=this.fields.length;for(c=0;c<d;c++){e=this.fields[c];g=a('<div class="text-center '+e.field_name+'" style="overflow: hidden">&nbsp</div>');h=a('<th class="'+e.field_name+'"></th>').append(g);f.append(h);}if(!this.options.show_footer)f.hide();},show_footer:function(){this.$element.find("table.outer-table tfoot tr:first").show();},hideFooter:function(){this.$element.find("table.outer-table tfoot tr:first").hide();},getCellWidth:function(a){return this.cellWidths[a];},setCellWidth:function(a,b){this.cellWidths[a]=b;},init_table:function(){if(this.item._pg_offset===0){this.initFields();this._sorted_fields=this.item._open_params.__order;if(this.item.paginate){this.page=0;this.updatePageInfo();this.updatePageCount();}else this.fieldWidthUpdated=false;}this.refresh();},form_closing:function(){var a=this.$element.closest('.modal');if(a)return a.data('_closing');return false;},update:function(a){var b,c=this,e;if(this.form_closing())return;switch(a){case d.UPDATE_OPEN:this.init_table();break;case d.UPDATE_CANCEL:this.refreshRow();break;case d.UPDATE_APPEND:e=this.addNewRow();this.$table.append(e);this.syncronize();this.syncColWidth();if(this.item.controls_enabled()&&this.item.record_count()===1)this.build();break;case d.UPDATE_INSERT:e=this.addNewRow();this.$table.prepend(e);this.syncronize();this.syncColWidth();break;case d.UPDATE_DELETE:this.deleteRow();break;case d.UPDATE_SCROLLED:this.syncronize();break;case d.UPDATE_CONTROLS:this.syncronize();break;case d.UPDATE_CLOSE:this.$table.empty();break;case d.UPDATE_REFRESH:this.build();break;}},update_field:function(a,b){var c=this.itemRow(),d,e,f;if(this.item.active&&this.item.controls_enabled()&&this.item.record_count()){f=c.find('div.'+a.field_name+' span');e=this.get_field_text(a);if(e!==f.text()){f.text(e);d=(this.$table.get(0).clientWidth>this.$scroll_div.innerWidth())||(this.$table.get(0).clientWidth>this.$element.innerWidth())||(this.$head.find('th.'+a.field_name).outerWidth()!==c.find('td.'+a.field_name).outerWidth()&&a!==this.fields[this.fields.length-1])||(f.get(0)&&f.get(0).clientWidth!==f.get(0).scrollWidth)||(this.item.is_new()&&this.item.record_count()===1);if(d)if(this.item.record_count()<100)this.build();else this.syncColWidth();if(!b)this.update_selected(c);}}},syncColWidth:function(){var a,b,c,d,e,f=this.fields.length;if(this.item.record_count()){a=this.$table.find("tr:first-child");if(this.options.multi_select){c=this.$head.find('th.'+'multi_select');d=a.find('td.'+'multi_select');d.width(c.width());}for(e=0;e<f-1;e++){b=this.fields[e];c=this.$head.find('th.'+b.field_name);d=a.find('td.'+b.field_name);d.find('div').width(c.find('div').width());d.width(c.width());}}},update_selected:function(a){var b,c=false;if(!a)a=this.itemRow();if(this.options.multi_select&&this.options.multi_select_get_selected){if(this.options.multi_select_get_selected.call(this.item,this.item))c=true;b=a.find('input.multi_select');if(b.length)b[0].checked=c;}if(this.options.row_callback)this.options.row_callback(a,this.item);},deleteRow:function(){var a=this.itemRow();a.remove();this.syncColWidth();},itemRow:function(){if(this.item.record_count())try{var b=this.item.rec_controls_info(),c=a(b[this.id]);this.update_selected(c);return c;}catch(d){console.log(d);}},refreshRow:function(){var a=this;this.each_field(function(b,c){a.update_field(b,true);});},do_on_edit:function(a){if(this.item.lookup_field)this.item.set_lookup_field_value();else if(!this.options.editable||(!this.editMode&&a)){if(this.on_dblclick)this.on_dblclick.call(this.item,this.item);else if(this.options.dblclick_edit)this.item.edit_record();}else if(!this.editMode&&!a&&this.options.editable)this.showEditor();},clicked:function(b,c){var d,e,f=a(c).parent();if(this.options.editable)this.setSelectedField(this.item.field_by_name(a(c).data('field_name')));d=this.item._records.indexOf(f.data("record"));if(this.editMode&&d!==this.item.rec_no){if(!this.item.is_edited())this.item.edit();this.flushEditor();this.item.post();}this.item.set_rec_no(d);if(!this.editing&&!this.is_focused())this.focus();if(b.type==="dblclick")this.do_on_edit(true);},hide_selection:function(){if(this.selected_row)if(this.options.editable&&this.selectedField){this.selected_row.removeClass("selected-focused selected");this.selected_row.find('td.'+this.selectedField.field_name).removeClass("field-selected-focused field-selected");}else this.selected_row.removeClass("selected-focused selected");},show_selection:function(){var a='selected',b='field-selected';if(this.is_focused()){a='selected-focused';b='field-selected-focused';}if(this.selected_row)if(this.options.editable&&this.selectedField){this.selected_row.addClass(a);this.selected_row.find('td.'+this.selectedField.field_name).removeClass(a).addClass(b);}else this.selected_row.addClass(a);},select_row:function(a){var b,c=this.textHeight,d=this.rowHeight,e='selected';this.update_selected_row(a);if(this.is_focused())e='selected-focused';this.hide_selection();if(this.selected_row&&this.options.expand_selected_row&&this.options.row_line_count===1)this.selected_row.find('tr, div').css('height',c);this.selected_row=a;this.show_selection();if(this.options.expand_selected_row&&this.options.row_line_count===1){b=this.selected_row.find('tr, div');b.css('height','');if(b.eq(0).height()<this.options.expand_selected_row*c)b.eq(0).css('height',this.options.expand_selected_row*c);}},update_selected_row:function(a){var b,c,d,e;if(a.length){b=this.$scroll_div.scrollTop();c=b+this.$scroll_div.height();d=a.get(0).offsetTop;e=d+a.height();if(d<b)this.$scroll_div.scrollTop(d);else if(e>c)this.$scroll_div.scrollTop(e-this.$scroll_div.height());}},syncronize:function(){var a=this,b,c;if(this.item.controls_enabled()&&this.item.record_count()>0){c=this.itemRow();b=!this.selected_row||(this.selected_row&&c&&this.selected_row.get(0)!==c.get(0));if(b&&this.options.editable)this.hideEditor();try{this.select_row(this.itemRow());}catch(d){}if(b&&this.options.editable&&this.editMode){clearTimeout(this.editorsTimeOut);this.editorsTimeOut=setTimeout(function(){a.showEditor();},75);}}},get_field_text:function(a){return a.get_lookup_data_type()===d.BOOLEAN?a.get_lookup_value()?'Ã—':'':a.get_display_text();},keydown:function(a){var b=this,c=(a.keyCode?a.keyCode:a.which);if(!a.ctrlKey&&!a.shiftKey)switch(c){case 33:case 34:case 35:case 36:case 38:case 40:a.preventDefault();this.flushEditor();this.hideEditor();if(c===33)this.priorPage();else if(c===34)if(this.item.paginate&&this.item.is_loaded)this.item.last();else this.nextPage();else if(c===38){this.item.prior();if(this.item.bof())this.priorPage(function(){b.item.last();});}else if(c===40){this.item.next();if(this.item.eof())if(this.options.editable&&this.options.append_on_lastrow_keydown)this.item.append();else this.nextPage();}else if(c===36)this.firstPage();else if(c===35)this.lastPage();break;case 37:if(this.options.editable&&!this.editMode)this.priorField();break;case 39:if(this.options.editable&&!this.editMode)this.nextField();break;}},keyup:function(a){var b=this,c,d=(a.keyCode?a.keyCode:a.which);if(a.target===this.$table.get(0)&&!a.ctrlKey&&!a.shiftKey)switch(d){case 13:a.preventDefault();this.do_on_edit(false);break;case 33:case 34:case 35:case 36:case 38:case 40:a.preventDefault();break;case 32:a.preventDefault();if(this.options.multi_select_set_selected){c=this.itemRow().find('input.multi_select');if(c.length){c[0].checked=!c[0].checked;this.options.multi_select_set_selected.call(this.item,this.item,c[0].checked);}}break;}},keypress:function(a){var b=this,c,d=a.which;if(d>32&&this.options.editable&&this.options.keypress_edit&&!this.editMode)if(this.selectedField&&this.selectedField.valid_char_code(d))this.showEditor();},setPageNumber:function(a,b){var c=this;if(!this.item.paginate||this.loading)return;if(a<this.pageCount||a===0){this.page=a;this.loading=true;this.item.open({offset:this.page*this.item._pg_limit},function(){if(b)b.call(c);c.loading=false;c.updatePageInfo();});}},reload:function(a){if(this.item.paginate)this.setPageNumber(this.page,a);else this.open(a);},updatePageInfo:function(){this.$pageInput.val(this.page+1);if(this.page===0){this.$fistPageBtn.addClass("disabled");this.$priorPageBtn.addClass("disabled");}else{this.$fistPageBtn.removeClass("disabled");this.$priorPageBtn.removeClass("disabled");}if(this.item.is_loaded){this.$lastPageBtn.addClass("disabled");this.$nextPageBtn.addClass("disabled");}else{this.$lastPageBtn.removeClass("disabled");this.$nextPageBtn.removeClass("disabled");}},updatePageCount:function(a){var b=this;this.item.total_records(function(a){b.recordCount=a;b.pageCount=Math.ceil(a/b.row_count);b.$pageCount.text(c.of+' '+b.pageCount);if(b.options.on_pagecount_update)b.options.on_pagecount_update.call(b.item,b.item,b);});},firstPage:function(a){if(this.item.paginate)this.setPageNumber(0,a);else this.item.first();},nextPage:function(a){var b,c;if(this.item.paginate){if(!this.item.is_loaded)this.setPageNumber(this.page+1,a);}else{c=this.item.clone();c.set_rec_no(this.item.get_rec_no());b=this.$scroll_div.innerHeight()/this.rowHeight-1;for(var d=0;d<b;d++)if(!c.eof())c.next();else break;this.item.set_rec_no(c.get_rec_no());}},priorPage:function(a){var b,c;if(this.item.paginate)if(this.page>0)this.setPageNumber(this.page-1,a);else this.syncronize();else{c=this.item.clone();c.set_rec_no(this.item.get_rec_no());b=this.$scroll_div.innerHeight()/this.rowHeight-1;for(var d=0;d<b;d++)if(!c.eof())c.prior();else break;this.item.set_rec_no(c.get_rec_no());}},lastPage:function(a){var b=this;if(this.item.paginate){this.item.total_records(function(d){b.recordCount=d;b.pageCount=Math.ceil(d/b.row_count);b.$pageCount.text(c.of+' '+b.pageCount);b.setPageNumber(b.pageCount-1,a);if(b.options.on_pagecount_update)b.options.on_pagecount_update.call(this.item,this.item,this);});}else this.item.last();},each_field:function(a){var b=0,c=this.fields.length,d;for(;b<c;b++){d=a.call(this.fields[b],this.fields[b],b);if(d===false)break;}},addNewRow:function(){var b=a(this.newRow()),c=this.item.get_rec_no(),d;b.data("record",this.item._records[c]);d=this.item.rec_controls_info();d[this.id]=b.get();if(this.options.row_callback)this.options.row_callback(b,this.item);return b;},newColumn:function(a,b,c,d,e){var f=this.getCellWidth(a),g='class="'+a+'"',h='data-field_name="'+a+'"',i='style="text-align:'+b+';overflow: hidden'+'"',j='style="overflow: hidden';if(this.textHeight&&this.options.row_line_count>=1)j+='; height: '+this.options.row_line_count*this.textHeight+'px';if(e&&f&&(d<this.fields.length-1))j+='; width: '+f+'px';j+='"';return '<td '+g+' '+h+' '+i+'>'+'<div '+g+' '+j+'>'+'<span '+j+'>'+c+'</span>'+'</div>'+'</td>';},newRow:function(){var a,b,c,f,g,h,i,j='',k=!this.autoFieldWidth||(this.autoFieldWidth&&this.fieldWidthUpdated);c=this.fields.length;i='';if(this.options.multi_select){if(this.options.multi_select_get_selected)if(this.options.multi_select_get_selected.call(this.item,this.item))j='checked';i+=this.newColumn('multi_select','center','<input class="multi_select" type="checkbox" '+j+'>',-1,k);}for(b=0;b<c;b++){f=this.fields[b];a=this.item[f.field_name];if(!(a instanceof n))a=this.item.field_by_name(f.field_name);h=this.get_field_text(a);g=a.data_type===d.BOOLEAN?'center':e[a.alignment];i+=this.newColumn(a.field_name,g,h,b,k);}return '<tr class="inner">'+i+'</tr>';},getElementWidth:function(a){if(!a.length)return 0;if(a.is(':visible'))return a.width();else return this.getElementWidth(a.parent());},refresh:function(b){var c,d,e,f,g,h,i,j,k,l,m,n='',o,p,q=[],r,s,t=this.$table.is(':visible'),u,v=this.item.clone(),w=a('<div>');s=this.is_focused();if(this.options.editable&&this.editMode&&this.editor){if(!s)s=this.editor.$input.is(':focus');u=this.editor.$input.value;this.hideEditor();}w.css("position","absolute").css("top",-1000).width(this.getElementWidth(this.$element));a('body').append(w);this.$outer_table.detach();w.append(this.$outer_table);this.$table.empty();this.$head.empty();this.$foot.hide();this.$outer_table.find('#top-td').attr('colspan',this.colspan);v.on_get_field_text=this.item.on_get_field_text;m='';p=this.item.rec_no;try{while(!v.eof()){this.item._cur_row=v._cur_row;m+=this.newRow();q.push(v.get_rec_no());v.next();}this.$table.html(m);m=this.$table.find("tr");d=m.length;for(c=0;c<d;c++){f=m.eq(c);o=q[c];v.set_rec_no(o);this.item._cur_row=o;f.data("record",v._records[o]);r=v.rec_controls_info();r[this.id]=f.get();if(this.options.row_callback)this.options.row_callback(f,this.item);}}finally{this.item._cur_row=p;}f=this.$table.find("tr:first");if(this.autoFieldWidth&&!this.fieldWidthUpdated){this.$table.css('table-layout','auto');this.$outer_table.css('table-layout','auto');g='<tr>';if(this.options.multi_select){if(this.options.multi_select_title)n=this.options.multi_select_title;g=g+'<th class="multi_select">'+'<div class="text-center multi_select" style="overflow: hidden">'+n+'</div>'+'</th>';}d=this.fields.length;for(c=0;c<d;c++)g=g+'<th class="'+this.fields[c].field_name+'" ><div style="overflow: hidden">'+this.fields[c].field_caption+'</div></th>';g=a(g+'</tr>');this.$table.prepend(g);if(this.options.multi_select)if(this.options.multi_select_colum_width)g.find(".multi_select").css("width",this.options.multi_select_colum_width);else g.find(".multi_select").css("width",'3%');for(var x in this.options.column_width)if(this.options.column_width.hasOwnProperty(x))g.find("."+x).css("width",this.options.column_width[x]);if(this.options.multi_select){h=f.find("td."+'multi_select');this.setCellWidth('multi_select',h.width());}for(c=0;c<d;c++){e=this.fields[c];h=f.find("td."+e.field_name);this.setCellWidth(e.field_name,h.width());}this.$table.css('table-layout','fixed');this.$outer_table.css('table-layout','fixed');this.fillTitle(w);if(this.options.multi_select){h=f.find("td."+'multi_select');j=this.$head.find("th."+'multi_select');k=this.$foot.find("th."+'multi_select');i=this.getCellWidth('multi_select');h.find('div').width(i);h.width(i);j.find('div').width(i);j.width(i);k.find('div').width(i);k.width(i);}for(c=0;c<d;c++){e=this.fields[c];if(c<this.fields.length-1){h=f.find("td."+e.field_name);j=this.$head.find("th."+e.field_name);k=this.$foot.find("th."+e.field_name);i=this.getCellWidth(e.field_name);h.find('div').width(i);h.width(i);j.find('div').width(i);j.width(i);k.find('div').width(i);k.width(i);}}if(this.item.record_count()>0&&t)this.fieldWidthUpdated=true;g.remove();}else{this.fillTitle(w);this.syncColWidth();}if(this.options.show_footer)this.$foot.show();this.$outer_table.detach();this.$element.append(this.$outer_table);w.remove();this.update_select_all_checkbox();this.syncronize();if(s)this.focus();if(this.options.editable&&this.editMode&&this.editor){this.showEditor();this.editor.$input.value=u;}if(b)b.call(this);},update_select_all_checkbox:function(){var a=this;if(this.options.multi_select_select_all)setTimeout(function(){a.$outer_table.find('th input.multi_select').prop('checked',a.$table.find('td input.multi_select').is(":checked"));},200);},build:function(){this.initFields();this.fieldWidthUpdated=false;this.refresh();this.syncColWidth();},is_focused:function(){return this.$table.get(0)===document.activeElement;},focus:function(){if(!this.is_focused())if(this.$table.modalCanFocus())this.$table.focus();}};function s(a){var b=this;this.field=a;this.read_only=false;}s.prototype={constructor:s,create_input:function(b,c,f){var g=this,h,i,j,k,l,m,n,o,p;if(!b)return;if(this.label)l=a('<label class="control-label"></label>').attr("for",b.field_name).text(this.label).addClass(b.field_name);if(b.get_lookup_data_type()===d.BOOLEAN)m=a('<input>').attr("id",b.field_name).attr("type","checkbox").attr("tabindex",c+"").click(function(a){g.field.value=!g.field.value;});else if(b.data_type===d.INTEGER&&b.lookup_values){m=a('<select>');m.append('<option value="0"></option>');for(var q=0;q<b.lookup_values.length;q++)m.append('<option value="'+b.lookup_values[q][0]+'">'+b.lookup_values[q][1]+'</option>');m.attr("id",b.field_name).attr("tabindex",c+"");m.on('change',function(){var a=parseInt(m.val(),10);if(a===0)a=null;g.field.value=a;});}else if(b.get_lookup_data_type()===d.BLOB)m=a('<textarea>').attr("id",b.field_name).attr("tabindex",c+"").innerHeight(70);else m=a('<input>').attr("id",b.field_name).attr("type","text").attr("tabindex",c+"");o=a('<div></div>').addClass("controls");this.$input=m;this.$input.addClass(b.field_name);this.$input.addClass('dbinput');this.$input.data('dbinput',this);this.$input.focus(function(a){g.focusIn(a);});this.$input.blur(function(a){g.focusOut();});this.$input.mousedown(function(a){g.mouseIsDown=true;});this.$input.mouseup(function(a){if(!g.mouseIsDown)g.$input.select();g.mouseIsDown=false;});this.$input.keydown(a.proxy(this.keydown,this));this.$input.keyup(a.proxy(this.keyup,this));this.$input.keypress(a.proxy(this.keypress,this));if(b.lookup_item&&!b.master_field){p=a('<div class="input-prepend input-append"></div>').addClass("input-with-buttons");n=a('<button class="btn input-button" type="button"><i class="icon-remove-sign"></button>');n.attr("tabindex",-1);n.click(function(){b.set_value(null);});this.$firstBtn=n;p.append(n);p.append(m);n=a('<button class="btn input-button" type="button"><i class="icon-folder-open"></button>');n.attr("tabindex",-1);n.click(function(){g.selectValue();});this.$lastBtn=n;p.append(n);o.append(p);m.addClass("input-lookupitem");if(this.field.enable_typeahead)m.jamtypeahead(this.field.get_typeahead_defs(m));}else{switch(b.get_lookup_data_type()){case d.TEXT:if(this.field.lookup_values)m.addClass("input-select");else m.addClass("input-text");o.append(m);break;case d.INTEGER:m.addClass("input-integer");o.append(m);break;case d.FLOAT:m.addClass("input-float");o.append(m);break;case d.CURRENCY:m.addClass("input-currency");o.append(m);break;case d.DATE:case d.DATETIME:p=a('<div class="input-append"></div>').addClass("input-with-buttons");m.addClass("input-date");p.append(m);n=a('<button class="btn input-button" type="button"><i class="icon-calendar"></button>');n.attr("tabindex",-1);n.click(function(){g.showDatePicker();});this.$lastBtn=n;p.append(n);o.append(p);break;case d.BOOLEAN:o.append(m);break;case d.BLOB:m.addClass("input-text");o.append(m);break;}h=b.data_type===d.BOOLEAN?'center':e[b.alignment];this.$input.css("text-align",h);}if(this.label_on_top)this.$controlGroup=a('<div class="input-container"></div>');else this.$controlGroup=a('<div class="control-group input-container"></div>');if(this.label)this.$controlGroup.append(l);this.$controlGroup.append(o);if(f)f.append(this.$controlGroup);this.field.controls.push(this);this.$input.bind('destroyed',function(){g.field.controls.splice(g.field.controls.indexOf(g),1);});this.$input.on('mouseenter',function(){var b=a(this);if(g.error)b.tooltip('show');});this.$input.tooltip({'placement':'bottom','title':''}).on('hide',function(a){a.stopPropagation();}).on('hidden',function(a){a.stopPropagation();}).on('show',function(a){a.stopPropagation();}).on('shown',function(a){a.stopPropagation();});this.$modalForm=this.$input.closest('.modal');this.update();},form_closing:function(){if(this.$modalForm)return this.$modalForm.data('_closing');return false;},update:function(){var a=this.$input.is(':focus');if(this.field.field_kind===d.ITEM_FIELD)if(this.field.owner.record_count()===0){this.read_only=true;if(this.$firstBtn)this.$firstBtn.prop('disabled',this.read_only);if(this.$lastBtn)this.$lastBtn.prop('disabled',this.read_only);if(this.$input)this.$input.prop('disabled',this.read_only);return;}if(!this.removed&&!this.form_closing()){if(this.read_only!==this.field.get_read_only()){this.read_only=this.field.get_read_only();if(this.$firstBtn)this.$firstBtn.prop('disabled',this.read_only);if(this.$lastBtn)this.$lastBtn.prop('disabled',this.read_only);if(this.$input)this.$input.prop('disabled',this.read_only);}if(this.field.master_field){if(this.$firstBtn)this.$firstBtn.prop('disabled',true);if(this.$lastBtn)this.$lastBtn.prop('disabled',true);if(this.$input)this.$input.prop('disabled',true);}if(this.field.get_lookup_data_type()===d.BOOLEAN)if(this.field.get_lookup_value())this.$input.attr("checked","checked");else this.$input.removeAttr("checked","checked");if(this.field.lookup_values)this.$input.val(this.field.value+'');else if(a&&this.$input.val()!==this.field.get_text()||!a&&this.$input.val()!==this.field.get_display_text()){this.errorValue=undefined;this.error=undefined;if(a&&!this.field.lookup_item&&!this.field.lookup_values)this.$input.val(this.field.get_text());else this.$input.val(this.field.get_display_text());}this.updateState(true);}},keydown:function(a){var b=(a.keyCode?a.keyCode:a.which);if(this.field.lookup_item&&!this.field.enable_typeahead&&!(b===229||b===9||b==8))a.preventDefault();if(a.ctrlKey===true)if(b!==67&&b!==86&&b!==88&&b!=90&&b!=8&&b!=37&&b!=39)a.preventDefault();if(b===9)if(this.grid&&this.grid.editMode){a.preventDefault();if(a.shiftKey)this.grid.priorField();else this.grid.nextField();}},keyup:function(a){var b,c=(a.keyCode?a.keyCode:a.which);if(this.field.enable_typeahead){b=this.$input.data('jamtypeahead');if(b&&b.shown)return;}if(c===13&&!a.ctrlKey&&!a.shiftKey){if(this.grid&&this.grid.editMode){a.stopPropagation();a.preventDefault();if(!this.grid.item.is_changing())this.grid.item.edit();this.grid.flushEditor();this.grid.hideEditor();if(this.grid.item.is_changing())this.grid.item.post();}else if(this.field.lookup_item&&!this.field.enable_typeahead){a.stopPropagation();a.preventDefault();this.selectValue();}else if((this.field.data_type===d.DATE)||(this.field.data_type===d.DATETIME)){a.stopPropagation();a.preventDefault();this.showDatePicker();}}else if(c===27&&this.grid&&this.grid.editMode){a.stopPropagation();a.preventDefault();this.grid.item.cancel();this.grid.hideEditor();}},keypress:function(a){var b=a.which;if(this.field.lookup_item&&!this.field.enable_typeahead)a.preventDefault();if(this.$input.is('select')){}else if(b&&!this.field.valid_char_code(b))a.preventDefault();},showDatePicker:function(){var a=this,e;if(this.field.data_type===d.DATE)e=b.D_FMT;else if(this.field.data_type===d.DATETIME)e=b.D_T_FMT;this.$input.datepicker({weekStart:c.week_start,format:e,daysMin:c.days_min,months:c.months,monthsShort:c.months_short}).on('show',function(b){b.stopPropagation();a.$input.datepicker().attr('data-weekStart',1);}).on('hide',function(a){a.stopPropagation();}).on('changeDate',function(b){a.field.set_value(b.date);a.$input.datepicker('hide');});this.$input.datepicker('show');},selectValue:function(){if(this.field.on_entry_button_click)this.field.on_entry_button_click.call(this.item,this.field);else this.field.select_value();},change_field_text:function(){var a=true,b;if(this.field.owner&&this.field.owner.is_changing&&!this.field.owner.is_changing())this.field.owner.edit();this.errorValue=undefined;this.error=undefined;if(this.field.lookup_item){if(this.$input.val()!==this.field.get_lookup_text())this.$input.val(this.field.get_display_text());}else try{b=this.$input.val();if(b==='')this.field.set_value(null);else{this.field.set_text(b);this.field.check_valid();if(this.$input.is(':visible'))this.$input.val(b);}}catch(c){this.errorValue=b;this.error=c;this.updateState(false);if(this.field.owner&&this.field.owner.task.settings.DEBUGGING)throw 'change_field_text error: '+c;a=false;}return a;},focusIn:function(a){this.hideError();if(this.field.lookup_item&&!this.field.enable_typeahead)this.$input.val(this.field.get_display_text());else{if(this.errorValue)this.$input.val(this.errorValue);else if(this.field.lookup_item)this.$input.val(this.field.get_display_text());else this.$input.val(this.field.get_text());if(!this.mouseIsDown){this.$input.select();this.mouseIsDown=false;}}this.mouseIsDown=false;},focusOut:function(a){var b=false;if(this.grid&&this.grid.editMode)if(this.grid.item.is_changing()){this.grid.flushEditor();this.grid.item.post();}if(this.field.data_type===d.BOOLEAN)b=true;else if(this.field.lookup_values)b=true;else if(this.change_field_text()){if(this.$input.is(':visible'))this.$input.val(this.field.get_display_text());b=true;}this.updateState(b);return b;},updateState:function(a){if(a){if(this.$controlGroup)this.$controlGroup.removeClass('error');this.errorValue=undefined;this.error=undefined;this.$input.tooltip('hide').attr('data-original-title','').tooltip('fixTitle');this.hideError();}else{this.showError();if(this.$controlGroup)this.$controlGroup.addClass('error');this.$input.tooltip('hide').attr('data-original-title',this.error).tooltip('fixTitle');}},showError:function(a){},hideError:function(a){},focus:function(){this.$input.focus();}};t.prototype=new s();t.prototype.constructor=t;function t(a,b){s.call(this,b);this.grid=a;this.create_input(b,0);this.$input.attr("autocomplete","off");this.$input.addClass('dbtableinput');}a.extend(t.prototype,{});u.prototype=new s();u.prototype.constructor=u;function u(a,b,c,d,e){s.call(this,a);if(this.field.owner&&this.field.owner.edit_form&&this.field.owner.edit_form.hasClass("modal"))this.$edit_form=this.field.owner.edit_form;this.label=e;this.label_on_top=d;if(!this.label)this.label=this.field.field_caption;this.create_input(a,b,c);}a.extend(u.prototype,{showError:function(a){if(this.$edit_form&&this.$edit_form.hasClass("normal-modal-border")){this.$edit_form.removeClass("nomal-modal-border");this.$edit_form.addClass("error-modal-border");}},hideError:function(a){if(this.$edit_form&&this.$edit_form.hasClass("error-modal-border")){this.$edit_form.removeClass("error-modal-border");this.$edit_form.addClass("nomal-modal-border");}}});a.event.special.destroyed={remove:function(a){if(a.handler)a.handler();}};window.task=new h();window.task.constructors={task:h,group:i,item:k,detail:m};})(jQuery);