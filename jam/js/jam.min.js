(function(a){"use strict";var b,c,d={"RESPONSE":1,"NOT_LOGGED":2,"UNDER_MAINTAINANCE":3,"NO_PROJECT":4,"TEXT":1,"INTEGER":2,"FLOAT":3,"CURRENCY":4,"DATE":5,"DATETIME":6,"BOOLEAN":7,"BLOB":8,"KEYS":9,"ITEM_FIELD":1,"FILTER_FIELD":2,"PARAM_FIELD":3,"FILTER_EQ":1,"FILTER_NE":2,"FILTER_LT":3,"FILTER_LE":4,"FILTER_GT":5,"FILTER_GE":6,"FILTER_IN":7,"FILTER_NOT_IN":8,"FILTER_RANGE":9,"FILTER_ISNULL":10,"FILTER_EXACT":11,"FILTER_CONTAINS":12,"FILTER_STARTWITH":13,"FILTER_ENDWITH":14,"FILTER_CONTAINS_ALL":15,"ALIGN_LEFT":1,"ALIGN_CENTER":2,"ALIGN_RIGHT":3,"STATE_INACTIVE":0,"STATE_BROWSE":1,"STATE_INSERT":2,"STATE_EDIT":3,"STATE_DELETE":4,"RECORD_UNCHANGED":null,"RECORD_INSERTED":1,"RECORD_MODIFIED":2,"RECORD_DELETED":3,"RECORD_DETAILS_MODIFIED":4,"REC_STATUS":0,"REC_CONTROLS_INFO":1,"REC_CHANGE_ID":2,"UPDATE_OPEN":0,"UPDATE_DELETE":1,"UPDATE_CANCEL":2,"UPDATE_APPEND":3,"UPDATE_INSERT":4,"UPDATE_SCROLLED":5,"UPDATE_CONTROLS":6,"UPDATE_CLOSE":7,"UPDATE_STATE":8,"UPDATE_APPLIED":9},e=['','left','center','right'],f=['eq','ne','lt','le','gt','ge','in','not_in','range','isnull','exact','contains','startwith','endwith','contains_all'],g=["ID","field_name","field_caption","data_type","required","lookup_item","master_field","lookup_field","lookup_field1","lookup_field2","view_visible","view_index","edit_visible","edit_index","_read_only","_expand","_word_wrap","field_size","default_value","is_default","calculated","editable","_alignment","lookup_values","multi_select","multi_select_all","enable_typeahead","field_help","field_placeholder","field_mask"],h=["filter_name","filter_caption","field_name","filter_type","multi_select_all","data_type","visible","filter_help","filter_placeholder"],i=["","text","integer","float",'currency',"date","datetime","boolean","blob","keys"];function j(a,b,c,d,e,f,g){if(e===undefined)e=true;this.owner=a;this.item_name=c||'';this.item_caption=d||'';this.visible=e;this.ID=b||null;this.item_type_id=f;this.item_type='';if(f)this.item_type=this.types[f-1];if(g)this.js_filename='js/'+g;this.from_options={left:undefined,top:undefined,close_focusout:false,transition:false,title:'',fields:[],close_button:true,close_caption:true,close_on_escape:true,show_history:false,print:false,refresh_button:false,tab_id:''};this.items=[];if(a){if(!a.find(c))a.items.push(this);if(!(c in a))a[c]=this;this.task=a.task;}}j.prototype={constructor:j,types:["root","users","roles","tasks",'task',"items","items","details","reports","item","item","detail_item","report","detail"],get_master_field:function(a,b){var c=0,d=a.length;for(;c<d;c++)if(a[c].ID==b)return a[c];},each_item:function(a){var b=0,c=this.items.length,d;for(;b<c;b++){d=a.call(this.items[b],this.items[b],b);if(d===false)break;}},all:function(a){var b=0,c=this.items.length;a.call(this,this);for(;b<c;b++)this.items[b].all(a);},find:function(a){var b=0,c=this.items.length;for(;b<c;b++)if(this.items[b].item_name===a)return this.items[b];},item_by_ID:function(a){var b;if(this.ID===a)return this;var c=0,d=this.items.length;for(;c<d;c++){b=this.items[c].item_by_ID(a);if(b)return b;}},addChild:function(a,b,c,d,e,f){var g;if(this.getChildClass){g=this.getChildClass();if(g)return new g(this,a,b,c,d,e,f);}},send_request:function(a,b,c){return this.task.process_request(a,this,b,c);},init:function(a){var b=0,c=a.items,d,e=c.length,f;for(;b<e;b++){f=c[b][1];d=this.addChild(f.id,f.name,f.caption,f.visible,f.type,f.js_filename);d._default_order=f.default_order;d._primary_key=f.primary_key;d._deleted_flag=f.deleted_flag;d._master_id=f.master_id;d._master_rec_id=f.master_rec_id;d._keep_history=f.keep_history;d.lock_on_edit=f.lock_on_edit;d.select_all=f.select_all;d.prototype_ID=f.prototype_ID;if(d.initAttr)d.initAttr(f);d.init(f);}},bind_items:function(){var a=0,b=this.items.length;if(this.bind_item)this.bind_item();for(;a<b;a++)this.items[a].bind_items();},script_loaded:function(){if(this.js_filename)return this.task._script_cache[this.js_filename];else return true;},_check_args:function(a){var b,c={};for(b=0;b<a.length;b++)c[typeof a[b]]=a[b];return c;},load_script:function(a,b,c){var d=this,e,f,g;if(a&&!this.task._script_cache[a]){g=document.createElement('script');f=document.getElementsByTagName('script')[0];e=a;g.src=e;g.type="text/javascript";g.async=true;f.parentNode.insertBefore(g,f);g.onload=function(){d.task._script_cache[a]=true;if(c)c.call(d,d);if(b)b.call(d,d);};}else if(b)b.call(d,d);},load_module:function(a){this.load_modules([this],a);},load_modules:function(a,b){var c=this,d=0,e=a.length,f,g=[],h=0,i=false,j=function(a){a.load_script(a.js_filename,function(){if(--h===0)if(b&&!i){i=true;b.call(c,c);}},function(){a.bind_handlers();});};for(;d<e;d++){f=a[d];if(!f.script_loaded())g.push(f);if(f.details&&f.each_detail)f.each_detail(function(a){if(!a.script_loaded())g.push(a);});}e=g.length;h=e;if(e)for(d=0;d<e;d++)j.call(g[d],g[d]);else if(b)b.call(this,this);},bind_handlers:function(){var a=task.events['events'+this.ID];this._events=[];for(var b in a)if(a.hasOwnProperty(b)){this[b]=a[b];this._events.push([b,a[b]]);}},bind_events:function(){var a=0,b=this.items.length;this.bind_handlers();for(;a<b;a++)this.items[a].bind_events();},view$:function(a){return this.view_form.find(a);},edit$:function(a){return this.edit_form.find(a);},filter$:function(a){return this.filter_form.find(a);},param$:function(a){return this.param_form.find(a);},can_view:function(){return this.task.has_privilege(this,'can_view');},_search_template:function(a,b){var c,d="."+a;if(b)d="."+a+"-"+b;c=this.task.templates.find(d);if(c.length)return c;},_parse_template:function(b){var c,d='$include(',e,f,g=b.html(),h='';b.empty();g=g.replace(/<!--(.*?)-->/g,"");while(true){c=g.indexOf(d);if(c!==-1){h+=g.slice(0,c);g=g.slice(c+d.length);c=g.indexOf(')');e=g.slice(0,c+1).replace(/[('")]/g,'');f=this.task.templates.find(e).clone();f=this._parse_template(f);h+=f.html();g=g.slice(c+1);}else{h+=g;break;}}return b.append(a(h));},find_template:function(a,b){var c,d,e,f=this;if(b.template_class)d=this._search_template(b.template_class);if(!d){if(f.item_type==="detail"){d=this._search_template(f.owner.item_name+"-"+f.item_name,a);if(!d)d=this._search_template(f.owner.owner.item_name+"-details",a);if(!d)d=this._search_template("default-details",a);if(!d)f=f.owner;}if(!d)while(true){e=f.item_name;d=this._search_template(f.item_name,a);if(d)break;f=f.owner;if(f===f.task)break;}}if(!d)d=this._search_template('default',a);if(d)c=d.clone();else this.warning(this.item_caption+': '+a+' form template not found.');return c;},server:function(b,c){var d=this._check_args(arguments),e=d['function'],f=d.boolean,g,h,i;if(c!==undefined&&(c===e||c===f))c=undefined;if(c===undefined)c=[];else if(!a.isArray(c))c=[c];if(e||f){this.send_request('server',[b,c],function(a){g=a[0];h=a[1];if(e)e.call(this,g,h);if(h)throw h;});}else{i=this.send_request('server',[b,c]);g=i[0];h=i[1];if(h)throw h;else return g;}},_focus_form:function(a){a.find(':input:enabled:visible').each(function(a){if(this.tabIndex!==-1){this.focus();return false;}});},_create_form_header:function(b,c,d,e){var f,g,h,i,j,k={title:this.item_caption,close_caption:true,close_button:true,print:false},l,m='';function n(a){var b=g.find('.modal-header');if(i){a.preventDefault();b.css('cursor','auto');g.css('margin-left',parseInt(g.css('margin-left'),10)+a.screenX-i);g.css('margin-top',parseInt(g.css('margin-top'),10)+a.screenY-j);i=a.screenX;j=a.screenY;}}function o(a){i=undefined;j=undefined;f.off("mousemove.modalform");f.off("mouseup.modalform");}if(this.task.templates)l=this.task.templates.find('.modal-header').clone();if(!l||!l.length){l=a('<div class="modal-header">'+'<div class="header-title"></div>'+'<div class="header-refresh-btn"></div>'+'<div class="header-history-btn"></div>'+'<div class="header-search">'+'</div>'+'<div class="header-print-btn"></div>'+'<div class="header-close-btn"></div>'+'</div>');l.find('.header-search').show();}if(d)if(this.master)m=this.master.item_name+'-'+this.item_name+' '+d+'-form';else m=this.item_name+' '+d+'-form';c=a.extend({},k,c);if(!c.title)c.title='&nbsp';if(e)if(this.task.add_form_borders){g=a('<div class="form-frame '+m+'" tabindex="-1">'+'</div>');g.append(l);}else{b.addClass('jam-form');return b;}else{g=a('<div class="modal form-frame hide normal-modal-border '+m+'" tabindex="-1" data-backdrop="static">'+'</div>');g.append(l);f=a(document);g.on("mousedown",".modal-header",function(a){i=a.screenX;j=a.screenY;f.on("mousemove.modalform",n);f.on("mouseup.modalform",o);});g.on("mousemove",".modal-header",function(b){a(this).css('cursor','move');});}this._set_form_options(g,c);g.append(b);g.addClass('jam-form');return g;},_set_form_options:function(a,b,d){var e=this,f=a.find('.modal-header'),g='',h='',i='',j='',k='',l='',m;if(b.close_button){if(c&&b.close_caption)g='&nbsp;'+c.close+' - [Esc]</small>';h='<button type="button" id="close-btn" class="close" tabindex="-1" aria-hidden="true" style="padding: 0px 10px;">'+g+' Ã—</button>';f.find('.header-close-btn').html(h);}if(c&&b.print){i='&nbsp;'+c.print+' - [Ctrl-P]</small>',j='<button type="button" id="print-btn" class="close" tabindex="-1" aria-hidden="true" style="padding: 0px 10px;">'+i+'</button>';f.find('.header-print-btn').html(j);}if(b.show_history&&this.keep_history&&task.history_item){l='<i id="history-btn" class="icon-film"></i>';f.find('.header-history-btn').html(l);}if(b.refresh_button){k='<i id="refresh-btn" class="icon-refresh"></i>';f.find('.header-refresh-btn').html(k);}f.find('.header-title').html('<h4 class="form-title">'+b.title+'</h4>');f.find("#close-btn").css('cursor','default').click(function(a){if(d)e._close_form(d);});f.find('#print-btn').css('cursor','default').click(function(b){if(a.find(".form-body").length)m=a.find(".form-body");else if(a.find(".modal-body").length)m=a.find(".modal-body");e.print_html(m);});f.find("#refresh-btn").css('cursor','default').click(function(a){e.open(true);});f.find('#history-btn').css('cursor','default').click(function(a){e.show_history();});},_close_modeless_form:function(a){var b=this;if(this[a])this._close_form(a);if(this[a]){this[a].bind('destroyed',function(){b._close_modeless_form(a);});throw this.item_name+" - can't close form";}},_active_form:function(b){var c=a(document.activeElement).closest('.jam-form');if(b.get(0)===c.get(0))return true;},_process_key_event:function(a,b,c){if(this._active_form(a))if(a._form_disabled){c.preventDefault();c.stopPropagation();c.stopImmediatePropagation();}else{if(c.which!==116)c.stopPropagation();if(b)b.call(this,c);}},_create_form:function(b,c){var d=this,e,f=b+'_form',g=this[b+'_options'],h;c.item_options=g;h=f+'.'+this.item_name;if(g.tab_id)h+='.'+g.tab_id;if(this[f]&&c.container)this._close_modeless_form(f);if(c.container)c.container.empty();e=a("<div></div>").append(this.find_template(b,g));e=this._create_form_header(e,g,b,c.container);this[f]=e;if(e){e.data('options',c);e.tabindex=1;if(c.container){a(window).on("keyup."+h,function(a){if(a.which===27&&g.close_caption){if(d._active_form(d[f]))d._close_form(f);}else d._process_key_event(d[f],c.onKeyUp,a);});a(window).on("keydown."+h,function(a){d._process_key_event(d[f],c.onKeyDown,a);});c.container.append(e);this[f].bind('destroyed',function(){d._close_modeless_form(f);});if(c.beforeShow)c.beforeShow.call(this);this._set_form_options(e,g,f);this._focus_form(e);if(c.onShown)c.onShown.call(this);}else if(e.hasClass("modal")){e.on("show",function(a){if(a.target===d[f].get(0)){a.stopPropagation();if(c.beforeShow)c.beforeShow.call(d,a);if(d[f].title)g.title=d[f].title;if(d[f].modal_width)g.width=d[f].modal_width;d._set_form_options(d[f],g,f);}});e.on("shown",function(a){if(a.target===d[f].get(0)){d._focus_form(d[f]);a.stopPropagation();if(c.onShown)c.onShown.call(d,a);}});e.on("hide",function(a){if(a.target===d[f].get(0)){var b=true;a.stopPropagation();if(c.onHide)b=c.onHide.call(d,a);if(b===false){a.preventDefault();d[f].data('_closing',false);}}});e.on("hidden",function(a){if(a.target===d[f].get(0)){a.stopPropagation();if(c.onHidden)c.onHidden.call(d,a);d[f].remove();d[f]=undefined;}});e.on("keydown."+h,function(a){d._process_key_event(d[f],c.onKeyDown,a);});e.on("keyup."+h,function(a){d._process_key_event(d[f],c.onKeyUp,a);});e.modal({item:this,form_name:f,item_options:g});}}},_close_form:function(b){var c=this,d=this[b],e,f,g;if(d){e=d.data('options'),g=b+'.'+this.item_name;if(e.item_options.tab_id)g+='.'+e.item_options.tab_id;d.data('_closing',true);if(d.hasClass('modal'))setTimeout(function(){d.modal('hide');},100);else{if(e&&e.onHide)f=e.onHide.call(c);if(f!==false){a(window).off("keydown."+g);a(window).off("keyup."+g);this[b]=undefined;e.onHidden.call(c);d.remove();}}}},_disable_form:function(a){if(a){a.css('pointer-events','none');a._form_disabled=true;}},_enable_form:function(a){if(a){a.css('pointer-events','auto');a._form_disabled=false;}},print_html:function(b){var c=window.frames.dummy,d=a("link[rel='stylesheet']"),e,f='<head>';d.each(function(a,b){f+='<link href="'+b.href+'" rel="stylesheet">';});f+='</head>';e=b.clone();c.document.write(f+'<body onload="window.print()">'+e.html()+'</body>');c.document.close();},message:function(b,c){var d=1,e=this,f={title:'',width:400,height:undefined,margin:undefined,buttons:undefined,default_button:undefined,print:false,text_center:false,button_min_width:100,center_buttons:false,close_button:true,close_on_escape:true},g,h,i='',j,k,l=a('<button type="button" class="btn">OK</button>'),m;if(b instanceof jQuery)b=b.clone();c=a.extend({},f,c);g=c.buttons;i='<div class="modal-body"></div>';if(!this.is_empty_obj(g))i+='<div class="modal-footer"></div>';j=this._create_form_header(a(i),c);k=j.find('.modal-body');if(c.margin)k.css('margin',c.margin);k.html(b);if(!c.title)j.find('.modal-header').remove();if(c.text_center)k.html(b).addClass("text-center");if(c.center_buttons)j.find(".modal-footer").css("text-align","center");j.find("#close-btn").click(function(a){j.modal('hide');});for(h in g)if(g.hasOwnProperty(h)){j.find(".modal-footer").append(l.clone().data('key',h).attr("tabindex",d).css("min-width",c.button_min_width).html(h).click(function(b){var c=a(this).data('key');setTimeout(function(){try{if(g[c])g[c].call(e);}catch(a){}j.modal('hide');},0);}));d++;}j.on("show hide hidden",function(a){if(a.target===j.get(0))a.stopPropagation();});j.on("shown",function(a){if(a.target===j.get(0)){e._focus_form(j);a.stopPropagation();}});j.on("keyup keydown",function(b){var c;b.stopPropagation();if(b.which===37||b.which===39){c=jQuery.Event(b.type);c.which=b.which+1;a(b.target).trigger(c);}else if(b.which===80&&b.ctrlKey){b.preventDefault();e.print_html(j.find(".modal-body"));}});j.modal({width:c.width,height:c.height,keyboard:c.close_on_escape});return j;},question:function(b,d,e,f){var g={},h={buttons:g,margin:"40px 20px",text_center:true,center_buttons:true};f=a.extend({},h,f);g[c.yes]=d;g[c.no]=e;return this.message(b,f);},warning:function(b,c,d){var e={"OK":c},f={buttons:e,margin:"40px 20px",text_center:true,center_buttons:true};d=a.extend({},f,d);return this.message(b,d);},show_message:function(a,b){return this.message(a,b);},hide_message:function(a){a.modal('hide');},yes_no_cancel:function(a,b,d,e){var f={};f[c.yes]=b;f[c.no]=d;f[c.cancel]=e;return this.message(a,{buttons:f,margin:"40px 20px",text_center:true,width:500,center_buttons:true});},display_history:function(b){var c=this,e='',f=a('<div class="accordion history-accordion" id="history_accordion">'),g,h,i={},j,k,l,m,n,o,p;if(c.master){h=c.master.copy({handlers:false}),g=h.item_by_ID(c.ID);h.open({open_empty:true});h.append();}else g=c.copy({handlers:false,details:false});g.open({open_empty:true});g.append();b.each(function(b){var e=a('<div class="accordion-group history-group">'+'<div class="accordion-heading history-heading">'+'<a class="accordion-toggle history-toggle" data-toggle="collapse" data-parent="#history_accordion" href="#history_collapse'+b.rec_no+'">'+'</a>'+'</div>'+'<div id="history_collapse'+b.rec_no+'" class="accordion-body collapse">'+'<div class="accordion-inner history-inner">'+'</div>'+'</div>'+'</div>'),h,j='',k='',l,m,n,o,p,q,r;q=b.changes.value;if(q&&q[0]==='0'){q=q.substring(1);q=JSON.parse(q);}if(b.operation.value===d.RECORD_DELETED)k='<p>Record deleted</p>';else if(q){r=q;if(r)for(h=0;h<r.length;h++){o=g.field_by_ID(r[h][0]);n=1;if(r[h].length===3)n=2;if(o&&!o.system_field()){p=o.field_caption;if(o.lookup_item){if(!i[o.lookup_item.ID])i[o.lookup_item.ID]=[];o.set_data(r[h][n]);m=o.value;if(m){i[o.lookup_item.ID].push([o.lookup_field,m]);m='<span class="'+o.lookup_field+'_'+m+'">value is loading</span>';}}else{o.set_data(r[h][n]);m=o.display_text;if(o.raw_value===null)m=' ';}if(b.operation.value===d.RECORD_INSERTED)k+='<p>'+c.task.language.field+' <b>'+p+'</b>: '+c.task.language.new_value+': <b>'+m+'</b></p>';else if(b.operation.value===d.RECORD_MODIFIED)k+='<p>'+c.task.language.field+' <b>'+p+'</b>: '+c.task.language.new_value+': <b>'+m+'</b></p>';}}}if(b.user.value)j=c.task.language.by_user+' '+b.user.value;e.find('.accordion-toggle').html(b.date.format_date_to_string(b.date.value,'%d.%m.%Y %H:%M:%S')+': '+b.operation.display_text+' '+j);e.find('.accordion-inner').html(k);if(b.rec_no===0)e.find('.accordion-body').addClass('in');f.append(e);});if(b.record_count())e=f;p=c.task.message(e,{width:700,height:600,title:b.item_caption+': '+c.item_caption,footer:false,print:true});f=p.find('#history_accordion.accordion');for(var q in i)if(i.hasOwnProperty(q)){o=c.task.item_by_ID(parseInt(q,10));if(o){o=o.copy({handlers:false});j={};k={};k[o._primary_key]=true;for(var r=0;r<i[q].length;r++){k[i[q][r][0]]=true;j[i[q][r][1]]=true;}l=[];for(var s in j)if(j.hasOwnProperty(s))l.push(parseInt(s,10));m=[];for(var t in k)if(k.hasOwnProperty(t))m.push(t);n={};n[o._primary_key+'__in']=l;o.open({where:n,fields:m},function(){var a=this;a.each(function(a){a.each_field(function(b){if(!b.system_field())f.find("."+b.field_name+'_'+a._primary_key_field.value).text(b.value);});});});}}},show_history:function(){var a=this,b=this.ID,c=this.task.history_item.copy();if(this.master)b=this.prototype_ID;c.set_where({item_id:b,item_rec_id:this.field_by_name(this._primary_key).value});c.set_order_by(['-date']);c.open(function(){a.display_history(c);});},is_empty_obj:function(a){for(var b in a)if(a.hasOwnProperty(b))return false;return true;},emptyFunc:function(){},abort:function(a){a=a?' - '+a:'';throw 'execution aborted: '+this.item_name+a;},log_message:function(a){if(this.task.settings.DEBUGGING){a=a?' message: '+a:'';console.log(this.item_name+a);}}};k.prototype=new j();function k(a,b){var c=this;j.call(this,undefined,0,a,b,true);this.task=this;this.user_info={};this._script_cache={};this.gridId=0;this.events={};this.add_form_borders=true;this.constructors={task:k,group:l,item:n,detail:p};}a.extend(k.prototype,{constructor:k,consts:d,getChildClass:function(){return l;},process_request:function(b,e,f,g){var h=this,i=new Date().getTime(),j=false,k={},l="application/json;charset=utf-8",m;if(g)j=true;if(this.ajaxStatusCode)k=this.ajaxStatusCode;a.ajax({url:"api",type:"POST",contentType:l,async:j,cache:false,data:JSON.stringify([b,this.ID,e.ID,f,i]),statusCode:k,success:function(b){var f;if(b.error)console.log(b);else if(b.result.status===d.NO_PROJECT){a('body').empty();e.warning('Creating a project is not finished yet. Run the Application builder to finish.');return;}else if(b.result.status===d.UNDER_MAINTAINANCE){if(!h.task._under_maintainance){h.task._under_maintainance=true;if(c)f=c.website_maintenance;else f='Web site currently under maintenance.';e.warning(f,function(){h.task._under_maintainance=undefined;});}return;}else if(b.result.status===d.NOT_LOGGED){if(!h.logged_in)h.login();else location.reload();return;}else if(h.ID>0&&b.result.version&&h.version&&b.result.version!==h.version){if(!h.task._version_changed){h.task._version_changed=true;h.message('<h4>'+c.version_changed+'</h4>',{margin:'40px 40px',width:500,text_center:true});}return;}if(g)g.call(e,b.result.data);else m=b.result.data;},error:function(a,b,d){if(a.responseText&&h.ID!==0){document.open();document.write(a.responseText);document.close();}else if(c){if(!h.task._server_request_error){h.task._server_request_error=true;h.warning(c.server_request_error,function(){h.task._server_request_error=undefined;});}if(g)g.call(e,[null,'Server request error']);}},fail:function(a,b,c){console.log('ajax fail: ',a,b,c);}});if(m!==undefined)return m;},_byteLength:function(a){var b=a.length;for(var c=a.length-1;c>=0;c--){var d=a.charCodeAt(c);if(d>0x7f&&d<=0x7ff)b++;else if(d>0x7ff&&d<=0xffff)b+=2;if(d>=0xDC00&&d<=0xDFFF)c--;}return b;},do_upload:function(a,b,c){var d=this,e,f,g=[],h,i='',j=[],k=';',l=new XMLHttpRequest(),m=this.ID+';'+this.item_name;i+=m.length+';'+m+k;i+=b.length+k;i+=this._byteLength(a)+k;for(e=0;e<b.length;e++){f=b[e][0];h=b[e][1];i+=this._byteLength(f.name)+k;i+=h.byteLength+k;g.push(f.name);}j.push(i);j.push(a);for(e=0;e<b.length;e++){f=b[e][0];h=b[e][1];j.push(f.name);j.push(h);}l.open('POST','upload',true);if(c.callback)l.onload=function(a){if(c.multiple)c.callback.call(d,g);else c.callback.call(d,g[0]);};if(c.on_progress)l.upload.onprogress=function(a){c.on_progress.call(d,d,a);};var n=new Blob(j,{type:'application/octet-stream'});l.send(n);},upload:function(b,c){var d=this,e={callback:undefined,on_progress:undefined,extension:undefined,multiple:false},f=a('<input type="file" style="position: absolute; top: -100px"/>');c=a.extend({},e,c);if(c.multiple)f.attr('multiple','multiple');a('body').append(f);f.on('change',function(a){var e=a.target.files,g,h,i,j,k,l=[],m,n=[];for(g=0,j;j=e[g];g++){i='';if(c.extension){h=j.name.split('.');if(h.length)i=h[h.length-1];if(i!==c.extension)continue;}n.push(j);}for(g=0;g<n.length;g++){k=n[g];m=new FileReader();m.onload=(function(a){return function(e){l.push([a,e.target.result]);if(l.length===n.length)d.do_upload(b,l,c);};})(k);m.readAsArrayBuffer(k);}f.remove();});f.click();},load:function(){var a=this;this.send_request('connect',null,function(b){if(b)a.load_task();else a.login();});},login:function(){var b=this,c,d;if(this.templates)d=this.templates.find("#login-form").clone();else d=a("#login-form").clone();d=this._create_form_header(d,{title:d.data('caption'),transition:false});d.find("#login-btn").click(function(a){var c=d.find("#inputLoging").val(),e=d.find("#inputPassword").val(),f=hex_md5(e);a.preventDefault();if(c&&e)b.send_request('login',[c,f],function(a){if(a){if(d)d.modal('hide');b.load_task();}});});d.find("#close-btn").click(function(a){d.modal('hide');});d.on("shown",function(a){d.find("#inputLoging").focus();a.stopPropagation();});d.find('input').keydown(function(b){var c=a(this),e=(b.keyCode?b.keyCode:b.which);if(e===40)if(c.attr('id')==='inputLoging')d.find('#inputPassword').focus();else d.find('#login-btn').focus();});d.modal({width:500});},logout:function(){this.send_request('logout');location.reload();},load_task:function(){var e=this,f;this.send_request('load',null,function(f){var g=f[0],h=f[1],i;if(h){e.warning(h);return;}e.logged_in=true;b=g.settings;c=g.language;e.settings=g.settings;e.language=g.language;e.user_info=g.user_info;e.user_privileges=g.privileges;e.consts=d;e.safe_mode=e.settings.SAFE_MODE;e.version=e.settings.VERSION;e.ID=g.task.id;e.item_name=g.task.name;e.item_caption=g.task.caption;e.visible=g.task.visible;e.lookup_lists=g.task.lookup_lists;e.history_item=g.task.history_item;e.item_type="";if(g.task.type)e.item_type=e.types[g.task.type-1];if(g.task.js_filename)e.js_filename='js/'+g.task.js_filename;e.task=e;e.templates=a("<div></div>");i=a(".templates");e.templates=i.clone();i.remove();e.init(g.task);e.bind_items();if(e.ID===0){e.js_filename='jam/js/admin.js';e.settings.DYNAMIC_JS=false;}if(e.static_js_modules){e.bind_events();if(e.on_page_loaded)e.on_page_loaded.call(e,e);}else e.init_modules();if(e.history_item)e._set_history_item(e.item_by_ID(e.history_item));});},_set_history_item:function(a){var b=this,c;this.history_item=a;if(this.history_item){this.history_item.read_only=true;a.view_options.fields=['item_id','item_rec_id','date','operation','user'];if(!a.on_field_get_text)a.on_field_get_text=function(a){var e,f;if(a.field_name==='operation'){if(a.value===d.RECORD_INSERTED)return b.language.created;else if(a.value===d.RECORD_MODIFIED||a.value===d.RECORD_DETAILS_MODIFIED)return b.language.modified;else if(a.value===d.RECORD_DELETED)return b.language.deleted;}else if(a.field_name==='item_id'){f=b.item_by_ID(a.value);if(f){c=f.item_caption;return c;}}};this.history_item.edit_record=function(){var b=a.task.item_by_ID(a.item_id.value),c=a.task.history_item.copy();c.set_where({item_id:a.item_id.value,item_rec_id:a.item_rec_id.value});c.set_order_by(['-date']);c.open(function(){b.display_history(c);});};}},init_modules:function(){var a=this,b=0,c=false,d=function(a){if(a.js_filename)b++;},e=function(d){if(d.js_filename)d.load_script(d.js_filename,function(){if(--b===0){a.bind_events();if(a.on_page_loaded&&!c){c=true;a.on_page_loaded.call(a,a);}}});};if(this.settings.DYNAMIC_JS){b=1;e(this);}else{this.all(d);this.all(e);}},has_privilege:function(a,b){var c;if(a.task.ID===0)return true;if(!this.user_privileges||a.master)return true;else{if(!this.user_privileges)return false;try{c=this.user_privileges[a.ID];}catch(d){c=null;}if(c)return c[b];else return false;}},create_cookie:function(a,b,c){var d;if(c){var e=new Date();e.setTime(e.getTime()+(c*24*60*60*1000));d="; expires="+e.toGMTString();}else d="";document.cookie=escape(a)+"="+escape(b)+d+"; path=/";},read_cookie:function(a){var b=escape(a)+"=";var c=document.cookie.split(';');for(var d=0;d<c.length;d++){var e=c[d];while(e.charAt(0)===' ')e=e.substring(1,e.length);if(e.indexOf(b)===0)return unescape(e.substring(b.length,e.length));}return null;},erase_cookie:function(a){this.create_cookie(a,"",-1);},_tab_content:function(a){var b=a.find('a').attr('href').substr(1);return a.parent().parent().find('> div.tab-content > div.'+b);},_show_tab:function(a){var b=a.find('a').attr('href').substr(1),c,d=this._tab_content(a),e=a.parent().parent().parent();e.find('> .tabbable > div.tab-content > div.tab-pane').removeClass('active');d.addClass('active');e.find('> .tabbable > ul.nav-tabs > li').removeClass('active');a.addClass('active');c=d.data('active_el');if(c)c.focus();},show_tab:function(a,b){var c=a.find('> .tabbable > ul.nav-tabs > li a[href="#'+b+'"]');if(c.length)this._show_tab(c.parent());},_close_tab:function(a){var b=a.parent(),c=this._tab_content(a),d;this._show_tab(a);if(a.next().length)d=a.next();else d=a.prev();this._tab_content(a).remove();a.remove();if(d.length)this._show_tab(d);},close_tab:function(a,b){var c=a.find('> .tabbable > ul.nav-tabs > li a[href="#'+b+'"]');if(c.length)this._close_tab(c.parent());},init_tabs:function(b,c){var d=this,e;if(!c)c='tabs-top';e=a('<div class="tabbable '+c+'">');b.empty();b.append(e);if(c==='tabs-below'){e.append('<div class="tab-content">');e.append('<ul class="nav nav-tabs">');}else{e.append('<ul class="nav nav-tabs">');e.append('<div class="tab-content">');}},can_add_tab:function(a){return a.find('> .tabbable  > ul.nav-tabs').length>0;},add_tab:function(b,c,d){var e=this,f,g,h,i,j,k,l;if(!b.length)this.warning('Container must be specified.');if(!c)this.warning('Tab name must be specified.');if(!d)d={};if(this.can_add_tab(b)){g=b.find('> .tabbable > ul.nav-tabs');if(!d.tab_id)d.tab_id='tab'+g.find('> li').length+1;h=g.find('> li.active');k=g.find('> li a[href="#'+d.tab_id+'"]');if(k.length)k=k.parent();else{i=b.find('> .tabbable > div.tab-content');if(d.show_close_btn)c='<span> '+c+' </span><i class="icon-remove close-tab-btn"></i>';k=a('<li><a href="#'+d.tab_id+'">'+c+'</a></li>');g.append(k);l=a('<div class="tab-pane '+d.tab_id+'"></div>');i.append(l);k.on('click',function(b){b.preventDefault();b.stopPropagation();e._show_tab(a(this));});l.on('focusout',function(b){var c;a(b.target).parents().each(function(){if(this===l.get(0)){l.data('active_el',b.target);return false;}});});if(d.show_close_btn)k.on('click','.close-tab-btn',function(a){a.preventDefault();a.stopPropagation();if(d.on_close)d.on_close.call();else e.close_tab(b,d.tab_id);});}if(d.set_active||!h.length)this.show_tab(b,d.tab_id);return l;}}});l.prototype=new j();function l(a,b,c,d,e,f,g){j.call(this,a,b,c,d,e,f,g);}a.extend(l.prototype,{constructor:l,getChildClass:function(){if(this.item_type==="reports")return o;else return n;},add_item:function(a,b,c,d,e,j){var k,l,m,o,p,s,t;k=new n(this,-1,a,b,true,10);k.field_defs=[];for(var u=0;u<c.length;u++){t=[];for(var v=0;v<g.length;v++){l=g[v];if(l.charAt(0)==='_')l=l.substr(1);m=c[u][l];switch(l){case 'ID':m=u+1;break;case 'data_type':p=c[u].field_type;m=i.indexOf(p);if(m<1)m=1;o=m;break;case 'field_size':if(o===1&&!m)m=99999;break;case 'lookup_item':if(m){s=m;m=m.ID;}break;case 'lookup_field':break;}t.push(m);}k.field_defs.push(t);}for(u=0;u<k.field_defs.length;u++)new q(k,k.field_defs[u]);k.prepare_fields();k.filter_defs=[];for(u=0;u<d.length;u++){filter_def=[];for(var v=0;v<h.length;v++){l=h[v];m=d[u][l];switch(l){case 'filter_type':m=f.indexOf(m);break;}filter_def.push(m);}k.filter_defs.push(filter_def);}for(u=0;u<k.filter_defs.length;u++)new r(this,k.filter_defs[u]);k.prepare_filters();k.on_open=e;k.on_count=j;return k;}});function m(a){this.item=a;this._change_id=0;this.records=[];this.logs={};this.fields=[];this.expanded=true;}m.prototype={constructor:m,get_change_id:function(){this._change_id+=1;return this._change_id+'';},is_empty_obj:function(a){for(var b in a)if(a.hasOwnProperty(b))return false;return true;},log_changes:function(){if(this.item.master)return this.item.master.change_log.log_changes();else return this.item.log_changes;},find_record_log:function(){var a,b,c,d,e,f,g=[],h;if(this.item.master){b=this.item.master.change_log.find_record_log();if(b){c=b.details;d=c[this.item.ID];if(this.is_empty_obj(d)){f=this.item.fields.length;for(e=0;e<f;e++)g.push(this.item.fields[e].field_name);d={logs:{},records:this.item._dataset,fields:g,expanded:this.item.expanded};c[this.item.ID]=d;}this.logs=d.logs;this.records=d.records;this.fields=d.fields;this.expanded=d.expanded;}}if(this.item.record_count()){h=this.item._get_rec_change_id();if(!h){h=this.get_change_id();this.item._set_rec_change_id(h);}a=this.logs[h];if(this.is_empty_obj(a)){a={old_record:null,record:this.cur_record(),details:{}};this.logs[h]=a;}}return a;},get_detail_log:function(a){var b,c,d;c=this.find_record_log();d=c.details;if(!this.is_empty_obj(d))b=d[a];if(b===undefined&&this._is_delta)b={records:[],fields:[],expanded:false,logs:{}};return b;},remove_record_log:function(){var a=this.item._get_rec_change_id();if(a){this.find_record_log();delete this.logs[a];this.item._set_rec_change_id(null);this.item._set_record_status(d.RECORD_UNCHANGED);}},cur_record:function(){return this.item._dataset[this.item._get_rec_no()];},record_modified:function(a){var b=false,c=a.old_record,d=a.record;for(var e=0;e<this.item._record_lookup_index;e++)if(c[e]!==d[e]){b=true;break;}return b;},copy_record:function(a,b){var c=null,d;if(a){if(b===undefined)b=true;if(b)c=a.slice(0,this.item._record_info_index);else c=a.slice(0,this.item._record_lookup_index);d=this.item.get_rec_info(undefined,a);c.push([d[0],{},d[2]]);}return c;},can_log_changes:function(){var a=this.log_changes();if(this.item.item_state===d.STATE_EDIT){}},log_change:function(){var a;if(this.log_changes()){a=this.find_record_log();if(this.item.item_state===d.STATE_BROWSE){if((this.item._get_record_status()===d.RECORD_UNCHANGED)||(this.item._get_record_status()===d.RECORD_DETAILS_MODIFIED&&a.old_record===null)){a.old_record=this.copy_record(this.cur_record(),false);return;}}else if(this.item.item_state===d.STATE_INSERT)this.item._set_record_status(d.RECORD_INSERTED);else if(this.item.item_state===d.STATE_EDIT){if(this.item._get_record_status()===d.RECORD_UNCHANGED)this.item.record_status=d.RECORD_MODIFIED;else if(this.item._get_record_status()===d.RECORD_DETAILS_MODIFIED)if(this.record_modified(a))this.item._set_record_status(d.RECORD_MODIFIED);}else if(this.item.item_state===d.STATE_DELETE)if(this.item._get_record_status()===d.RECORD_INSERTED)this.remove_record_log();else this.item._set_record_status(d.RECORD_DELETED);else throw this.item.item_name+': change log invalid records state';if(this.item.master)if(this.item.master._get_record_status()===d.RECORD_UNCHANGED)this.item.master._set_record_status(d.RECORD_DETAILS_MODIFIED);}},get_changes:function(a){var b={},c,e,f=null,g,h,i,j,k,l,m,n;a.fields=this.fields;a.expanded=false;a.data=b;for(var o in this.logs)if(this.logs.hasOwnProperty(o)){c=this.logs[o];e=c.record;g=this.item.get_rec_info(undefined,e);if(g[d.REC_STATUS]!==d.RECORD_UNCHANGED){l=c.details;if(this.item.keep_history)f=c.old_record;h=this.copy_record(e,false);i={};for(var j in l)if(l.hasOwnProperty(j)){k=l[j];m={};n=this.item.item_by_ID(parseInt(j,10));n.change_log.logs=k.logs;n.change_log.get_changes(m);i[j]=m;}b[o]={record:h,details:i,old_record:f};}}},set_changes:function(a){var b=a.data,c,d,e,f,g,h;this.records=[];this.logs={};this.fields=a.fields;this.expanded=a.expanded;this._change_id=0;for(var i in b)if(b.hasOwnProperty(i)){c=b[i];if(this._change_id<parseInt(i,10))this._change_id=parseInt(i,10);d=c.record;this.records.push(d);f={};this.logs[i]={old_record:null,record:d,details:f};e=c.details;for(var j in e)if(e.hasOwnProperty(j)){g=e[j];h=this.item.item_by_ID(parseInt(j,10));h.change_log.set_changes(g);f[j]={logs:h.change_log.logs,records:h.change_log.records,fields:h.change_log.fields,expanded:h.change_log.expanded};}}},copy_records:function(a){var b=0,c=a.length,d=[];for(b=0;b<c;b++)d.push(a[b].slice(0));return d;},store_details:function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p;for(var q=0;q<this.item.details.length;q++){c=this.item.details[q];o=c.ID;n=a[o];f={};h=[];k=[];l=true;if(n){d=n.logs;g=n.records;k=n.fields;l=n.expanded;h=this.copy_records(g);for(var r in d)if(d.hasOwnProperty(r)){e=d[r];i=e.record;j=c.change_log.copy_record(i);m=g.indexOf(i);if(m!==-1)h[m]=j;p={};c.change_log.store_details(e.details,p);f[r]={old_record:e.old_record,record:j,details:p};}}else if(c._dataset)h=this.copy_records(c._dataset);b[o]={logs:f,records:h,fields:k,expanded:l};}},store_record_log:function(){var a,b,c,d;if(this.log_changes()){a=this.find_record_log();b={};this.store_details(a.details,b);d={};d.old_record=a.old_record;d.record=this.copy_record(a.record);d.details=b;}else{d={};d.record=this.copy_record(this.cur_record());b={};for(var e=0;e<this.item.details.length;e++){c=this.item.details[e];if(!c.disabled&&c._dataset)b[c.ID]=c._dataset.slice(0);}d.details=b;}return d;},restore_record_log:function(a){var b,c,e,f,g,h;if(this.log_changes()){b=this.find_record_log();c=a.record;g=this.cur_record();h=this.item._record_info_index;for(var i=0;i<h;i++)g[i]=c[i];b.old_record=a.old_record;b.record=g;b.details=a.details;for(var i=0;i<this.item.details.length;i++){e=this.item.details[i];f=a.details[e.ID];if(!this.is_empty_obj(f))e._dataset=f.records;}if(this.item._get_record_status()===d.RECORD_UNCHANGED)this.remove_record_log();}else{c=a.record;g=this.cur_record();h=this.item._record_info_index;for(var i=0;i<h;i++)g[i]=c[i];for(var i=0;i<this.item.details.length;i++){e=this.item.details[i];e._dataset=a.details[e.ID];}}},update:function(a,b){var c,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s;if(a){e=a.changes;for(var t in e)if(e.hasOwnProperty(t)){c=e[t];f=c.log_id;g=c.rec_id;i=c.details;j=this.logs[f];if(j){k=j.record;l=j.details;m=i.length;for(var u=0;u<m;u++){h=i[u];n=h.ID;o=this.item.detail_by_ID(parseInt(n,10));p=l[n];if(!this.is_empty_obj(p)){o.change_log.logs=p.logs;o.change_log.update(h,g);}}if(g)if(!k[this.item._primary_key_field.bind_index])k[this.item._primary_key_field.bind_index]=g;if(b)if(!k[this.item._master_rec_id_field.bind_index])k[this.item._master_rec_id_field.bind_index]=b;q=this.item.get_rec_info(undefined,k);q[d.REC_STATUS]=d.RECORD_UNCHANGED;q[d.REC_CHANGE_ID]=d.RECORD_UNCHANGED;delete this.logs[f];}}}},prepare:function(){var a=this,b,c=this.item.fields.length;if(this.item.master)a=this.item.master.change_log.get_detail_log(this.item.ID);if(a){a.records=[];a.logs={};a.fields=[];for(b=0;b<c;b++)if(!this.item.fields[b].master_field)a.fields.push(this.item.fields[b].field_name);a.expanded=this.item.expanded;}}};n.prototype=new j();function n(b,c,d,e,f,g,h){var i;j.call(this,b,c,d,e,f,g,h);if(this.task&&g!==0&&!(d in this.task))this.task[d]=this;this.field_defs=[];this._fields=[];this.fields=[];this.filter_defs=[];this.filters=[];this.details=[];this.controls=[];this.change_log=new m(this);this.paginate=false;this.disabled=false;this.expanded=true;this._log_changes=true;this._dataset=null;this._eof=false;this._bof=false;this._cur_row=null;this._old_row=0;this._old_status=null;this._buffer=null;this._modified=null;this._state=0;this._read_only=false;this._parent_read_only=true;this._active=false;this._disabled_count=0;this._open_params={};this._where_list=[];this._order_by_list=[];this._select_field_list=[];this._record_lookup_index=-1;this._record_info_index=-1;this._is_delta=false;this._limit=20;this._offset=0;this._selections=undefined;this.show_selected=false;this.selection_limit=1500;this.is_loaded=false;this.view_options=a.extend({},this.from_options);this.view_options.width=960;this.view_options.refresh_button=true;this.edit_options=a.extend({},this.from_options);this.filter_options=a.extend({},this.from_options);Object.defineProperty(this,"rec_no",{get:function(){return this._get_rec_no();},set:function(a){this._set_rec_no(a);}});Object.defineProperty(this,"rec_count",{get:function(){return this.get_rec_count();}});Object.defineProperty(this,"active",{get:function(){return this._get_active();}});Object.defineProperty(this,"read_only",{get:function(){return this._get_read_only();},set:function(a){this._set_read_only(a);}});Object.defineProperty(this,"filtered",{get:function(){return this._get_filtered();},set:function(a){this._set_filtered(a);}});Object.defineProperty(this,"item_state",{get:function(){return this._get_item_state();},set:function(a){this._set_item_state(a);}});Object.defineProperty(this,"record_status",{get:function(){return this._get_record_status();},set:function(a){this._set_record_status(a);}});Object.defineProperty(this,"default_field",{get:function(){return this.get_default_field();}});Object.defineProperty(this,"log_changes",{get:function(){return this._get_log_changes();},set:function(a){this._set_log_changes(a);}});Object.defineProperty(this,"dataset",{get:function(){return this.get_dataset();},set:function(a){this.set_dataset(a);}});Object.defineProperty(this,"selections",{get:function(){return this.get_selections();},set:function(a){this.set_selections(a);}});Object.defineProperty(this,"keep_history",{get:function(){return this.get_keep_history();}});}a.extend(n.prototype,{constructor:n,getChildClass:function(){return p;},initAttr:function(a){var b,c=a.fields,d=a.filters,e;if(c){e=c.length;for(b=0;b<e;b++){this.field_defs.push(c[b]);new q(this,c[b]);}}if(d){e=d.length;for(b=0;b<e;b++){this.filter_defs.push(d[b]);new r(this,d[b]);}}this.reports=a.reports;},bind_item:function(){var a=0,b,c;this.prepare_fields();this.init_options();this.prepare_filters();b=this.reports.length;c=this.reports;this.reports=[];for(a=0;a<b;a++)this.reports.push(this.task.item_by_ID(c[a]));},can_create:function(){if(this.master)return this.task.has_privilege(this.master,'can_create');else return this.task.has_privilege(this,'can_create');},can_edit:function(){if(this.master)return this.task.has_privilege(this.master,'can_edit');else return this.task.has_privilege(this,'can_edit');},can_delete:function(){if(this.master)return this.task.has_privilege(this.master,'can_delete');else return this.task.has_privilege(this,'can_delete');},prepare_fields:function(){var a=0,b=this._fields.length,c,d,e;for(;a<b;a++){c=this._fields[a];if(c.lookup_item&&(typeof c.lookup_item==="number")){c.lookup_item=this.task.item_by_ID(c.lookup_item);if(c.lookup_field&&(typeof c.lookup_field==="number")){d=c.lookup_item._field_by_ID(c.lookup_field);c.lookup_field=d.field_name;if(d.lookup_item&&c.lookup_field1){c.lookup_item1=d.lookup_item;if(typeof c.lookup_item1==="number")c.lookup_item1=this.task.item_by_ID(c.lookup_item1);if(typeof c.lookup_field1==="number"){e=c.lookup_item1._field_by_ID(c.lookup_field1);c.lookup_field1=e.field_name;}if(e.lookup_item&&c.lookup_field2){c.lookup_item2=e.lookup_item;if(typeof c.lookup_item2==="number")c.lookup_item2=self.task.item_by_ID(c.lookup_item2);if(typeof c.lookup_field2==="number")c.lookup_field2=c.lookup_item2._field_by_ID(c.lookup_field2).field_name;}}}}if(c.master_field&&(typeof c.master_field==="number"))c.master_field=this.get_master_field(this._fields,c.master_field);if(c.lookup_values&&(typeof c.lookup_values==="number"))c.lookup_values=self.task.lookup_lists[c.lookup_values];}this.fields=this._fields.slice(0);for(a=0;a<b;a++){c=this.fields[a];if(this[c.field_name]===undefined)this[c.field_name]=c;}},dyn_fields:function(a){var b,c,d,e,f,h,j;this._fields=[];this.fields=[];this.field_defs=[];for(var b=0;b<a.length;b++){j=[];for(var c=0;c<g.length;c++){d=g[c];if(d.charAt(0)==='_')d=d.substr(1);if(d==='data_type')d='field_type';e=a[b][d];switch(d){case 'ID':e=b+1;break;case 'field_type':f=a[b].field_type;e=i.indexOf(f);if(e<1)e=1;h=e;break;case 'field_size':if(h===1&&!e)e=99999;break;case 'lookup_item':if(e){lookup_item=e;e=e.ID;}break;}j.push(e);}this.field_defs.push(j);}for(b=0;b<this.field_defs.length;b++)new q(this,this.field_defs[b]);this.prepare_fields();},prepare_filters:function(){var a=0,b,c;b=this.filters.length;for(a=0;a<b;a++){c=this.filters[a].field;if(c.lookup_item&&(typeof c.lookup_item==="number"))c.lookup_item=this.task.item_by_ID(c.lookup_item);if(c.lookup_field&&(typeof c.lookup_field==="number"))c.lookup_field=c.lookup_item._field_by_ID(c.lookup_field).field_name;}},init_options:function(){var b,c=[],d=[],e=this._fields.length;for(b=0;b<e;b++){if(this._fields[b].view_visible&&this._fields[b].view_index!==-1)c.push(this._fields[b]);if(this._fields[b].edit_visible&&this._fields[b].edit_index!==-1)d.push(this._fields[b]);}c.sort(function(a,b){if(a.view_index>b.view_index===0)return 0;if(a.view_index>b.view_index)return 1;else return -1;});d.sort(function(a,b){if(a.edit_index>b.edit_index===0)return 0;if(a.edit_index>b.edit_index)return 1;else return -1;});this.view_options.fields=[];for(b=0;b<c.length;b++)this.view_options.fields.push(c[b].field_name);this.edit_options.fields=[];for(b=0;b<d.length;b++)this.edit_options.fields.push(d[b].field_name);this.edit_options.title=this.item_caption;this.view_options.title=this.item_caption;this._edit_options=a.extend({},this.edit_options);this._view_options=a.extend({},this.view_options);},each:function(a){var b;if(this._active){this.first();while(!this.eof()){b=a.call(this,this);if(b===false)break;else this.next();}}},each_field:function(a){var b=0,c=this.fields.length,d;for(;b<c;b++){d=a.call(this.fields[b],this.fields[b],b);if(d===false)break;}},each_filter:function(a){var b=0,c=this.filters.length,d;for(;b<c;b++){d=a.call(this.filters[b],this.filters[b],b);if(d===false)break;}},each_detail:function(a){var b=0,c=this.details.length,d;for(;b<c;b++){d=a.call(this.details[b],this.details[b],b);if(d===false)break;}},_field_by_name:function(a){return this.field_by_name(a,this._fields);},field_by_name:function(a,b){var c=0,d,e;if(b===undefined)b=this.fields;d=b.length;for(;c<d;c++)if(b[c].field_name===a)return b[c];return e;},_field_by_ID:function(a){return this.field_by_ID(a,this._fields);},field_by_ID:function(a,b){var c=0,d;if(b===undefined)b=this.fields;d=b.length;for(;c<d;c++)if(b[c].ID===a)return b[c];},filter_by_name:function(a){var b=0,c=this.filters.length;try{return this.filters[a];}catch(d){for(;b<c;b++)if(this.filters[b].filter_name===a)return this.filters[b];}},detail_by_name:function(a){var b=0,c=this.details.length;try{return this.details[a];}catch(d){for(;b<c;b++)if(this.details[b].item_name===a)return this.details[b];}},get_dataset:function(){var a,b,c=[];if(this.active){b=this._dataset.length;for(a=0;a<b;a++)c.push(this._dataset[a].slice(0,this._record_info_index));return c;}},set_dataset:function(a){this._dataset=a;},get_keep_history:function(){if(this.master)return this.master._keep_history;else return this._keep_history;},get_selections:function(){return this._selections;},set_selections:function(a){this._selections=a;this.update_controls();},copy:function(a){if(this.master)throw 'A detail item can not be copied.';return this._copy(a);},_copy:function(b){var c,d,e,f,g,h,i={filters:true,details:true,handlers:true};h=new n(this.owner,this.ID,this.item_name,this.item_caption,this.visible,this.item_type_id);h.master=this.master;h.item_type=this.item_type;b=a.extend({},i,b);h.ID=this.ID;h.item_name=this.item_name;h.expanded=this.expanded;h.field_defs=this.field_defs;h.filter_defs=this.filter_defs;h._primary_key=this._primary_key;h._deleted_flag=this._deleted_flag;h._master_id=this._master_id;h._master_rec_id=this._master_rec_id;h._default_order=this._default_order;h._edit_options=this._edit_options;h._view_options=this._view_options;h.edit_options=a.extend({},this._edit_options);h.view_options=a.extend({},this._view_options);h.prototype_ID=this.prototype_ID;h._keep_history=this._keep_history;h.select_all=this.select_all;e=h.field_defs.length;for(d=0;d<e;d++)new q(h,h.field_defs[d]);h.prepare_fields();if(b.filters){e=h.filter_defs.length;for(d=0;d<e;d++)new r(h,h.filter_defs[d]);h.prepare_filters();}h._events=this._events;if(b.handlers){e=this._events.length;for(d=0;d<e;d++)h[this._events[d][0]]=this._events[d][1];}if(b.handlers)for(var j in this)if(this.hasOwnProperty(j))if((j.substring(0,3)==="on_")&&(typeof this[j]==="function"))h[j]=this[j];if(b.details)this.each_detail(function(a,d){c=a._copy(b);c.owner=h;c.expanded=a.expanded;c.master=h;c.item_type=a.item_type;h.details.push(c);h.items.push(c);if(!(c.item_name in h))h[c.item_name]=c;if(!(c.item_name in h.details))h.details[c.item_name]=c;});return h;},clone:function(a){var b,c,e,f,g;if(a===undefined)a=true;b=new n(this.owner,this.ID,this.item_name,this.item_caption,this.visible,this.item_type_id);b.master=this.master;b.item_type=this.item_type;b.ID=this.ID;b.item_name=this.item_name;b.expanded=this.expanded;b.field_defs=this.field_defs;b.filter_defs=this.filter_defs;b._primary_key=this._primary_key;b._deleted_flag=this._deleted_flag;b._master_id=this._master_id;b._master_rec_id=this._master_rec_id;e=b.field_defs.length;for(c=0;c<e;c++)f=new q(b,b.field_defs[c]);b.prepare_fields();e=b.fields.length;for(c=0;c<e;c++){f=b.fields[c];if(b[f.field_name]!==undefined)delete b[f.field_name];}b.fields=[];e=this.fields.length;for(c=0;c<e;c++){f=this.fields[c];g=b._field_by_name(f.field_name);b.fields.push(g);if(b[g.field_name]===undefined)b[g.field_name]=g;}b.update_system_fields();b._bind_fields(b.expanded);b._dataset=this._dataset;if(a){b.on_filter_record=this.on_filter_record;b.filtered=this.filtered;}b._active=true;b._set_item_state(d.STATE_BROWSE);b.first();return b;},store_handlers:function(){var a={};for(var b in this)if(this.hasOwnProperty(b))if((b.substring(0,3)==="on_")&&(typeof this[b]==="function"))a[b]=this[b];return a;},clear_handlers:function(){for(var a in this)if(this.hasOwnProperty(a))if((a.substring(0,3)==="on_")&&(typeof this[a]==="function"))this[a]=undefined;},load_handlers:function(a){for(var b in a)if(a.hasOwnProperty(b))this[b]=a[b];},_get_log_changes:function(){return this._log_changes;},_set_log_changes:function(a){this._log_changes=a;},is_modified:function(){return this._modified;},_set_modified:function(a){this._modified=a;if(this.master&&a)this.master._set_modified(a);},_bind_fields:function(a){var b=0;if(a===undefined)a=true;this.each_field(function(a,b){a.bind_index=null;a.lookup_index=null;});this.each_field(function(a,c){if(!a.master_field){a.bind_index=b;b+=1;}});this.each_field(function(a,b){if(a.master_field)a.bind_index=a.master_field.bind_index;});this._record_lookup_index=b;if(a)this.each_field(function(a,c){if(a.lookup_item){a.lookup_index=b;b+=1;}});this._record_info_index=b;},set_fields:function(a){this._select_field_list=a;},set_order_by:function(a){this._order_by_list=this.get_order_by_list(a);},get_order_by_list:function(a){var b,c,d,e,f,g,h=[];g=a.length;for(f=0;f<g;f++){b=a[f];c=b;d=false;if(b[0]==='-'){d=true;c=b.substring(1);}try{e=this.field_by_name(c);}catch(i){throw this.item_name+': set_order_by method arument error - '+b+' '+i;}h.push([e.ID,d]);}return h;},set_where:function(a){this._where_list=this.get_where_list(a);},get_where_list:function(a){var b,c,e,g,h,i,j,k=[];for(c in a)if(a.hasOwnProperty(c)){e=c;i=a[c];j=c.indexOf('__');if(j>-1){h=c.substring(j+2);c=c.substring(0,j);}else h='eq';g=f.indexOf(h);if(g!==-1)g+=1;else throw this.item_name+': set_where method arument error - '+e;b=this._field_by_name(c);if(!b)throw this.item_name+': set_where method arument error - '+e;if(i!==null){if(b.data_type===d.DATETIME&&g!==d.FILTER_ISNULL)i=b.format_date_to_string(i,'%Y-%m-%d %H:%M:%S');k.push([c,g,i]);}}return k;},update_system_fields:function(){var a,b,c,d,e,f=['_primary_key','_deleted_flag','_master_id','_master_rec_id'];b=f.length;for(a=0;a<b;a++){e=f[a];d=this[e];if(d){c=this.field_by_name(d);if(c)this[e+'_field']=c;}}},_update_fields:function(a){var b,c,d;c=this.fields.length;for(b=0;b<c;b++){d=this.fields[b];if(this[d.field_name]!==undefined)delete this[d.field_name];}this.fields=[];if(a===undefined&&this._select_field_list.length)a=this._select_field_list;if(a){c=a.length;for(b=0;b<c;b++)this.fields.push(this._field_by_name(a[b]));}else this.fields=this._fields.slice(0);a=[];c=this.fields.length;for(b=0;b<c;b++){d=this.fields[b];if(this[d.field_name]===undefined)this[d.field_name]=d;a.push(d.field_name);}this.update_system_fields();return a;},_do_before_open:function(a,b,c,e,f,g,h,i,j,k){var l=[];if(this.on_before_open)this.on_before_open.call(this,this,g);g.__expanded=a;g.__fields=[];b=this._update_fields(b);this._select_field_list=[];if(b)g.__fields=b;g.__open_empty=f;g.__order=[];if(!f){g.__limit=0;g.__offset=0;if(i){g.__limit=i;if(h)g.__offset=h;}if(c)l=this.get_where_list(c);else if(this._where_list.length)l=this._where_list.slice(0);else this.each_filter(function(a,b){if(a.get_value()!==null)l.push([a.field.field_name,a.filter_type,a.get_value()]);});if(g.__search!==undefined){var m=g.__search[0],n=g.__search[1],o=g.__search[2];l.push([m,o,n]);}if(this.show_selected)l.push([this._primary_key,d.FILTER_IN,this.selections]);g.__filters=l;if(e)g.__order=this.get_order_by_list(e);else if(this._order_by_list.length)g.__order=this._order_by_list.slice(0);else if(this._default_order){g.__order=this._default_order.slice();for(var p=0;p<g.__order.length;p++)if(!this.field_by_ID(g.__order[p][0])){g.__order=[];break;}}this._where_list=[];this._order_by_list=[];if(j)g.__funcs=j;if(k)g.__group_by=k;}this._open_params=g;},_do_after_open:function(){if(this.on_after_open)this.on_after_open.call(this,this);},open_details:function(a){var b=this,c=0;function d(){c-=1;if(c===0)a.call(b);}if(a){this.each_detail(function(a,b){if(!a.disabled)c+=1;});this.each_detail(function(a,b){if(!a.disabled)a.open(d);});}else this.each_detail(function(a,b){if(!a.disabled)a.open();});},find_change_log:function(){if(this.master)if(this.master._get_record_status()!==d.RECORD_UNCHANGED)return this.master.change_log.get_detail_log(this.ID);},_check_open_options:function(b){if(b){if(b.fields&&!a.isArray(b.fields))throw this.item_name+': open method options error: the fields option must be an array.';if(b.order_by&&!a.isArray(b.order_by))throw this.item_name+': open method options error: the order_by option must be an array.';if(b.group_by&&!a.isArray(b.group_by))throw this.item_name+': open method options error: the group_by option must be an array.';}},open:function(){var a=this._check_args(arguments),b=a['function'],c=a.object,e=a.boolean,f,g,h,i,j,k,l,m,b,n,o,p,q,r,s,t=this;this._check_open_options(c);if(c){f=c.expanded;g=c.fields;h=c.where;i=c.order_by;j=c.open_empty;m=c.params;p=c.offset;o=c.limit;k=c.funcs;l=c.group_by;}if(!m)m={};if(f===undefined)f=this.expanded;else this.expanded=f;if(!e)e=b?true:false;if(this.master)if(!this.disabled&&this.master.record_count()>0){m.__master_id=this.master.ID;m.__master_rec_id=this.master.field_by_name(this.master._primary_key).value;if(this.master.is_new())s=[];else{n=this.find_change_log();if(n){s=n.records;g=n.fields;f=n.expanded;}}if(s!==undefined){this._do_before_open(f,g,h,i,j,m,p,o,k,l);this._bind_fields(f);if(this.master.is_new())this.change_log.prepare();this._dataset=s;this._active=true;this._set_item_state(d.STATE_BROWSE);this.first();this._do_after_open();this.update_controls(d.UPDATE_OPEN);if(b)b.call(this,this);return;}}else{this.close();return;}if(this.paginate&&p!==undefined){m=this._open_params;m.__offset=p;if(this.on_before_open)this.on_before_open.call(this,this,m);}else{if(p===undefined)p=0;this._do_before_open(f,g,h,i,j,m,p,o,k,l);this._bind_fields(f);}if(this.paginate)m.__limit=this._limit;this.change_log.prepare();this._dataset=[];this.do_open(p,e,m,j,function(){t._active=true;t._set_item_state(d.STATE_BROWSE);t._cur_row=null;t.first();t._do_after_open();if((!t.paginate||t.paginate&&p===0)&&t.on_filters_applied)t.on_filters_applied.call(t,t);t.update_controls(d.UPDATE_OPEN);if(b)b.call(t,t);});},do_open:function(a,b,c,d,e){var f=this,g;if(this.on_open&&!d){if(this.on_open)this.on_open.call(this,this,c,function(b){f._do_after_load(b,a,e);});}else if(b&&!d)this.send_request('open',c,function(b){f._do_after_load(b,a,e);});else{if(d)g=[[],''];else g=this.send_request('open',c);this._do_after_load(g,a,e);}},_do_after_load:function(a,b,c){var d,e,f,g;if(a){e=a[1];if(e)this.warning(e);else if(a[0]){d=a[0];g=d.length;this._dataset=d;if(this._limit&&this.paginate&&d){this._offset=b;this.is_loaded=false;}if(g<this._limit)this.is_loaded=true;c.call(this,this);}}else{this._dataset=[];console.log(this.item_name+" error while opening table");}},_do_close:function(){this._active=false;this._dataset=null;this._cur_row=null;},close:function(){var a=this.details.length;this.update_controls(d.UPDATE_CLOSE);this._do_close();for(var b=0;b<a;b++)this.details[b].close();},sort:function(a){var b=this.get_order_by_list(a);this._sort(b);},_sort:function(a){var b,c=[],d=[];for(b=0;b<a.length;b++){c.push(this.field_by_ID(a[b][0]).field_name);d.push(a[b][1]);}this._sort_dataset(c,d);},_sort_dataset:function(a,b){var c=this,e,f,g;function h(a,b){if(a===null)if(b===d.TEXT)a='';else if(b===d.INTEGER||b===d.FLOAT||b===d.CURRENCY)a=0;else if(b===d.DATE||b===d.DATETIME)a=new Date(0);else if(b===d.BOOLEAN)a=false;if(b===d.FLOAT)a=Number(a.toFixed(10));if(b===d.CURRENCY)a=Number(a.toFixed(2));return a;}function i(d,e){var f,g,i,j,k,l,m;for(var f=0;f<a.length;f++){g=c.field_by_name(a[f]);j=g.bind_index;if(g.lookup_item)j=g.lookup_index;i=g.get_lookup_data_type();l=h(d[j],i);m=h(e[j],i);if(l<m)k=-1;if(l>m)k=1;if(k){if(b[f])k=-k;return k;}}return 0;}this._dataset.sort(i);this.update_controls();},search:function(){var a=this._check_args(arguments),b=a['function'],c=arguments[0],e=arguments[1].trim(),g,h,i,j,k,l,m,n,o,p={};if(b){if(arguments.length===4)g=arguments[2];}else if(arguments.length===3)g=arguments[2];if(g)h=f.indexOf(g)+1;else h=d.FILTER_CONTAINS_ALL;if(this.field_by_name(c).lookup_values){o=this.field_by_name(c).lookup_values;k=[];for(i=0;i<o.length;i++){m=o[i][1].toLowerCase();l=e.toLowerCase().split(' ');n=true;for(j=0;j<l.length;j++)if(l[j])if(m.indexOf(l[j])===-1){n=false;break;}if(n)k.push(o[i][0]);}e=k;h=d.FILTER_IN;}if(e.length){p.__search=[c,e,h];this.open({params:p},b);}else this.open(function(){;if(b)b.call(this,this);});},total_records:function(a){var b=this;if(this._open_params.__open_empty&&a)return 0;else if(this.on_count){this.on_count.call(this,this,this._open_params,function(c){if(c&&a)a.call(b,c[0]);});}else this.send_request('total_records',this._open_params,function(c){if(c&&a)a.call(b,c[0]);});},new_record:function(){var a=[];this.each_field(function(b,c){if(!b.master_field)a.push(null);});if(this.expanded)this.each_field(function(b,c){if(b.lookup_item)a.push(null);});return a;},_do_before_append:function(){if(this.on_before_append)this.on_before_append.call(this,this);},_do_after_append:function(){var a=0,b=this.fields.length,c;for(;a<b;a++){c=this.fields[a];if(c.default_value)try{c.text=c.default_value;}catch(d){}}this._modified=false;if(this.on_after_append)this.on_after_append.call(this,this);},append:function(){if(!this._active)throw c.append_not_active.replace('%s',this.item_name);if(this.master&&!this.master.is_changing())throw c.append_master_not_changing.replace('%s',this.item_name);if(this._get_item_state()!==d.STATE_BROWSE)throw c.append_not_browse.replace('%s',this.item_name);this._do_before_append();this._do_before_scroll();this._old_row=this._get_rec_no();this._set_item_state(d.STATE_INSERT);this._dataset.push(this.new_record());this._cur_row=this._dataset.length-1;this._set_record_status(d.RECORD_INSERTED);this.update_controls(d.UPDATE_APPEND);this._do_after_scroll();this._do_after_append();},insert:function(){if(!this._active)throw c.insert_not_active.replace('%s',this.item_name);if(this.master&&!this.master.is_changing())throw c.insert_master_not_changing.replace('%s',this.item_name);if(this._get_item_state()!==d.STATE_BROWSE)throw c.insert_not_browse.replace('%s',this.item_name);this._do_before_append();this._do_before_scroll();this._old_row=this._get_rec_no();this._set_item_state(d.STATE_INSERT);this._dataset.splice(0,0,this.new_record());this._cur_row=0;this._modified=false;this._set_record_status(d.RECORD_INSERTED);this.update_controls(d.UPDATE_INSERT);this._do_after_scroll();this._do_after_append();},_do_before_edit:function(){if(this.on_before_edit)this.on_before_edit.call(this,this);},_do_after_edit:function(){if(this.on_after_edit)this.on_after_edit.call(this,this);},edit:function(){if(!this._active)throw c.edit_not_active.replace('%s',this.item_name);if(this.record_count()===0)throw c.edit_no_records.replace('%s',this.item_name);if(this.master&&!this.master.is_changing())throw c.edit_master_not_changing.replace('%s',this.item_name);if(this._get_item_state()!==d.STATE_BROWSE)throw c.edit_not_browse.replace('%s',this.item_name);this._do_before_edit();this.change_log.log_change();this._buffer=this.change_log.store_record_log();this._set_item_state(d.STATE_EDIT);this._old_row=this._get_rec_no();this._old_status=this._get_record_status();this._modified=false;this._do_after_edit();},_do_before_cancel:function(){if(this.on_before_cancel)this.on_before_cancel.call(this,this);},_do_after_cancel:function(){if(this.on_after_cancel)this.on_after_cancel.call(this,this);},cancel:function(){var a,b,e;this._do_before_cancel();if(this._get_item_state()===d.STATE_EDIT){this.change_log.restore_record_log(this._buffer);this.update_controls(d.UPDATE_CANCEL);for(var a=0;a<this.details.length;a++)this.details[a].update_controls(d.UPDATE_OPEN);}else if(this._get_item_state()===d.STATE_INSERT){this.change_log.remove_record_log();this.update_controls(d.UPDATE_DELETE);this._dataset.splice(this.rec_no,1);}else throw c.cancel_invalid_state.replace('%s',this.item_name);e=this._get_item_state();this._set_item_state(d.STATE_BROWSE);if(e===d.STATE_INSERT)this._do_before_scroll();this._cur_row=this._old_row;if(e===d.STATE_EDIT)this._set_record_status(this._old_status);this._modified=false;if(e===d.STATE_INSERT)this._do_after_scroll();this._do_after_cancel();},is_browsing:function(){return this._get_item_state()===d.STATE_BROWSE;},is_changing:function(){return(this._get_item_state()===d.STATE_INSERT)||(this._get_item_state()===d.STATE_EDIT);},is_new:function(){return this._get_item_state()===d.STATE_INSERT;},is_edited:function(){return this._get_item_state()===d.STATE_EDIT;},is_deleting:function(){return this._get_item_state()===d.STATE_DELETE;},_do_before_delete:function(a){if(this.on_before_delete)this.on_before_delete.call(this,this);},_do_after_delete:function(){if(this.on_after_delete)this.on_after_delete.call(this,this);},"delete":function(){var a=this._get_rec_no();if(!this._active)throw c.delete_not_active.replace('%s',this.item_name);if(this.record_count()===0)throw c.delete_no_records.replace('%s',this.item_name);if(this.master&&!this.master.is_changing())throw c.delete_master_not_changing.replace('%s',this.item_name);this._set_item_state(d.STATE_DELETE);try{this._do_before_delete();this._do_before_scroll();this.update_controls(d.UPDATE_DELETE);this.change_log.log_change();if(this.master)this.master._set_modified(true);this._dataset.splice(a,1);this._set_rec_no(a);this._set_item_state(d.STATE_BROWSE);this._do_after_scroll();this._do_after_delete();}catch(b){throw b;}finally{this._set_item_state(d.STATE_BROWSE);}},detail_by_ID:function(a){var b;if(typeof a==="string")a=parseInt(a,10);this.each_detail(function(c,d){if(c.ID===a){b=c;return false;}});return b;},post:function(a){var b,c,e,f=this._get_item_state();if(!this.is_changing())throw this.item_name+' post method: dataset is not in edit or insert mode';if(this.on_before_post)this.on_before_post.call(this,this);if(this.master&&this._master_id)this.field_by_name(this._master_id).set_data(this.master.ID);this.check_record_valid();e=this.details.length;for(c=0;c<e;c++)if(this.details[c].is_changing())this.details[c].post();if(this.is_modified()||this.is_new())this.change_log.log_change();else if(this._get_record_status()===d.RECORD_UNCHANGED)this.change_log.remove_record_log();this._modified=false;this._set_item_state(d.STATE_BROWSE);if(this.on_after_post)this.on_after_post.call(this,this);if(!this._valid_record()){this.update_controls(d.UPDATE_DELETE);this._search_record(this._get_rec_no(),0);}},apply:function(){var b=this._check_args(arguments),c=b['function'],d=b.object,e=b.boolean,f=this,g={},h,i,h=true;if(this.master){if(c)c.call(this);return;}if(this.is_changing())this.post();this.change_log.get_changes(g);if(!this.change_log.is_empty_obj(g.data)){if(this.on_before_apply){h=this.on_before_apply.call(this,this);if(h)d=a.extend({},d,h);}if(c||e)this.send_request('apply',[g,d],function(a){f._process_apply(a,c);});else{i=this.send_request('apply',[g,d]);h=this._process_apply(i);}}else if(c)if(c)c.call(this);},_process_apply:function(a,b){var c,e;if(a){c=a[0];e=a[1];if(e){if(b)b.call(this,e);throw e;}else{this.change_log.update(c);if(this.on_after_apply)this.on_after_apply.call(this,this);if(b)b.call(this);this.update_controls(d.UPDATE_APPLIED);}}},delta:function(a){var b,c,e,f;if(a===undefined){a={};this.change_log.get_changes(a);}f=this.copy({filters:false,details:true,handlers:false});f.on_after_scroll=function(a){a.open_details();};f.expanded=false;f._is_delta=true;c=f.details.length;for(b=0;b<c;b++){f.details[b].expanded=false;f.details[b]._is_delta=true;}f.change_log.set_changes(a);f._dataset=f.change_log.records;f._update_fields(f.change_log.fields);f._bind_fields(f.change_log.expanded);f._set_item_state(d.STATE_BROWSE);f._cur_row=null;f._active=true;f.first();return f;},field_by_id:function(a,b,c){var d,e,f;if(typeof b==='string')b=[b];d=this.copy();d.set_where({id:a});if(c){d.open({expanded:false,fields:b},function(){e=d._dataset[0];if(b.length===1)e=e[0];return e;});}else{d.open({expanded:false,fields:b});if(d.record_count()===1){e=d._dataset[0];if(b.length===1)e=e[0];return e;}}},locate:function(a,b){var c=this.clone();function d(){var d,e;if(a instanceof Array){e=a.length;for(d=0;d<e;d++)if(c.field_by_name(a[d]).value!==b[d])return false;return true;}else if(c.field_by_name(a).value===b)return true;}c.first();while(!c.eof()){if(d()){this.rec_no=c.rec_no;return true;}c.next();}},_get_active:function(){return this._active;},_set_read_only:function(a){var b,c;this._read_only=a;c=this.fields.length;for(b=0;b<c;b++)this.fields[b].update_controls();this.each_detail(function(b,c){b._set_read_only(a);});},_get_read_only:function(){if(this.master&&this._parent_read_only)return this.master._get_read_only();else return this._read_only;},_get_filtered:function(){return this._filtered;},_set_filtered:function(a){if(a)if(!this.on_filter_record)a=false;if(this._filtered!==a){this._filtered=a;this.first();this.update_controls(d.UPDATE_OPEN);}},clear_filters:function(){this.each_filter(function(a){a.value=null;});},assign_filters:function(a){var b=this;a.each_filter(function(a){if(a.value===null)b.filter_by_name(a.filter_name).field.value=null;else b.filter_by_name(a.filter_name).field.value=a.field.value;});},_set_item_state:function(a){if(this._state!==a){this._state=a;if(this.on_state_changed)this.on_state_changed.call(this,this);this.update_controls(d.UPDATE_STATE);}},_get_item_state:function(){return this._state;},_do_after_scroll:function(){var a=this.details.length;for(var b=0;b<a;b++)this.details[b]._do_close();this.update_controls(d.UPDATE_SCROLLED);if(this.on_after_scroll)this.on_after_scroll.call(this,this);},_do_before_scroll:function(){if(this._cur_row!==null){if(this.is_changing())this.post();if(this.on_before_scroll)this.on_before_scroll.call(this,this);}},skip:function(a){var b,c,d,e;if(this.record_count()===0){this._do_before_scroll();this._eof=true;this._bof=true;this._do_after_scroll();}else{d=this._cur_row;b=false;c=false;e=a;if(e<0){e=0;c=true;}if(e>=this._dataset.length){e=this._dataset.length-1;b=true;}this._eof=b;this._bof=c;if(d!==e){this._do_before_scroll();this._cur_row=e;this._do_after_scroll();}else if(b||c&&this.is_new()&&this.record_count()===1){this._do_before_scroll();this._do_after_scroll();}}},_set_rec_no:function(a){if(this._active)if(this.filter_active())this._search_record(a,0);else this.skip(a);},_get_rec_no:function(){if(this._active)return this._cur_row;},filter_active:function(){if(this.on_filter_record&&this.filtered)return true;},first:function(){if(this.filter_active())this.find_first();else this._set_rec_no(0);},last:function(){if(this.filter_active())this.find_last();else this._set_rec_no(this._dataset.length);},next:function(){if(this.filter_active())this.find_next();else this._set_rec_no(this._get_rec_no()+1);},prior:function(){if(this.filter_active())this.find_prior();else this._set_rec_no(this._get_rec_no()-1);},eof:function(){return this._eof;},bof:function(){return this._bof;},_valid_record:function(){if(this.on_filter_record&&this.filtered)return this.on_filter_record.call(this,this);else return true;},_search_record:function(a,b){var c,d,e=this;if(b===undefined)b=1;function f(){if(e.record_count()===0){e._eof=true;e._bof=true;}else{e._eof=false;e._bof=false;if(e._cur_row<0){e._cur_row=0;e._bof=true;}if(e._cur_row>=e._dataset.length){e._cur_row=e._dataset.length-1;e._eof=true;}}}function g(){if(b===1)return e.eof();else return e.bof();}if(this.active){if(this.record_count()===0){this.skip(a);return;}d=this._cur_row;this._cur_row=a+b;f();if(b===0){if(this._valid_record()){this._cur_row=d;this.skip(a);return;}b=1;}while(!g())if(this._valid_record()){if(a!==this._cur_row){c=this._cur_row;this._cur_row=a;this.skip(c);return;}}else{this._cur_row=this._cur_row+b;f();}}},find_first:function(){this._search_record(-1,1);},find_last:function(){this._search_record(this._dataset.length,-1);},find_next:function(){this._search_record(this._get_rec_no(),1);},find_prior:function(){this._search_record(this._get_rec_no(),-1);},_count_filtered:function(){var a=this.clone(true),b=0;this.each(function(){b+=1;});return b;},get_rec_count:function(){if(this._dataset)if(this.filtered)return this._count_filtered();else return this._dataset.length;else return 0;},record_count:function(){if(this._dataset)return this._dataset.length;else return 0;},find_rec_info:function(a,b){if(b===undefined)if(a===undefined){a=this._get_rec_no();if(this.record_count()>0)b=this._dataset[a];}if(b&&(this._record_info_index>0)){if(b.length<this._record_info_index+1)b.push([null,{},null]);return b[this._record_info_index];}},get_rec_info:function(a,b){return this.find_rec_info(a,b);},_get_record_status:function(){var a=this.get_rec_info();if(a)return a[d.REC_STATUS];},_set_record_status:function(a){var b=this.get_rec_info();if(b&&this.log_changes)b[d.REC_STATUS]=a;},rec_controls_info:function(){var a=this.get_rec_info();if(a)return a[d.REC_CONTROLS_INFO];},_get_rec_change_id:function(){var a=this.get_rec_info();if(a)return a[d.REC_CHANGE_ID];},_set_rec_change_id:function(a){var b=this.get_rec_info();if(b)b[d.REC_CHANGE_ID]=a;},rec_unchanged:function(){return this._get_record_status()===d.RECORD_UNCHANGED;},rec_inserted:function(){return this._get_record_status()===d.RECORD_INSERTED;},rec_deleted:function(){return this._get_record_status()===d.RECORD_DELETED;},rec_modified:function(){return this._get_record_status()===d.RECORD_MODIFIED||this._get_record_status()===d.RECORD_DETAILS_MODIFIED;},insert_record:function(b,c){if(b&&this.task.can_add_tab(b)&&a('.modal').length===0)this._append_record_in_tab(b,c);else this._insert_record();},_insert_record:function(a){if(this.can_create()){if(!this.is_changing())this.insert();this.create_edit_form(a);}},append_record:function(b,c){if(b&&this.task.can_add_tab(b)&&a('.modal').length===0)this._append_record_in_tab(b,c);else this._append_record();},_append_record:function(a){if(this.can_create()){if(!this.is_changing())this.append();this.create_edit_form(a);}},_append_record_in_tab:function(a,b){var c=this.item_name+0,d,e=this,f=this.copy(),g;if(this.can_create()){if(!b)b='<i class="icon-plus-sign"></i> '+this.item_caption;g=task.add_tab(a,b,{tab_id:c,show_close_btn:true,set_active:true,on_close:function(){task.show_tab(a,c);f.close_edit_form();}});if(g)f.open({open_empty:true},function(){f.edit_options.tab_id=c;f._append_record(g);e._update_tab_copy(f,a,c);});}},edit_record:function(b,c){if(b&&this.task.can_add_tab(b)&&a('.modal').length===0)this._edit_record_in_tab(b,c);else this._edit_record();},_edit_record:function(a){if(this.can_edit())if(!this.is_changing())this.edit();this.create_edit_form(a);},_edit_record_in_tab:function(a,b){var c=this._primary_key,d=this.field_by_name(c).value,e={},f=this.item_name+d,g,h=this,i=this.copy(),j;if(this.can_edit()){if(!b)b='<i class="icon-edit"></i> '+this.item_caption;j=task.add_tab(a,b,{tab_id:f,show_close_btn:true,set_active:true,on_close:function(){task.show_tab(a,f);i.close_edit_form();}});if(j){e[c]=d;i.set_where(e);i.open(function(){i.edit_options.tab_id=f;i._edit_record(j);h._update_tab_copy(i,a,f);});}}},_update_tab_copy:function(a,b,c){var d=this,e=a.on_edit_form_closed,f=a.on_after_apply;if(a.edit_options.width)a.edit_form.css('max-width',a.edit_options.width+'px');a.on_edit_form_closed=function(d){task.close_tab(b,c);if(e)e.call(a,a);};a.on_after_apply=function(b){if(f)f(a,a);d.refresh_page(true);};},cancel_edit:function(){if(this.is_changing())this.cancel();this.close_edit_form();},delete_record:function(a){var b=this,d=b._get_rec_no(),e=b._dataset[d];if(this.can_delete())if(this.record_count()>0){this.question(c.delete_record,function(){b["delete"]();this.apply(function(f){var g;if(f){g=(f+'').toUpperCase();if(g&&(g.indexOf('FOREIGN KEY')!==-1||g.indexOf('INTEGRITY CONSTRAINT')!==-1)&&(g.indexOf('VIOLAT')!==-1||g.indexOf('FAIL')!==-1))b.warning(c.cant_delete_used_record);else b.warning(f);b._dataset.splice(d,0,e);b._cur_row=d;b.change_log.remove_record_log();b.update_controls();b._do_after_scroll();}if(a)a.call(this,this);});});}else this.warning(c.no_record);},check_record_valid:function(){var a;this.each_field(function(b,c){try{b.check_valid();}catch(d){b.update_control_state(d);if(!a)a='Field "'+b.field_name+'": '+d;}});if(a)throw a;},check_filters_valid:function(){var a;this.each_filter(function(b,c){try{b.check_valid();}catch(d){b.field.update_control_state(d);if(b.field1)b.field1.update_control_state(d);if(!a)a=d;}});if(a)throw a;},post_record:function(){this.post();this.close_edit_form();},apply_record:function(){var a=this._check_args(arguments),b=a['function'],c=a.object,d=this;if(this.is_changing()){this._disable_form(this.edit_form);try{this.post();this.apply(c,function(a){if(a){d.warning(a);this._enable_form(this.edit_form);if(!d.is_changing())d.edit();}else{if(b)b.call(d,d);d.close_edit_form();}});}catch(e){if(this.edit_form._form_disabled)this._enable_form(this.edit_form);}}else this.close_edit_form();},do_on_view_keyup:function(a){if(this.task.on_view_form_keyup)this.task.on_view_form_keyup.call(this,this,a);if(this.owner.on_view_form_keyup)this.owner.on_view_form_keyup.call(this,this,a);if(this.on_view_form_keyup)this.on_view_form_keyup.call(this,this,a);},do_on_view_keydown:function(a){if(this.task.on_view_form_keydown)this.task.on_view_form_keydown.call(this,this,a);if(this.owner.on_view_form_keydown)this.owner.on_view_form_keydown.call(this,this,a);if(this.on_view_form_keydown)this.on_view_form_keydown.call(this,this,a);},view_modal:function(a){this.is_lookup_item=true;this.view(a);},view:function(a){if(a&&this.task.can_add_tab(a))this._view_in_tab(a);else{this.view_options.close_caption=true;this._view(a);}},_view:function(a){var b=this;b.show_selected=false;this.load_modules([this,this.owner],function(){b.create_view_form(a);});},_view_in_tab:function(a){var b=this,c,d=this.item_name,e=this.task.add_tab(a,this.item_caption,{tab_id:this.item_name,show_close_btn:true,set_active:true,on_close:function(){task.show_tab(a,d);b.close_view_form();}});if(e){this._view(e);c=this.on_view_form_closed,this.on_view_form_closed=function(e){b.task.close_tab(a,d);if(c)c.call(b,b);};}},create_view_form:function(a){var b=this;this.view_options.show_history=true;this._create_form('view',{container:a,beforeShow:function(){if(this.task.on_view_form_created)this.task.on_view_form_created.call(this,this);if(!this.master&&this.owner.on_view_form_created)this.owner.on_view_form_created.call(this,this);if(this.on_view_form_created)this.on_view_form_created.call(this,this);},onShown:function(){if(b.task.on_view_form_shown)b.task.on_view_form_shown.call(b,b);if(!this.master&&b.owner.on_view_form_shown)b.owner.on_view_form_shown.call(b,b);if(b.on_view_form_shown)b.on_view_form_shown.call(b,b);},onHide:function(a){var c,d;if(b.on_view_form_close_query)d=b.on_view_form_close_query.call(b,b);if(!this.master&&d===undefined&&b.owner.on_view_form_close_query&&!b.master)d=b.owner.on_view_form_close_query.call(b,b);if(d===undefined&&b.task.on_view_form_close_query)d=b.task.on_view_form_close_query.call(b,b);return d;},onHidden:function(){if(b.task.on_view_form_closed)b.task.on_view_form_closed.call(b,b);if(!this.master&&b.owner.on_view_form_closed)b.owner.on_view_form_closed.call(b,b);if(b.on_view_form_closed)b.on_view_form_closed.call(b,b);},onKeyUp:this.do_on_view_keyup,onKeyDown:this.do_on_view_keydown});},close_view_form:function(){this._close_form('view_form');},do_on_edit_keyup:function(a){if(this.task.on_edit_form_keyup)this.task.on_edit_form_keyup.call(this,this,a);if(this.owner.on_edit_form_keyup)this.owner.on_edit_form_keyup.call(this,this,a);if(this.on_edit_form_keyup)this.on_edit_form_keyup.call(this,this,a);},do_on_edit_keydown:function(a){if(this.task.on_edit_form_keydown)this.task.on_edit_form_keydown.call(this,this,a);if(this.owner.on_edit_form_keydown)this.owner.on_edit_form_keydown.call(this,this,a);if(this.on_edit_form_keydown)this.on_edit_form_keydown.call(this,this,a);},create_edit_form:function(){var a=this,b=this._check_args(arguments),c=b['function'],d=b.object;this.edit_options.show_history=true;this._create_form('edit',{container:d,beforeShow:function(){if(a.task.on_edit_form_created)a.task.on_edit_form_created.call(a,a);if(!a.master&&a.owner.on_edit_form_created&&!a.master)a.owner.on_edit_form_created.call(a,a);if(a.on_edit_form_created)a.on_edit_form_created.call(a,a);},onShown:function(){if(a.task.on_edit_form_shown)a.task.on_edit_form_shown.call(a,a);if(!a.master&&a.owner.on_edit_form_shown&&!a.master)a.owner.on_edit_form_shown.call(a,a);if(a.on_edit_form_shown)a.on_edit_form_shown.call(a,a);if(c)c.call(a,a);},onHide:function(b){var c,d;if(a.on_edit_form_close_query)d=a.on_edit_form_close_query.call(a,a);if(!a.master&&d===undefined&&a.owner.on_edit_form_close_query&&!a.master)d=a.owner.on_edit_form_close_query.call(a,a);if(d===undefined&&a.task.on_edit_form_close_query)d=a.task.on_edit_form_close_query.call(a,a);return d;},onHidden:function(){if(a.task.on_edit_form_closed)a.task.on_edit_form_closed.call(a,a);if(!this.master&&a.owner.on_edit_form_closed)a.owner.on_edit_form_closed.call(a,a);if(a.on_edit_form_closed)a.on_edit_form_closed.call(a,a);},onKeyUp:this.do_on_edit_keyup,onKeyDown:this.do_on_edit_keydown});},close_edit_form:function(){this._close_form('edit_form');},create_filter_form:function(){var a=this,b=this._check_args(arguments),c=b.object;this._create_form('filter',{container:c,beforeShow:function(){if(a.task.on_filter_form_created)a.task.on_filter_form_created.call(a,a);if(!a.master&&a.owner.on_filter_form_created)a.owner.on_filter_form_created.call(a,a);if(a.on_filter_form_created)a.on_filter_form_created.call(a,a);},onShown:function(){if(a.task.on_filter_form_shown)a.task.on_filter_form_shown.call(a,a);if(!a.master&&a.owner.on_filter_form_shown&&!a.master)a.owner.on_filter_form_shown.call(a,a);if(a.on_filter_form_shown)a.on_filter_form_shown.call(a,a);},onHide:function(b){var c,d;if(a.on_filter_form_close_query)d=a.on_filter_form_close_query.call(a,a);if(!a.master&&d===undefined&&a.owner.on_filter_form_close_query)d=a.owner.on_filter_form_close_query.call(a,a);if(d===undefined&&a.task.on_filter_form_close_query)d=a.task.on_filter_form_close_query.call(a,a);return d;},onHidden:function(){if(a.task.on_filter_form_closed)a.task.on_filter_form_closed.call(a,a);if(!this.master&&a.owner.on_filter_form_closed)a.owner.on_filter_form_closed.call(a,a);if(a.on_filter_form_closed)a.on_filter_form_closed.call(a,a);}});},close_filter_form:function(){this._close_form('filter_form');},apply_filters:function(){try{if(this.on_filters_apply)this.on_filters_apply.call(this,this);this.check_filters_valid();this.open(function(){this.close_filter_form();});}catch(a){}},get_filter_text:function(){var a='';this.each_filter(function(b){if(b.text)a+=' '+b.text;});if(a)a=c.filter+' -'+a;return a;},close_filter:function(){this.close_filter_form();},disable_controls:function(){this._disabled_count+=1;},enable_controls:function(){this._disabled_count-=1;if(this.controls_enabled())this.update_controls(d.UPDATE_SCROLLED);},controls_enabled:function(){return this._disabled_count===0;},controls_disabled:function(){return !this.controls_enabled();},update_controls:function(a){var b=0,c=this.fields.length;if(a===undefined)a=d.UPDATE_CONTROLS;if(this.controls_enabled()){for(b=0;b<c;b++)this.fields[b].update_controls(a,true);c=this.controls.length;if(this.on_update_controls)this.on_update_controls.call(this,this);for(b=0;b<c;b++)this.controls[b].update(a);}},create_table:function(a,b){return new u(this,a,b);},create_tree:function(a,b,c,d,e){return new t(this,a,b,c,d,e);},create_inputs:function(b,c){var d,e,f,g,h,i=[],j=[],k=[],l,m;if(!b.length)return;d={fields:[],col_count:1,label_on_top:false,label_width:undefined,row_count:undefined,autocomplete:false,in_well:true,tabindex:undefined};c=a.extend({},d,c);if(c.fields.length)j=c.fields;else j=this.edit_options.fields;f=j.length;for(e=0;e<f;e++){h=this.field_by_name(j[e]);if(h)i.push(h);else throw this.item_name+' create_entries: there is not a field with field_name - "'+j.fields[e]+'"';}b.empty();m=a('<form class="row-fluid" autocomplete="off"></form>').appendTo(b);if(c.in_well)m.addClass('well');if(c.autocomplete)m.attr("autocomplete","on");if(!c.label_on_top)m.addClass("form-horizontal");f=i.length;for(g=0;g<c.col_count;g++)k.push(a("<div></div>").addClass("span"+12/c.col_count).appendTo(m));l=c.tabindex;if(!c.row_count)c.row_count=Math.ceil(f/c.col_count);for(e=0;e<f;e++)new x(i[e],e+l,k[Math.floor(e/c.row_count)],c.label_on_top,c.label_width);},append_button:function(b,c){var d,e,f={icon:'icon-folder-open'};c=a.extend({},f,c);if(b.length){d=a('<button class="btn small-btn" type="button" tabindex="-1"></button>');if(c&&c.icon)d.append('<i class="'+c.icon+'"></i>');if(c&&c.id)d.attr('id',c.id);if(b.parent().hasClass('input-append'))b.parent().append(d);else if(b.parent().hasClass('input-prepend')){b.parent().append(d);b.parent().addClass('input-append');}else{e=a('<div class="input-append">');b.parent().append(e);b.detach();e.append(b);e.append(d);}}return d;},create_filter_inputs:function(b,e){var f,g,h,i,j,k=[],l=[],m,n;if(!b.length)return;f={filters:[],col_count:1,label_on_top:false,label_width:undefined,autocomplete:false,in_well:true,tabindex:undefined};e=a.extend({},f,e);if(e.filters.length){h=e.filters.length;for(g=0;g<h;g++)k.push(this.filter_by_name(e.filters[g]));}else this.each_filter(function(a,b){if(a.visible)k.push(a);});b.empty();n=a('<form form class="row-fluid" autocomplete="off"></form>').appendTo(a("<div></div>").addClass("row-fluid").appendTo(b));if(e.in_well)n.addClass('well');if(e.autocomplete)n.attr("autocomplete","on");if(!e.label_on_top)n.addClass("form-horizontal");h=k.length;for(i=0;i<e.col_count;i++)l.push(a("<div></div>").addClass("span"+12/e.col_count).appendTo(n));m=e.tabindex;if(!m&&this.filter_form){m=this.filter_form.tabindex;this.filter_form.tabindex+=h;}for(g=0;g<h;g++){j=k[g];if(j.filter_type===d.FILTER_RANGE){new x(j.field,g+1,l[Math.floor(g%e.col_count)],e.label_on_top,e.label_width,j.filter_caption+' '+c.range_from);new x(j.field1,g+1,l[Math.floor(g%e.col_count)],e.label_on_top,e.label_width,j.filter_caption+' '+c.range_to);}else new x(j.field,g+1,l[Math.floor(g%e.col_count)],e.label_on_top,e.label_width,j.filter_caption);}},_find_lookup_value:function(a,b){if(b.field_kind===d.ITEM_FIELD){if(a.field_name===b.lookup_field&&a.lookup_field===b.lookup_field1&&a.lookup_field1===b.lookup_field2)return a.lookup_value;else if(a.field_kind===d.ITEM_FIELD&&a.owner.ID===b.lookup_item.ID&&a.lookup_field&&a.lookup_field===b.lookup_field1&&a.lookup_field1===b.lookup_field2)return a.lookup_value;}else if(a.field_name===b.lookup_field)return a.lookup_value;},set_lookup_field_value:function(){if(this.record_count()){var a=this.lookup_field,b=this.field_by_name(a.lookup_field),c=null,e=this.lookup_field.owner,f=[],g={},h=this;if(b)c=this._find_lookup_value(b,a);if(a.owner&&a.owner.is_changing&&!a.owner.is_changing())a.owner.edit();if(this.lookup_field.data_type===d.KEYS)this.selections=[this._primary_key_field.value];else if(a.multi_select)a.set_value([this._primary_key_field.value],c);else{if(e)e.each_field(function(b){if(b.master_field===a)h.each_field(function(a){var c=h._find_lookup_value(a,b);if(c){g[b.field_name]=c;return false;}});});a.set_value(this._primary_key_field.value,c,g,this);}}if(this.lookup_field)this.close_view_form();},get_default_field:function(){var a=0;if(this._default_field===undefined){this._default_field=null;for(a=0;a<this.fields.length;a++)if(this.fields[a].is_default){this._default_field=this.fields[a];break;}}return this._default_field;},set_edit_fields:function(a){this.edit_options.fields=a;},set_view_fields:function(a){this.view_options.fields=a;},round:function(a,b){return Number(a.toFixed(b));},refresh:function(a){},_do_on_refresh_record:function(a,b){var c,e;if(a.record_count()===1){e=a._dataset[0].length;for(c=0;c<e;c++)this._dataset[this.rec_no][c]=a._dataset[0][c];this.update_controls(d.UPDATE_CANCEL);if(b)b.call(this);}},refresh_record:function(a){var b=this._check_args(arguments),a=b['function'],c=b.boolean,d=this,e=[],f=this._primary_key,g={},h;if(this.master)throw 'The refresh_record method can not be executed for a detail item';if(!this.rec_count)return;h=this.copy({filters:false,details:false,handlers:false});if(this._primary_key_field.value){d.each_field(function(a){e.push(a.field_name);});g[f]=this._primary_key_field.value;if(a||c)h.open({expanded:this.expanded,fields:e,where:g},function(){d._do_on_refresh_record(h,a);});else{h.open({expanded:this.expanded,fields:e,where:g});this._do_on_refresh_record(h);}}},_do_on_refresh_page:function(a,b){this.rec_no=a;this.update_controls(d.UPDATE_OPEN);if(b)b.call(this);},refresh_page:function(a){var b=this._check_args(arguments),c=b['function'],d=b.boolean,e=this,f=this.rec_no;if(c||d)this.open({params:this._open_params,offset:this._open_params.__offset},function(){this._do_on_refresh_page(f,c);});else{this.open({params:this._open_params,offset:this._open_params.__offset});this._do_on_refresh_page(f,c);}},format_string:function(a,b){var c=a;if(typeof b==='object'){for(var d in b)if(b.hasOwnProperty(d))c=c.replace('%('+d+')s',b[d]+'');}else c=c.replace('%s',b+'');return c;}});o.prototype=new j();function o(b,c,e,f,g,h,i){j.call(this,b,c,e,f,g,h,i);if(this.task&&!(e in this.task))this.task[e]=this;this._fields=[];this.params=this._fields;this._state=d.STATE_EDIT;this.param_options=a.extend({},this.from_options);}a.extend(o.prototype,{constructor:o,_set_item_state:function(a){if(this._state!==a)this._state=a;},_get_item_state:function(){return this._state;},initAttr:function(a){var b,c=a.fields,d;if(c){d=c.length;for(b=0;b<d;b++)new s(this,c[b]);}},bind_item:function(){var a=0,b,c=this.params.length;for(a=0;a<c;a++){b=this.params[a];if(b.lookup_item&&(typeof b.lookup_item==="number"))b.lookup_item=this.task.item_by_ID(b.lookup_item);if(b.lookup_field&&(typeof b.lookup_field==="number"))b.lookup_field=b.lookup_item._field_by_ID(b.lookup_field).field_name;if(b.lookup_values&&(typeof b.lookup_values==="number"))b.lookup_values=self.task.lookup_lists[b.lookup_values];}this.param_options.title=this.item_caption;},eachParam:function(a){var b=0,c=this.params.length,d;for(;b<c;b++){d=a.call(this.params[b],this.params[b],b);if(d===false)break;}},each_field:function(a){this.eachParam(a);},param_by_name:function(a){var b=0,c=this.params.length;for(;b<c;b++)if(this.params[b].param_name===a)return this.params[b];},create_param_form:function(){var a=this,b=this._check_args(arguments),c=b.object;this._create_form('param',{container:c,beforeShow:function(){if(a.task.on_param_form_created)a.task.on_param_form_created.call(a,a);if(a.owner.on_param_form_created)a.owner.on_param_form_created.call(a,a);if(a.on_param_form_created)a.on_param_form_created.call(a,a);},onShown:function(){if(a.task.on_param_form_shown)a.task.on_param_form_shown.call(a,a);if(a.owner.on_param_form_shown)a.owner.on_param_form_shown.call(a,a);if(a.on_param_form_shown)a.on_param_form_shown.call(a,a);},onHide:function(b){var c,d;if(a.on_param_form_close_query)d=a.on_param_form_close_query.call(a,a);if(d===undefined&&a.owner.on_param_form_close_query)d=a.owner.on_param_form_close_query.call(a,a);if(d===undefined&&a.task.on_param_form_close_query)d=a.task.on_param_form_close_query.call(a,a);return d;},onHidden:function(){if(a.task.on_param_form_closed)a.task.on_param_form_closed.call(a,a);if(!this.master&&a.owner.on_param_form_closed)a.owner.on_param_form_closed.call(a,a);if(a.on_param_form_closed)a.on_param_form_closed.call(a,a);}});},close_param_form:function(){this._close_form('param_form');},print:function(a,b){var c=this;this.load_modules([this,this.owner],function(){c._print(a,b);});},_print:function(){var a=this._check_args(arguments),b=a['function'],c=a.boolean;if(!c)this.eachParam(function(a){if(a.edit_visible){c=true;return false;}});if(c)this.create_param_form();else this.process_report(b);},checkParams:function(){var a,b=this.params.length;for(a=0;a<b;a++)try{this.params[a].check_valid();}catch(c){this.warning(c);return false;}return true;},process_report:function(a){var b=this,c=[location.protocol,'//',location.host,location.pathname].join(''),d,e,f=[];if(this.checkParams()){if(this.task.on_before_print_report)this.task.on_before_print_report.call(this,this);if(this.owner.on_before_print_report)this.owner.on_before_print_report.call(this,this);if(this.on_before_print_report)this.on_before_print_report.call(this,this);e=this.params.length;for(d=0;d<e;d++)f.push(this.params[d].get_data());this.send_request('print',[f,c,this.extension],function(c){var d,e,f,g,h;if(c)d=c[0],e=c[1];if(e)b.warning(e);if(d)if(b.on_open_report)b.on_open_report.call(b,b,d);else if(b.owner.on_open_report)b.owner.on_open_report.call(b.owner,b,d);else{f=d.split('.').pop();if(f==='ods')window.open(d,"_self");else{h=window.open(d,"_blank");if(b.send_to_printer)h.onload=function(){h.print();g=setTimeout(function(){h.onfocus=function(){h.close();};},1000);};}}if(a)a.call(b,b,d);});return true;}},create_param_inputs:function(b,c){var d,e,f,g,h=[],i=[],j,k;if(!b.length)return;d={params:[],col_count:1,label_on_top:false,label_width:undefined,autocomplete:false,in_well:true,tabindex:undefined};c=a.extend({},d,c);if(c.params.length){f=c.params.length;for(e=0;e<f;e++)h.push(this.param_by_name(c.params[e]));}else{this.eachParam(function(a){if(a.edit_visible&&a.edit_index!==-1)h.push(a);});h.sort(function(a,b){if(a.edit_index>b.edit_index===0)return 0;if(a.edit_index>b.edit_index)return 1;else return -1;});}b.empty();j=a('<form form class="row-fluid" autocomplete="off"></form>').appendTo(a("<div></div>").addClass("row-fluid").appendTo(b));if(c.in_well)j.addClass('well');if(c.autocomplete)j.attr("autocomplete","on");if(!c.label_on_top)j.addClass("form-horizontal");f=h.length;for(g=0;g<c.col_count;g++)i.push(a("<div></div>").addClass("span"+12/c.col_count).appendTo(j));k=c.tabindex;if(!k&&this.param_form){k=this.param_form.tabindex;this.param_form.tabindex+=f;}for(e=0;e<f;e++)new x(h[e],e+k,i[Math.floor(e%c.col_count)],c.label_on_top,c.label_width);}});p.prototype=new n();p.prototype.constructor=p;function p(a,b,c,d,e,f,g){n.call(this,a,b,c,d,e,f,g);if(a){this.master=a;a.details.push(this);a.details[c]=this;}this.item_type="detail";}p.prototype.getChildClass=function(){return undefined;};function q(a,b){this.owner=a;this.set_info(b);this.controls=[];this.bind_index=null;this.lookup_index=null;this.field_type=i[this.data_type];this.field_kind=d.ITEM_FIELD;if(a)a._fields.push(this);Object.defineProperty(this,"data",{get:function(){return this.get_data();}});Object.defineProperty(this,"value",{get:function(){return this.get_value();},set:function(a){this.set_value(a);}});Object.defineProperty(this,"raw_value",{get:function(){return this.get_raw_value();}});Object.defineProperty(this,"text",{get:function(){return this.get_text();},set:function(a){this.set_text(a);}});Object.defineProperty(this,"display_text",{get:function(){return this.get_display_text();}});Object.defineProperty(this,"lookup_text",{get:function(){return this.get_lookup_text();}});Object.defineProperty(this,"lookup_value",{get:function(){return this.get_lookup_value();},set:function(a){this.set_lookup_value(a);}});Object.defineProperty(this,"lookup_type",{get:function(){return i[this.get_lookup_data_type()];}});Object.defineProperty(this,"alignment",{get:function(){return this.get_alignment();},set:function(a){this.set_alignment(a);}});Object.defineProperty(this,"read_only",{get:function(){return this._get_read_only();},set:function(a){this._set_read_only(a);}});}q.prototype={constructor:q,copy:function(a){var b=new q(a,this.get_info());b.lookup_item=this.lookup_item;b.lookup_field=this.lookup_field;return b;},get_info:function(){var a,b=g.length,c=[];for(a=0;a<b;a++)c.push(this[g[a]]);return c;},set_info:function(a){if(a){var b,c=g.length;for(b=0;b<c;b++)this[g[b]]=a[b];}},get_row:function(){if(this.owner._dataset&&this.owner._dataset.length)return this.owner._dataset[this.owner._get_rec_no()];else{if(this.owner)this.owner.warning('An error occurred while reading or writing to an empty dataset.');throw c.value_in_empty_dataset.replace('%s',this.owner.item_name);}},get_data:function(){var a;if(this.field_kind===d.ITEM_FIELD){a=this.get_row();if(a&&this.bind_index>=0)return a[this.bind_index];}else return this._value;},set_data:function(a){var b;if(this.field_kind===d.ITEM_FIELD){b=this.get_row();if(b&&this.bind_index>=0)b[this.bind_index]=a;}else this._value=a;},get_lookup_data:function(){var a;if(this.field_kind===d.ITEM_FIELD){a=this.get_row();if(a&&this.lookup_index>=0)return a[this.lookup_index];}else return this._lookup_value;},set_lookup_data:function(a){var b;if(this.field_kind===d.ITEM_FIELD){b=this.get_row();if(b&&this.lookup_index>=0)b[this.lookup_index]=a;}else this._lookup_value=a;},get_text:function(){var a="",b="";try{a=this.get_value();if(a!==null){switch(this.data_type){case d.TEXT:break;case d.INTEGER:a=this.int_to_str(a);break;case d.FLOAT:a=this.float_to_str(a);break;case d.CURRENCY:a=this.float_to_str(a);break;case d.DATE:a=this.date_to_str(a);break;case d.DATETIME:a=this.datetime_to_str(a);break;case d.BOOLEAN:if(this.get_value())a=c.yes;else a=c.no;break;case d.KEYS:if(a.length)a=c.items_selected.replace('%s',a.length);break;}}else a="";}catch(e){a='';console.error(e);}if(typeof a!=='string')a='';return a;},set_text:function(a){var b="";if(a!==this.get_text())switch(this.data_type){case d.TEXT:this.set_value(a);break;case d.INTEGER:this.set_value(this.str_to_int(a));break;case d.FLOAT:this.set_value(this.str_to_float(a));break;case d.CURRENCY:this.set_value(this.str_to_float(a));break;case d.DATE:this.set_value(this.str_to_date(a));break;case d.DATETIME:this.set_value(this.str_to_datetime(a));break;case d.BOOLEAN:if(c)if(a.length&&a.toUpperCase().trim()===c.yes.toUpperCase().trim())this.set_value(true);else this.set_value(false);else if(a.length&&(a[0]==='T'||a[0]==='t'))this.set_value(true);else this.set_value(false);break;case d.KEYS:break;default:this.set_value(a);}},_convert_date_time:function(a){if(a){if(a.search('.')!==-1)a=a.split('.')[0];return this.format_string_to_date(a,'%Y-%m-%d %H:%M:%S');}else return a;},_convert_date:function(a){if(a){if(a.search(' ')!==-1)a=a.split(' ')[0];return this.format_string_to_date(a,'%Y-%m-%d');}else return a;},_convert_keys:function(a){var b=[];if(this.get_lookup_data())return this.get_lookup_data();else if(a)if(this.get_lookup_data_type()===d.TEXT)b=a.split(';');else b=a.split(';').map(function(a){return parseInt(a,10);});this.set_lookup_data(b);return b;},get_raw_value:function(){var a=this.get_data();if(this.data_type===d.DATETIME&&a)a=a.replace('T',' ');else if(this.multi_select)if(a instanceof Array)if(!a.length)a=null;return a;},get_value:function(){var a=this.get_raw_value();if(a===null){if(this.field_kind===d.ITEM_FIELD)switch(this.data_type){case d.INTEGER:a=0;break;case d.FLOAT:a=0;break;case d.CURRENCY:a=0;break;case d.TEXT:a='';break;case d.BOOLEAN:a=false;break;case d.KEYS:a=[];break;}else if(this.data_type===d.KEYS)a=[];}else switch(this.data_type){case d.DATE:a=this._convert_date(a);break;case d.DATETIME:a=this._convert_date_time(a);break;case d.BOOLEAN:return a?true:false;break;case d.KEYS:return this._convert_keys(a);break;}return a;},_change_lookup_field:function(a,b){var c=this,d=this.owner,e;if(this.lookup_item){if(this.owner){e=this;if(this.master_field)e=this.master_field;e.lookup_value=null;this.owner.each_field(function(a){if(a.master_field===e)if(e===c&&b&&b[a.field_name])a.lookup_value=b[a.field_name];else a.lookup_value=null;});}if(a)this.lookup_value=a;}},_do_before_changed:function(){if(this.field_kind===d.ITEM_FIELD){if(this.owner._get_item_state()!==d.STATE_INSERT&&this.owner._get_item_state()!==d.STATE_EDIT)throw c.not_edit_insert_state.replace('%s',this.owner.item_name);if(this.owner.on_before_field_changed)this.owner.on_before_field_changed.call(this.owner,this);}},_do_after_changed:function(a){if(this.owner&&this.owner.on_field_changed)this.owner.on_field_changed.call(this.owner,this,a);if(this.filter){this.filter.update(this);if(this.filter.owner.on_filter_changed)this.filter.owner.on_filter_changed.call(this.filter.owner,this.filter);}},_check_system_field_value:function(a){if(this.field_kind===d.ITEM_FIELD){if(this.field_name===this.owner._primary_key&&this.value&&this.value!==a)throw c.no_primary_field_changing.replace('%s',this.owner.item_name);if(this.field_name===this.owner._deleted_flag&&this.value!==a)throw c.no_deleted_field_changing.replace('%s',this.owner.item_name);}},set_value:function(a,b,c,e){if(a===undefined)a=null;this._check_system_field_value(a);this.new_value=null;this.new_lookup_value=b;if(a!==null){this.new_value=a;if(!this.multi_select)switch(this.data_type){case d.INTEGER:this.new_value=a;if(typeof a==="string")this.new_value=parseInt(a,10);break;case d.FLOAT:this.new_value=a;if(typeof a==="string")this.new_value=parseFloat(a);break;case d.CURRENCY:this.new_value=a;if(typeof a==="string")this.new_value=parseFloat(a);break;case d.BOOLEAN:this.new_value=a?1:0;break;case d.DATE:this.new_value=this.format_date_to_string(a,'%Y-%m-%d');break;case d.DATETIME:this.new_value=this.format_date_to_string(a,'%Y-%m-%d %H:%M:%S');break;case d.TEXT:this.new_value=a+'';break;case d.KEYS:this.new_value=a.join(';');b=a;break;}}if(this.get_raw_value()!==this.new_value){this._do_before_changed();try{this.set_data(this.new_value);}catch(f){throw this.field_name+": "+this.type_error();}this._change_lookup_field(b,c);this._set_modified(true);this._do_after_changed(e);}else if(b&&b!==this.lookup_value){this.lookup_value=b;this._do_after_changed(e,c);}this.new_value=null;this.new_lookup_value=null;this.update_controls();},_set_modified:function(a){if(this.field_kind===d.ITEM_FIELD)if(this.owner._set_modified&&!this.calculated)this.owner._set_modified(a);},get_lookup_data_type:function(){if(this.lookup_values)return d.TEXT;else if(this.lookup_item)if(this.lookup_field2)return this.lookup_item2._field_by_name(this.lookup_field2).data_type;else if(this.lookup_field1)return this.lookup_item1._field_by_name(this.lookup_field1).data_type;else return this.lookup_item._field_by_name(this.lookup_field).data_type;else return this.data_type;},_get_value_in_list:function(){var a=0,b=this.lookup_values.length,c='';for(;a<b;a++)if(this.lookup_values[a][0]===this.value)c=this.lookup_values[a][1];return c;},get_lookup_value:function(){var a=null;if(this.lookup_values)try{a=this._get_value_in_list();}catch(b){}else if(this.lookup_item){if(this.get_value()){a=this.get_lookup_data();switch(this.get_lookup_data_type()){case d.DATE:if(typeof a==="string")a=this._convert_date(a);break;case d.DATETIME:if(typeof a==="string")a=this._convert_date_time(a);break;case d.BOOLEAN:if(a)return true;else return false;break;}}}else a=this.get_value();return a;},set_lookup_value:function(a){if(this.lookup_item){this.set_lookup_data(a);this.update_controls();}},get_lookup_text:function(){var a=this,b,c='';try{if(this.lookup_values)c=this.get_lookup_value();else if(this.lookup_item){if(this.data_type===d.KEYS)c=this.text;else if(this.get_value())c=this.get_lookup_value();if(c===null)c='';else{b=this.get_lookup_data_type();if(b)switch(b){case d.DATE:c=this.date_to_str(c);break;case d.DATETIME:c=this.datetime_to_str(c);break;case d.FLOAT:c=this.float_to_str(c);break;case d.CURRENCY:c=this.cur_to_str(c);break;}}}}catch(e){}return c;},get_display_text:function(){var a,b,e,f='';if(this.multi_select){e=this.raw_value;if(e instanceof Array)b=e.length;if(b)if(b===1&&this.lookup_value)f=this.lookup_value;else f=c.items_selected.replace('%s',b);}else if(this.lookup_values)f=this.get_lookup_text();else if(this.lookup_item)if(this.field_kind===d.ITEM_FIELD&&!this.owner.expanded)f=this.get_text();else f=this.get_lookup_text();else if(this.data_type===d.CURRENCY){if(this.raw_value!==null)f=this.cur_to_str(this.get_value());}else f=this.get_text();if(this.owner&&(this.owner.on_field_get_text||this.owner.on_get_field_text))if(!this.on_field_get_text_called){this.on_field_get_text_called=true;try{if(this.owner.on_field_get_text)a=this.owner.on_field_get_text.call(this.owner,this);else if(this.owner.on_get_field_text)a=this.owner.on_get_field_text.call(this.owner,this);if(a!==undefined)f=a;}finally{this.on_field_get_text_called=false;}}if(f===undefined)f='';return f;},_set_read_only:function(a){this._read_only=a;this.update_controls();},_get_read_only:function(){var a=this._read_only;if(this.owner&&this.owner._parent_read_only&&this.owner._get_read_only())a=this.owner._get_read_only();return a;},set_visible:function(a){this._visible=a;this.update_controls();},get_visible:function(){return this._visible;},set_alignment:function(a){this._alignment=a;this.update_controls();},get_alignment:function(){return this._alignment;},set_expand:function(a){this._expand=a;this.update_controls();},get_expand:function(){return this._expand;},set_word_wrap:function(a){this._word_wrap=a;this.update_controls();},get_word_wrap:function(){return this._word_wrap;},check_type:function(){this.get_value();if((this.data_type===d.TEXT)&&(this.field_size!==0)&&(this.get_text().length>this.field_size))throw this.field_caption+': '+c.invalid_length.replace('%s',this.field_size);return true;},check_reqired:function(){if(!this.required)return true;else if(this.get_raw_value()!==null)return true;else throw this.field_caption+': '+c.value_required;},check_valid:function(){var a;if(this.check_reqired())if(this.check_type()){if(this.owner&&this.owner.on_field_validate){a=this.owner.on_field_validate.call(this.owner,this);if(a){throw a;return;}}if(this.filter){a=this.filter.check_value(this);if(a){throw a;return;}}return true;}},typeahead_options:function(){var a=this,b=10,c=a.lookup_item.copy(),e;c.lookup_field=this,e={length:b,lookup_item:c,source:function(e,f){var g={};if(a.owner&&a.owner.on_param_select_value)a.owner.on_param_select_value.call(a.owner,a,c);if(a.owner&&a.owner.on_field_select_value)a.owner.on_field_select_value.call(a.owner,a,c);if(a.filter&&a.filter.owner.on_filter_select_value)a.filter.owner.on_filter_select_value.call(a.filter.owner,a.filter,c);g.__search=[a.lookup_field,e,d.FILTER_CONTAINS_ALL];c.open({limit:b,params:g},function(b){var c=[],d=b.field_by_name(a.lookup_field);b.each(function(a){c.push([a._primary_key_field.value,d.value]);});return f(c);});}};return e;},get_typeahead_defs:function(a){var b=this,c,e=10,f;c=b.lookup_item.copy(),c.lookup_field=this,f={items:e,lookup_item:c,field:this,source:function(a,f){var g={};if(b.owner&&b.owner.on_param_select_value)b.owner.on_param_select_value.call(b.owner,b,c);if(b.owner&&b.owner.on_field_select_value)b.owner.on_field_select_value.call(b.owner,b,c);if(b.filter&&b.filter.owner.on_filter_select_value)b.filter.owner.on_filter_select_value.call(b.filter.owner,b.filter,c);g.__search=[b.lookup_field,a,d.FILTER_CONTAINS_ALL];c.open({limit:e,params:g},function(a){var c=[],d=a.field_by_name(b.lookup_field);a.each(function(a){c.push([a._primary_key_field.value,d.value]);});return f(c);});}};return f;},numeric_field:function(){if(!this.lookup_item&&(this.data_type===d.INTEGER||this.data_type===d.FLOAT||this.data_type===d.CURRENCY))return true;},system_field:function(){if(this.field_name===this.owner._primary_key||this.field_name===this.owner._deleted_flag||this.field_name===this.owner._master_id||this.field_name===this.owner._master_rec_id)return true;},_check_args:function(a){var b,c={};for(b=0;b<a.length;b++)c[typeof a[b]]=a[b];return c;},update_controls:function(){var a,b,c=this._check_args(arguments),d=c.boolean,e=c.number;b=this.controls.length;for(a=0;a<b;a++)this.controls[a].update(e);if(!d&&this.owner&&this.owner.controls){b=this.owner.controls.length;for(a=0;a<b;a++)this.owner.controls[a].update_field(this);}},update_control_state:function(a){for(var b=0;b<this.controls.length;b++){this.controls[b].error=a;this.controls[b].updateState(false);}},type_error:function(){switch(this.data_type){case d.INTEGER:return c.invalid_int.replace('%s','');case d.FLOAT:return c.invalid_float.replace('%s','');case d.CURRENCY:return c.invalid_cur.replace('%s','');case d.DATE:return c.invalid_date.replace('%s','');case d.DATE_TIME:return c.invalid_date.replace('%s','');case d.BOOLEAN:return c.invalid_bool.replace('%s','');default:return c.invalid_value.replace('%s','');}},valid_char_code:function(a){var c=String.fromCharCode(a),e=a>=48&&a<=57,f=c==='.'||c===b.DECIMAL_POINT||c===b.MON_DECIMAL_POINT,g=c==='+'||c==='-',h=this.get_lookup_data_type();if(h===d.INTEGER)if(!e&&!g)return false;if(h===d.FLOAT||h===d.CURRENCY)if(!e&&!g&&!f)return false;return true;},str_to_int:function(a){var b=parseInt(a,10);if(isNaN(b))throw "invalid integer value";return b;},str_to_date:function(a){return this.format_string_to_date(a,b.D_FMT);},str_to_datetime:function(a){return this.format_string_to_date(a,b.D_T_FMT);},str_to_float:function(a){var c;a=a.replace(b.DECIMAL_POINT,".");a=a.replace(b.MON_DECIMAL_POINT,".");c=parseFloat(a);if(isNaN(c))throw "invalid float value";return c;},str_to_cur:function(c){var d='';if(value){d=a.trim(c);if(b.MON_THOUSANDS_SEP)d=d.replace(b.MON_THOUSANDS_SEP,'');if(b.CURRENCY_SYMBOL)d=a.trim(d.replace(b.CURRENCY_SYMBOL,''));if(b.POSITIVE_SIGN)d=d.replace(b.POSITIVE_SIGN,'');if(b.NEGATIVE_SIGN&&d.indexOf(b.NEGATIVE_SIGN)!==-1){d=d.replace(b.NEGATIVE_SIGN,'');d='-'+d;}d=a.trim(d.replace(b.MON_DECIMAL_POINT,'.'));d=parseFloat(d);}return d;},int_to_str:function(a){if(a||a===0)return a.toString();else return '';},float_to_str:function(a){var c,d,e='';if(a||a===0){c=(''+a.toFixed(6)).replace(".",b.DECIMAL_POINT);d=c.length-1;for(;d>=0;d--)if((c[d]==='0')&&(e.length===0))continue;else e=c[d]+e;if(e.slice(e.length-1)===b.DECIMAL_POINT)e=e+'0';}return e;},date_to_str:function(a){if(a)return this.format_date_to_string(a,b.D_FMT);else return '';},datetime_to_str:function(a){if(a)return this.format_date_to_string(a,b.D_T_FMT);else return '';},cur_to_str:function(a){var c,d,e,f,g,h=0,i,j='';if(a||a===0){j=a.toFixed(b.FRAC_DIGITS);if(isNaN(j[0]))j=j.slice(1,j.length);c=j.indexOf('.');d='';e=j;if(c>=0){e=j.slice(0,c);d=j.slice(c+1,j.length);}j='';i=e.length;for(f=0;f<i;f++){g=e[i-f-1];j=g+j;h+=1;if((h%3===0)&&(f!==i-1))j=b.MON_THOUSANDS_SEP+j;}if(d)j=j+b.MON_DECIMAL_POINT+d;if(a<0){if(b.N_SIGN_POSN===3)j=b.NEGATIVE_SIGN+j;else if(b.N_SIGN_POSN===4)j=b.result+b.NEGATIVE_SIGN;}else if(b.P_SIGN_POSN===3)j=b.POSITIVE_SIGN+j;else if(b.P_SIGN_POSN===4)j=j+b.POSITIVE_SIGN;if(b.CURRENCY_SYMBOL)if(a<0)if(b.N_CS_PRECEDES)if(b.N_SEP_BY_SPACE)j=b.CURRENCY_SYMBOL+' '+j;else j=b.CURRENCY_SYMBOL+j;else if(b.N_SEP_BY_SPACE)j=j+' '+b.CURRENCY_SYMBOL;else j=j+b.CURRENCY_SYMBOL;else if(b.P_CS_PRECEDES)if(b.P_SEP_BY_SPACE)j=b.CURRENCY_SYMBOL+' '+j;else j=b.CURRENCY_SYMBOL+j;else if(b.P_SEP_BY_SPACE)j=j+' '+b.CURRENCY_SYMBOL;else j=j+b.CURRENCY_SYMBOL;if(a<0){if(b.N_SIGN_POSN===0&&b.NEGATIVE_SIGN)j=b.NEGATIVE_SIGN+'('+j+')';else if(b.N_SIGN_POSN===1)j=b.NEGATIVE_SIGN+j;else if(b.N_SIGN_POSN===2)j=j+b.NEGATIVE_SIGN;}else if(b.P_SIGN_POSN===0&&b.POSITIVE_SIGN)j=b.POSITIVE_SIGN+'('+j+')';else if(b.P_SIGN_POSN===1)j=b.POSITIVE_SIGN+j;else if(b.P_SIGN_POSN===2)j=j+b.POSITIVE_SIGN;}return j;},parseDateInt:function(a,b){var c=parseInt(a.substring(0,b),10);if(isNaN(c))throw 'invalid date';return c;},format_string_to_date:function(a,b){var c='',d=a,e,f,g,h=0,i=0,j=0;for(var k=0;k<b.length;++k){c=b.charAt(k);switch(c){case "%":break;case "d":e=this.parseDateInt(d,2);d=d.slice(2);break;case "m":f=this.parseDateInt(d,2);d=d.slice(2);break;case "Y":g=this.parseDateInt(d,4);d=d.slice(4);break;case "H":h=this.parseDateInt(d,2);d=d.slice(2);break;case "M":i=this.parseDateInt(d,2);d=d.slice(2);break;case "S":j=this.parseDateInt(d,2);d=d.slice(2);break;default:d=d.slice(c.length);}}return new Date(g,f-1,e,h,i,j);},leftPad:function(a,b,c){var d=a.toString();while(d.length<b)d=c+d;return d;},format_date_to_string:function(a,b){var c='',d='';for(var e=0;e<b.length;++e){c=b.charAt(e);switch(c){case "%":break;case "d":d+=this.leftPad(a.getDate(),2,'0');break;case "m":d+=this.leftPad(a.getMonth()+1,2,'0');break;case "Y":d+=a.getFullYear();break;case "H":d+=this.leftPad(a.getHours(),2,'0');break;case "M":d+=this.leftPad(a.getMinutes(),2,'0');break;case "S":d+=this.leftPad(a.getSeconds(),2,'0');break;default:d+=c;}}return d;},select_value:function(){var a=this,b=this.lookup_item.copy(),c=b.on_view_form_closed;b.is_lookup_item=true;b.lookup_field=this;if(this.data_type===d.KEYS){b.selections=this.value;b.on_view_form_closed=function(d){if(c)c(d);a.value=b.selections;};}if(this.owner&&this.owner.on_param_select_value)this.owner.on_param_select_value.call(this.owner,this,b);if(this.owner&&this.owner.on_field_select_value)this.owner.on_field_select_value.call(this.owner,this,b);if(this.filter&&this.filter.owner.on_filter_select_value)this.filter.owner.on_filter_select_value.call(this.filter.owner,this.filter,b);b.view();}};function r(a,b){var c=this,e;this.owner=a;this.set_info(b);if(a){a.filters.push(this);if(!(this.filter_name in a.filters))a.filters[this.filter_name]=this;if(this.field_name){e=this.owner._field_by_ID(this.field_name);this.field=this.create_field(e);if(this.field.lookup_values&&(typeof this.field.lookup_values==="number"))this.field.lookup_values=this.owner.task.lookup_lists[this.field.lookup_values];this.field.field_help=this.filter_help;this.field.field_placeholder=this.filter_placeholder;this.field.multi_select_all=this.multi_select_all;if(this.filter_type===d.FILTER_IN||this.filter_type===d.FILTER_NOT_IN)this.field.multi_select=true;if(this.filter_type===d.FILTER_RANGE){this.field1=this.create_field(e);this.field1.field_help=undefined;}}}Object.defineProperty(this,"value",{get:function(){return this.get_value();},set:function(a){this.set_value(a);}});Object.defineProperty(this,"text",{get:function(){return this.get_text();}});}r.prototype={constructor:r,create_field:function(a){var b=new q();b.set_info(a.get_info());b._read_only=false;b.filter=this;b._value=null;b._lookup_value=null;b.field_kind=d.FILTER_FIELD;return b;},copy:function(a){var b=new r(a,this.get_info());return b;},get_info:function(){var a,b=h.length,c=[];for(a=0;a<b;a++)c.push(this[h[a]]);return c;},set_info:function(a){if(a){var b,c=h.length;for(b=0;b<c;b++)this[h[b]]=a[b];}},get_value:function(){if(this.filter_type===d.FILTER_RANGE)if(this.field.raw_value!==null&&this.field1.raw_value!==null)return [this.field.raw_value,this.field1.raw_value];else return null;else return this.field.raw_value;},set_value:function(a,b){if(this.filter_type===d.FILTER_RANGE)if(a===null){this.field.value=null;this.field1.value=null;}else{this.field.value=a[0];this.field1.value=a[1];}else this.field.set_value(a,b);},update:function(a){var b=this.field;if(this.filter_type===d.FILTER_RANGE)if(a.value!==null){if(a===this.field)b=this.field1;if(b.raw_value===null)b.value=a.value;}},check_valid:function(){var a=this.check_value(this.field);if(a)throw a;},check_value:function(a){if(this.filter_type===d.FILTER_RANGE)if(this.field.raw_value===null&&this.field1.raw_value!==null||this.field.raw_value!==null&&this.field1.raw_value===null||this.field.value>this.field1.value)return c.invalid_range;},get_text:function(){var a='';if(this.visible&&this.value!=null){a=this.filter_caption+': ';if(this.filter_type===d.FILTER_RANGE)a+=this.field.get_display_text()+' - '+this.field1.get_display_text();else if(this.field.data_type===d.BOOLEAN)if(this.field.value)a+='x';else a+='-';else a+=this.field.get_display_text();}return a;}};s.prototype=new q();s.prototype.constructor=q;function s(a,b){q.call(this,a,b);this.param_name=this.field_name;this.param_caption=this.field_caption;this.field_size=0;this.report=a;this._value=null;this._lookup_value=null;this.field_kind=d.PARAM_FIELD;if(this.owner[this.param_name]===undefined)this.owner[this.param_name]=this;}function t(a,b,c,d,e,f){this.init(a,b,c,d,e,f);}t.prototype={constructor:t,init:function(b,c,d){var e=this,f={id_field:undefined,parent_field:undefined,text_field:undefined,parent_of_root_value:undefined,text_tree:undefined,on_click:undefined,on_dbl_click:undefined};this.id=b.task.controlId++;this.item=b;this.$container=c;this.options=a.extend({},f,d);this.$element=a('<div class="dbtree '+this.item.item_name+'" tabindex="0" style="overflow-x:auto; overflow-y:auto;"></div>');this.$element.css('position','relative');this.$element.data('tree',this);this.$element.tabindex=0;this.item.controls.push(this);this.$element.bind('destroyed',function(){e.item.controls.splice(e.item.controls.indexOf(e),1);});this.$element.appendTo(this.$container);this.height(c.height());this.$element.on('focus blur',function(a){e.select_node(e.selected_node,false);});this.$element.on('keyup',function(a){e.keyup(a);});this.$element.on('keydown',function(a){e.keydown(a);});if(b._get_active()&&this.$container.width())this.build();},form_closing:function(){var a=this.$element.closest('.modal');if(a)return a.data('_closing');return false;},height:function(a){if(a)this.$element.height(a);else return this.$element.height();},is_focused:function(){return this.$element.get(0)===document.activeElement;},scroll_into_view:function(){this.select_node(this.selected_node);},update:function(a){var b,c=this,e;if(this.form_closing())return;switch(a){case d.UPDATE_OPEN:this.build();break;case d.UPDATE_CANCEL:this.changed();break;case d.UPDATE_APPEND:this.changed();break;case d.UPDATE_INSERT:this.changed();break;case d.UPDATE_DELETE:case d.UPDATE_DELETE:this.changed();break;case d.UPDATE_SCROLLED:this.syncronize();break;case d.UPDATE_CONTROLS:this.build();break;case d.UPDATE_CLOSE:this.$element.empty();break;}},keydown:function(a){var b=this,c,d=(a.keyCode?a.keyCode:a.which);if(this.selected_node&&!a.ctrlKey&&!a.shiftKey)switch(d){case 13:a.preventDefault();this.toggle_expanded(this.selected_node);break;case 38:a.preventDefault();c=this.selected_node.prev();if(c.length)this.select_node(c);else{c=this.selected_node.parent().parent();if(c.length&&c.prop("tagName")==="LI")this.select_node(c);}break;case 40:a.preventDefault();if(this.selected_node.hasClass('parent')&&!this.selected_node.hasClass('collapsed')){c=this.selected_node.find('ul:first li:first');if(c.length)this.select_node(c);}else{c=this.selected_node.next();if(c.length)this.select_node(c);else{c=this.selected_node.find('ul:first li:first');if(c.length)this.select_node(c);}}break;}},keyup:function(a){var b=this,c=(a.keyCode?a.keyCode:a.which);if(!a.ctrlKey&&!a.shiftKey)switch(c){case 13:break;case 38:break;case 40:break;}},build_child_nodes:function(a,b){var c=0,d=b.length,e,f,g,h,i,j,k,l,m,n,o,p;for(c=0;c<d;c++){e=b[c];f=e.id;g=e.text;h=e.rec;i='<span class="empty-bullet"></span>',j="",k="",o=this.child_nodes[f+''];if(o&&o.length){i='<i class="icon-chevron-right bullet"></i>';j=' parent';k='collapsed';}l='<li class="'+k+j+'" style="list-style: none" data-rec="'+h+'">'+'<div><span class="tree-bullet">'+i+'</span>'+'<span class="tree-text">'+g+'<span></div>';a+=l;if(o&&o.length){a+='<ul style="display: none">';a=this.build_child_nodes(a,o);a+='</ul>';}a+='</li>';a+='</li>';}return a;},collect_nodes:function(a){var b=a[this.options.id_field],c=a[this.options.parent_field],d=a[this.options.text_field],e;this.child_nodes={};a.first();while(!a.eof()){e=this.child_nodes[c.value+''];if(e===undefined){e=[];this.child_nodes[c.value+'']=e;}e.push({'id':b.value,'text':d.display_text,'rec':a.rec_no});a.next();}},build:function(){var b=this,c=this.item.clone(),d='<ul>',e,f,g,h,i,j,k;this.collect_nodes(c);this.$element.empty();k=this.child_nodes[this.options.parent_of_root_value+''];if(k&&k.length)d=this.build_child_nodes(d,k);d+='</ul>';this.$element.append(a(d));j=this.$element.find('li');f=j.length;for(e=0;e<f;e++){i=j.eq(e);g=i.data('rec');c._set_rec_no(g);this.item._cur_row=g;i.data("record",c._dataset[g]);h=c.rec_controls_info();h[this.id]=i.get(0);if(this.options.node_callback)this.options.node_callback(i,this.item);}this.select_node(j.eq(0));this.$element.off('click','li.parent > div span.tree-bullet');this.$element.on('click','li.parent > div span.tree-bullet',function(c){var d=a(this),e=d.parent().parent(),f;b.toggle_expanded(e);c.preventDefault();c.stopPropagation();});this.$element.off('click','li > div span.tree-text');this.$element.on('click','li > div span.tree-text',function(c){var d=a(this).parent().parent();b.select_node(d);});},toggle_expanded:function(a){var b=a.find('div:first span.tree-bullet'),c;if(a.hasClass('parent')){c=a.find('ul:first'),a.toggleClass('collapsed');if(a.hasClass('collapsed'))b.html('<i class="icon-chevron-right bullet"></i>');else b.html('<i class="icon-chevron-down bullet"></i>');c.slideToggle(0);}},expand:function(a){if(a.hasClass('parent')&&a.hasClass('collapsed'))this.toggle_expanded(a);a=a.parent().parent();if(a.prop("tagName")==="LI")this.expand(a);},collapse:function(a){if(a.hasClass('parent')&&!a.hasClass('collapsed'))this.toggle_expanded(a);},select_node:function(a,b){var c=this,d,e;if(b===undefined)b=true;if(this.selected_node)this.selected_node.removeClass('selected selected-focused');if(a&&(!this.selected_node||a.get(0)!==this.selected_node.get(0))){this.selected_node=a;e=this.item._dataset.indexOf(a.data("record"));if(e!==this.item.rec_no)this.item._set_rec_no(e);d=this.selected_node.parent().parent();if(d.prop("tagName")==="LI")this.expand(d);}if(this.is_focused())this.selected_node.addClass('selected-focused');else this.selected_node.addClass('selected');if(b)this.update_selected_node(this.selected_node);},update_selected_node:function(a){var b,c,d,e,f;if(a.length){b=this.$element.scrollTop();c=b+this.$element.height();d=a.get(0).offsetTop;e=d+a.height();if(d<b)this.$element.scrollTop(d);else if(e>c)this.$element.scrollTop(e-this.$element.height());}},update_field:function(){},syncronize:function(){var b,c;if(this.item.record_count())try{b=this.item.rec_controls_info(),c=a(b[this.id]);this.select_node(c);}catch(d){console.log(d);}},changed:function(){}};function u(a,b,c,d){this.init(a,b,c,d);}u.prototype={constructor:u,init:function(b,c,d,e){var f=this,g={table_class:undefined,height:undefined,row_count:undefined,fields:[],column_width:{},title_word_wrap:false,row_line_count:1,expand_selected_row:0,selections:undefined,select_all:true,selection_limit:undefined,tabindex:0,striped:true,dblclick_edit:true,on_click:undefined,on_dblclick:undefined,on_pagecount_update:undefined,on_page_changed:undefined,editable:false,keypress_edit:true,editable_fields:undefined,selected_field:undefined,append_on_lastrow_keydown:false,sortable:false,sort_fields:undefined,sort_add_primary:false,row_callback:undefined,title_callback:undefined,summary_fields:undefined,show_footer:undefined,show_paginator:true,paginator_container:undefined,freeze_count:0,hide_y_scroll:true};if(!c.length)return;this.item=b;if(!this.item.paginate)g.striped=false;this.id=b.task.gridId++;this.$container=c;this.$container.css('position','relative');this.master_table=e;this.options=a.extend({},g,d);if(!this.options.height&&!this.options.row_count)this.options.height=480;if(this.options.row_line_count<1)this.options.row_line_count=1;if(this.item.master)this.options.select_all=false;if(this.options.summary_fields&&this.item.paginate)this.options.show_footer=true;this.editMode=false;this._sorted_fields=[];this._multiple_sort=false;this.on_dblclick=this.options.on_dblclick;this.init_selections();this.page=0;this.recordCount=0;this.cellWidths={};this.autoFieldWidth=true;this.scrollLeft=0;this.fieldWidthUpdated=false;this.initFields();this.$element=a('<div class="dbtable">');this.$element.addClass(b.item_name);this.$element.append(a('<div class="table-container" style="overflow-x:auto;">'));this.$element.append(a('<div class="paginator text-center">'));if(this.options.table_class)this.$element.addClass(this.options.table_class);this.$element.data('dbtable',this);this.item.controls.push(this);this.resize_id='resize.dbtable-'+this.item.item_name+this.id;if(this.master_table){this.$element.addClass('freezed');this.resize_id='resize.dbtable.freezed-'+this.item.item_name+this.id;}a(window).on(this.resize_id,function(){clearTimeout(f.timeOut);f.timeOut=setTimeout(function(){if(f.master_table&&!f.master_table.freezed_table)return;f.build();f.sync_freezed();},100);});this.$element.bind('destroyed',function(){a(window).off(f.resize_id);f.item.controls.splice(f.item.controls.indexOf(f),1);});this.$container.empty();this.$element.appendTo(this.$container);this.createTable();this.create_pager();this.sync_freezed();if(b._get_active())setTimeout(function(){f.init_table();f.sync_freezed();},0);},get_freezed_fields:function(a){var b,c=[];if(!a)a=this.options.freeze_count;for(b=0;b<a;b++)c.push(this.fields[b].field_name);return c;},create_freezed_table:function(){var b,c,d;c=a.extend({},this.options);c.show_paginator=false;c.fields=[];c.freeze_count=0;c.fields=this.get_freezed_fields();d=a('<div>');this.freezed_table=new u(this.item,d,c,this);this.freezed_table.$element.detach();this.freezed_table.$element.css('position','absolute');this.freezed_table.$element.css('left','0');this.freezed_table.$element.css('top','0');this.freezed_table.$element.css('overflow','hidden');this.freezed_table.$table_container.css('overflow','hidden');this.freezed_table.$outer_table.css('overflow','hidden');this.freezed_table.$scroll_div.css('overflow','hidden');this.freezed_table.$container=this.$container;this.$container.append(this.freezed_table.$element);},delete_freezed_table:function(){this.freezed_table.$element.remove();delete this.freezed_table;this.freezed_table=undefined;},sync_freezed:function(){var a,b,c,d,e,f,g,h,i,j,k,l;if(this.options.freeze_count){if(this.freezed_table){h=this.get_freezed_fields();i=this.freezed_table.get_freezed_fields(this.options.freeze_count);j=h.length===i.length;if(j)for(a=0;a<h.length;a++)if(h[a]!==i[a]){j=false;break;}if(!j)this.delete_freezed_table();}if(this.$scroll_div.get(0).scrollWidth>this.$element.innerWidth()){if(!this.freezed_table)this.create_freezed_table();b=this.options.freeze_count-1;if(this.item.selections)b+=1;c=this.$head.find('th').eq(b);k=this.$element.find('.table-container')[0].scrollLeft;l=k+(c.position().left+c.outerWidth(true)+1);this.freezed_table.$element.width(l);}else if(this.freezed_table)this.delete_freezed_table();}else if(this.master_table){for(a=0;a<this.fields.length-1;a++){g=this.fields[a].field_name;f=this.master_table.getCellWidth(g);this.setCellWidth(g,f);d=this.$table.find('td.'+g);c=this.$element.find("thead tr:first th."+g);e=this.$element.find("tfoot tr:first th."+g);d.width(f);d.find('div').width(f);c.width(f);c.find('div').width(f);e.width(f);e.find('div').width(f);}this.syncColWidth();}},init_selections:function(){var a;if(this.options.selections&&this.options.selections instanceof Array)this.item.selections=this.options.selections;if(this.item.lookup_field&&this.item.lookup_field.multi_select){a=this.item.lookup_field.raw_value;this.options.select_all=this.item.lookup_field.multi_select_all;if(a instanceof Array)this.item.selections=a;else this.item.selections=[];}this.item.select_all=this.options.select_all;},selections_update_selected:function(){var a=this.$element.find('th .multi-select .sel-count');if(this.item.selections){a.text(this.item.selections.length);if(this.item.show_selected)a.addClass('selected-shown');else a.removeClass('selected-shown');if(this.item.lookup_field&&this.item.lookup_field.multi_select)if(this.item.selections.length===1&&this.item._primary_key_field&&this.item.selections.indexOf(this.item._primary_key_field.value)!==-1)this.item.lookup_field.set_value(this.item.selections,this.item.field_by_name(this.item.lookup_field.lookup_field).display_text);else this.item.lookup_field.set_value(this.item.selections,'');}},selections_get_selected:function(){return this.item.selections.indexOf(this.item._primary_key_field.value)!==-1;},selections_can_change:function(a){var b=true;if(a&&this.options.selection_limit){b=(this.options.selection_limit&&this.options.selection_limit>=this.item.selections.length+1);if(!b)this.item.warning(c.selection_limit_exceeded.replace('%s',this.options.selection_limit));}return b;},selections_set_selected:function(a){var b=a,c,d=false;if(this.selections_can_change(a)){if(a){this.item.selections.push(this.item._primary_key_field.value);d=true;}else{c=this.item.selections.indexOf(this.item._primary_key_field.value);if(c!==-1){this.item.selections.splice(c,1);d=this.selections_get_all_selected();}}this.selections_update_selected();this.$element.find('input.multi-select-header').prop('checked',d);}else b=false;return b;},selections_get_all_selected:function(){var a=this,b=this.item.clone(),c=false;b.each(function(b){if(a.item.selections.indexOf(b._primary_key_field.value)!==-1){c=true;return false;}});return c;},selections_set_all_selected_ex:function(a){var b=this,c,d,e=[],f,g,h,i,j;if(this.options.select_all){i=this.item.copy({handlers:false});i._where_list=this.item._open_params.__filters;i._order_by_list=this.item._open_params.__order;if(this.options.selection_limit)f=this.options.selection_limit;e.push(i._primary_key);for(c=0;c<i._where_list.length;c++){d=this.item.field_by_name(i._where_list[c][0]);if(d.lookup_item)e.push(d.field_name);}for(c=0;c<i._order_by_list.length;c++){d=this.item.field_by_ID(i._order_by_list[c][0]);if(e.indexOf(d.field_name)===-1)e.push(d.field_name);}i.open({fields:e,limit:f},function(){var d={};for(c=0;c<b.item.selections.length;c++)d[b.item.selections[c]]=true;b.item.selections.length=0;i.each(function(b){if(a)d[b._primary_key_field.value]=true;else delete d[b._primary_key_field.value];});for(var e in d)b.item.selections.push(parseInt(e,10));b.$table.find('td input.multi-select').prop('checked',a);b.$element.find('input.multi-select-header').prop('checked',b.selections_get_all_selected());b.selections_update_selected();});}},selections_set_all_selected:function(a){var b=this,c,d,e=[],f,g,h,i,j;j=this.item.clone();j.each(function(c){var d;if(b.selections_can_change(a)){if(a)b.item.selections.push(c._primary_key_field.value);else{d=b.item.selections.indexOf(c._primary_key_field.value);if(d!==-1)b.item.selections.splice(d,1);}}else{g=true;return false;}});if(g)this.build();else b.$table.find('td input.multi-select').prop('checked',a);this.selections_update_selected();},initFields:function(){var a=0,b,c,d;this.fields=[];if(this.options.fields.length)d=this.options.fields;else d=this.item.view_options.fields;if(d.length){b=d.length;for(;a<b;a++){c=this.item.field_by_name(d[a]);if(c)this.fields.push(c);}}this.options.editable=this.options.editable&&!this.item.read_only;if(this.options.editable)this.options.striped=false;this.editableFields=[];if(this.options.editable_fields){b=this.options.editable_fields.length;for(a=0;a<b;a++){c=this.item.field_by_name(this.options.editable_fields[a]);if(c&&!c.read_only)this.editableFields.push(c);}}else{b=this.fields.length;for(a=0;a<b;a++)if(!this.fields[a].read_only)this.editableFields.push(this.fields[a]);}this.initSelectedField();this.colspan=this.fields.length;if(this.item.selections)this.colspan+=1;},initKeyboardEvents:function(){var a=this,b;clearTimeout(b);b=setTimeout(function(){a.$table.on('keydown',function(b){a.keydown(b);});a.$table.on('keyup',function(b){a.keyup(b);});a.$table.on('keypress',function(b){a.keypress(b);});},300);},createTable:function(){var b=this,c=a(document),d,e,f,g,h=0,i;this.colspan=this.fields.length;if(this.item.selections)this.colspan+=1;this.$element.find('.table-container').append(a('<table class="outer-table" style="width: 100%;">'+'   <thead>'+'       <tr><th>&nbsp</th></tr>'+'   </thead>'+'   <tr>'+'       <td id="top-td" style="padding: 0;" colspan='+this.colspan+'>'+'           <div class="overlay-div" style="height: 100px; width: 100%; overflow-y: auto; overflow-x: hidden;">'+'               <table class="inner-table" style="width: 100%"></table>'+'           </div>'+'       </td>'+'   </tr>'+'   <tfoot class="outer-table">'+'       <tr><th>&nbsp</th></tr>'+'   </tfoot>'+'</table>'));this.$table_container=this.$element.find(".table-container");this.$outer_table=this.$element.find("table.outer-table");this.$scroll_div=this.$element.find('div.overlay-div');this.$table=this.$element.find("table.inner-table");this.$head=this.$element.find("table.outer-table thead tr:first");this.$foot=this.$element.find("table.outer-table tfoot tr:first");if(this.item.paginate&&this.options.hide_y_scroll)this.$scroll_div.css('overflow-y','hidden');this.$scroll_div.keydown(function(a){var b=(a.keyCode?a.keyCode:a.which);if(b==32)a.preventDefault();});this.$element.find('table.outer-table').addClass("table table-condensed table-bordered").css("margin",0);this.$table.addClass("table table-condensed").css("margin",0).attr("disabled",false);if(this.options.striped)this.$table.addClass("table-striped");this.$table.on('mousedown dblclick','td',function(c){var d=this;if(this.nodeName!=='TD')d=a(this).closest('td');c.preventDefault();c.stopPropagation();b.clicked(c,d);});this.$element.on('mousewheel DOMMouseScroll','div.overlay-div, table.inner-table',function(a){if(a.originalEvent.wheelDelta>0||a.originalEvent.detail<0)b.prior_record();else b.next_record();a.preventDefault();a.stopPropagation();});this.$table.on('click','td',function(a){if(b.options.on_click)b.options.on_click.call(b.item,b.item);});this.$table.on('mouseenter mouseup','td div',function(){var c=a(this),d=c.data('tooltip');if(Math.abs(this.offsetHeight-this.scrollHeight)>1||Math.abs(this.offsetWidth-this.scrollWidth)>1){b._remove_tooltip();c.tooltip({'placement':'right','container':'body','title':c.text()}).on('hide hidden show shown',function(a){if(a.target===c.get(0))a.stopPropagation();}).eq(0).tooltip('show');try{c.data('tooltip').$tip.addClass('table-tooltip');}catch(e){}}});this.$table.on('mousedown','td input.multi-select',function(c){var d=a(this),e=d.is(':checked');b.clicked(c,d.closest('td'));b.selections_set_selected(!e);d.prop('checked',b.selections_get_selected());});this.$table.on('click','td input.multi-select',function(c){var d=a(this);c.stopPropagation();c.preventDefault();setTimeout(function(){d.prop('checked',b.selections_get_selected());},0);});this.$element.on('click','input.multi-select-header',function(c){b.selections_set_all_selected(a(this).is(':checked'));});this.$table.attr("tabindex",this.options.tabindex);this.initKeyboardEvents();this.$element.on('mousemove.grid-title','table.outer-table thead tr:first th',function(c){var d=a(this),e=d.data('field_name'),f=b.$element.find("thead tr:first th:last").get(0);if(d.outerWidth()-c.offsetX<8&&!i&&(this!==f||b.master_table))d.css('cursor','col-resize');else if(b.options.sortable&&(!b.options.sort_fields||b.options.sort_fields.indexOf(e)!==-1))d.css('cursor','pointer');else d.css('cursor','default');});function j(a){var b=h+a.screenX-i,c=parseInt(d.css("left"),10);if(i){a.preventDefault();if(b>-(e.innerWidth()-30)){h=b;d.css('left',c+a.screenX-i);}i=a.screenX;}}function k(a,c){var d,e,f,g,h,i,j=b.$element.find("thead tr:first th:last").get(0),k,l,m;e=a.data('field_name');g=b.$table.find('td.'+e);i=b.$element.find("tfoot tr:first th."+e);l=b.getCellWidth(e);m=l+c;b.setCellWidth(e,m);if(b.master_table){b.$element.width(b.$element.width()+c);b.master_table.setCellWidth(e,m);g=b.master_table.$table.find('td.'+e);h=b.master_table.$element.find("thead tr:first th."+e);i=b.master_table.$element.find("tfoot tr:first th."+e);g.width(m);g.find('div').width(m);h.width(m);h.find('div').width(m);i.width(m);i.find('div').width(m);b.master_table.syncColWidth();b.master_table.sync_freezed();}else{g.width(m);g.find('div').width(m);a.width(m);a.find('div').width(m);i.width(m);i.find('div').width(m);b.syncColWidth();}b.sync_freezed();}function l(a){var b,f,g,j;c.off("mousemove.grid-title");c.off("mouseup.grid-title");k(e,h);i=undefined;d.remove();}this.$element.on('mousedown.grid-title','table.outer-table thead tr:first th',function(f){var g=a(this),k,m,n=g.data('field_name'),o,p,q=[],k,r=false,s,t,u,v,w,x;m=b.$element.find("thead tr:first th:last").get(0);if(g.outerWidth()-f.offsetX<8&&(this!==m||b.master_table)){g.css('cursor','default');i=f.screenX;e=g;k=b.fields.indexOf(b.item.field_by_name(n));h=0;c.on("mousemove.grid-title",j);c.on("mouseup.grid-title",l);u=b.$container.closest('.modal');if(u.length){w=g.offset().left-u.offset().left;v=b.$element.offset().top-u.offset().top;}else{u=a('body');w=g.offset().left;v=b.$element.offset().top;}d=a('<div>').addClass('selection-box').css({'width':0,'height':b.$outer_table.find('thead').innerHeight()+b.$scroll_div.innerHeight(),'left':w+g.outerWidth(),'top':v});d.appendTo(u);}else if(n&&b.options.sortable&&(!b.options.sort_fields||b.options.sort_fields.indexOf(n)!==-1)){if(f.ctrlKey){if(!b._multiple_sort)b._multiple_sort=true;}else if(b._multiple_sort){b._sorted_fields=[];b._multiple_sort=false;}p=b.item.field_by_name(n).ID;x=b._sorted_fields.slice();if(b._multiple_sort){k=-1;for(var y=0;y<x.length;y++)if(x[y][0]===p){k=y;break;}if(k===-1)x.push([p,false]);else x[k][1]=!x[k][1];}else if(x.length&&x[0][0]===p)x[0][1]=!x[0][1];else x=[[p,false]];b._sorted_fields=x.slice();if(b.item.master||!b.item.paginate)b.item._sort(b._sorted_fields);else{if(b.options.sort_add_primary){t=b.item[b.item._primary_key];r=b._sorted_fields[b._sorted_fields.length-1][1];b._sorted_fields.push([t.ID,r]);}b.item._open_params.__order=b._sorted_fields;b.item.open({params:b.item._open_params,offset:0},true);}}});this.$table.focus(function(a){if(!this.syncronizing){this.syncronizing=true;try{b.syncronize();}finally{this.syncronizing=false;}}});this.$table.blur(function(a){b.syncronize();});this.fill_footer();this.calculate();},_remove_tooltip:function(){try{a('body > div.tooltip.table-tooltip').remove();}catch(b){}},calculate:function(){var b,c,d,e,f,g,h,i,j,k;if(this.master_table){this.row_count=this.master_table.row_count;this.textHeight=this.master_table.textHeight;this.row_height=this.master_table.row_height;this.selected_row_height=this.master_table.selected_row_height;this.height(this.master_table.height());this.$scroll_div.height(this.master_table.$scroll_div.height());return;}c=this.$element.clone().css("float","left").css("position","absolute").css("top",0);c.width(this.$container.width());if(!c.width())c.width(a('body').width());this.fill_title(c);this.fill_footer(c);this.create_pager(c);d=c.find("table.inner-table");if(this.item.selections&&!this.item.master)e='<tr><td><div><input type="checkbox"></div></td><td><div>W</div></td></tr>';else e='<tr><td><div>W</div></td></tr>';for(b=0;b<10;b++)d.append(e);a('body').append(c);f=d.find('tr:last td');this.textHeight=f.find('div').height();i=f.outerHeight(true);g=i*10-d.innerHeight();h=Math.abs(Math.abs(g)-10);if(h&&h<5&&g<0){i+=Math.round(h);g=i*10-d.innerHeight();}this.row_height=i+(this.options.row_line_count-1)*this.textHeight;this.selected_row_height=0;j=c.outerHeight();k=c.find('div.overlay-div').innerHeight();c.remove();this.$scroll_div.height(this.options.height-(j-k)-c.find('.paginator').outerHeight(true));if(this.item.paginate){if(this.options.row_count)this.row_count=this.options.row_count;else{k=this.$scroll_div.innerHeight()+g;if(this.options.expand_selected_row){this.selected_row_height=i+(this.options.expand_selected_row-1)*this.textHeight;k=this.$scroll_div.height()-this.selected_row_height+g;}this.row_count=Math.floor(k/this.row_height);}if(this.options.expand_selected_row)this.row_count+=1;if(this.row_count<=0)this.row_count=1;this.item._limit=this.row_count;}else if(this.options.row_count)this.$scroll_div.height(this.row_height*this.options.row_count);},create_pager:function(b){var d=this,e,f,g,h;if(this.item.paginate&&this.options.show_paginator){g=-1;e=a('   <div id="pager" style="margin: 0 auto">'+'       <form class="form-inline" style="margin: 0">'+'           <a class="btn btn-small" tabindex="-1" href="first"><i class="icon-backward"></i></a>'+'           <a class="btn btn-small" tabindex="-1" href="prior"><i class="icon-chevron-left"></i></a>'+'           <label  class="control-label" for="input-page">'+c.page+'</label>'+'           <input class="pager-input input-mini" id="input-page" tabindex="'+g+'" type="text">'+'           <label id="page-count" class="control-label" for="input-page">'+c.of+'1000000 </label>'+'           <a class="btn btn-small" tabindex="-1" href="next"><i class="icon-chevron-right"></i></a>'+'           <a class="btn btn-small" tabindex="-1" href="last"><i class="icon-forward"></i></a>'+'       </form>'+'   </div>');this.$fistPageBtn=e.find('[href="first"]');this.$fistPageBtn.on("click",function(a){d.firstPage();a.preventDefault();});this.$fistPageBtn.addClass("disabled");this.$priorPageBtn=e.find('[href="prior"]');this.$priorPageBtn.on("click",function(a){d.priorPage();a.preventDefault();});this.$priorPageBtn.addClass("disabled");this.$nextPageBtn=e.find('[href="next"]');this.$nextPageBtn.on("click",function(a){d.nextPage();a.preventDefault();});this.$lastPageBtn=e.find('[href="last"]');this.$lastPageBtn.on("click",function(a){d.lastPage();a.preventDefault();});this.$pageInput=e.find('input');this.$pageInput.val(1);this.$pageInput.on("keydown",function(a){var b,c=(a.keyCode?a.keyCode:a.which);if(c===13){b=parseInt(d.$pageInput.val(),10);a.preventDefault();if(!isNaN(b)&&(b>0)){d.$pageInput.val(b);d.setPageNumber(b-1);}}});this.$page_count=e.find('#page-count');this.$page_count.text(c.of+'1000000');f=e.find('#pager').clone().css("float","left").css("position","absolute").css("top",-1000);a("body").append(f);h=f.width();f.remove();if(this.options.paginator_container){this.options.paginator_container.empty();this.options.paginator_container.append(e);}else if(b)b.find('.paginator').append(e);else this.$element.find('.paginator').append(e);this.$page_count.text(c.of+' ');e.find('#pager').width(h);}},initSelectedField:function(){var a;if(!this.selectedField&&this.editableFields.length){this.selectedField=this.editableFields[0];if(this.options.selected_field){a=this.item.field_by_name(this.options.selected_field);if(this.editableFields.indexOf(a)!==-1)this.selectedField=a;}}},setSelectedField:function(a){var b=this,c=this.selectedField!==a;if(this.editableFields.indexOf(a)!==-1){if(c&&this.options.editable){this.flushEditor();this.hideEditor();}this.hide_selection();this.selectedField=a;if(c&&this.options.editable&&this.editMode){clearTimeout(this.editorsTimeOut);this.editorsTimeOut=setTimeout(function(){b.showEditor();},75);}this.show_selection();}},nextField:function(){var a;if(this.selectedField){a=this.editableFields.indexOf(this.selectedField);if(a<this.editableFields.length-1)this.setSelectedField(this.editableFields[a+1]);}},priorField:function(){var a;if(this.selectedField){a=this.editableFields.indexOf(this.selectedField);if(a>0)this.setSelectedField(this.editableFields[a-1]);}},hideEditor:function(){var a,b,c,d;d;if(this.editing){try{this.editMode=false;d=this.editor.$controlGroup.parent();b=this.editor.field;c=d.find('div.'+b.field_name);a=d.outerWidth();d.css("padding-left",this.editor.paddingLeft);d.css("padding-top",this.editor.paddingTop);d.css("padding-right",this.editor.paddingRight);d.css("padding-bottom",this.editor.paddingBottom);this.editor.$controlGroup.remove();this.editor.removed=true;this.editor=undefined;d.outerWidth(a);c.show();}finally{this.editing=false;}this.focus();}},flushEditor:function(){if(this.editor&&this.editing)this.editor.change_field_text();},selected_field_visible:function(){var a,b;if(this.selectedField&&this.freezed_table){a=this.selectedField.field_name;b=this.$table.find('tr:first td.'+a);if(b.position().left<this.freezed_table.$element.width())return false;}return true;},showEditor:function(){var b,c,d,e,f,g=this.itemRow();if(g&&!this.editing&&this.selectedField&&this.selected_field_visible()&&this.item.record_count()){if(!this.item.is_changing())this.item.edit();this.editMode=true;this.editor=new w(this,this.selectedField);this.editor.$controlGroup.find('.controls, .input-prepend, .input-append, input').css('margin',0);this.editor.$controlGroup.css('margin',0);e=g.find('div.'+this.editor.field.field_name);e.hide();f=g.find('td.'+this.editor.field.field_name);this.editor.$input.css('font-size',f.css('font-size'));c=f.innerHeight();b=f.outerWidth();this.editor.paddingLeft=f.css("padding-left");this.editor.paddingTop=f.css("padding-top");this.editor.paddingRight=f.css("padding-right");this.editor.paddingBottom=f.css("padding-bottom");this.editor.padding=f.css("padding");f.css("padding",0);f.outerWidth(b);f.append(this.editor.$controlGroup);b=0;this.editor.$input.parent().children('*').each(function(){b+=a(this).outerWidth(true);});this.editor.$input.width(this.editor.$input.width()+this.editor.$controlGroup.width()-b);this.editor.$controlGroup.find('.controls, .input-prepend, .input-append, input, btn').outerHeight(c,true);this.editor.update();if(this.is_focused())this.editor.$input.focus();this.editing=true;}},height:function(a){if(a===undefined)return this.$element.height();else this.$scroll_div.height(a-(this.$element.height()-this.$scroll_div.height()));},fill_title:function(b){var c,d,e=this,f,g,h,i,j,k,l='',m,n,o,p={},q,r='',s;if(b===undefined)b=this.$element;if(!this._sorted_fields)this._sorted_fields=[];d=this._sorted_fields.length;for(c=0;c<d;c++)try{o=this._sorted_fields[c][1];f=this.item.field_by_ID(this._sorted_fields[c][0]);if(o)p[f.field_name]='icon-arrow-down';else p[f.field_name]='icon-arrow-up';}catch(t){}g=b.find("table.outer-table thead tr:first");g.empty();if(this.item.selections)if(this.item.master){if(this.selections_get_all_selected())l='checked';h=a('<div class="text-center multi-select" style="overflow: hidden"></div>');n=a('<p class="sel-count text-center">'+this.item.selections.length+'</p>');h.append(n);j=a('<input class="multi-select-header" type="checkbox" '+l+' tabindex="-1">');h.append(j);i=a('<th class="multi-select-header"></th>').append(h);s=this.getCellWidth('multi-select');if(s&&this.fields.length){i.width(s);h.width('auto');}g.append(i);}else{if(this.selections_get_all_selected())l='checked';h=a('<div class="text-center multi-select" style="overflow: hidden"></div>');n=a('<p class="sel-count text-center">'+this.item.selections.length+'</p>');h.append(n);if(this.options.select_all)r+='<li id="mselect-all"><a tabindex="-1" href="#">'+task.language.select_all+'</a></li>'+'<li id="munselect-all"><a tabindex="-1" href="#">'+task.language.unselect_all+'</a></li>';q=task.language.show_selected;if(e.item.show_selected)q=task.language.show_all;r+='<li id="mshow-selected"><a tabindex="-1" href="#">'+q+'</a></li>';this.$element.find('#mselect-block').empty();k=a('<div style="height: 0; position: relative;">'+'<div id="mselect-block" class="btn-group" style="position: absolute">'+'<button type="button" class="btn mselect-btn" tabindex="-1">'+'<input class="multi-select-header" type="checkbox" tabindex="-1" style="margin: 0" '+l+'>'+'</button>'+'<a class="btn dropdown-toggle" data-toggle="dropdown" href="#" tabindex="-1" style="padding: 3px">'+'<span class="caret"></span>'+'</a>'+'<ul class="dropdown-menu">'+r+'</ul>'+'</div>'+'</div>');j=k.find('#mselect-block');k.find("#mselect-all").click(function(a){a.preventDefault();e.selections_set_all_selected_ex(true);e.$table.focus();});k.find("#munselect-all").click(function(a){a.preventDefault();e.selections_set_all_selected_ex(false);e.$table.focus();});k.find("#mshow-selected").click(function(a){a.preventDefault();e.item.show_selected=!e.item.show_selected;e.item.open(function(){e.selections_update_selected();e.$table.focus();});});this.selection_block=k;this.$element.prepend(k);i=a('<th class="multi-select"></th>').append(h);s=this.getCellWidth('multi-select');if(s&&this.fields.length){i.width(s);h.width('auto');}g.append(i);h.css('min-height',50);i.css('padding-top',0);j.css('top',n.outerHeight()+n.position().top+4);j.css('left',(i.outerWidth()-j.width())/2+1);}d=this.fields.length;for(c=0;c<d;c++){f=this.fields[c];h=a('<div class="text-center '+f.field_name+'" style="overflow: hidden"><p>'+f.field_caption+'</p></div>');i=a('<th class="'+f.field_name+'" data-field_name="'+f.field_name+'"></th>').append(h);if(!this.options.title_word_wrap){h.css('height',this.textHeight);i.css('height',this.textHeight);}s=this.getCellWidth(f.field_name);if(s&&(c<this.fields.length-1)){i.width(s);h.width('auto');}if(p[f.field_name]){i.find('p').append('<i class="'+p[f.field_name]+'"></i>');i.find('i').css('margin-left',2);}g.append(i);}g.append('<th class="fake-column" style="display: None;></th>');if(this.options.title_callback)this.options.title_callback(g,this.item);this.selections_update_selected();},fill_footer:function(b){var c,d,e,f,g,h,i,j,k;if(b===undefined)b=this.$element;f=b.find("table.outer-table tfoot tr:first");g=f.clone();f.empty();if(this.item.selections){h=a('<div class="text-center multi-select" style="overflow: hidden; width: 100%"></div>');j=a('<th class="multi-select"></th>').append(h);f.append(j);}d=this.fields.length;for(c=0;c<d;c++){e=this.fields[c];h=a('<div class="text-center '+e.field_name+'" style="overflow: hidden; width: 100%">&nbsp</div>');i=g.find('div.'+e.field_name);if(i.length)h.html(i.html());j=a('<th class="'+e.field_name+'"></th>').append(h);f.append(j);}if(!this.options.show_footer)f.hide();},show_footer:function(){this.$element.find("table.outer-table tfoot tr:first").show();},hideFooter:function(){this.$element.find("table.outer-table tfoot tr:first").hide();},getCellWidth:function(a){return this.cellWidths[a];},setCellWidth:function(a,b){this.cellWidths[a]=b;},init_table:function(){if(this.item._offset===0){this.initFields();this._sorted_fields=this.item._open_params.__order;if(this.item.paginate){this.page=0;this.updatePageInfo();this.updatePageCount();}else this.fieldWidthUpdated=false;}this.refresh();},form_closing:function(){var a=this.$element.closest('.modal');if(a)return a.data('_closing');return false;},update:function(a){var b,c=this,e;if(this.form_closing())return;switch(a){case d.UPDATE_OPEN:this.init_table();this.sync_freezed();this.calc_summary();break;case d.UPDATE_CANCEL:this.refreshRow();break;case d.UPDATE_APPEND:e=this.addNewRow();this.$table.append(e);this.syncronize();this.syncColWidth();if(this.item.controls_enabled()&&this.item.record_count()===1)this.build();break;case d.UPDATE_INSERT:e=this.addNewRow();this.$table.prepend(e);this.syncronize();this.syncColWidth();break;case d.UPDATE_DELETE:this.deleteRow();break;case d.UPDATE_DELETE:this.deleteRow();break;case d.UPDATE_SCROLLED:this.syncronize();break;case d.UPDATE_CONTROLS:this.build();break;case d.UPDATE_CLOSE:this.$table.empty();break;case d.UPDATE_APPLIED:this.calc_summary();break;}},calc_summary:function(){var a=this,b,c,d,e,f,g;if(this.options.summary_fields&&this.item.paginate&&this.page===0){c=this.item.copy({handlers:false,details:false});f=[];g={};for(b=0;b<this.options.summary_fields.length;b++){d=this.options.summary_fields[b];e=this.item.field_by_name(d);if(e&&this.fields.indexOf(e)!==-1){f.push(d);if(e.numeric_field())g[d]='sum';else g[d]='count';}}if(f.length){c._where_list=a.item._open_params.__filters;c.open({expanded:false,fields:f,funcs:g},function(){var b;c.each_field(function(c){if(c.numeric_field())b=c.display_text;else b=c.data;a.$foot.find('div.'+c.field_name).text(b);});});}}},update_field:function(a,b){var c=this,e=this.itemRow(),f,g,h,i;if(this.item.active&&this.item.controls_enabled()&&this.item.record_count()){i=e.find('div.'+a.field_name);if(i.length){h=this.get_field_text(a);if(h!==i.text()){i.text(h);if(this.item.is_new()&&this.item.record_count()<10)f=true;else if(this.$table.get(0).clientWidth>this.$scroll_div.innerWidth()||this.$table.get(0).clientWidth>this.$element.innerWidth())f=true;else if(this.$table.get(0).clientWidth>this.$scroll_div.innerWidth()||this.$table.get(0).clientWidth>this.$element.innerWidth())f=true;else if(this.$table.get(0).clientWidth>this.$scroll_div.innerWidth()||this.$table.get(0).clientWidth>this.$element.innerWidth())f=true;else if((a.data_type===d.INTEGER||a.data_type===d.FLOAT||a.data_type===d.CURRENCY)&&Math.abs(i.get(0).offsetWidth-i.get(0).scrollWidth)>1)f=true;if(f||g){clearTimeout(this._update_field_timeout);this._update_field_timeout=setTimeout(function(){if(c.item.record_count()<=100)c.build();else c.syncColWidth();},0);}if(!b)this.update_selected(e);}}}},update_selected:function(a){if(!a)a=this.itemRow();if(this.options.row_callback)this.options.row_callback(a,this.item);},deleteRow:function(){var a=this.itemRow();a.remove();this.syncColWidth();},itemRow:function(){if(this.item.record_count())try{var b=this.item.rec_controls_info(),c=a(b[this.id]);this.update_selected(c);return c;}catch(d){console.log(d);}},refreshRow:function(){var a=this;this.each_field(function(b,c){a.update_field(b,true);});},do_on_edit:function(a){if(this.item.lookup_field)this.item.set_lookup_field_value();else if(!this.options.editable||(!this.editMode&&a)){if(this.on_dblclick)this.on_dblclick.call(this.item,this.item);else if(this.options.dblclick_edit)this.item.edit_record();}else if(!this.editMode&&!a&&this.options.editable)this.showEditor();},clicked:function(b,c){var d,e,f=a(c).parent();if(this.options.editable)this.setSelectedField(this.item.field_by_name(a(c).data('field_name')));d=this.item._dataset.indexOf(f.data("record"));if(this.editMode&&d!==this.item.rec_no){if(!this.item.is_edited())this.item.edit();this.flushEditor();this.item.post();}this.item._set_rec_no(d);if(!this.editing&&!this.is_focused())this.focus();if(b.type==="dblclick")this.do_on_edit(true);},hide_selection:function(){this.remove_selection();},remove_selection:function(){if(this.selected_row)if(this.options.editable&&this.selectedField){this.selected_row.removeClass("selected-focused selected");this.selected_row.find('td.'+this.selectedField.field_name).removeClass("field-selected-focused field-selected");}else this.selected_row.removeClass("selected-focused selected");},show_selection:function(){this.highlight_selection(this.is_focused());},highlight_selection:function(a){var b='selected',c='field-selected';if(a){b='selected-focused';c='field-selected-focused';}if(this.selected_row)if(this.options.editable&&this.selectedField){this.selected_row.addClass(b);this.selected_row.find('td.'+this.selectedField.field_name).removeClass(b).addClass(c);}else this.selected_row.addClass(b);},select_row:function(a){var b,c=this.textHeight;this.update_selected_row(a);this.hide_selection();if(this.selected_row&&this.options.expand_selected_row)this.selected_row.find('tr, div').css('height',this.options.row_line_count*c);this.selected_row=a;this.show_selection();if(this.options.expand_selected_row){b=this.selected_row.find('tr, div');b.css('height','');b.css('height',this.options.expand_selected_row*c);}},update_selected_row:function(a){var b,c,d,e;if(a.length){b=this.$scroll_div.scrollTop();c=b+this.$scroll_div.height();d=a.get(0).offsetTop;e=d+a.height();if(d<b)this.$scroll_div.scrollTop(d);else if(e>c)this.$scroll_div.scrollTop(e-this.$scroll_div.height());}},syncronize:function(){var a=this,b,c;if(this.item.controls_enabled()&&this.item.record_count()>0){c=this.itemRow();b=!this.selected_row||(this.selected_row&&c&&this.selected_row.get(0)!==c.get(0));if(b&&this.options.editable)this.hideEditor();try{this.select_row(this.itemRow());}catch(d){}if(b&&this.options.editable&&this.editMode){clearTimeout(this.editorsTimeOut);this.editorsTimeOut=setTimeout(function(){a.showEditor();},75);}}},get_field_text:function(a){if(a.get_lookup_data_type()===d.BOOLEAN)if(this.owner&&(this.owner.on_field_get_text||this.owner.on_get_field_text))return a.get_display_text();else return a.get_lookup_value()?'Ã—':'';else return a.get_display_text();},next_record:function(){this.item.next();if(this.item.eof())if(this.options.editable&&this.options.append_on_lastrow_keydown)this.item.append();else this.nextPage();},prior_record:function(){var a=this;this.item.prior();if(this.item.bof())this.priorPage(function(){a.item.last();});},keydown:function(a){var b=this,c=(a.keyCode?a.keyCode:a.which);if(!a.ctrlKey&&!a.shiftKey)switch(c){case 33:case 34:case 35:case 36:case 38:case 40:a.preventDefault();this.flushEditor();this.hideEditor();if(c===33)this.priorPage();else if(c===34)if(this.item.paginate&&this.item.is_loaded)this.item.last();else this.nextPage();else if(c===38)this.prior_record();else if(c===40)this.next_record();else if(c===36)this.firstPage();else if(c===35)this.lastPage();break;case 37:if(this.options.editable&&!this.editMode)this.priorField();break;case 39:if(this.options.editable&&!this.editMode)this.nextField();break;}},keyup:function(a){var b=this,c,d=(a.keyCode?a.keyCode:a.which);if(a.target===this.$table.get(0)&&!a.ctrlKey&&!a.shiftKey)switch(d){case 13:a.preventDefault();this.do_on_edit(false);break;case 33:case 34:case 35:case 36:case 38:case 40:a.preventDefault();break;case 32:a.preventDefault();if(this.item.selections){c=this.itemRow().find('input.multi-select');this.selections_set_selected(!c[0].checked);c.prop('checked',this.selections_get_selected());}break;}},keypress:function(a){var b=this,c,d=a.which;if(d>32&&this.options.editable&&this.options.keypress_edit&&!this.editMode)if(this.selectedField&&this.selectedField.valid_char_code(d))this.showEditor();},setPageNumber:function(a,b){var c=this;if(!this.item.paginate||this.loading)return;if(a<this.page_count||a===0){this._remove_tooltip();this.page=a;this.scrollLeft=this.$element.find('.table-container').get(0).scrollLeft;if(this.master_table)this.master_table.scrollLeft=this.master_table.$element.find('.table-container').get(0).scrollLeft;this.loading=true;if(this.item.record_count())this.item._do_before_scroll();this.item.open({offset:this.page*this.item._limit},function(){if(b)b.call(c);c.loading=false;c.updatePageInfo();c.$element.find('.table-container').get(0).scrollLeft=c.scrollLeft;if(c.master_table)c.master_table.$element.find('.table-container').get(0).scrollLeft=c.master_table.scrollLeft;});}},reload:function(a){if(this.item.paginate)this.setPageNumber(this.page,a);else this.open(a);},updatePageInfo:function(){if(this.options.show_paginator&&this.$pageInput){this.$pageInput.val(this.page+1);if(this.page===0){this.$fistPageBtn.addClass("disabled");this.$priorPageBtn.addClass("disabled");}else{this.$fistPageBtn.removeClass("disabled");this.$priorPageBtn.removeClass("disabled");}if(this.item.is_loaded){this.$lastPageBtn.addClass("disabled");this.$nextPageBtn.addClass("disabled");}else{this.$lastPageBtn.removeClass("disabled");this.$nextPageBtn.removeClass("disabled");}}if(this.options.on_page_changed)this.options.on_page_changed.call(this.item,this.item,this);},updatePageCount:function(a){var b=this;this.item.total_records(function(a){b.recordCount=a;b.page_count=Math.ceil(a/b.row_count);if(b.$page_count)b.$page_count.text(c.of+' '+b.page_count);if(b.options.on_pagecount_update)b.options.on_pagecount_update.call(b.item,b.item,b);if(b.options.on_page_changed)b.options.on_page_changed.call(b.item,b.item,b);});},firstPage:function(a){if(this.item.paginate)this.setPageNumber(0,a);else this.item.first();},nextPage:function(a){var b,c;if(this.item.paginate){if(!this.item.is_loaded)this.setPageNumber(this.page+1,a);}else{c=this.item.clone();c._set_rec_no(this.item._get_rec_no());b=this.$scroll_div.innerHeight()/this.row_height-1;for(var d=0;d<b;d++)if(!c.eof())c.next();else break;this.item._set_rec_no(c._get_rec_no());}},priorPage:function(a){var b,c;if(this.item.paginate)if(this.page>0)this.setPageNumber(this.page-1,a);else this.syncronize();else{c=this.item.clone();c._set_rec_no(this.item._get_rec_no());b=this.$scroll_div.innerHeight()/this.row_height-1;for(var d=0;d<b;d++)if(!c.eof())c.prior();else break;this.item._set_rec_no(c._get_rec_no());}},lastPage:function(a){var b=this;if(this.item.paginate){this.item.total_records(function(d){b.recordCount=d;b.page_count=Math.ceil(d/b.row_count);if(b.options.show_paginator)b.$page_count.text(c.of+' '+b.page_count);b.setPageNumber(b.page_count-1,a);if(b.options.on_pagecount_update)b.options.on_pagecount_update.call(this.item,this.item,this);});}else this.item.last();},each_field:function(a){var b=0,c=this.fields.length,d;for(;b<c;b++){d=a.call(this.fields[b],this.fields[b],b);if(d===false)break;}},addNewRow:function(){var b=a(this.newRow()),c=this.item._get_rec_no(),d;b.data("record",this.item._dataset[c]);d=this.item.rec_controls_info();d[this.id]=b.get(0);if(this.options.row_callback)this.options.row_callback(b,this.item);return b;},newColumn:function(a,b,c,d,e){var f=this.getCellWidth(a),g='class="'+a+'"',h='data-field_name="'+a+'"',i='style="text-align:'+b+';overflow: hidden',j='style="overflow: hidden';if(this.textHeight)j+='; height: '+this.options.row_line_count*this.textHeight+'px; width: auto';if(e&&f&&(d<this.fields.length-1))i+='; width: '+f+'px';i+='""';j+='"';return '<td '+g+' '+h+' '+i+'>'+'<div '+g+' '+j+'>'+c+'</div>'+'</td>';},newRow:function(){var a,b,c,f,g,h,i,j='',k=!this.autoFieldWidth||(this.autoFieldWidth&&this.fieldWidthUpdated);c=this.fields.length;i='';if(this.item.selections){if(this.selections_get_selected())j='checked';i+=this.newColumn('multi-select','center','<input class="multi-select" type="checkbox" '+j+' tabindex="-1">',-1,k);}for(b=0;b<c;b++){f=this.fields[b];a=this.item[f.field_name];if(!(a instanceof q))a=this.item.field_by_name(f.field_name);h=this.get_field_text(a);g=a.data_type===d.BOOLEAN?'center':e[a.alignment];i+=this.newColumn(a.field_name,g,h,b,k);}i+='<td class="fake-column" style="display: None;"></td>';return '<tr class="inner">'+i+'</tr>';},getElementWidth:function(a){if(!a.length)return 0;if(a.is(':visible'))return a.width();else return this.getElementWidth(a.parent());},syncColWidth:function(a){var b,c,d,e,f,g,h,i=this.fields.length;if(this.item.record_count()){b=this.$table.find("tr:first-child");if(this.item.selections){d=this.$head.find('th.'+'multi-select');e=b.find('td.'+'multi-select');h=d.width();d.width(h);e.width(h);}g=i-1;if(a)g=i;for(f=0;f<g;f++){c=this.fields[f];d=this.$head.find('th.'+c.field_name);e=b.find('td.'+c.field_name);h=d.width();d.width(h);e.width(h);}if(a)return;if(this.fields.length){c=this.fields[i-1];d=this.$head.find('th.'+c.field_name);if(d.width()<0){this.$head.find('th.'+'fake-column').show();this.$table.find('td.'+'fake-column').show();this.set_saved_width(b,true);this.syncColWidth(true);}else{this.$head.find('th.'+'fake-column').hide();this.$table.find('td.'+'fake-column').hide();}}}},set_saved_width:function(a,b){var c,d=this.fields.length,e=d-1,f,g;if(this.item.selections){g=this.getCellWidth('multi-select');a.find("td."+'multi-select').width(g);this.$head.find("th."+'multi-select').width(g);}if(b)e=d;for(c=0;c<e;c++){f=this.fields[c];g=this.getCellWidth(f.field_name);a.find("td."+f.field_name).width(g);this.$head.find("th."+f.field_name).width(g);}},fill_rows:function(){var a,b,c,d,e,f,g=[],h,i=this.item.clone(true);i.on_field_get_text=this.item.on_field_get_text;d='';f=this.item.rec_no;try{while(!i.eof()){this.item._cur_row=i._cur_row;d+=this.newRow();g.push(i._get_rec_no());i.next();}this.$table.html(d);d=this.$table.find("tr");b=d.length;for(a=0;a<b;a++){c=d.eq(a);e=g[a];i._set_rec_no(e);this.item._cur_row=e;c.data("record",i._dataset[e]);h=i.rec_controls_info();h[this.id]=c.get(0);if(this.options.row_callback)this.options.row_callback(c,this.item);}}finally{this.item._cur_row=f;}},refresh:function(b){var c,d,e,f,g,h,i,j,k,l,m,n='',o,p,q=[],r,s,t=this.$table.is(':visible'),u,v=this.item.clone(true),w=a('<div>');if(b===undefined)b=true;s=this.is_focused();if(this.options.editable&&this.editMode&&this.editor){if(!s)s=this.editor.$input.is(':focus');u=this.editor.$input.value;this.hideEditor();}w.css("position","absolute").css("top",0).width(this.getElementWidth(this.$element));a('body').append(w);this.$element.detach();w.append(this.$element);if(b){this.$table.empty();this.$head.empty();if(this.selection_block)this.selection_block.remove();this.$foot.hide();this.$outer_table.find('#top-td').attr('colspan',this.colspan);this.fill_rows();}f=this.$table.find("tr:first");if(this.autoFieldWidth&&!this.fieldWidthUpdated){this.$table.css('table-layout','auto');this.$outer_table.css('table-layout','auto');g='<tr>';if(this.item.selections)g=g+'<th class="multi-select">'+'<div class="text-center multi-select" style="overflow: hidden"></div>'+'</th>';d=this.fields.length;for(c=0;c<d;c++)g=g+'<th class="'+this.fields[c].field_name+'" ><div style="overflow: hidden">'+this.fields[c].field_caption+'</div></th>';g=a(g+'</tr>');this.$table.prepend(g);for(var x in this.options.column_width)if(this.options.column_width.hasOwnProperty(x))g.find("."+x).css("width",this.options.column_width[x]);if(this.item.selections){h=f.find("td."+'multi-select');this.setCellWidth('multi-select',38);}for(c=0;c<d;c++){e=this.fields[c];h=f.find("td."+e.field_name);this.setCellWidth(e.field_name,h.width());}this.$table.css('table-layout','fixed');this.$outer_table.css('table-layout','fixed');this.fill_title(w);this.fill_footer(w);this.set_saved_width(f);if(this.item.record_count()>0&&t)this.fieldWidthUpdated=true;g.remove();if(this.fieldWidthUpdated)this.refresh(false);}else{this.fill_title(w);this.fill_footer(w);this.syncColWidth();}if(this.options.show_footer)this.$foot.show();this.$element.detach();this.$container.append(this.$element);w.remove();this.$container.find('tfoot .pager').attr('colspan',this.colspan);this.syncronize();if(s)this.focus();if(this.options.editable&&this.editMode&&this.editor){this.showEditor();this.editor.$input.value=u;}},build:function(){var a=this.$scroll_div.scrollTop();this.initFields();this.fieldWidthUpdated=false;this.refresh();this.syncColWidth();this.$scroll_div.scrollTop(a);this.syncronize();},is_focused:function(){return this.$table.get(0)===document.activeElement;},focus:function(){if(!this.is_focused())this.$table.focus();}};function v(a){var b=this;this.field=a;this.read_only=false;this.is_changing=true;}v.prototype={constructor:v,create_input:function(b,c,f){var g=this,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w='';if(a('body').css('font-size')==='12px')w=' small-btn';if(!b)return;if(this.label){l=a('<label class="control-label"></label>').attr("for",b.field_name).text(this.label).addClass(b.field_name);if(this.field.required)l.addClass('required');if(this.label_width)l.width(this.label_width);}if(b.get_lookup_data_type()===d.BOOLEAN)m=a('<input>').attr("id",b.field_name).attr("type","checkbox").click(function(a){g.field.value=!g.field.value;});else if(b.get_lookup_data_type()===d.BLOB)m=a('<textarea>').attr("id",b.field_name).innerHeight(70);else m=a('<input>').attr("id",b.field_name).attr("type","text");if(c)m.attr("tabindex",c+"");s=a('<div class="controls"></div>');if(this.label_width&&!this.label_on_top)s.css('margin-left',this.label_width+20+'px');this.$input=m;this.$input.addClass(b.field_name);this.$input.addClass('dbinput');this.$input.data('dbinput',this);this.$input.focus(function(a){g.focusIn(a);});this.$input.blur(function(a){g.focusOut();});this.$input.mousedown(function(a){g.mouseIsDown=true;});this.$input.mouseup(function(a){if(!g.mouseIsDown)g.$input.select();g.mouseIsDown=false;});this.$input.keydown(a.proxy(this.keydown,this));this.$input.keyup(a.proxy(this.keyup,this));this.$input.keypress(a.proxy(this.keypress,this));if(b.lookup_item&&!b.master_field||b.lookup_values){t=a('<div class="input-prepend input-append"></div>');r=a('<button class="btn'+w+'"type="button"><i class="icon-remove-sign"></button>');r.attr("tabindex",-1);r.click(function(){b.set_value(null);});this.$firstBtn=r;t.append(r);t.append(m);r=a('<button class="btn'+w+'" type="button"><i></button>');r.attr("tabindex",-1);r.click(function(){if(b.lookup_values)g.dropdown.enter_pressed();else g.selectValue();});this.$lastBtn=r;t.append(r);s.append(t);if(b.lookup_values){t.addClass("lookupvalues-input-container");m.addClass("input-lookupvalues");this.$lastBtn.find('i').addClass("icon-chevron-down");this.dropdown=new z(this.field,m);}else{t.addClass("lookupfield-input-container");m.addClass("input-lookupitem");this.$lastBtn.find('i').addClass("icon-folder-open");if(this.field.enable_typeahead)this.dropdown=new A(this.field,m,this.field.typeahead_options());}}else{v=b.get_lookup_data_type();switch(v){case d.TEXT:m.addClass("input-text");s.append(m);break;case d.INTEGER:m.addClass("input-integer");s.append(m);break;case d.FLOAT:m.addClass("input-float");s.append(m);break;case d.CURRENCY:m.addClass("input-currency");s.append(m);break;case d.DATE:case d.DATETIME:t=a('<div class="input-prepend input-append"></div>');r=a('<button class="btn'+w+'" type="button"><i class="icon-remove-sign"></button>');r.attr("tabindex",-1);r.click(function(){b.set_value(null);});this.$firstBtn=r;t.append(r);if(v===d.DATETIME){t.addClass("datetime-input-container");m.addClass("input-datetime");}else{t.addClass("date-input-container");m.addClass("input-date");}t.append(m);r=a('<button class="btn'+w+'" type="button"><i class="icon-calendar"></button>');r.attr("tabindex",-1);r.click(function(){g.showDatePicker();});this.$lastBtn=r;t.append(r);s.append(t);break;case d.BOOLEAN:s.append(m);break;case d.BLOB:m.addClass("input-blob");s.append(m);break;}h=b.data_type===d.BOOLEAN?'center':e[b.alignment];this.$input.css("text-align",h);}if(this.label_on_top)this.$controlGroup=a('<div class="input-container"></div>');else this.$controlGroup=a('<div class="control-group input-container"></div>');if(this.label)this.$controlGroup.append(l);this.$controlGroup.append(s);if(f)f.append(this.$controlGroup);s.find('.add-on').css('padding-top',parseInt(s.find('.add-on').css('padding-top'))+parseInt(s.find('.add-on').css('border-top-width'))-1+'px');s.find('.add-on').css('padding-bottom',parseInt(s.find('.add-on').css('padding-bottom'))+parseInt(s.find('.add-on').css('border-bottom-width'))-1+'px');this.$modalForm=this.$input.closest('.modal');this.field.controls.push(this);this.$input.on('mouseenter',function(){var b=a(this);if(g.error)b.tooltip('show');});if(!this.grid&&this.field.field_placeholder)this.$input.attr('placeholder',this.field.field_placeholder);if(!this.grid&&this.field.field_help){u=a('<a href="#" tabindex="-1"><span class="badge help-badge">?</span></a>');u.click(function(a){a.preventDefault();g.$lastBtn.focus().click();});u.find('span').popover({container:'body',placement:'right',trigger:'hover',html:true,title:g.field.field_caption,content:g.field.field_help}).click(function(a){a.preventDefault();});if(t){s.append(u);u.find('span').addClass('btns-help-badge');}else s.append(u);}this.$input.tooltip({placement:'bottom',title:''}).on('hide hidden show shown',function(a){if(a.target===g.$input.get(0))a.stopPropagation();});this.$input.bind('destroyed',function(){g.field.controls.splice(g.field.controls.indexOf(g),1);if(g.dropdown)g.dropdown.destroy();});this.update();},form_closing:function(){if(this.$modalForm)return this.$modalForm.data('_closing');return false;},set_read_only:function(a){if(this.$firstBtn)this.$firstBtn.prop('disabled',a);if(this.$lastBtn)this.$lastBtn.prop('disabled',a);if(this.$input)this.$input.prop('disabled',a);},update:function(a){var b=this.field.field_placeholder,c=this.$input.get(0)===document.activeElement,e=this.is_changing;if(this.field.field_kind===d.ITEM_FIELD){e=this.field.owner.is_changing();if(!this.field.owner.active||this.field.owner.record_count()===0){this.read_only=true;this.is_changing=false;this.set_read_only(true);this.$input.val('');return;}}if(!this.removed&&!this.form_closing()){if(this.read_only!==this.field._get_read_only()||e!==this.is_changing){this.read_only=this.field._get_read_only();this.is_changing=e;this.set_read_only(this.read_only||!this.is_changing);}if(this.field.master_field)this.set_read_only(true);if(this.field.get_lookup_data_type()===d.BOOLEAN)if(this.field.get_lookup_value())this.$input.prop("checked",true);else this.$input.prop("checked",false);if(this.field.lookup_values)this.$input.val(this.field.display_text);else if(c&&this.$input.val()!==this.field.get_text()||!c&&this.$input.val()!==this.field.get_display_text()){this.errorValue=undefined;this.error=undefined;if(c&&!this.field.lookup_item&&!this.field.lookup_values)this.$input.val(this.field.get_text());else this.$input.val(this.field.get_display_text());}if(this.read_only||!this.is_changing||this.field.master_field)b='';this.$input.attr('placeholder',b);this.updateState(true);}if(a===d.UPDATE_CLOSE){this.$input.val('');this.set_read_only(true);}},keydown:function(a){var b=(a.keyCode?a.keyCode:a.which);if(this.field.lookup_item&&!this.field.enable_typeahead&&!(b===229||b===9||b==8))a.preventDefault();if(a.ctrlKey===true)if(b!==67&&b!==86&&b!==88&&b!=90&&b!=8&&b!=37&&b!=39)a.preventDefault();if(b===9)if(this.grid&&this.grid.editMode){a.preventDefault();if(a.shiftKey)this.grid.priorField();else this.grid.nextField();}},keyup:function(a){var b,c=(a.keyCode?a.keyCode:a.which);if(this.field.enable_typeahead){b=this.$input.data('jamtypeahead');if(b&&b.shown)return;}if(c===13&&!a.ctrlKey&&!a.shiftKey){if(this.grid&&this.grid.editMode){if(!(this.dropdown&&this.dropdown.shown)){a.stopPropagation();a.preventDefault();if(!this.grid.item.is_changing())this.grid.item.edit();this.grid.flushEditor();this.grid.hideEditor();if(this.grid.item.is_changing())this.grid.item.post();}}else if(this.field.lookup_item&&!this.field.enable_typeahead){a.stopPropagation();a.preventDefault();this.selectValue();}else if((this.field.data_type===d.DATE)||(this.field.data_type===d.DATETIME)){a.stopPropagation();a.preventDefault();this.showDatePicker();}}else if(c===27)if(this.grid&&this.grid.editMode){a.stopPropagation();a.preventDefault();this.grid.item.cancel();this.grid.hideEditor();}else if(this.field.lookup_values)if(this.$input.parent().hasClass('open')){this.$input.parent().removeClass('open');a.stopPropagation();}},keypress:function(a){var b=a.which;if(this.field.lookup_item&&!this.field.enable_typeahead)a.preventDefault();if(this.$input.is('select')){}else if(b&&!this.field.valid_char_code(b))a.preventDefault();},showDatePicker:function(){var a=this,e;if(this.field.data_type===d.DATE)e=b.D_FMT;else if(this.field.data_type===d.DATETIME)e=b.D_T_FMT;this.$input.datepicker({weekStart:parseInt(c.week_start,10),format:e,daysMin:c.days_min,months:c.months,monthsShort:c.months_short,date:this.field.value}).on('show',function(b){if(b.target===a.$input.get(0)){b.stopPropagation();a.$input.datepicker().attr('data-weekStart',1);}}).on('hide hidden shown',function(b){if(b.target===a.$input.get(0))b.stopPropagation();}).on('changeDate',function(b){a.field.set_value(b.date);a.$input.datepicker('hide');});this.$input.datepicker('show');},selectValue:function(){if(this.field.on_entry_button_click)this.field.on_entry_button_click.call(this.item,this.field);else this.field.select_value();},change_field_text:function(){var a=true,b;this.errorValue=undefined;this.error=undefined;if(this.field.lookup_item||this.field.lookup_values){if(this.$input.val()!==this.field.get_lookup_text())this.$input.val(this.field.get_display_text());}else try{b=this.$input.val();if(b!==this.field.text){if(this.field.owner&&this.field.owner.is_changing&&!this.field.owner.is_changing())this.field.owner.edit();if(b==='')this.field.set_value(null);else{this.field.set_text(b);this.field.check_valid();if(this.$input.is(':visible'))this.$input.val(b);}}}catch(c){this.errorValue=b;this.error=c;this.updateState(false);if(c.stack)console.error(c.stack);a=false;}return a;},focusIn:function(a){this.hideError();if(this.field.lookup_item&&!this.field.enable_typeahead)this.$input.val(this.field.get_display_text());else{if(this.errorValue)this.$input.val(this.errorValue);else if(this.field.lookup_item||this.field.lookup_values)this.$input.val(this.field.get_display_text());else this.$input.val(this.field.get_text());if(!this.mouseIsDown){this.$input.select();this.mouseIsDown=false;}}this.mouseIsDown=false;},focusOut:function(a){var b=false;if(this.grid&&this.grid.editMode)if(this.grid.item.is_changing()){this.grid.flushEditor();this.grid.item.post();}if(this.field.data_type===d.BOOLEAN)b=true;else if(!this.$input.is(':disabled')&&this.change_field_text()){if(this.$input.is(':visible'))this.$input.val(this.field.get_display_text());b=true;}this.updateState(b);return b;},updateState:function(a){if(a){if(this.$controlGroup)this.$controlGroup.removeClass('error');this.errorValue=undefined;this.error=undefined;this.$input.tooltip('hide').attr('data-original-title','').tooltip('fixTitle');this.hideError();}else{this.showError();if(this.$controlGroup)this.$controlGroup.addClass('error');this.$input.tooltip('hide').attr('data-original-title',this.error).tooltip('fixTitle');}},showError:function(a){},hideError:function(a){},focus:function(){this.$input.focus();}};w.prototype=new v();w.prototype.constructor=w;function w(a,b){v.call(this,b);this.grid=a;this.create_input(b,0);this.$input.attr("autocomplete","off");this.$input.addClass('dbtableinput');}a.extend(w.prototype,{});x.prototype=new v();x.prototype.constructor=x;function x(a,b,c,d,e,f){v.call(this,a);if(this.field.owner&&this.field.owner.edit_form&&this.field.owner.edit_form.hasClass("modal"))this.$edit_form=this.field.owner.edit_form;this.label=f;this.label_width=e;this.label_on_top=d;if(!this.label)this.label=this.field.field_caption;this.create_input(a,b,c);}a.extend(x.prototype,{showError:function(a){if(this.$edit_form&&this.$edit_form.hasClass("normal-modal-border")){this.$edit_form.removeClass("nomal-modal-border");this.$edit_form.addClass("error-modal-border");}},hideError:function(a){if(this.$edit_form&&this.$edit_form.hasClass("error-modal-border")){this.$edit_form.removeClass("error-modal-border");this.$edit_form.addClass("nomal-modal-border");}}});function y(a,b,c){this.$element=b;this.field=a;this.options=c;}y.prototype={constructor:y,init:function(){var b={menu:'<ul class="typeahead dropdown-menu"></ul>',item:'<li><a href="#"></a></li>',length:10,min_length:1};this.options=a.extend({},b,this.options);this.$menu=a(this.options.menu);},show:function(){var b;if(this.$element){b=a.extend({},this.$element.offset(),{height:this.$element[0].offsetHeight});this.$menu.appendTo(a('body')).css({top:b.top+b.height,left:b.left,"min-width":this.$element.innerWidth(),"max-width":a(window).width()-this.$element.offset().left-20,"overflow":"hidden"}).show();this.shown=true;return this;}},hide:function(){this.$menu.hide();this.$menu.detach();this.shown=false;return this;},destroy:function(){this.$element=undefined;this.$menu.remove();},get_items:function(b){var c;if(this.$element){this.query=this.$element.val();if(!this.query||this.query.length<this.min_length)return this.shown?this.hide():this;c=a.isFunction(this.source)?this.source(this.query,a.proxy(this.process,this)):this.source;return c?this.process(c):this;}},lookup:function(a){this.get_items(a);},process:function(b){var c=this;b=a.grep(b,function(a){return c.matcher(a);});if(!b.length)return this.shown?this.hide():this;return this.render(b.slice(0,this.length)).show();},matcher:function(a){return true;},highlighter:function(a){var b=0,c,d=a,e;if(this.query){e=this.query.split(' ');for(b=0;b<e.length;b++){c=e[b];if(c.indexOf('strong>')===-1&&c.length){c=c.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,'\\$&');d=d.replace(new RegExp('('+c+')','ig'),function(a,b){return '<strong>'+b+'</strong>';});}}}return d;},render:function(b){var c=this;b=a(b).map(function(b,d){b=a(c.options.item).data('id-value',d[0]);b.find('a').html(c.highlighter(d[1]));return b[0];});b.first().addClass('active');this.$menu.html(b);return this;},next:function(b){var c=this.$menu.find('.active').removeClass('active'),d=c.next();if(!d.length)d=a(this.$menu.find('li')[0]);d.addClass('active');},prev:function(a){var b=this.$menu.find('.active').removeClass('active'),c=b.prev();if(!c.length)c=this.$menu.find('li').last();c.addClass('active');},listen:function(){this.$element.on('focus',a.proxy(this.focus,this)).on('blur',a.proxy(this.blur,this)).on('keypress',a.proxy(this.keypress,this)).on('keyup',a.proxy(this.keyup,this));if(this.eventSupported('keydown'))this.$element.on('keydown',a.proxy(this.keydown,this));this.$menu.on('click',a.proxy(this.click,this)).on('mouseenter','li',a.proxy(this.mouseenter,this)).on('mouseleave','li',a.proxy(this.mouseleave,this));},eventSupported:function(a){var b=a in this.$element;if(!b){this.$element.setAttribute(a,'return;');b=typeof this.$element[a]==='function';}return b;},move:function(a){if(!this.shown)return;switch(a.keyCode){case 9:case 13:case 27:a.preventDefault();break;case 38:a.preventDefault();this.prev();break;case 40:a.preventDefault();this.next();break;}a.stopPropagation();},keydown:function(b){this.suppressKeyPressRepeat=~a.inArray(b.keyCode,[40,38,9,13,27]);this.move(b);},keypress:function(a){if(this.suppressKeyPressRepeat)return;this.move(a);},keyup:function(a){if(!a.ctrlKey&&!a.shiftKey){switch(a.keyCode){case 40:case 38:case 16:case 17:case 18:break;case 9:case 13:if(!this.shown){if(a.keyCode===13)this.enter_pressed();}else this.select();break;case 27:if(!this.shown)return;this.field.update_controls();if(this.$element)this.$element.select();this.hide();break;default:this.lookup();}a.stopPropagation();a.preventDefault();}},focus:function(a){this.focused=true;},blur:function(a){this.focused=false;if(!this.mousedover&&this.shown)this.hide();},click:function(a){a.stopPropagation();a.preventDefault();this.select();this.$element.focus();},mouseenter:function(b){this.mousedover=true;this.$menu.find('.active').removeClass('active');a(b.currentTarget).addClass('active');},mouseleave:function(a){this.mousedover=false;if(!this.focused&&this.shown)this.hide();}};z.prototype=new y();z.prototype.constructor=z;function z(a,b,c){y.call(this,a,b,c);this.init();this.source=this.field.lookup_values;this.options.length=this.source.length;this.listen();}a.extend(z.prototype,{matcher:function(a){if(this.query)return ~a[1].toLowerCase().indexOf(this.query.toLowerCase());else return true;},select:function(){var a=this.$menu.find('.active');if(this.field.owner&&this.field.owner.is_changing&&!this.field.owner.is_changing())this.field.owner.edit();this.field.value=a.data('id-value');return this.hide();},enter_pressed:function(){this.query='';if(this.$element)this.$element.focus();this.process(this.source);}});A.prototype=new y();A.prototype.constructor=A;function A(a,b,c){y.call(this,a,b,c);this.init();this.source=this.options.source;this.lookup_item=this.options.lookup_item;this.listen();}a.extend(A.prototype,{lookup:function(a){var b=this;clearTimeout(this.timeOut);this.timeOut=setTimeout(function(){b.get_items(a);},400);},select:function(){var a=this.$menu.find('.active'),b=a.data('id-value');this.lookup_item.locate(this.lookup_item._primary_key,b);this.lookup_item.set_lookup_field_value();return this.hide();},enter_pressed:function(){this.field.select_value();}});a.event.special.destroyed={remove:function(a){if(a.handler)a.handler();}};window.task=new k();})(jQuery);