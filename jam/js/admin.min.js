(function(a,b){"use strict";function c(){var c={"ROOT_TYPE":1,"USERS_TYPE":2,"ROLES_TYPE":3,"TASKS_TYPE":4,"TASK_TYPE":5,"ITEMS_TYPE":6,"JOURNALS_TYPE":7,"TABLES_TYPE":8,"REPORTS_TYPE":9,"ITEM_TYPE":10,"JOURNAL_TYPE":11,"TABLE_TYPE":12,"REPORT_TYPE":13,"DETAIL_TYPE":14},d={"SQLITE":1,"FIREBIRD":2,"POSTGRESQL":3,"MYSQL":4};function e(a){var d;b.btns_panel.show();a.task.cur_item_title=a.f_name.value;if(a.type_id.value===c.ROOT_TYPE){b.view_panel.empty();b.view_panel.append('<div class="admin-task-info"></div>');n(b);b.right_panel.show();b.btns_panel.empty();l(a.task);}else if(a.type_id.value===c.USERS_TYPE){b.right_panel.hide();a.task.sys_users.view_options.fields=['f_name','f_login','f_password','f_role','f_admin'];a.task.sys_users.view(b.view_panel);}else if(a.type_id.value===c.ROLES_TYPE){b.right_panel.hide();a.task.sys_roles.view(b.view_panel);}else{b.right_panel.show();a.task.sys_items.tree_changed(a.task.sys_items);}}function f(a,b){a.server('server_update_has_children',[]);a.item_tree.set_where({has_children:true});a.item_tree.open({fields:['id','parent','f_name','type_id','task_id']});a.item_tree.locate('type_id',c.TASK_TYPE);a.tree.expand(a.tree.selected_node);a.item_tree.on_after_scroll=e;if(b)a.item_tree.locate('id',b);else a.item_tree.locate('type_id',c.ROOT_TYPE);a.tree_panel.show();e(a.item_tree);}function g(a){var b=a.sys_params.view_options.fields;b.splice(b.indexOf('f_field_id_gen'),1);b.push('id');a.sys_params.open({fields:b});}function h(b){var e,h,i;b._manual_update=false;b.init_project=true;b.item_types=c;b.db_types=d;g(b);if(!b.sys_params.f_language.value){b.sys_params.set_edit_fields(['f_language']);b.sys_params.edit_options.title='Project language';b.sys_params.edit_record();return;}b.sys_tasks.open();if(!b.sys_tasks.f_db_type.value){i=['f_name','f_item_name','f_db_type','f_alias','f_login','f_password','f_host','f_port','f_encoding'];b.sys_tasks.set_edit_fields(i);b.sys_tasks.edit_options.title=b.language.project_params;b.sys_tasks.edit_record();return;}if(b.sys_params.f_language.value&&b.sys_tasks.f_db_type.value){b.init_project=false;b.server('server_get_db_options',[b.sys_tasks.f_db_type.value],function(a){b.db_options=a[0];h=a[1];if(h){b.warning(h);return;}});b.buttons_info={divider:{},project_params:{handler:x,short_cut:'F2',key_code:113,editor:true},project_locale:{handler:y,short_cut:'F3',key_code:114,editor:true},db:{handler:z,short_cut:'F4',key_code:115,editor:true},'export':{handler:G,short_cut:'Ctrl-E',key_code:69,key_ctrl:true},'import':{handler:F,short_cut:'Ctrl-I',key_code:73,key_ctrl:true},find:{handler:B,short_cut:'Alt-F',key_code:70,key_alt:true},print:{handler:D,short_cut:'Shift-P',key_code:80,key_shift:true},client_module:{handler:b.sys_items.edit_client,item:b.sys_items,short_cut:'F8',key_code:119,editor:true},server_module:{handler:b.sys_items.edit_server,item:b.sys_items,short_cut:'F9',key_code:120,editor:true},'index.html':{handler:b.sys_items.edit_index_html,item:b.sys_items,short_cut:'F10',key_code:121,editor:true},'project.css':{handler:b.sys_items.edit_project_css,item:b.sys_items,short_cut:'F11',key_code:122,editor:true},'Lookup lists':{handler:A,editor:true},viewing:{handler:b.sys_items.view_setup,item:b.sys_items,editor:true},editing:{handler:b.sys_items.edit_setup,item:b.sys_items,editor:true},filters:{handler:b.sys_items.filters_setup,item:b.sys_items,editor:true},details:{handler:b.sys_items.details_setup,item:b.sys_items,editor:true},order:{handler:b.sys_items.order_setup,item:b.sys_items,editor:true},indices:{handler:b.sys_items.indices_setup,item:b.sys_items,editor:true},foreign_keys:{handler:b.sys_items.foreign_keys_setup,item:b.sys_items,editor:true},reports:{handler:b.sys_items.reports_setup,item:b.sys_items,editor:true},report_params:{handler:b.sys_items.report_params_setup,item:b.sys_items,editor:true,short_cut:'F7',key_code:118,editor:true},privileges:{handler:b.sys_items.privileges_setup,item:b.sys_items,editor:true}};a("#title").html(b.language.admin);if(b.safe_mode){a("#user-info").text(b.user_info.role_name+' '+b.user_info.user_name);a('#log-out').show().click(function(a){a.preventDefault();b.logout();});}b.left_panel=a("#left-panel");b.center_panel=a("#center-panel");b.right_panel=a("#right-panel");b.btns_panel=a("#btns-panel");b.view_panel=a("#view-panel");b.tree_panel=a("#tree-panel");b.item_tree=b.sys_items.copy({handlers:false,details:false});b.item_tree.on_after_open=function(a){a.locate('type_id',c.TASK_TYPE);a.edit();a.f_name.value=b.language.groups;a.post();};b.tree=b.item_tree.create_tree(b.tree_panel,{id_field:'id',parent_field:'parent',text_field:'f_name',parent_of_root_value:0});b.tree.$element.height(a("#left-panel").height());f(b);N(b);a(window).on('focus.task',function(a){n(b);});a(window).on('resize.task',function(){M(b);});a(window).on('keydown.task',function(a){if(a.which===116)b.editing_finished();});window.onbeforeunload=function(a){b.editing_finished();window.onbeforeunload=undefined;};M(b);}}function i(b,c,d,e,f,g,h,i,j,k,l){function m(a){var f,g,h,i;a.preventDefault();a.stopImmediatePropagation();a.stopPropagation();if(e)h=e,i=e.id.value;else{h=b;i=0;}if(l){f=[h.ID,i,c,b.user_info];g=b.server('check_doc_edited',f);if(g)b.question(b.doc_editing_message(g),function(){b.edited_doc=f;d.call(h,h,b.language[c]);b.server('set_edited',f);});else{b.edited_doc=f;d.call(h,h,b.language[c]);b.server('set_edited',f);}}else d.call(h,h,b.language[c]);}var n='',o='',p='',q;if(c){n=b.language[c];if(!n)n=c;}if(f)o='<i class="'+f+'"></i>';if(g)p='<small class="muted">&nbsp;['+g+']</small>';q=a('<button class="btn vert-btn text-center '+c+'" type="button">'+o+' '+n+p+'</button>');b.btns_panel.append(q);if(d)q.click(function(a){m(a);});if(h){a(window).off('keydown.'+c);a(window).on('keydown.'+c,(function(a){var b=(a.keyCode?a.keyCode:a.which);if(i&&a.ctrlKey&&h===a.keyCode||j&&a.shiftKey&&h===a.keyCode||k&&a.altKey&&h===a.keyCode||!i&&!j&&!k&&h===a.keyCode){a.preventDefault();m(a);}}));}}function j(){b.btns_panel.append('<div class="btns-divider">');}function k(a,b){var c=0,d=b.length,e,f;for(;c<d;c++){e=b[c];if(e==='divider')j();else{f=a.buttons_info[e];i(a,e,f.handler,f.item,f.icon,f.short_cut,f.key_code,f.key_ctrl,f.key_shift,f.key_alt,f.editor);}}}function l(a){k(a,['project_params','project_locale','divider','db','divider','export','import','divider','find','print']);}function m(b){var c,d,e=[];if(b.reports){for(var f=0;f<b.reports.length;f++)if(b.reports[f].can_view())e.push(b.reports[f]);if(e.length){c=b.view_form.find("#report-btn ul");for(var f=0;f<e.length;f++){d=a('<li><a href="#">'+e[f].item_caption+'</a></li>');d.find('a').data('report',e[f]);d.on('click','a',function(){a(this).data('report').print();});c.append(d);}}else b.view_form.find("#report-btn").hide();}else b.view_form.find("#report-btn").hide();}function n(b){if(b._importing)return;if(b.cur_task_info)a('.admin-task-info').html(b.cur_task_info);b.server('server_get_task_info',function(c){var d=c[1],e=c[2],f=c[3];b.task_name=c[0];if(b.server_started&&b.server_started!==c[4])if(b.edited_doc)if(b.server('check_doc_edited',b.edited_doc))location.reload();else b.server('set_edited',b.edited_doc);b.server_started=c[4];b.cur_task_info='<h4><span class="editor-title">'+d+'</span> <span class="muted">'+f+'</span> v. '+e+'</h4>';a('.admin-task-info').html(b.cur_task_info);});}function o(a){var b=a.sys_items.copy();b.set_where({type_id:c.TASK_TYPE});b.open({fields:['f_item_name','f_name']});a.task_name=b.f_item_name.value;a.task_caption=b.f_name.value;}function p(a){var b=a.task,c,d,e;if(a.item_name==='sys_fields_editor'||a.item_name==='sys_code_editor'||a.item_name==='sys_lang')return;a.paginate=false;if(a.view_form.hasClass('modal')){a.view_form.find("#select-btn").on('click.task',function(){a.set_lookup_field_value();});a.view_options.width=960;d=480;if(a.item_name==='sys_items'||a.item_name==='sys_fields'){a.view_options.width=560;a.view_form.find('.title').hide();if(a.view_form.find('.sys_items_system').length)a.task.sys_params.init_lookup_form(a);else a.view_form.find('.modal-footer').hide();c={id:'10%'};}else if(a.item_name==='sys_filters'||a.item_name==='sys_indices'){a.view_options.width=680;d=460;}else if(a.item_name==='sys_report_params'){a.view_options.width=900;d=560;}}else{b.cur_item=a;a.view_form.find(".modal-body").css('padding',0);a.view_form.find("#title-left").html('<h4>'+'<span class="editor-title">'+b.cur_item_title+'</span>'+'</h4>');a.view_form.find("#select-btn").hide();d=b.center_panel.height()-b.view_panel.height();a.view_form.find("#title-right").addClass('admin-task-info');n(b);}if(a.item_name==='sys_items')c={id:'5%',f_visible:'10%',f_soft_delete:'10%'};if(a.item_name!=="sys_roles"){a.view_form.find("#new-btn").text(a.task.language['new']).on('click.task',function(){a.append_record();});a.view_form.find("#edit-btn").text(a.task.language.edit).on('click.task',function(){a.edit_record();});a.view_form.find("#delete-btn").text(a.task.language['delete']).on('click.task',function(){a.delete_record();});e={height:d,word_wrap:false,column_width:c};if(a.init_view_table)a.init_view_table(a,e);a.view_table=a.create_table(a.view_form.find(".view-table"),e);}m(a);}function q(b){b.find(".modal-footer button.btn").each(function(){if(a(this).outerWidth()<100&&a(this).text())a(this).outerWidth(100);});}function r(a){q(a.view_form);if(a.item_name==='sys_fields_editor'||a.item_name==='sys_code_editor')return;if(a===a.task.sys_privileges)a.open({params:{item_id:a.task.sys_items.id.value}});else if(a.item_name==='sys_items')a.open({fields:['id','deleted','parent','task_id','type_id','table_id','has_children','f_index','f_name','f_item_name','f_table_name','f_gen_name','f_view_template','f_visible','f_soft_delete','f_virtual_table','f_js_external','f_primary_key','f_deleted_flag','f_master_id','f_master_rec_id','f_keep_history','f_edit_lock','sys_id']});else a.open();}function s(a){var b={};if(a.item_name!=='sys_items'&&a.item_name!=='sys_fields'&&a.item_name!=='sys_code_editor'){a.edit_options.width=560;if(a.init_edit_options)a.init_edit_options(a,b);a.create_inputs(a.edit_form.find(".edit-body"),b);a.edit_form.find("#cancel-btn").text(a.task.language.cancel).attr("tabindex",101).on('click.task',function(b){a.cancel_edit(b);return false;});a.edit_form.find("#ok-btn").attr("tabindex",100).text(a.task.language.ok).on('click.task',function(){a.apply_record();});}}function t(a){q(a.edit_form);if(a.details_active)a.each_detail(function(a){a.update_controls();});else a.open_details();K(a);}function u(a){var c;if(a.item_name!=='sys_search')if(a.is_changing())if(a.is_modified()){a.yes_no_cancel(b.language.save_changes,function(){a.apply_record();},function(){a.cancel_edit();});c=false;}else{a.cancel();c=true;}if(c!==false&&a.edited_doc_info&&a.edited_doc_info.edit_form)a.task.editing_finished(a);return c;}function v(a){a.filter_form.title=a.item_caption+' - filter';a.create_filter_inputs(a.filter_form.find(".edit-body"));a.filter_form.find("#cancel-btn").attr("tabindex",101).on('click.task',function(){a.close_filter();});a.filter_form.find("#ok-btn").attr("tabindex",100).on('click.task',function(){a.apply_filter();});}function w(a){a.create_param_inputs(a.param_form.find(".edit-body"));a.param_form.find("#cancel-btn").attr("tabindex",101).on('click.task',function(){a.close_param_form();});a.param_form.find("#ok-btn").attr("tabindex",100).on('click.task',function(){a.process_report();});}function x(a,b){g(a);a.sys_params.params=true;a.sys_params.edit_options.fields=['f_safe_mode','f_debugging','f_con_pool_size','f_mp_pool','f_persist_con','f_compressed_js','f_single_file_js','f_dynamic_js','f_timeout','f_ignore_change_ip','f_version'];a.sys_params.edit_options.title=b;a.sys_params.edit_record();}function y(a,b){g(a);a.sys_params.params=false;a.sys_params.edit_options.fields=['f_decimal_point','f_mon_decimal_point','f_mon_thousands_sep','f_currency_symbol','f_frac_digits','f_p_cs_precedes','f_n_cs_precedes','f_p_sep_by_space','f_n_sep_by_space','f_positive_sign','f_negative_sign','f_p_sign_posn','f_n_sign_posn','f_d_fmt','f_d_t_fmt'];a.sys_params.edit_options.title=b;a.sys_params.edit_options.width=900;a.sys_params.edit_record();}function z(a,b){var c=['f_manual_update','f_db_type','f_alias','f_login','f_password','f_host','f_port','f_encoding'];a.sys_tasks.open();a.sys_tasks.edit_options.fields=c;a.sys_tasks.f_name.required=false;a.sys_tasks.f_item_name.required=false;a.sys_tasks.edit_options.title=b;a.sys_tasks.edit_record();}function A(a){a.sys_lookup_lists.view_options.fields=['f_name'];a.sys_lookup_lists.edit_options.fields=['f_name'];a.sys_lookup_lists.view();}function B(a){a.sys_search.find_in_task(a);}function C(b,c){var d,e,f,g,h=0,i,j;for(d=0;d<b.length;d++){c.append(a('<h4>'+b[d][0]+'</h4>'));i=b[d][1].split('\n');for(e=0;e<i.length;e++){g=i[e];h=0;for(f=0;f<g.length;f++)if(g[f]===' ')h+=1;else if(g[f]==='\t ')h+=4;else break;g=g.trim();if(g.length===0)j=a('<p style="line-height: 16px; margin: 0px;">').html('&nbsp;');else j=a('<p style="line-height: 16px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: '+h*6+'px">').text(g);j.css("font-family","'Courier New', Courier, monospace");c.append(j);}}}function D(b){var c=a(window).width()-50,d=a(window).height()-200,e=a('<div>'),f=b.server('server_web_print_code',[b.sys_tasks.task_id.value]);if(f){e.append(a('<h2>'+f.task+'</h2>'));e.append(a('<h3>Client</h3>'));C(f.client,e);e.append(a('<h3>Server</h3>'));C(f.server,e);b.message(e,{title:'Project code',margin:10,width:c,height:d,text_center:false,buttons:{"Close":undefined},center_buttons:false,print:true});}}function E(c){var d;d=b.show_message(a('<h5>Please wait while import is under way.</h5>'),{margin:"20px 20px",text_center:true});b._importing=true;b.server('server_import_task',[b.sys_tasks.task_id.value,'static/internal/'+c,true],function(a){var c=a[0],e=a[1],f=a[2],g,h=function(){if(c)location.reload();},i={text_center:false,width:720,height:400,title:'Import result',close_button:false,print:true,margin:0};b.hide_message(d);if(c){g='The metadata have been successfully imported';if(e)g='The metadata have been imported with errors.';g='<h3 class="text-center">'+g+'</h3>';}else g='<h3 class="text-center text-error">The metadata have not been imported.</h3>';if(f)g+='<h4 class="text-info">Import log</h4><div>'+f+'</div>';b.warning(g,h,i);b._importing=false;});}function F(a){a.upload('static/internal',{multiple:false,callback:E});}function G(a){var b,c=location.protocol+'/'+'/'+location.hostname+(location.port?':'+location.port:''),d=a.server('server_export_task',[a.sys_tasks.task_id.value,c]);window.open(d,"_self");}function H(a,b,c){var d=a._dataset[b],e=a._dataset[c],f,g;for(f=0;f<d.length-1;f++){g=d[f];d[f]=e[f];e[f]=g;}a.update_controls();a.rec_no=c;}function I(a){if(a.rec_no>0)H(a,a.rec_no,a.rec_no-1);}function J(a){if(a.rec_no<a.record_count()-1)H(a,a.rec_no,a.rec_no+1);}function K(b,c){var d,e,f;if(b.edit_form&&b.edit_table){d=b.edit_form.height();e=a(window).height();if(c||d>e-20){f=b.edit_table.height()-(d-e)-20;if(f>450)f=450;if(f<200)f=200;b.edit_table.height(f);b.update_controls();}}}var L;function M(b){clearTimeout(L);L=setTimeout(function(){var c=b.left_panel.height()+a(window).height()-a('body').height()-40;b.left_panel.height(c);b.tree.height(c);b.btns_panel.height(c);if(b.cur_item)b.cur_item.view_table.height(c-74);if(b.code_editor_item)b.code_editor_item.resize(b.code_editor_item);},100);}function N(b){if(b._manual_update)a("#project-mode").text('DB manual mode').css("color","red");else a("#project-mode").text('');}function O(a,b){if(a.item_name==='sys_users'||a.item_name==='sys_report_params'||a.item_name==='sys_filters')if(b.keyCode===45&&b.ctrlKey===true){b.preventDefault();a.append_record();}else if(b.keyCode===46&&b.ctrlKey===true){b.preventDefault();a.delete_record();}}function P(a,b){if(a.item_name==='sys_users'||a.item_name==='sys_indices'||a.item_name==='sys_report_params'||a.item_name==='sys_filters')if(b.keyCode===13&&b.ctrlKey===true){b.preventDefault();a.edit_form.find("#ok-btn").focus();a.apply_record();}}function Q(c,d){if(this.edited_doc)this.server('clear_edited',this.edited_doc,function(){this.edited_doc=undefined;a("title").html(b.language.admin);if(c&&d)d.call(c,c);});}function R(a){var b=this,c=a[2],d='',e=b.language[c],f;if(a[3])d=a[3].user_name;if(!e)e=c;if(d){f=b.language.is_edited_by;f=f.replace('%s',e);f=f.replace('%s',d);}else{f=b.language.is_edited;f=f.replace('%s',e);}return f;}this.tree_changed=e;this.refresh_tree=f;this.open_sys_params=g;this.on_page_loaded=h;this.add_button=i;this.add_divider=j;this.add_buttons=k;this.create_params_btn=l;this.create_print_btns=m;this.update_task_info=n;this.read_task_name=o;this.on_view_form_created=p;this.expand_buttons=q;this.on_view_form_shown=r;this.on_edit_form_created=s;this.on_edit_form_shown=t;this.on_edit_form_close_query=u;this.on_filter_form_created=v;this.on_param_form_created=w;this.set_project_params=x;this.set_locale_params=y;this.edit_database=z;this.show_lookup_lists=A;this.find_in_task=B;this.print_section=C;this.print_code=D;this.do_import=E;this.import_task=F;this.export_task=G;this.move_vert=H;this.move_record_up=I;this.move_record_down=J;this.resize_edit_table=K;this.resize=M;this.update_db_manual_mode=N;this.on_view_form_keydown=O;this.on_edit_form_keydown=P;this.editing_finished=Q;this.doc_editing_message=R;}b.events.events0=new c();function d(){function c(a){var b=a.task;a.fields_editor=false;if(b.item_tree.type_id.value===b.item_types.TASKS_TYPE){a.view_options.fields=['id','f_name','f_item_name'];a.edit_options.fields=['f_name','f_item_name'];}else if(b.item_tree.type_id.value===b.item_types.TASK_TYPE){a.fields_editor=true;a.view_options.fields=['id','f_name','f_item_name','f_visible'];a.edit_options.fields=['f_name','f_item_name','f_visible'];if(a.task._manual_update)a.sys_fields.view_options.fields=['f_name','f_field_name','f_db_field_name','f_data_type','f_size','f_required','f_read_only','f_object','f_object_field','f_master_field','f_enable_typehead','f_lookup_values','f_alignment','f_default'];else a.sys_fields.view_options.fields=['f_name','f_field_name','f_data_type','f_size','f_required','f_read_only','f_object','f_object_field','f_master_field','f_enable_typehead','f_lookup_values','f_alignment','f_default'];}else if(b.item_tree.type_id.value===b.item_types.ITEMS_TYPE||b.item_tree.type_id.value===b.item_types.TABLES_TYPE){a.fields_editor=true;a.view_options.fields=['id','f_name','f_item_name','f_table_name','f_visible','f_soft_delete'];a.edit_options.fields=['f_name','f_item_name','f_table_name'];if(a.task._manual_update)a.sys_fields.view_options.fields=['f_name','f_field_name','f_db_field_name','f_data_type','f_size','f_required','f_read_only','f_object','f_object_field','f_master_field','f_enable_typehead','f_lookup_values','f_alignment','f_default'];else a.sys_fields.view_options.fields=['f_name','f_field_name','f_data_type','f_size','f_required','f_read_only','f_object','f_object_field','f_master_field','f_enable_typehead','f_lookup_values','f_alignment','f_default'];}else if(b.item_tree.type_id.value===b.item_types.REPORTS_TYPE){a.view_options.fields=['id','f_name','f_item_name','f_view_template','f_visible'];a.edit_options.fields=['f_name','f_item_name','f_view_template','f_visible','f_js_external'];}else if(b.item_tree.type_id.value===b.item_types.ITEM_TYPE||b.item_tree.type_id.value===b.item_types.TABLE_TYPE){a.view_options.fields=['id','f_name','f_item_name','f_table_name'];a.edit_options.fields=['f_name','f_item_name','f_keep_history'];}}function d(a){var b=a.task;b.btns_panel.empty();if(b.item_tree.type_id.value===b.item_types.TASKS_TYPE)b.add_buttons(b,['client_module','server_module','index.html','project.css','divider','Lookup lists']);else if(b.item_tree.type_id.value===b.item_types.TASK_TYPE)b.add_buttons(b,['client_module','server_module']);else if(b.item_tree.type_id.value===b.item_types.ITEMS_TYPE||b.item_tree.type_id.value===b.item_types.TABLES_TYPE)b.add_buttons(b,['client_module','server_module','divider','viewing','editing','filters','divider','details','divider','order','indices','foreign_keys','divider','reports','divider','privileges']);else if(b.item_tree.type_id.value===b.item_types.ITEM_TYPE||b.item_tree.type_id.value===b.item_types.TABLE_TYPE)b.add_buttons(b,['client_module','server_module','divider','viewing','editing','divider','order']);else if(b.item_tree.type_id.value===b.item_types.REPORTS_TYPE)b.add_buttons(b,['client_module','server_module','divider','report_params']);}function e(a){var b=a.task,e=a.task.item_tree,f;a.filters.parent.value=e.id.value;c(a);a.view(b.view_panel);d(a);}function f(a){var b=a.task.item_tree.type_id.value,c=a.task.item_types,d=a.task;if(b===c.TASKS_TYPE)return c.TASK_TYPE;else if(b===c.TASK_TYPE)return c.ITEMS_TYPE;else if(b===c.ITEMS_TYPE)return c.ITEM_TYPE;else if(b===c.TABLES_TYPE)return c.TABLE_TYPE;else if(b===c.REPORTS_TYPE)return c.REPORT_TYPE;else if(b===c.ITEM_TYPE||b===c.TABLE_TYPE)return c.DETAIL_TYPE;}function g(a){var b=0,c=a.rec_no;try{a.each(function(a){a.edit();a.f_index.value=b;a.post();b++;});a.apply();}finally{a.rec_no=c;}}function h(a){var b=a.task.item_types;a.task.sys_new_group.on_edit_form_created=function(a){a.edit_form.find("#ok-btn").off('click.task').on('click',function(){a.post_record();});};a.task.sys_new_group.on_after_post=function(c){var d=c.group_type.value,e=[b.ITEMS_TYPE,b.TABLES_TYPE,b.REPORTS_TYPE];if(d){a.append();a.type_id.value=e[d-1];}setTimeout(function(){a.edit_record();},300);};a.task.sys_new_group.open({open_empty:true});a.task.sys_new_group.append_record();}function i(a){var b='';if(a.id.value)if(a.type_id.value===a.task.item_types.ITEMS_TYPE||a.type_id.value===a.task.item_types.TABLES_TYPE||a.type_id.value===a.task.item_types.REPORTS_TYPE){if(!a.server('server_group_is_empty',[a.id.value]))b='You can not delete the group. The group is not empty.';}else b=a.server('server_can_delete',[a.id.value]);return b;}function j(a){var c=[a.ID,a.id.value,'item_editor',a.task.user_info],d=b.server('check_doc_edited',c);if(d)a.task.question(a.task.doc_editing_message(d),function(){a.task.edited_doc=c;a.edit_record();a.task.server('set_edited',c);});else{a.task.edited_doc=c;a.edit_record();a.task.server('set_edited',c);}}function k(a,b){b.on_dblclick=j;}function l(a){var b=a.task.item_tree.type_id.value,c=a.task.item_types;a.cur_record_count=undefined;if(b===c.TASKS_TYPE||f(a)===c.DETAIL_TYPE){a.view_form.find('#new-btn').hide();a.view_form.find('#delete-btn').hide();a.view_form.find('#up-btn').hide();a.view_form.find('#down-btn').hide();}a.view_form.find('#import-btn').hide();if((b===c.ITEMS_TYPE||b===c.TABLES_TYPE)&&a.task._manual_update&&a.task.db_options.IMPORT_SUPPORT){a.view_form.find('#import-btn').show();a.view_form.find('#import-btn').on('click',function(){ab(a);});}a.view_form.find('#edit-btn').off('click.task').on('click',function(){j(a);});a.view_form.find('#delete-btn').off('click.task').on('click',function(){if(a.record_count())a.question(a.task.language.delete_record,function(){var b=i(a);if(b)a.warning(b);else{a["delete"]();a.apply();}});else a.warning('Record is not selected.');});a.view_form.find("#new-btn").off('click.task').on('click',function(){if(b===c.TASK_TYPE)h(a);else a.append_record();});a.view_form.find('#up-btn').click(function(){a.task.move_record_up(a);g(a);});a.view_form.find('#down-btn').click(function(){a.task.move_record_down(a);g(a);});}function m(b){var c=b.task.item_tree.type_id.value,d=b.task.item_types,e,f,g=450,h=560,i=b.task.item_tree;b._import_info=undefined;if(b.type_id.value===d.ITEM_TYPE||b.type_id.value===d.TABLE_TYPE){b.fields_editor=true;if(b.task.db_options.NEED_GENERATOR){e=['f_name','f_item_name','f_table_name','f_gen_name','f_primary_key','f_deleted_flag'];f=6;if(b.type_id.value===d.TABLE_TYPE){e=e.concat(['f_master_id','f_master_rec_id']);f=8;}}else{e=['f_name','f_item_name','f_table_name','f_primary_key','f_deleted_flag'];f=5;if(b.type_id.value===d.TABLE_TYPE){e=e.concat(['f_master_id','f_master_rec_id']);f=7;}}e=e.concat(['f_visible','f_soft_delete','f_virtual_table','f_keep_history','f_js_external']);}if(b.type_id.value===d.ITEMS_TYPE||b.type_id.value===d.TABLES_TYPE){b.fields_editor=true;e=['f_name','f_item_name','f_visible','f_primary_key','f_deleted_flag'];if(b.type_id.value===d.TABLES_TYPE)e=e.concat(['f_master_id','f_master_rec_id']);}else if(b.type_id.value===d.REPORTS_TYPE)b.fields_editor=false;if(b.fields_editor){h=1100;if(a(window).width()-50<h)h=a(window).width()-50;b.create_inputs(b.edit_form.find(".edit-body"),{fields:e,col_count:2,row_count:f});}else b.create_inputs(b.edit_form.find(".edit-body"));b.edit_options.width=h;b.edit_form.find("#cancel-btn").attr("tabindex",101).on('click.task',function(a){b.cancel_edit(a);return false;});b.edit_form.find("#ok-btn").attr("tabindex",100).on('click.task',function(){b.apply_record();});if(b.item_name==='sys_items')if(b.fields_editor){if(c===d.TASK_TYPE){g=520;if(b.id.value&&!b.server('server_group_is_empty',[b.id.value])){b.edit_form.find("#new-btn").prop("disabled",true);b.edit_form.find("#delete-btn").prop("disabled",true);q(b,true);}else q(b,false);}else if(b.id.value)q(b,true);else q(b,false);b.edit_table=b.sys_fields.create_table(b.edit_form.find(".edit-detail"),{height:g,tabindex:90,sortable:true,row_callback:n});b.edit_form.find("#new-btn").attr("tabindex",92).on('click.task',function(){b.sys_fields.append_record();});b.edit_form.find("#edit-btn").attr("tabindex",91).on('click.task',function(){b.sys_fields.edit_record();});b.edit_form.find("#delete-btn").attr("tabindex",90).off('click.task').on('click',function(){b.question(b.task.language.delete_record,function(){var a=b.sys_fields.can_delete(b.sys_fields);if(a)b.warning(a);else{b.sys_fields["delete"]();b.sys_fields.apply();}});});}else b.edit_form.find('#edit-detail-footer').hide();}function n(a,b){var c,d=function(){var a=b.owner._import_info.fields;for(var c=0;c<a.length;c++)if(a[c].field_name.toUpperCase()===b.f_field_name.value.toUpperCase())return a[c];};if(b.owner._import_info){if(!b.f_data_type.value){c=d();if(c)a.find('td.f_data_type span').text(c.data_type);a.find('td.f_data_type').css("color","#ff9999");}else{a.find('td.f_data_type span').text(b.f_data_type.display_text);a.find('td.f_data_type').css("color","#333333");}if(!b.f_size.value){c=d();if(c&&c.size)a.find('td.f_size span').text(c.size);a.find('td.f_size').css("color","#ff9999");}else{a.find('td.f_size span').text(b.f_size.display_text);a.find('td.f_size').css("color","#333333");}}}function o(a){var b='Item Editor';if(a.type_id.value===a.task.item_types.REPORT_TYPE)b='Report Editor';else if(a.type_id.value===a.task.item_types.ITEMS_TYPE)b='Item Group Editor';else if(a.type_id.value===a.task.item_types.TABLES_TYPE)b='Table Group Editor';else if(a.type_id.value===a.task.item_types.REPORTS_TYPE)b='Report Group Editor';if(a.is_new())a.edit_form.find('h4.modal-title').html(b);else a.edit_form.find('h4.modal-title').html(b+' <span class="editor-title">'+a.f_item_name.value+'</span>');}function p(a){a.task.editing_finished();}function q(a,b){a.f_primary_key.read_only=b;a.f_deleted_flag.read_only=b;if(a.f_master_id)a.f_master_id.read_only=b;if(a.f_master_rec_id)a.f_master_rec_id.read_only=b;}function r(a){var b=a.copy({handlers:false,details:false});a.f_visible.value=true;a.parent.value=a.task.item_tree.id.value;a.task_id.value=a.task.item_tree.task_id.value;a.table_id.value=0;a.f_index.value=a.record_count();if(!a.type_id.value)a.type_id.value=f(a);b.set_where({id:a.parent.value});b.open();if(b.record_count()){a.f_primary_key.value=b.f_primary_key.value;a.f_primary_key.lookup_value=b.f_primary_key.lookup_value;a.f_deleted_flag.value=b.f_deleted_flag.value;a.f_deleted_flag.lookup_value=b.f_deleted_flag.lookup_value;a.f_master_id.value=b.f_master_id.value;a.f_master_id.lookup_value=b.f_master_id.lookup_value;a.f_master_rec_id.value=b.f_master_rec_id.value;a.f_master_rec_id.lookup_value=b.f_master_rec_id.lookup_value;}if(a.f_deleted_flag.value)a.f_soft_delete.value=true;}function s(a){var b=a.owner,c,d=b.task.item_types,e=[],f=[],g,h,i,j,k;if(a.field_name==='f_item_name'){if(!b.valid_identifier(a.value))return b.task.language.invalid_name;f.push(b.parent.value);if(b.type_id.value!==d.DETAIL_TYPE)e.push(d.TASK_TYPE);if(b.type_id.value===d.ITEM_TYPE||b.type_id.value===d.TABLE_TYPE||b.type_id.value===d.REPORT_TYPE){e.push(d.ITEMS_TYPE);e.push(d.TABLES_TYPE);e.push(d.REPORTS_TYPE);}c=b.copy({handlers:false,details:false});if(e.length){c.set_where({type_id__in:e});c.open();c.each(function(a){f.push(a.id.value);});}c.set_where({parent__in:f});c.open();c.each(function(c){if(c.id.value!==b.id.value&&c.f_item_name.value===a.value){k='There is an item with this name';return false;}});if(k)return k;if(b.type_id.value===d.ITEM_TYPE||b.type_id.value===d.TABLE_TYPE||b.type_id.value===d.REPORT_TYPE){h=new b.task.constructors.item();if(h[a.value]!==undefined)return b.task.language.reserved_word;}if(b.type_id.value===d.ITEMS_TYPE||b.type_id.value===d.TABLES_TYPE||b.type_id.value===d.REPORTS_TYPE){i=new b.task.constructors.group();if(i[a.value]!==undefined)return b.task.language.reserved_word;}if(b.type_id.value===d.TASK_TYPE){j=new b.task.constructors.task();if(j[a.value]!==undefined)return b.task.language.reserved_word;}if(b.type_id.value===d.DETAIL_TYPE){g=new b.task.constructors.detail();if(g[a.value]!==undefined)return b.task.language.reserved_word;}}else if(a.field_name==='f_primary_key'){if(!a.value&&!b.f_virtual_table.value&&(b.type_id.value===d.ITEM_TYPE||b.type_id.value===d.TABLE_TYPE))return b.task.language.value_required;}else if(a.field_name==='f_master_id'&&!b.task._manual_update){if(!a.value&&!b.f_virtual_table.value&&b.type_id.value===d.TABLE_TYPE)return b.task.language.value_required;}else if(a.field_name==='f_master_rec_id')if(!a.value&&!b.f_virtual_table.value&&b.type_id.value===d.TABLE_TYPE)return b.task.language.value_required;}function t(a,b){var c,d,e,f=a.owner;if(f.is_new()&&f.type_id.value!=f.task.item_types.DETAIL_TYPE){if(a.field_name=='f_item_name'){e=f.task.server('get_new_table_name',a.value);f.f_table_name.value=e[0];if(f.task.db_options.NEED_GENERATOR)f.f_gen_name.value=e[1];}if(a.field_name==='f_name'&&!f.f_item_name.value)try{d=a.text.replace(' ','_').toLowerCase();if(u(d))f.f_item_name.value=d;}catch(g){}}if(a.field_name==='f_deleted_flag')if(a.value){f.f_soft_delete.read_only=false;f.f_soft_delete.value=true;}else{f.f_soft_delete.value=false;f.f_soft_delete.read_only=true;}}function u(a){function b(a){return a.charCodeAt(0)>=65&&a.charCodeAt(0)<=90||a.charCodeAt(0)>=97&&a.charCodeAt(0)<=122;}function c(a){return a.charCodeAt(0)>=48&&a.charCodeAt(0)<=57;}var d,e=a.length;if(a[0]==='_'||b(a[0])){for(d=1;d<e;d++)if(!(a[d]==='_'||b(a[d])||c(a[d])))return false;return true;}return false;}function v(a){var c;clearTimeout(c);c=setTimeout(function(){b.btns_panel.find('button').prop("disabled",a.record_count()===0);if(a.record_count()&&a.f_table_name&&a.f_virtual_table){a.f_table_name.read_only=!a.is_new();a.f_gen_name.read_only=!a.is_new();a.f_virtual_table.read_only=!a.is_new();b.btns_panel.find('button.indices').prop("disabled",a.f_virtual_table.value);b.btns_panel.find('button.foreign_keys').prop("disabled",a.f_virtual_table.value);}if(a.f_soft_delete&&a.f_deleted_flag)a.f_soft_delete.read_only=!a.f_deleted_flag.value;},100);}function w(a){var b=a.sys_items,c=b.copy(),d=b.task.sys_fields.copy(),e,f=[];if(b.table_id.value===0)d.set_where({owner_rec_id__in:[b.id.value,b.parent.value]});else{c.set_where({id:b.table_id.value});c.open({fields:['id','parent']});e=c.parent.value;d.set_where({owner_rec_id__in:[b.table_id.value,e]});}d.set_order_by(['f_field_name']);d.open({fields:['id','f_field_name']});d.each(function(a){f.push([a.id.value,a.f_field_name.value]);});return f;}function x(a){var b,c=[],d=[],e,f;function g(a,c){b.view_list=c;a.server('server_store_interface',[a.id.value,b]);}b=a.server('server_load_interface',[a.id.value]);c=[['id','',false],['name',a.task.language.caption_name,true]];d=[['id','',false],['name',a.task.language.caption_name,true,'60%'],['param1','Word wrap',false],['param2','Expand',false],['param3','Edit',false]];f=a.task.language.viewing+' <span class="editor-title">'+a.f_item_name.value+'</span>';a.task.sys_fields_editor.fields_editor(a,f,c,w(a.task),d,b.view_list,g);}function y(a){var b,c=[],d=[],e,f;function g(a,c){b.edit_list=c;a.server('server_store_interface',[a.id.value,b]);}b=a.server('server_load_interface',[a.id.value]);c=[['id','',false],['name',a.task.language.caption_name,true]];d=[['id','',false],['name',a.task.language.caption_name,true]];f=a.task.language.editing+' <span class="editor-title">'+a.f_item_name.value+'</span>';;a.task.sys_fields_editor.fields_editor(a,f,c,w(a.task),d,b.edit_list,g);}function z(a,b){a.task.sys_code_editor.code_editor(a,b);}function A(a,b){a.task.sys_code_editor.file_editor(a,b);}function B(a){z(a,'f_web_client_module');}function C(a){z(a,'f_server_module');}function D(a){A(a,'index.html');}function E(a){A(a,'project.css');}function F(a){var c=[],d=a.copy({handlers:false});d.set_where({type_id:b.item_types.TABLE_TYPE});d.open();d.each(function(a){c.push([a.id.value,a.f_item_name.value]);});return c;}function G(a){var b=[],c=a.copy({handlers:false});c.set_where({parent:a.id.value});c.open();c.each(function(a){b.push([a.table_id.value]);});return b;}function H(a){var b,c=[],d=[],e=F(a),f=G(a),g;function h(a,b){if(JSON.stringify(f)!==JSON.stringify(b)){a.server('server_update_details',[a.id.value,b]);a.task.refresh_tree(a.task);}}c=[['id','',false],['name',a.task.language.caption_name,true]];d=[['id','',false],['name',a.task.language.caption_name,true]];g=a.task.language.details+' <span class="editor-title">'+a.f_item_name.value+'</span>';;a.task.sys_fields_editor.fields_editor(a,g,c,e,d,f,h,undefined,false);}function I(a){var b,c=[],d=[],e,f;function g(a,c){b.order_list=c;a.server('server_store_interface',[a.id.value,b]);}b=a.server('server_load_interface',[a.id.value]);c=[['id','',false],['name',a.task.language.caption_name,true]];d=[['id','',false],['name',a.task.language.caption_name,true,'80%'],['param1',a.task.language.caption_descening,true]];f=a.task.language.order+' <span class="editor-title">'+a.f_item_name.value+'</span>';a.task.sys_fields_editor.fields_editor(a,f,c,w(a.task),d,b.order_list,g);}function J(a){var b,c=[],d=a.copy({handlers:false});d.set_where({type_id:a.task.item_types.REPORTS_TYPE});d.open();b=d.id.value;d.set_where({parent:b});d.open();d.each(function(a){c.push([a.id.value,a.f_name.value]);});return c;}function K(a){var b,c=[],d=[],e,f;function g(a,c){b.reports_list=c;a.server('server_store_interface',[a.id.value,b]);}b=a.server('server_load_interface',[a.id.value]);c=[['id','',false],['name',a.task.language.caption_name,true]];d=[['id','',false],['name',a.task.language.caption_name,true]];f=a.task.language.reports+' <span class="editor-title">'+a.f_item_name.value+'</span>';;a.task.sys_fields_editor.fields_editor(a,f,c,J(a),d,b.reports_list,g);}function L(a){a.task.sys_filters.filters.owner_rec_id.value=a.id.value;a.task.sys_filters.open();a.task.sys_filters.set_view_fields(['f_name','f_filter_name','f_type','f_field','f_visible']);a.task.sys_filters.set_edit_fields(['f_field','f_name','f_filter_name','f_type','f_multi_select_all','f_placeholder','f_help','f_visible']);a.task.sys_filters.view_options.title='Filters <span class="editor-title">'+a.f_item_name.value+'</span>';a.task.sys_filters.view();}function M(a){a.task.sys_indices.filters.owner_rec_id.value=a.id.value;a.task.sys_indices.filters.foreign_index.value=false;a.task.sys_indices.open();a.task.sys_indices.view_options.title='Indices <span class="editor-title">'+a.f_item_name.value+'</span>';a.task.sys_indices.view();}function N(a){a.task.sys_indices.filters.owner_rec_id.value=a.id.value;a.task.sys_indices.filters.foreign_index.value=true;a.task.sys_indices.open();a.task.sys_indices.view_options.title='Foreign keys <span class="editor-title">'+a.f_item_name.value+'</span>';a.task.sys_indices.view();}function O(a){var b=['f_name','f_param_name','f_data_type','f_object','f_object_field','f_enable_typehead','f_multi_select','f_lookup_values','f_required','f_alignment','f_visible'];a.task.sys_report_params.filters.owner_rec_id.value=a.id.value;a.task.sys_report_params.open();a.task.sys_report_params.view_options.fields=b;b=['f_name','f_param_name','f_data_type','f_object','f_object_field','f_enable_typehead','f_multi_select','f_multi_select_all','f_lookup_values','f_required','f_alignment','f_placeholder','f_help','f_visible'];a.task.sys_report_params.edit_options.fields=b;a.task.sys_report_params.view_options.title='Params <span class="editor-title">'+a.f_item_name.value+'</span>';a.task.sys_report_params.view();}function P(a){var b=a.task.sys_privileges;b.view_options.fields=['item_id','f_can_view','f_can_create','f_can_edit','f_can_delete'];b.view();}function Q(a,b){if(b.keyCode===45&&b.ctrlKey===true){b.preventDefault();a.append_record();}else if(b.keyCode===46&&b.ctrlKey===true){b.preventDefault();a.delete_record();}}function R(a,b){if(b.keyCode===13&&b.ctrlKey===true){b.preventDefault();a.edit_form.find("#ok-btn").focus();a.apply_record();}if(b.keyCode===45&&b.ctrlKey===true){b.preventDefault();a.sys_fields.append_record();}else if(b.keyCode===46&&b.ctrlKey===true){b.preventDefault();a.sys_fields.delete_record();}}function S(a){a.refresh_record();v(a);if(a.cur_record_count&&a.cur_record_count!==a.record_count())if(a.type_id.value===a.task.item_types.ITEMS_TYPE||a.type_id.value===a.task.item_types.TABLES_TYPE||a.type_id.value===a.task.item_types.REPORTS_TYPE)a.task.refresh_tree(a.task);if(a._import_info){X(a,a._import_info.indexes);a._import_info=undefined;}}function T(a,b){var c=a.owner;if(b.item_name==='sys_fields')b.set_view_fields(['f_field_name','f_name']);if(b.item_name==='sys_fields')b.set_order_by(['f_field_name']);if(a.field_name==='f_primary_key'||a.field_name==='f_deleted_flag'||a.field_name==='f_master_id'||a.field_name==='f_master_rec_id'){b.set_order_by(['f_field_name']);b.set_where({owner_rec_id__in:[c.parent.value],f_data_type__in:[c.task.consts.INTEGER,c.task.consts.TEXT]});}b.on_after_open=function(a){var b=c.sys_fields.clone();a.first();while(!a.eof())if(a.id.value===c.f_primary_key.value||a.id.value===c.f_deleted_flag.value||a.id.value===c.f_master_id.value||a.id.value===c.f_master_rec_id.value)a["delete"]();else a.next();b.each(function(b){if((b.f_data_type.value===c.task.consts.INTEGER||b.f_data_type.value===c.task.consts.TEXT)&&b.id.value!==c.f_primary_key.value&&b.id.value!==c.f_deleted_flag.value&&b.id.value!==c.f_master_id.value&&b.id.value!==c.f_master_rec_id.value){a.append();a.id.value=b.id.value;a.f_field_name.value=b.f_field_name.value;a.f_db_field_name.value=b.f_db_field_name.value;a.f_name.value=b.f_name.value;a.f_data_type.value=b.f_data_type.value;a.post();}});a.first();};}function U(a){a.cur_record_count=a.record_count();}function V(a){a.cur_record_count=a.record_count();}function W(a){return{'manual_update':a.task._manual_update};}function X(a,b){var c=a.task.sys_indices,d,e,f,g,h=0,i;c.open({open_empty:true});if(b.length){for(var j=0;j<b.length;j++){c.append();c.f_index_name.value=b[j].index_name;c.f_unique_index.value=b[j].unique;i=[];e=true;for(var k=0;k<b[j].fields.length;k++){g=b[j].fields[k][0];d=b[j].fields[k][1];f=0;a.sys_fields.each(function(a){if(a.f_db_field_name.value.toUpperCase()===g.toUpperCase()){f=a.id.value;return false;}});if(f)i.push([f,d]);else{e=false;break;}}c.f_fields_list.value=c.server('server_dump_index_fields',[i]);if(e){h+=1;c.post();}else c.cancel();}c.apply();a.warning('Information about '+h+' index(es) have been added. Information about '+(b.length-h)+' index(es) could not be added.');}}function Y(a,b){var c=b.f_table_name.value,d=a.task.server('server_import_table',c),e,f,g,h,i,j=function(a,b){for(var c in b)if(b[c]===a)return c;return 0;};if(d){e=d.fields;f=d.field_types;b.close_view_form();a.append_record();i=a.sys_fields.store_handlers();a.sys_fields.disable_controls();try{a._import_info=d;a.sys_fields.clear_handlers();a.f_name.value=c.charAt(0).toUpperCase()+c.slice(1).toLowerCase();a.f_item_name.value=c.toLowerCase();a.f_table_name.value=c;a.f_gen_name.value='';a.f_soft_delete.value=false;h=a.task.server('get_fields_next_id',e.length);for(var k=0;k<e.length;k++){g=e[k].field_name;a.sys_fields.append();a.sys_fields.id.value=h;h+=1;a.sys_fields.f_name.value=g;a.sys_fields.f_field_name.value=g.toLowerCase();a.sys_fields.f_db_field_name.value=g;a.sys_fields.f_data_type.value=j(e[k].data_type,f);a.sys_fields.f_size.value=e[k].size;if(e[k].pk){a.f_primary_key.value=a.sys_fields.id.value;a.f_primary_key.lookup_value=a.sys_fields.f_field_name.value;}if(e[k].default_value)a.sys_fields.f_default_value.value=e[k].default_value;a.sys_fields.post();}a.sys_fields.first();}finally{a.sys_fields.load_handlers(i);a.sys_fields.enable_controls();a.sys_fields.update_controls();}}}function Z(a){var b=a.task.sys_fields.copy({handlers:false});b.set_where({owner_rec_id:a.task.item_tree.id.value});b.open({fields:['id']});if(b.record_count()){a.warning(a.task.language.import_prohibited.replace('%s',a.task.item_tree.f_name.value));return false;}return true;}function ab(a){var b=a.copy({handlers:false});if(Z(a)){b.each_field(function(a){a.required=false;});b.log_changes=false;b.set_where({id__in:[]});b.init_view_table=function(b,c){c.on_dblclick=function(){Y(a,b);};};b.on_view_form_created=function(b){b.view_form.find('.modal-footer').show();b.view_form.find('#import-btn').click(function(){Y(a,b);});b.task.server('server_get_table_names',function(a){for(var c=0;c<a.length;c++){b.append();b.f_table_name.value=a[c];b.post();}b.first();});};b.view_options.template_class='import-tables-view';b.view_options.title='Import';b.view_options.fields=['f_table_name'];b.view();}}function ac(a){var b=a.sys_fields.clone(),c=false;if(a._import_info){b.each(function(a){if(!a.f_data_type.value||(a.f_data_type.value===a.task.consts.TEXT&&!a.f_size.value)){c=true;return false;}});if(c){a.warning(a.task.language.fields_not_defined);throw a.task.language.fields_not_defined;}}}this.init_fields=c;this.init_buttons=d;this.tree_changed=e;this.get_type_id=f;this.save_order=g;this.append_group=h;this.can_delete=i;this.edit_item=j;this.init_view_table=k;this.on_view_form_created=l;this.on_edit_form_created=m;this.field_colors=n;this.on_edit_form_shown=o;this.on_edit_form_closed=p;this.update_sys_fields_read_only=q;this.on_after_append=r;this.on_field_validate=s;this.on_field_changed=t;this.valid_identifier=u;this.on_after_scroll=v;this.get_fields_list=w;this.view_setup=x;this.edit_setup=y;this.edit_code=z;this.edit_file=A;this.edit_client=B;this.edit_server=C;this.edit_index_html=D;this.edit_project_css=E;this.get_detail_source_list=F;this.get_detail_dest_list=G;this.details_setup=H;this.order_setup=I;this.get_reports_list=J;this.reports_setup=K;this.filters_setup=L;this.indices_setup=M;this.foreign_keys_setup=N;this.report_params_setup=O;this.privileges_setup=P;this.on_view_form_keydown=Q;this.on_edit_form_keydown=R;this.on_after_apply=S;this.on_field_select_value=T;this.on_before_append=U;this.on_before_delete=V;this.on_before_apply=W;this.add_import_indexes=X;this.import_table=Y;this.can_import_tables=Z;this.import_tables=ab;this.on_before_post=ac;}b.events.events3=new d();function e(){function b(b){var g=b.task.center_panel.height()-b.task.view_panel.height();if(b.view_form.hasClass('modal')){g=460;b.view_options.width=560;b.view_form.find("#priv-panel").remove();b.view_form.find("#roles-panel").removeClass('span4').addClass('span12');b.view_form.find("#roles-footer").hide();b.view_table=b.create_table(b.view_form.find("#roles-panel .view-table"),{height:g,fields:['id','f_name'],column_width:{id:'10%'}});}else{b.view_form.find("#roles-panel #new-btn").text(b.task.language['new']).on('click.task',function(){f(b);});b.view_form.find("#roles-panel #delete-btn").text(b.task.language['delete']).on('click.task',function(){e(b);});b.view_form.find("#select-all-btn").text(b.task.language.select_all).on('click.task',function(){c(b);});b.view_form.find("#unselect-all-btn").text(b.task.language.unselect_all).on('click.task',function(){d(b);});b.set_view_fields(['f_name'],[b.task.language.roles]);b.view_table=b.create_table(b.view_form.find("#roles-panel .view-table"),{height:g,fields:['id','f_name'],word_wrap:false,sortable:false});b.sys_privileges.set_view_fields(['item_id','f_can_view','f_can_create','f_can_edit','f_can_delete'],[b.task.language.item,b.task.language.can_view,b.task.language.can_create,b.task.language.can_edit,b.task.language.can_delete]);b.detail_table=b.sys_privileges.create_table(b.view_form.find("#priv-panel .view-table"),{height:g,word_wrap:true,column_width:{item_id:'50%'},sortable:false,dblclick_edit:false});b.detail_table.$table.on('click','td',function(){var c=a(this),d=c.data('field_name'),e=b.sys_privileges.field_by_name(d);if(e.field_type==="boolean"){if(!b.sys_privileges.is_changing())b.sys_privileges.edit();e.value=!e.value;}});}}function c(a,b){var c=a.details.sys_privileges,d=c.on_field_changed,e=c.rec_no;if(b===undefined)b=true;if(!a.is_changing())a.edit();try{c.on_field_changed=undefined;c.disable_controls();c.each(function(c){c.edit();c.f_can_create.value=b;c.f_can_view.value=b;c.f_can_edit.value=b;c.f_can_delete.value=b;if(c.id.value)c.record_status=a.task.consts.RECORD_MODIFIED;else c.record_status=a.task.consts.RECORD_INSERTED;c.post();});}finally{c.on_field_changed=d;c.rec_no=e;c.enable_controls();}if(a.is_changing()){a.post();a.apply();a.edit();}c.open();}function d(a){c(a,false);}function e(a){if(a.is_changing())a.cancel();a.delete_record();}function f(a){if(a.is_changing()){a.post();a.apply();}a.append_record();}function g(a){if(a.is_changing()){a.post();a.apply();}}var h;function i(a){clearTimeout(h);h=setTimeout(function(){a.sys_privileges.open();if(a.is_browsing())a.edit();},50);}function j(a){a.server('roles_changed');}this.on_view_form_created=b;this.select_all_clicked=c;this.unselect_all_clicked=d;this.del_role=e;this.append_role=f;this.on_before_scroll=g;this.on_after_scroll=i;this.on_after_apply=j;}b.events.events2=new e();function f(){function a(a){a.f_manual_update.value=a.task._manual_update;}function c(a){if(b.init_project&&a.f_db_type.value){a.task.server('server_create_task');a.task.on_page_loaded(a.task);}a.task.update_db_manual_mode(a.task);}function d(a,b){var c=a.owner,d,e,f;if(a===a.owner.f_db_type&&a.value){d=c.task.server('server_get_db_options',[a.owner.f_db_type.value]);e=d[0];f=d[1];if(f){c.warning(f);a.value=null;return;}if(a.owner.is_changing()){a.owner.f_alias.value=null;a.owner.f_login.value=null;a.owner.f_password.value=null;a.owner.f_encoding.value=null;a.owner.f_host.value=null;a.owner.f_port.value=null;}a.owner.f_login.read_only=!e.NEED_DATABASE_NAME;a.owner.f_login.read_only=!e.NEED_LOGIN;a.owner.f_password.read_only=!e.NEED_PASSWORD;a.owner.f_encoding.read_only=!e.NEED_ENCODING;a.owner.f_host.read_only=!e.NEED_HOST;a.owner.f_port.read_only=!e.NEED_PORT;}}function e(a){var c=a.task.server('server_check_connection',[a.f_db_type.value,a.f_alias.value,a.f_login.value,a.f_password.value,a.f_host.value,a.f_port.value,a.f_encoding.value]);if(c){a.warning(c);a.abort();}if(b.init_project)a.task.server('server_set_task_name',[a.f_name.value,a.f_item_name.value]);a.task._manual_update=a.f_manual_update.value;a.f_manual_update.value=false;}function f(a){}function g(a){var b=a.owner;if(a.field_name==='f_item_name'&&a.required)if(!b.task.sys_items.valid_identifier(a.value))return b.task.language.invalid_name;if(a.field_name==='f_port'&&a.value)if(isNaN(a.value))return 'The port must be an integer value.';}function h(a){a.task.editing_finished();}this.on_after_edit=a;this.on_after_apply=c;this.on_field_changed=d;this.on_before_post=e;this.on_after_post=f;this.on_field_validate=g;this.on_edit_form_closed=h;}b.events.events9=new f();function g(){function c(a,b){var c=this.copy(),d;c.item=a;c.field_name=b;c.is_server=b==='f_server_module';c.doc_type='client_module';if(c.is_server)c.doc_type='server_module';c.item_info=a.task.server('server_item_info',[a.task.sys_items.id.value,c.is_server,c.doc_type]);c.view();}function d(a,b){var c=this.copy(),d;c.item=a;c.file_name=b;c.doc_type=b;c.item_info=a.task.server('server_get_file_info',[a.task.sys_items.id.value,b]);c.view();}function e(c){b.code_editor_item=c;if(c.field_name){a("title").html(c.item_info.module_name);c.view_options.title='Code Editor <span class="editor-title">'+c.item_info.module_name+'</span>';}else if(c.file_name){a("title").html(c.file_name);c.view_options.title='Code Editor <span class="editor-title">'+c.file_name+'</span>';}c.view_form.find("#left-box").width(250);c.view_form.find("#right-box").hide();c.view_form.find("#cancel-btn").attr("tabindex",101).on('click',function(a){n(c);});c.view_form.find("#ok-btn").attr("tabindex",100).on('click',function(){m(c);});c.view_form.find("#find-btn").attr("tabindex",99).on('click',function(){w(c);});o(c);}function f(b){if(b.field_name){b.view_form.find('#editor-tabs ul').append('<li id="module"><a href="#">Module</a></li>').append('<li id="events"><a href="#">Events</a></li>').append('<li id="task"><a href="#">Task</a></li>').append('<li id="fields"><a href="#">Fields</a></li>');u(b,"Module");u(b,"Events");u(b,"Task");u(b,"Fields");b.view_form.find('#editor-tabs #info-grids').height(b.view_form.find('#left-box').innerHeight()-b.view_form.find('ul.nav-tabs').outerHeight()-14);t(b,b.view_form.find('li#module'));b.editor=ace.edit("editor");b.editor.$blockScrolling=Infinity;if(b.is_server){b.is_server_module=true;b.editor.getSession().setMode("ace/mode/python");b.editor.getSession().setOption("tabSize",4);b.editor.getSession().setUseSoftTabs(true);}else b.editor.getSession().setMode("ace/mode/javascript");}else if(b.file_name){if(b.item_info.Templates){b.view_form.find('#editor-tabs ul').append('<li id="templates"><a href="#">Templates</a></li>');u(b,"Templates");b.view_form.find('#editor-tabs #info-grids').height(b.view_form.find('#left-box').innerHeight()-b.view_form.find('ul.nav-tabs').outerHeight()-14);t(b,b.view_form.find('li#templates'));}else b.view_form.find("#left-box").hide();b.editor=ace.edit("editor");b.editor.$blockScrolling=Infinity;if(b.file_name==='index.html')b.editor.getSession().setMode("ace/mode/html");else b.editor.getSession().setMode("ace/mode/css");}b.loaded=true;b.editor.session.setValue(b.item_info.code);b.editor.gotoLine(1);b.view_form.find('#ok-btn').prop("disabled",true);b.editor.on('input',function(){b.view_form.find("#error-info").text('');if(b.loaded){b.loaded=false;h(b);return;}if(g(b))b.view_form.find('#ok-btn').prop("disabled",false);else b.view_form.find('#ok-btn').prop("disabled",true);});b.view_form.on('click','#editor-tabs > .nav > li',function(){t(b,a(this));});b.view_form.on('dblclick','.dbtree ul li',function(c){c.preventDefault();c.stopPropagation();r(b,a(this));});a(b.editor).focus();setTimeout(function(){b.view_form.off('keyup.dismiss.modal');a(b.editor).focus();},100);}function g(a){return !a.editor.session.getUndoManager().isClean();}function h(a){a.editor.session.getUndoManager().markClean();}function i(a){var c;if(g(a)){a.yes_no_cancel(b.language.save_changes,function(){m(a);a.close_view_form();},function(){h(a);a.close_view_form();});c=false;}else{b.code_editor_item=undefined;a.editor.destroy();c=true;}return c;}function j(a){a.task.editing_finished();}function k(a){var b=a.editor.getValue(),c,d,e,f;if(a.is_server&&b.indexOf('\t')!==-1){b=b.split('\t').join(' '+'   ');a.editor.setValue(b);}c=a.task.server('server_save_edit',[a.task.sys_items.id.value,b,a.is_server]),d=c[0],e=c[1],f=c[2];if(d&&e&&e<a.editor.session.getLength())a.editor.gotoLine(e);if(!d){a.item_info.Module=f;u(a,"Module");s(a);}return d;}function l(a){var b=a.task.server('server_save_file',[a.file_name,a.editor.getValue()]),c=b.error;if(b.Templates){a.item_info.Templates=b.Templates;u(a,"Templates");s(a);}}function m(a){var b=false;if(a.field_name)b=k(a);else if(a.file_name)b=l(a);if(b)a.view_form.find("#error-info").text(b);else{a.view_form.find("#error-info").text('');h(a);a.view_form.find('#ok-btn').prop("disabled",true);}}function n(a){h(a);a.close_view_form();}function o(b){var c;b.view_options.width=a(window).width()-50;c=a(window).height()-200;b.view_form.find("#editor-box").height(c);}function p(b){var c;c=a(window).height()-200;b.view_options.width=a(window).width()-50;b.view_form.data('modal').layout();}function q(a,b){return a.editor.find(b,{backwards:false,wrap:false,caseSensitive:true,wholeWord:true,regExp:false});}function r(a,b){var c=b.closest('.info-tree').attr('id'),d=b.find('span.tree-text:first').text(),e,f,g;if(c==='module'){a.editor.gotoLine(1);if(a.is_server_module)e='def '+d;else e='function '+d;f=q(a,e);}else if(c==='events'){a.editor.gotoLine(1);if(!q(a,d+'(')){g=a.item_info.Events[d];a.editor.gotoLine(a.editor.session.getLength()+1);if(a.is_server_module)e='def '+d+'('+g+'):\n\tpass';else e='function '+d+'('+g+') {\n\n}';a.editor.insert('\n\n'+e);}}else if(c==='task'||c==='fields')a.editor.insert(d);else if(c==='templates'){a.editor.gotoLine(1);e=d;q(a,e);}a.editor.focus();}function s(a){var b,c,d;b=a.view_form.find('#editor-tabs > .nav > li.active');if(b.length){d=a.view_form.find('#editor-tabs #info-grids').innerHeight();a.view_form.find('#editor-tabs div.info-tree').hide();a.view_form.find('#editor-tabs div.info-tree.'+b.attr('id')).show().height(d).find('.dbtree').height(d);c=a.view_form.find('#editor-tabs div.info-tree.'+b.attr('id')).find('.dbtree').data('tree');if(c)c.scroll_into_view();}}function t(a,b){var c;a.view_form.find('#editor-tabs li').removeClass('active');b.addClass('active');s(a);}function u(b,c){var d=b.copy(),e=c.toLowerCase(),f=b.view_form.find('li#'+e),g=b.item_info[c],h;h=b.view_form.find('#editor-tabs #info-grids > div.'+e);if(h.length)h.empty();else{h=a('<div id="'+e+'" class="info-tree '+e+'">');b.view_form.find('#editor-tabs #info-grids').append(h);}h.hide();d.open({open_empty:true});v(d,g,0);d.disable_controls();try{d.create_tree(h,{id_field:'id',parent_field:'parent',text_field:'name',parent_of_root_value:0});}finally{d.enable_controls();}}function v(a,b,c){var d=[],e=0;for(var f in b)d.push(f);d=d.sort();e=c+1;if(d.length)for(var g=0;g<d.length;g++){a.append();a.id.value=e;a.parent.value=c;a.name.value=d[g];a.post();if(b[d[g]]!==null&&typeof b[d[g]]==='object')e=v(a,b[d[g]],e);e++;}return e;}function w(a){a.task.sys_search.find_in_task(b);}function x(a,b){var c=(b.keyCode?b.keyCode:b.which);if(c===27)if(!a.view_form.find('.ace_search').is(':visible'))a.close_view_form();if(b.ctrlKey&&c===83){b.preventDefault();b.stopPropagation();m(a);}if(b.altKey&&c===70){b.preventDefault();b.stopPropagation();w(a);}}this.code_editor=c;this.file_editor=d;this.on_view_form_created=e;this.on_view_form_shown=f;this.get_modified=g;this.mark_clean=h;this.on_view_form_close_query=i;this.on_view_form_closed=j;this.save_to_field=k;this.save_to_file=l;this.save_edit=m;this.cancel_edit=n;this.update_size=o;this.resize=p;this.find_text=q;this.tree_node_clicked=r;this.update_tab_height=s;this.info_tab_clicked=t;this.add_tree=u;this.build_tree=v;this.find_in_project=w;this.on_view_form_keydown=x;}b.events.events14=new g();function h(){function b(a,b,c,d,e,f,g,h,i,j){var k=this.copy();k.item=a;k.title=b;k.source_def=c;k.source_list=d;k.dest_def=e;k.dest_list=f;k.save_func=g;k.cancel_func=h;if(i===undefined)i=true;k.can_move=i;if(j===undefined)j=false;k.read_only=j;k.view();return k;}function c(b){var c={},d,e;if(b.dest_def[1].length===4)c={'name':b.dest_def[1][3]};b.source=b.copy(),b.dest=b.copy();b.view_options.width=680;b.view_form.title=b.title;e=[];for(d=0;d<b.source_def.length;d++)if(b.source_def[d][2])e.push(b.source_def[d][0]);b.source.set_view_fields(e);e=[];for(d=0;d<b.dest_def.length;d++)if(b.dest_def[d][2])e.push(b.dest_def[d][0]);b.dest.set_view_fields(e);b.left_grid=b.dest.create_table(b.view_form.find("#left-grid"),{height:360,column_width:c,dblclick_edit:false});b.right_grid=b.source.create_table(b.view_form.find("#right-grid"),{height:360,dblclick_edit:false});b.left_grid.$table.keydown(function(a){var c=(a.keyCode?a.keyCode:a.which);if(c===32){a.preventDefault();h(b);}});b.right_grid.$table.keydown(function(a){var c=(a.keyCode?a.keyCode:a.which);if(c===32){a.preventDefault();g(b);}});if(!b.can_move)b.view_form.find("#vert-btns-box").hide();b.view_form.find("#up-btn").attr('tabindex',-1).click(function(){b.task.move_record_up(b.dest);});b.view_form.find("#down-btn").attr('tabindex',-1).click(function(){b.task.move_record_down(b.dest);});b.view_form.find("#left-btn").attr('tabindex',-1).click(function(){g(b);});b.view_form.find("#right-btn").attr('tabindex',-1).click(function(){h(b);});b.view_form.find("#cancel-btn").attr("tabindex",101).text(b.task.language.cancel).on('click.task',function(a){l(b);});b.view_form.find("#ok-btn").attr("tabindex",100).text(b.task.language.ok).on('click.task',function(){i(b);});if(b.read_only)b.view_form.find("button.arrow_btn").hide();b.left_grid.$table.on('click','td',function(){var c=a(this),d=c.data('field_name'),e=b.dest.field_by_name(d);if(e.field_type==="boolean"&&!b.read_only){if(!b.dest.is_changing())b.dest.edit();e.value=!e.value;b.dest.post();}});}function d(a){e(a);a.right_grid.focus();}function e(a){var b,c,d,e,f,g;a.source.disable_controls();try{a.source.open({open_empty:true});for(b=0;b<a.source_def.length;b++)if(a.source_def[b][2])a.source.field_by_name(a.source_def[b][0]).field_caption=a.source_def[b][1];for(b=0;b<a.source_list.length;b++){e=a.source_list[b];g=false;for(c=0;c<a.dest_list.length;c++){f=a.dest_list[c];if(e[0]===f[0]){g=true;break;}}if(!g){a.source.append();for(d=0;d<a.source_def.length;d++)a.source.field_by_name(a.source_def[d][0]).value=e[d];a.source.post();}}a.source.first();}finally{a.source.enable_controls();}a.source.update_controls();a.dest.disable_controls();try{a.dest.open({open_empty:true});for(b=0;b<a.dest_def.length;b++)if(a.dest_def[b][2])a.dest.field_by_name(a.dest_def[b][0]).field_caption=a.dest_def[b][1];for(b=0;b<a.dest_list.length;b++){f=a.dest_list[b];g=false;for(c=0;c<a.source_list.length;c++){e=a.source_list[c];if(e[0]===f[0]){g=true;break;}}if(g){a.dest.append();a.dest.id.value=e[0];a.dest.name.value=e[1];for(d=2;d<a.dest_def.length;d++)a.dest.field_by_name(a.dest_def[d][0]).value=f[d-1];a.dest.post();}}a.dest.first();}finally{a.dest.enable_controls();}a.dest.update_controls();}function f(a,b){if(a.record_count()){b.append();b.id.value=a.id.value;b.name.value=a.name.value;b.post();a["delete"]();}}function g(a){f(a.source,a.dest);}function h(a){f(a.dest,a.source);}function i(a){var b=[],c=a.dest.rec_no;a.dest.disable_controls();try{a.dest.each(function(c){var d,e=[];e.push(c.id.value);for(d=2;d<a.dest_def.length;d++)e.push(a.dest.field_by_name(a.dest_def[d][0]).value);b.push(e);});}finally{a.dest.rec_no=c;a.dest.enable_controls();}a.save_func(a.item,b);a.close_view_form();}function j(a){if(a.item.is_changing())if(a.cancel_func)a.cancel_func(a.item);}function k(a){a.task.editing_finished();}function l(a){a.close_view_form();}function m(a,b){if(b.keyCode===13){b.preventDefault();i(a);}}this.fields_editor=b;this.on_view_form_created=c;this.on_view_form_shown=d;this.prepare_grids=e;this.move_hor=f;this.move_left=g;this.move_right=h;this.save_result=i;this.on_view_form_close_query=j;this.on_view_form_closed=k;this.item_cancel=l;this.on_view_form_keydown=m;}b.events.events15=new h();function i(){function a(a){if(a.task.init_project&&a.f_language.value){a.task.server('server_set_project_langage',[a.f_language.value]);location.reload();}else if(a._safe_mode!==a.f_safe_mode.value){a.task.logout();location.reload();}else a.task.update_task_info(a.task);}function b(a,b){if(a.params===true){a.edit_options.width=560;b.label_width=200;}else if(a.params===false){a.edit_options.width=560;b.label_width=360;}}function c(a){if(a.field_name==='f_con_pool_size'&&a.value<1)return 'The Connection pool size value must be greater than zero';}function d(a){a.task.editing_finished(a);}function e(a){a._safe_mode=a.f_safe_mode.value;}function f(a){a.task.editing_finished();}function g(a,b){if(a.field_name==='f_history_item'||a.field_name==='f_lock_item'){if(a.field_name==='f_history_item')b.set_where({sys_id:1});else if(a.field_name==='f_lock_item')b.set_where({sys_id:2});b.view_options.template_class='sys_items_system';b.view_options.fields=['f_name','f_item_name'];}}function h(a){var b;if(a.lookup_field.field_name==='f_history_item')b='Create history item';else if(a.lookup_field.field_name==='f_lock_item')b='Create lock item';a.view_form.find('#create-btn').text(b).click(function(){i(a);});}function i(a){var b=a.task.server('create_system_item',a.lookup_field.field_name),c=b[0],d=b[1];if(d)a.warning(d);else a.warning(c,function(){location.reload();});}this.on_after_apply=a;this.init_edit_options=b;this.on_field_validate=c;this.on_before_apply=d;this.on_after_edit=e;this.on_edit_form_closed=f;this.on_field_select_value=g;this.init_lookup_form=h;this.create_system_item=i;}b.events.events11=new i();function j(){function c(a){var b=a.sys_search.copy();b.open({open_empty:true});b.set_edit_fields(['find_text','case_sensitive','whole_words']);b.append_record();}function d(a){a.edit_form.title=b.language.find;a.edit_form.find("#cancel-btn").text(b.language.close).attr("tabindex",101);a.edit_form.find("#ok-btn").text(b.language.find).attr("tabindex",100).off('click.task').on('click',function(){e(a);});}function e(c){var d,e,f,g,h=a(window).width()-50,i=a(window).height()-200,j=a('<div>');if(c.find_text.value){d=c.task.server('server_find_in_task',[c.task.sys_tasks.task_id.value,c.find_text.value,c.case_sensitive.value,c.whole_words.value]);if(d){j.append(a('<h4>Client</h4>'));g=d.client.split('\n');for(e=0;e<g.length;e++){f=a('<p style="margin: 0px;">').text(g[e]);f.css("font-family","'Courier New', Courier, monospace");j.append(f);}j.append(a('<h4>Server</h4>'));g=d.server.split('\n');for(e=0;e<g.length;e++){f=a('<p style="margin: 0px;">').text(g[e]);f.css("font-family","'Courier New', Courier, monospace");j.append(f);}b.message(j,{title:'Search result',margin:10,width:h,height:i,text_center:false,buttons:{"Close":undefined},center_buttons:false,print:true});}}}function f(a,b){if(b.keyCode===13){b.preventDefault();a.edit_form.find("#ok-btn").focus();e(a);}}this.find_in_task=c;this.on_edit_form_created=d;this.find=e;this.on_edit_form_keydown=f;}b.events.events16=new j();function k(){function a(a,b){a.view_options.width=400;b.height=400;}function b(a){return a.task.server('server_can_delete_lookup_list',a.id.value);}function c(a){a.view_form.find("#select-btn").hide();a.view_form.find('#delete-btn').off('click.task').on('click',function(){a.question(a.task.language.delete_record,function(){var c=b(a);if(c)a.warning(c);else{a["delete"]();a.apply();}});});}function d(a){var b=a.task.sys_field_lookups.copy();a.lookups=b;e(a);a.edit_form.find("#new-btn").attr("tabindex",92).on('click.task',function(){b.append_record();});a.edit_form.find("#edit-btn").attr("tabindex",91).on('click.task',function(){b.edit_record();});a.edit_form.find("#delete-btn").attr("tabindex",90).on('click',function(){b.delete_record();});a.edit_table=b.create_table(a.edit_form.find(".edit-detail"),{height:300,tabindex:90,column_width:{f_value:'15%'},sortable:true});}function e(a){var b=[];a.lookups.open({open_empty:true});if(!a.is_new()){b=JSON.parse(a.f_lookup_values_text.value);for(var c=0;c<b.length;c++){a.lookups.append();a.lookups.f_value.value=b[c][0];a.lookups.f_lookup.value=b[c][1];a.lookups.post();}}}function f(a){var b=[];a.lookups.each(function(a){b.push([a.f_value.value,a.f_lookup.value]);});a.f_lookup_values_text.value=JSON.stringify(b);}function g(a){a.task.editing_finished();}this.init_view_table=a;this.can_delete=b;this.on_view_form_created=c;this.on_edit_form_created=d;this.init_lookups=e;this.on_before_post=f;this.on_view_form_closed=g;}b.events.events18=new k();function l(){function a(a){a.view_form.find('#up-btn').click(function(){a.task.move_record_up(a);});a.view_form.find('#down-btn').click(function(){a.task.move_record_down(a);});}function b(a){}function c(a){a.edit_form.find('textarea.f_help').attr('rows',3).height(40);d(a);}function d(a){a.f_multi_select_all.read_only=a.f_type.value!==a.task.consts.FILTER_IN&&a.f_type.value!==a.task.consts.FILTER_NOT_IN;if(a.f_multi_select_all.read_only&&a.is_changing())a.f_multi_select_all.value=false;}function e(a){a.task_id.value=a.task.sys_items.task_id.value;a.owner_id.value=0;a.f_visible.value=true;a.f_index.value=a.record_count();a.f_type.value=1;}function f(a){a.owner_rec_id.value=a.task.sys_items.id.value;a.owner.value=a.task.sys_items.ID;}function g(a,b){var c,e=a.owner;if(a.field_name==='f_field'){c=e.task.sys_fields.copy();c.set_where({id:a.value});c.open();e.f_name.value=c.f_name.value;e.f_filter_name.value=c.f_field_name.value;e.f_help.value=c.f_help.value;}d(e);}function h(a,b){var c,d=a.owner;if(a.field_name==='f_field'){c=d.copy();b.filters.owner_rec_id.value=[d.task.sys_items.id.value,d.task.sys_items.parent.value];b.filters.master_field_is_null.value=true;b.set_view_fields(['f_field_name','f_name']);b.set_order_by(['f_field_name']);}}function i(a){var b=0;a.each(function(a){a.edit();a.f_index.value=b;a.post();b++;});a.apply();a.task.editing_finished();}this.on_view_form_created=a;this.on_view_form_shown=b;this.on_edit_form_created=c;this.update_multi_select_all=d;this.on_after_append=e;this.on_before_post=f;this.on_field_changed=g;this.on_field_select_value=h;this.on_view_form_close_query=i;}b.events.events5=new l();function m(){function a(a){a.view_form.find("#edit-btn").text(a.task.language.view);if(a.filters.foreign_index.value){a.f_index_name.field_caption='Foreign key';a.view_options.fields=['f_foreign_field','f_index_name'];a.edit_options.fields=a.view_options.fields;a.f_foreign_field.required=true;a.f_index_name.required=true;}else{a.f_index_name.field_caption='Index';if(a.task.db_options.DATABASE==='FIREBIRD')a.view_options.fields=['f_index_name','f_unique_index','descending'];else a.view_options.fields=['f_index_name','f_unique_index'];a.edit_options.fields=a.view_options.fields;a.f_foreign_field.required=false;a.view_form.find("#new-btn").off('click.task').on('click.task',function(){c(a,true);});a.view_form.find("#edit-btn").off('click.task').on('click.task',function(){c(a,false);});a.view_table.on_dblclick=function(){c(a,false);};}}function b(a,b){if(b.keyCode===45&&b.ctrlKey===true){b.preventDefault();if(a.filters.foreign_index.value)a.append_record();else c(a,true);}else if(b.keyCode===46&&b.ctrlKey===true){b.preventDefault();a.delete_record();}}function c(a,b){var c,d=[],e=[],f=[],g='';function h(a,c){var d;if(b){if(!a.f_index_name.value)d=a.task.language.index_name_required;if(!c.length)d=a.task.language.index_fields_required;if(d){a.warning(d);throw d;}a.f_fields_list.value=a.server('server_dump_index_fields',[c]);a.post();try{a.apply();}catch(e){a.warning(e);throw e;}}else{a.read_only=false;a.cancel();}}function i(a){a.read_only=false;a.cancel();}function j(a){var b=a.sys_items,c=b.task.sys_fields.copy(),d,e=[];c.set_where({owner_rec_id__in:[b.id.value,b.parent.value]});c.set_order_by(['f_field_name']);c.open({fields:['id','f_field_name','f_master_field']});c.each(function(a){if(!a.f_master_field.value)e.push([a.id.value,a.f_field_name.value]);});return e;}if(b){a.append();a.read_only=false;}else if(a.record_count()>0){a.edit();a.read_only=true;f=a.server('server_load_index_fields',[a.f_fields_list.value]);}else return;d=[['id','',false],['name',a.task.language.caption_name,true]];if(a.task.db_options.DATABASE==='FIREBIRD')e=[['id','',false],['name',a.task.language.caption_name,true]];else e=[['id','',false],['name',a.task.language.caption_name,true],['param1',a.task.language.caption_descening,true]];c=a.task.sys_fields_editor.fields_editor(a,g,d,j(a.task),e,f,h,i,undefined,!b);a.create_inputs(c.view_form.find('div#fields-container'));}function d(a){var b=a.task.task_name,c=a.task.sys_items.f_item_name.value;if(!a.filters.foreign_index.value)a.f_index_name.value=b.toUpperCase()+'_'+c.toUpperCase()+'_'+'IDX';a.task_id.value=a.task.sys_items.task_id.value;a.owner_rec_id.value=a.task.sys_items.id.value;a.f_foreign_index.value=a.filters.foreign_index.value;}function e(a,b){function c(b){var c,d,e;if(b.f_object.value&&!b.f_master_field.value){e=b.task.sys_items.field_by_id(b.f_object.value,'f_soft_delete');if(!e){c=a.owner.clone();d=true;c.each(function(a){if(a.f_foreign_field.value==b.id.value){d=false;return false;}});return d;}}}b.view_options.fields=['f_nane','f_field_name'];b.on_filter_record=c;b.filtered=true;}function f(a,b){var c=a.owner;if(a.field_name==='f_foreign_field')c.f_index_name.value='FK_'+c.task.sys_items.f_table_name.value.toUpperCase()+'_'+a.display_text.toUpperCase();}function g(a){var b=a.owner,c='',d;if(a.field_name==='f_index_name'){d=b.clone();d.each(function(d){if(b.rec_no!==d.rec_no&&a.value===d.f_index_name.value){c='There is index with this name';return false;}});if(c)return c;}}function h(a){return{'manual_update':a.task._manual_update};}function i(a){a.task.editing_finished();}this.on_view_form_created=a;this.on_view_form_keydown=b;this.edit_index=c;this.on_after_append=d;this.on_field_select_value=e;this.on_field_changed=f;this.on_field_validate=g;this.on_before_apply=h;this.on_view_form_closed=i;}b.events.events10=new m();function n(){function b(b){b.view_options.width=760;b.view_form.find("#select-all-btn").text(b.task.language.select_all).on('click.task',function(){c(b);});b.view_form.find("#unselect-all-btn").text(b.task.language.unselect_all).on('click.task',function(){d(b);});b.view_table.$table.on('click','td',function(){var c=a(this),d=c.data('field_name'),e=b.field_by_name(d);if(e.field_type==="boolean"){if(!b.is_changing())b.edit();e.value=!e.value;}});}function c(a,b){var c=a.rec_no;if(b===undefined)b=true;try{a.disable_controls();a.each(function(a){a.edit();a.f_can_create.value=b;a.f_can_view.value=b;a.f_can_edit.value=b;a.f_can_delete.value=b;a.post();});}finally{a.rec_no=c;a.enable_controls();a.update_controls();}}function d(a){c(a,false);}function e(a){var b=a.copy();b.open({open_empty:true});a.first();while(!a.eof())if(a.id.value)a.next();else{b.append();a.each_field(function(a){b.field_by_name(a.field_name).value=a.value;b.id.value=null;});b.post();a["delete"]();};a.apply(function(){});b.apply(function(){});}function f(a){a.task.editing_finished();a.task.sys_roles.server('roles_changed');}this.on_view_form_created=b;this.select_all_clicked=c;this.unselect_all_clicked=d;this.on_view_form_close_query=e;this.on_view_form_closed=f;}b.events.events7=new n();function o(){function a(a){a.task.sys_filters.on_view_form_created(a);a.on_field_validate=a.task.sys_items.sys_fields.on_field_validate;}function b(a){a.task.sys_filters.on_view_form_close_query(a);}function c(a){a.task.sys_filters.on_before_post(a);}function d(a){a.task_id.value=a.task_id.value;a.f_data_type.read_only=false;a.f_visible.value=true;}function e(a,b){var c=a.owner;c.task.sys_items.sys_fields.on_field_changed(a,b);if(a.field_name==='f_object_field'){if(!c.f_name.value)c.f_name.value=b.f_name.value;if(!c.f_param_name.value)c.f_param_name.value=b.f_field_name.value;}}function f(a,b){a.owner.task.sys_items.sys_fields.on_field_select_value(a,b);}function g(a){a.edit_form.find('textarea.f_help').attr('rows',3).height(40);}this.on_view_form_created=a;this.on_view_form_close_query=b;this.on_before_post=c;this.on_after_append=d;this.on_field_changed=e;this.on_field_select_value=f;this.on_edit_form_created=g;}b.events.events12=new o();function p(){function a(a){if(a.field_name==='f_value'&&a.value<=0)return 'Value must be greater than zero';}function b(a){a.task.editing_finished();}this.on_field_validate=a;this.on_view_form_closed=b;}b.events.events17=new p();function q(){function a(a){function b(){var b=false,c;if(a.owner.id.value&&a.id.value){c=a.task.sys_indices;c.set_where({owner_rec_id:a.owner.id.value});c.open();c.each(function(c){if(c.f_foreign_index.value&&c.f_foreign_field.value===a.id.value)b=true;});}return b;}var c;a.f_field_name.read_only=a.f_field_name.value==='id'||a.f_field_name.value==='deleted'||a.f_field_name.value==='owner_id'||a.f_field_name.value==='owner_rec_id';a.f_data_type.read_only=false;a.f_size.read_only=false;a.f_object.read_only=false;a.f_object_field.read_only=false;a.f_master_field.read_only=false;a.f_lookup_values.read_only=true;i(a);if(b())a.f_object.read_only=true;if(a.task._manual_update)c=['f_name','f_field_name','f_db_field_name','f_data_type','f_size','f_default_value','f_required','f_read_only'];else c=['f_name','f_field_name','f_data_type','f_size','f_default_value','f_required','f_read_only'];a.create_inputs(a.edit_form.find("#definition"),{fields:c});a.create_inputs(a.edit_form.find("#lookups"),{fields:['f_object','f_object_field','f_object_field1','f_object_field2','f_master_field','f_enable_typehead','f_lookup_values']});a.create_inputs(a.edit_form.find("#interface"),{fields:['f_alignment','f_placeholder','f_help','f_default']});a.edit_form.find('textarea.f_help').attr('rows',3).height(40);a.edit_form.find("#cancel-btn").text(a.task.language.cancel).attr("tabindex",101).on('click.task',function(b){a.cancel_edit(b);return false;});a.edit_form.find("#ok-btn").attr("tabindex",100).html(a.task.language.ok+'<small class="muted">&nbsp;[Ctrl+Enter]</small>').on('click.task',function(){a.apply_record();});}function b(a){var b='Field Editor';if(a.f_field_name.value)a.edit_form.find('h4.modal-title').html(b+' <span class="editor-title">'+a.f_field_name.value+'</span>');else a.edit_form.find('h4.modal-title').html(b);}function c(a){a._old_fields={};a.disable_controls();try{a.each(function(b){a._old_fields[b.id.value+'']=true;});}finally{a.first();a.enable_controls();}}function d(a){var b=true;if(a._old_fields)b=!a._old_fields[a.id.value+''];return b;}function e(a,b){var c=a.owner,d,e,f;if(b.item_name==='sys_items')b.set_view_fields(['id','f_item_name','f_name']);else if(b.item_name==='sys_fields'){b.set_order_by(['f_field_name']);b.set_view_fields(['f_field_name','f_name']);}else if(b.item_name==='sys_lookup_lists')b.set_view_fields(['f_name']);if(a===c.f_object){if(c.owner===c.task.sys_items){b.filters.not_id.value=c.owner.id.value;if(c.owner.type_id.value===c.task.item_types.TASK_TYPE)b.filters.task_id.value=c.owner.id.value;else b.filters.task_id.value=c.owner.task_id.value;}b.set_order_by(['f_item_name']);b.filters.type_id.value=[c.task.item_types.ITEM_TYPE,c.task.item_types.TABLE_TYPE];b.filters.table_id.value=0;}else if(a.field_name==='f_master_field'&&c.f_object.value){e=c.owner.id.value;f=c.task.sys_items.field_by_id(e,'parent');if(f){b.filters.owner_rec_id.value=[f];b.filters.not_id.value=c.id.value;b.filters.object.value=c.f_object.value;b.filters.master_field_is_null.value=true;}else b.filters.owner_rec_id.value=[-1];b.set_fields(['id','f_name','f_field_name','f_db_field_name']);b.on_after_open=function(a){var b=c.clone();a.first();b.each(function(b){if(b.id.value!==c.id.value&&b.f_object.value===c.f_object.value&&!b.f_master_field.value){a.append();a.id.value=b.id.value;a.f_field_name.value=b.f_field_name.value;a.f_db_field_name.value=b.f_db_field_name.value;a.f_name.value=b.f_name.value;a.post();}});a.first();};}if(a.field_name==='f_object_field')if(c.f_object.value){e=c.f_object.value;f=c.task.sys_items.field_by_id(e,'parent');b.filters.owner_rec_id.value=[e,f];b.filters.master_field_is_null.value=true;b.set_order_by(['f_field_name']);}else b.filters.owner_rec_id.value=[-1];if(a.field_name==='f_object_field1'){d=c.task.sys_fields.copy();d.set_where({id:c.f_object_field.value});d.open();if(d.f_object.value){e=d.f_object.value;f=d.task.sys_items.field_by_id(e,'parent');b.filters.owner_rec_id.value=[e,f];b.filters.master_field_is_null.value=true;b.set_order_by(['f_field_name']);}else b.filters.owner_rec_id.value=[-1];}if(a.field_name==='f_object_field2'){d=c.task.sys_fields.copy();d.set_where({id:c.f_object_field1.value});d.open();if(d.f_object.value){e=d.f_object.value;f=d.task.sys_items.field_by_id(e,'parent');b.filters.owner_rec_id.value=[e,f];b.filters.master_field_is_null.value=true;b.set_order_by(['f_field_name']);}else b.filters.owner_rec_id.value=[-1];}}function f(a,b){var c='',d,e,f;if(!a.owner.valid_identifier(b))c=a.task.language.invalid_field_name;d=a.clone();d.each(function(d){if(a.rec_no!==d.rec_no&&b===d.f_field_name.value){c='There is a field with this name';return false;}});if(!c){f=new a.task.constructors.item();if(f[b]!==undefined)c=a.task.language.reserved_word;}if(!c){e=a.id;if(b==='id')e=a.deleted;if(e[b]!==undefined)c=a.task.language.reserved_word;}return c;}function g(a){var b=a.owner,c='';if(a.field_name==='f_field_name'){c=f(b,a.value);if(c)return c;}else if(a.field_name==='f_object_field'){if(b.f_object.value&&!a.value)return b.task.language.object_field_required;}else if(a.field_name==='f_data_type'&&b.f_data_type.value===0)return b.task.language.type_is_required;else if(a.field_name==='f_size'&&b.f_data_type.value===b.task.consts.TEXT&&!a.value)return b.task.language.size_is_required;}function h(a){var b=a.owner,c,d,e;if(!b._field_changing){b._field_changing=true;try{if(a.field_name==='f_name')if(b.f_field_name){if(!b.f_field_name.value)try{e=a.text.split(' ').join('_').toLowerCase();if(b.owner.valid_identifier(e))b.f_field_name.value=e;}catch(f){}}else if(b.f_param_name)if(!b.f_param_name.value)try{e=a.text.split(' ').join('_').toLowerCase();if(b.owner.valid_identifier(e))b.f_param_name.value=e;}catch(f){}if(b.f_field_name&&!b.task._manual_update)b.f_db_field_name.value=b.task.server('server_set_literal_case',b.f_field_name.value);if(a.field_name==='f_object'){b.f_object_field.value=null;b.f_object_field1.value=null;b.f_object_field2.value=null;b.f_lookup_values.value=null;b.f_master_field.value=null;if(b.f_object.value){d=b.task.server('server_get_primary_key_type',a.value);b.f_data_type.value=d[0];b.f_size.value=d[1];}}else if(a.field_name==='f_object_field'){b.f_object_field1.value=null;b.f_object_field2.value=null;}else if(a.field_name==='f_object_field1')b.f_object_field2.value=null;else if(a.field_name==='f_lookup_values'){b.f_object.value=null;b.f_object_field.value=null;b.f_master_field.value=null;if(b.f_lookup_values.value)b.f_data_type.value=b.task.consts.INTEGER;}else if(a===b.f_data_type)if(b.f_data_type.value===b.task.consts.TEXT)b.f_size.value=10;else b.f_size.value=null;if(a===b.f_data_type||a===b.f_object||a===b.f_lookup_values)b.f_alignment.value=k(b);i(b);}finally{b._field_changing=false;}}}function i(a){if(!d(a)&&!a.owner.f_virtual_table.value&&!a.task._manual_update){a.f_data_type.read_only=!a.task.db_options.CAN_CHANGE_TYPE;a.f_size.read_only=true;if(a.f_data_type.value===a.task.consts.TEXT){a.f_size.read_only=!a.task.db_options.CAN_CHANGE_SIZE;if(a.f_object.value||a.owner.f_primary_key.value===a.id.value)a.f_size.read_only=true;}a.f_object.read_only=true;a.f_object_field.read_only=true;a.f_master_field.read_only=true;a.f_lookup_values.read_only=true;if(a.f_data_type.value===a.task.consts.INTEGER){a.f_object.read_only=false;a.f_object_field.read_only=false;a.f_master_field.read_only=false;a.f_lookup_values.read_only=false;}}else{if(!a.f_data_type.value){a.f_data_type.read_only=false;a.f_lookup_values.read_only=false;a.f_object.read_only=false;a.f_object_field.read_only=false;a.f_master_field.read_only=false;}else if(a.f_data_type.value)if(a.f_object.value)a.f_data_type.read_only=true;else if(a.f_lookup_values.value)a.f_data_type.read_only=true;else{a.f_data_type.read_only=false;a.f_lookup_values.read_only=false;a.f_object.read_only=false;a.f_object_field.read_only=false;a.f_master_field.read_only=false;}else{a.f_object.read_only=true;a.f_object_field.read_only=true;a.f_master_field.read_only=true;a.f_lookup_values.read_only=true;}if(a.f_data_type.value===a.task.consts.TEXT&&!a.f_object.value)a.f_size.read_only=false;else a.f_size.read_only=true;}j(a);}function j(a){a.f_object_field.read_only=!a.f_object.value;a.f_object_field1.read_only=!a.f_object_field.value;a.f_object_field2.read_only=!a.f_object_field1.value;a.f_master_field.read_only=!a.f_object_field.value;a.f_multi_select.read_only=true;a.f_enable_typehead.read_only=true;if(a.f_object.value&&!a.f_master_field.value){a.f_multi_select.read_only=false;a.f_enable_typehead.read_only=false;}if(a.f_enable_typehead.value)a.f_multi_select.read_only=true;if(a.f_multi_select.value)a.f_enable_typehead.read_only=true;a.f_multi_select_all.read_only=!a.f_multi_select.value;if(a.is_changing()){if(a.f_multi_select.read_only){a.f_multi_select.value=null;a.f_multi_select_all.value=null;}if(!a.f_multi_select.value)a.f_multi_select_all.value=null;if(a.f_enable_typehead.read_only)a.f_enable_typehead.value=null;}}function k(a){var b=a.f_data_type.value,c;if(b===a.task.consts.INTEGER||b===a.task.consts.FLOAT||b===a.task.consts.CURRENCY)c=a.task.consts.ALIGN_RIGHT;else if(b===a.task.consts.DATE||b===a.task.consts.DATETIME)c=a.task.consts.ALIGN_CENTER;else c=a.task.consts.ALIGN_LEFT;if(a.f_object.value||a.f_lookup_values.value)c=a.task.consts.ALIGN_LEFT;return c;}function l(a){var b,c;if(a.f_object.value){c=a.clone();c.each(function(c){if(c.f_object.value===a.f_object.value&&c.f_master_field.value===a.id.value){b='You can not delete the <b>'+a.f_field_name.value+'</b>field. It is a master field to the <b>'+c.f_field_name.value+'.</b> field';return false;}});}if(!b&&!d(a))b=a.task.sys_fields.server('server_can_delete_field',[a.id.value]);return b;}function m(a){a.f_data_type.read_only=false;}function n(a){if(a.id.value===a.owner.f_primary_key.value)a.owner.f_primary_key.value=null;else if(a.id.value===a.owner.f_deleted_flag.value)a.owner.f_deleted_flag.value=null;else if(a.id.value===a.owner.f_master_id.value)a.owner.f_master_id.value=null;else if(a.id.value===a.owner.f_master_rec_id.value)a.owner.f_master_rec_id.value=null;}function o(a){if(a.f_data_type.value!==a.task.consts.TEXT)a.f_size.value=null;a.task_id.value=a.task.item_tree.task_id.value;if(!a.id.value)a.id.value=a.task.server('get_fields_next_id');}function p(a){}function q(a){if(a.field_name==='f_size'&&a.value===0)return '';}this.on_edit_form_created=a;this.on_edit_form_shown=b;this.on_after_open=c;this.new_field=d;this.on_field_select_value=e;this.check_valid_field_name=f;this.on_field_validate=g;this.on_field_changed=h;this.update_fields_read_only=i;this.update_lookup_attr=j;this.get_alignment=k;this.can_delete=l;this.on_after_append=m;this.on_before_delete=n;this.on_before_post=o;this.on_before_edit=p;this.on_field_get_text=q;}b.events.events6=new q();function r(){function a(a,b){var c=a.owner;c.post();c.owner.post();if(c.id.value)c.record_status=c.task.consts.RECORD_MODIFIED;else c.record_status=c.task.consts.RECORD_INSERTED;c.owner.apply();c.owner.edit();}this.on_field_changed=a;}b.events.events8=new r();})(jQuery,task);